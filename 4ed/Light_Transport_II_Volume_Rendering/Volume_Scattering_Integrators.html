
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.ico?v=2" /> <!-- force refresh -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

  <script async src="https://cse.google.com/cse.js?cx=003601324460585362024:4xwpwgaitgd"></script>
  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
        
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>Volume Scattering Integrators</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_II_Volume_Rendering.html">Light Transport II: Volume Rendering</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Volume Scattering Integrators</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html">(Previous: The Equation of Transfer)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:vol-light-transport"></span><h2>14.2 Volume Scattering Integrators</h2><p>



</p>
<p>The path space expression of the null-scattering equation of transfer
allows a variety of sampling techniques to be applied to the light
transport problem.  This section defines two integrators that are based on
path tracing starting from the camera.

</p>
<p>First is the <tt>SimpleVolPathIntegrator</tt>, which uses simple sampling
techniques, giving an implementation that is short and easily verified.
This integrator is particularly useful for computing ground-truth results
when debugging more sophisticated volumetric sampling and integration algorithms.

</p>
<p>The <a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a> is defined next.  This integrator is fairly
complex, but it applies state-of-the-art sampling techniques to volume
light transport while handling surface scattering similarly to the
<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>.  It is <tt>pbrt</tt>&rsquo;s default integrator and is also the
template for the wavefront integrator in Chapter&nbsp;<a href="../Wavefront_Rendering_on_GPUs.html#chap:gpu">15</a>.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#ASimpleVolumetricIntegrator"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="ASimpleVolumetricIntegrator"></span><h3>14.2.1  A Simple Volumetric Integrator</h3><p>


</p>
<p>The <tt>SimpleVolPathIntegrator</tt> implements a basic volumetric path
tracer, following the sampling approach described in
Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#sec:volumetric-path-tracing-deriv">14.1.2</a>.
Its <tt>Li()</tt> method is under 100 lines of
code, none of them too tricky.  However, with this simplicity comes a
number of limitations.  First, like the <a href="../Introduction/pbrt_System_Overview.html#RandomWalkIntegrator"><tt>RandomWalkIntegrator</tt></a>, it does
not perform any explicit light sampling, so it requires that rays are able
to randomly intersect the lights in the scene.  Second, it does
not handle scattering from surfaces.  An error message is therefore issued
if it is used with a
scene that contains delta distribution light sources or has surfaces with
nonzero-valued BSDFs.  (These defects are all addressed in the
<a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a> discussed in
Section&nbsp;<a href="#sec:volpath-improving-sampling">14.2.2</a>.)
Nevertheless, this integrator is capable of
rendering complex volumetric effects; see Figure&nbsp;<a href="#fig:explosion-simplevolpath">14.6</a>.

</p>
<p></p>
<span class="anchor" id="fig:explosion-simplevolpath"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
<img src="ground-explosion-simplepath.png" style="max-width: 100%; height: auto;" width=944 height=1089>
</div>
<p>

</p>
<figcaption class="caption">Figure 14.6: Explosion Rendered Using the <a href="#SimpleVolPathIntegrator"><tt>SimpleVolPathIntegrator</tt></a>. <span class="legend">
With 256 samples per pixel, this integrator gives a reasonably accurate
rendering of the volumetric model, though there are variance spikes in some
pixels (especially visible toward the bottom of the volume) due to error from the
integrator not directly sampling the scene&rsquo;s light sources.  The
<a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a>, which uses more sophisticated sampling
strategies, renders this scene with 1,288 times lower MSE; it is discussed
in Section&nbsp;<a href="#sec:volpath-improving-sampling">14.2.2</a>.
<em>(Scene courtesy of Jim Price.)</em>
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-SimpleVolPathIntegratorDefinition-0"></span><div class="fragmentname">&lt;&lt;SimpleVolPathIntegrator Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="SimpleVolPathIntegrator"></span>SimpleVolPathIntegrator : public <a href="../Introduction/pbrt_System_Overview.html#RayIntegrator" class="code">RayIntegrator</a> {
  public:
    &lt;&lt;<span class="fragmentname">SimpleVolPathIntegrator Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1947" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1947"><i></i></a><div id="fragbit-1947" class="collapse"><div class="fragmentcode">       SimpleVolPathIntegrator(int maxDepth, <a href="../Cameras_and_Film/Camera_Interface.html#Camera" class="code">Camera</a> camera, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler,
                               <a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive" class="code">Primitive</a> aggregate, std::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights);
       
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Li(<a href="../Geometry_and_Transformations/Rays.html#RayDifferential" class="code">RayDifferential</a> ray, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda,
                          <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler, <a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer" class="code">ScratchBuffer</a> &amp;scratchBuffer,
                          <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a> *visibleSurface) const;
       
       static std::unique_ptr&lt;SimpleVolPathIntegrator&gt; Create(
           const ParameterDictionary &amp;parameters, <a href="../Cameras_and_Film/Camera_Interface.html#Camera" class="code">Camera</a> camera, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler,
           <a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive" class="code">Primitive</a> aggregate, std::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights, const FileLoc *loc);
       
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-SimpleVolPathIntegratorPrivateMembers-0">SimpleVolPathIntegrator Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1948" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1948"><i></i></a><div id="fragbit-1948" class="collapse"><div class="fragmentcode">       int maxDepth;</div></div>
};</div><p>


</p>
<p>

</p>
<p>

</p>
<p>This integrator&rsquo;s only parameter is the maximum path length, which is set
via a value passed to the constructor (not included here).

</p>
<p></p>
<span class="anchor" id="fragment-SimpleVolPathIntegratorPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;SimpleVolPathIntegrator Private Members&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int <span class="anchor" id="SimpleVolPathIntegrator::maxDepth"></span>maxDepth;</div><p>


</p>
<p>The general form of the <tt>Li()</tt> method follows that of the
<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-SimpleVolPathIntegratorMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;SimpleVolPathIntegrator Method Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="SimpleVolPathIntegrator::Li"></span>SimpleVolPathIntegrator::Li(<a href="../Geometry_and_Transformations/Rays.html#RayDifferential" class="code">RayDifferential</a> ray,
        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler, <a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer" class="code">ScratchBuffer</a> &amp;buf,
        <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a> *) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Declarelocalvariablesfordeltatrackingintegration-0">Declare local variables for delta tracking integration</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1949" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1949"><i></i></a><div id="fragbit-1949" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> L(0.f);
       Float beta = 1.f;
       int depth = 0;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Terminatesecondarywavelengthsbeforestartingrandomwalk-0">Terminate secondary wavelengths before starting random walk</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1950" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1950"><i></i></a><div id="fragbit-1950" class="collapse"><div class="fragmentcode">       lambda.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths::TerminateSecondary" class="code">TerminateSecondary</a>();</div></div>
    while (true) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Estimateradianceforraypathusingdeltatracking-0">Estimate radiance for ray path using delta tracking</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1951" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1951"><i></i></a><div id="fragbit-1951" class="collapse"><div class="fragmentcode">           pstd::optional&lt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection" class="code">ShapeIntersection</a>&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(ray);
           bool scattered = false, terminated = false;
           if (ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonoRNGforsamplingthemajoranttransmittance-0">Initialize <tt>RNG</tt> for sampling the majorant transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1952" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1952"><i></i></a><div id="fragbit-1952" class="collapse"><div class="fragmentcode">                  uint64_t hash0 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
                  uint64_t hash1 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
                  <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(hash0, hash1);</div></div>
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplemediumusingdeltatracking-0">Sample medium using delta tracking</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1953" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1953"><i></i></a><div id="fragbit-1953" class="collapse"><div class="fragmentcode">                  Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : Infinity;
                  Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
                  Float uMode = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
                  <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(ray, tMax, u, rng, lambda,
                      [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
                          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) {
                          &lt;&lt;<span class="fragmentname"><a href="#fragment-Computemediumeventprobabilitiesforinteraction-0">Compute medium event probabilities for interaction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1954" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1954"><i></i></a><div id="fragbit-1954" class="collapse"><div class="fragmentcode">                             Float pAbsorb = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a>[0] / sigma_maj[0];
                             Float pScatter = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0] / sigma_maj[0];
                             Float pNull = std::max&lt;Float&gt;(0, 1 - pAbsorb - pScatter);</div></div>
                          &lt;&lt;<span class="fragmentname"><a href="#fragment-Randomlysamplemediumscatteringeventfordeltatracking-0">Randomly sample medium scattering event for delta tracking</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1955" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1955"><i></i></a><div id="fragbit-1955" class="collapse"><div class="fragmentcode">                             int mode = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>({pAbsorb, pScatter, pNull}, uMode);
                             if (mode == 0) {
                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleabsorptioneventformediumsample-0">Handle absorption event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1956" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1956"><i></i></a><div id="fragbit-1956" class="collapse"><div class="fragmentcode">                                    L += beta * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>;
                                    terminated = true;
                                    return false;</div></div>
                             } else if (mode == 1) {
                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleregularscatteringeventformediumsample-0">Handle regular scattering event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1957" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1957"><i></i></a><div id="fragbit-1957" class="collapse"><div class="fragmentcode">                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1958" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1958"><i></i></a><div id="fragbit-1958" class="collapse"><div class="fragmentcode">                                       if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
                                           terminated = true;
                                           return false;
                                       }</div></div>
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionformediumscatteringevent-0">Sample phase function for medium scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1959" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1959"><i></i></a><div id="fragbit-1959" class="collapse"><div class="fragmentcode">                                       <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(), rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;()};
                                       pstd::optional&lt;PhaseFunctionSample&gt; ps = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
                                       if (!ps) {
                                           terminated = true;
                                           return false;
                                       }</div></div>
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatestateforrecursiveevaluationofL_romani-0">Update state for recursive evaluation of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1960" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1960"><i></i></a><div id="fragbit-1960" class="collapse"><div class="fragmentcode">                                       beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                       ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
                                       ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                                       scattered = true;
                                       return false;</div></div></div></div>
                             } else {
                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenull-scatteringeventformediumsample-0">Handle null-scattering event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1961" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1961"><i></i></a><div id="fragbit-1961" class="collapse"><div class="fragmentcode">                                    uMode = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;();
                                    return true;</div></div>
                             }</div></div>
                      });</div></div>
           }
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleterminatedandunscatteredraysaftermediumsampling-0">Handle terminated and unscattered rays after medium sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1962" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1962"><i></i></a><div id="fragbit-1962" class="collapse"><div class="fragmentcode">              if (terminated) return L;
              if (scattered) continue;
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemissiontosurvivingray-0">Add emission to surviving ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1963" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1963"><i></i></a><div id="fragbit-1963" class="collapse"><div class="fragmentcode">                 if (si)
                     L += beta * si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, lambda);
                 else {
                     for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>)
                         L += beta * light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda);
                     return L;
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlesurfaceintersectionalongraypath-0">Handle surface intersection along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1964" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1964"><i></i></a><div id="fragbit-1964" class="collapse"><div class="fragmentcode">                 <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, buf, sampler);
                 if (!bsdf)
                     si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
                 else {
                     &lt;&lt;<span class="fragmentname">Report error if BSDF returns a valid sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1965" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1965"><i></i></a><div id="fragbit-1965" class="collapse"><div class="fragmentcode">                        Float uc = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
                        <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
                        if (bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, uc, u))
                            <a href="../Utilities/User_Interaction.html#ErrorExit" class="code">ErrorExit</a>("SimpleVolPathIntegrator doesn't support surface scattering.");
                        else
                            break;</div></div>
                 }</div></div></div></div></div></div>
    }
    return L;
}</div><p>


</p>
<p>A few familiar variables track the path state, including <tt>L</tt> to
accumulate the radiance estimate for the path. For this integrator,
<tt>beta</tt>, which tracks the path throughput weight, is just a single
<tt>Float</tt> value, since the product of ratios of phase function values and
sampling PDFs from Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:delta-tracking-path-estimator">14.19</a>) is a
scalar value.

</p>
<p></p>
<span class="anchor" id="fragment-Declarelocalvariablesfordeltatrackingintegration-0"></span><div class="fragmentname">&lt;&lt;Declare local variables for delta tracking integration&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> L(0.f);
Float beta = 1.f;
int depth = 0;</div><p>


</p>
<p>
Media with scattering properties that vary according to wavelength
introduce a number of complexities in sampling and evaluating Monte Carlo
estimators.  We will defer addressing them until we cover the
<a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a>.  The <tt>SimpleVolPathIntegrator</tt> instead
estimates radiance at a single wavelength by terminating all but the first wavelength
sample.

</p>
<p>Here is a case where we have chosen simplicity over efficiency for this
integrator&rsquo;s implementation: we might instead have accounted for all
wavelengths until the point that spectrally varying scattering properties
were encountered, enjoying the variance reduction benefits of
estimating all of them for scenes where doing so is possible.  However, doing
this would have led to a more complex integrator implementation.

</p>
<p></p>
<span class="anchor" id="fragment-Terminatesecondarywavelengthsbeforestartingrandomwalk-0"></span><div class="fragmentname">&lt;&lt;Terminate secondary wavelengths before starting random walk&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">lambda.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths::TerminateSecondary" class="code">TerminateSecondary</a>();</div><p>


</p>
<p>The first step in the loop is to find the ray&rsquo;s intersection with the scene
geometry, if any. This gives the parametric distance <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> beyond which
no samples should be taken for the current ray, as the intersection either represents a
transition to a different medium or a surface that occludes farther-away
points.

</p>
<p>The <tt>scattered</tt> and <tt>terminated</tt> variables declared here will allow the
lambda function that is passed to
<tt>SampleT_maj()</tt> to report
back the state of the path after sampling terminates.

</p>
<p></p>
<span class="anchor" id="fragment-Estimateradianceforraypathusingdeltatracking-0"></span><div class="fragmentname">&lt;&lt;Estimate radiance for ray path using delta tracking&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection" class="code">ShapeIntersection</a>&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(ray);
bool scattered = false, terminated = false;
if (ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonoRNGforsamplingthemajoranttransmittance-0">Initialize <tt>RNG</tt> for sampling the majorant transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1966" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1966"><i></i></a><div id="fragbit-1966" class="collapse"><div class="fragmentcode">       uint64_t hash0 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
       uint64_t hash1 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
       <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(hash0, hash1);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplemediumusingdeltatracking-0">Sample medium using delta tracking</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1967" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1967"><i></i></a><div id="fragbit-1967" class="collapse"><div class="fragmentcode">       Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : Infinity;
       Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
       Float uMode = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
       <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(ray, tMax, u, rng, lambda,
           [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
               <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Computemediumeventprobabilitiesforinteraction-0">Compute medium event probabilities for interaction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1968" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1968"><i></i></a><div id="fragbit-1968" class="collapse"><div class="fragmentcode">                  Float pAbsorb = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a>[0] / sigma_maj[0];
                  Float pScatter = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0] / sigma_maj[0];
                  Float pNull = std::max&lt;Float&gt;(0, 1 - pAbsorb - pScatter);</div></div>
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Randomlysamplemediumscatteringeventfordeltatracking-0">Randomly sample medium scattering event for delta tracking</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1969" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1969"><i></i></a><div id="fragbit-1969" class="collapse"><div class="fragmentcode">                  int mode = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>({pAbsorb, pScatter, pNull}, uMode);
                  if (mode == 0) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleabsorptioneventformediumsample-0">Handle absorption event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1970" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1970"><i></i></a><div id="fragbit-1970" class="collapse"><div class="fragmentcode">                         L += beta * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>;
                         terminated = true;
                         return false;</div></div>
                  } else if (mode == 1) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleregularscatteringeventformediumsample-0">Handle regular scattering event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1971" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1971"><i></i></a><div id="fragbit-1971" class="collapse"><div class="fragmentcode">                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1972" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1972"><i></i></a><div id="fragbit-1972" class="collapse"><div class="fragmentcode">                            if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
                                terminated = true;
                                return false;
                            }</div></div>
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionformediumscatteringevent-0">Sample phase function for medium scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1973" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1973"><i></i></a><div id="fragbit-1973" class="collapse"><div class="fragmentcode">                            <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(), rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;()};
                            pstd::optional&lt;PhaseFunctionSample&gt; ps = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
                            if (!ps) {
                                terminated = true;
                                return false;
                            }</div></div>
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatestateforrecursiveevaluationofL_romani-0">Update state for recursive evaluation of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1974" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1974"><i></i></a><div id="fragbit-1974" class="collapse"><div class="fragmentcode">                            beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                            ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
                            ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                            scattered = true;
                            return false;</div></div></div></div>
                  } else {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenull-scatteringeventformediumsample-0">Handle null-scattering event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1975" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1975"><i></i></a><div id="fragbit-1975" class="collapse"><div class="fragmentcode">                         uMode = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;();
                         return true;</div></div>
                  }</div></div>
           });</div></div>
}
&lt;&lt;<span class="fragmentname"><a href="#fragment-Handleterminatedandunscatteredraysaftermediumsampling-0">Handle terminated and unscattered rays after medium sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1976" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1976"><i></i></a><div id="fragbit-1976" class="collapse"><div class="fragmentcode">   if (terminated) return L;
   if (scattered) continue;
   &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemissiontosurvivingray-0">Add emission to surviving ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1977" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1977"><i></i></a><div id="fragbit-1977" class="collapse"><div class="fragmentcode">      if (si)
          L += beta * si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, lambda);
      else {
          for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>)
              L += beta * light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda);
          return L;
      }</div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlesurfaceintersectionalongraypath-0">Handle surface intersection along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1978" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1978"><i></i></a><div id="fragbit-1978" class="collapse"><div class="fragmentcode">      <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, buf, sampler);
      if (!bsdf)
          si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
      else {
          &lt;&lt;<span class="fragmentname">Report error if BSDF returns a valid sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1979" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1979"><i></i></a><div id="fragbit-1979" class="collapse"><div class="fragmentcode">             Float uc = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
             <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
             if (bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, uc, u))
                 <a href="../Utilities/User_Interaction.html#ErrorExit" class="code">ErrorExit</a>("SimpleVolPathIntegrator doesn't support surface scattering.");
             else
                 break;</div></div>
      }</div></div></div></div></div><p>


</p>
<p>An <a href="../Utilities/Mathematical_Infrastructure.html#RNG"><tt>RNG</tt></a> is required for the call to the <tt>SampleT_maj()</tt>
function.  We derive seeds for it based on two random values from the
sampler, hashing them to convert <tt>Float</tt>s into integers.  

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonoRNGforsamplingthemajoranttransmittance-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>RNG</tt> for sampling the majorant transmittance&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">uint64_t hash0 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
uint64_t hash1 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
<a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(hash0, hash1);</div><p>


</p>
<p>With that, a call to <tt>SampleT_maj()</tt> starts the generation of samples
according to
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.538ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 3676 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal m normal a normal j Baseline upper T Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
<g transform="translate(1831,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</svg>.  The <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler"><tt>Sampler</tt></a> is used to generate the first uniform
sample <tt>u</tt> that is passed to the method; recall from
Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#sec:sample-tmaj">14.1.3</a> that subsequent ones will be
generated using the provided <a href="../Utilities/Mathematical_Infrastructure.html#RNG"><tt>RNG</tt></a>.  In a similar fashion, the
<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler"><tt>Sampler</tt></a> is used for the initial value of <tt>uMode</tt> here.  It will be
used to choose among the three types of scattering event at the first
sampled point.  For <tt>uMode</tt> as well, the <tt>RNG</tt> will provide
subsequent values.

</p>
<p>In this case, the transmittance that <tt>SampleT_maj()</tt> returns for the
final segment is unneeded, so it is ignored.

</p>
<p></p>
<span class="anchor" id="fragment-Samplemediumusingdeltatracking-0"></span><div class="fragmentname">&lt;&lt;Sample medium using delta tracking&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : Infinity;
Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
Float uMode = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(ray, tMax, u, rng, lambda,
    [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Computemediumeventprobabilitiesforinteraction-0">Compute medium event probabilities for interaction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1980" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1980"><i></i></a><div id="fragbit-1980" class="collapse"><div class="fragmentcode">           Float pAbsorb = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a>[0] / sigma_maj[0];
           Float pScatter = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0] / sigma_maj[0];
           Float pNull = std::max&lt;Float&gt;(0, 1 - pAbsorb - pScatter);</div></div>
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Randomlysamplemediumscatteringeventfordeltatracking-0">Randomly sample medium scattering event for delta tracking</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1981" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1981"><i></i></a><div id="fragbit-1981" class="collapse"><div class="fragmentcode">           int mode = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>({pAbsorb, pScatter, pNull}, uMode);
           if (mode == 0) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleabsorptioneventformediumsample-0">Handle absorption event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1982" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1982"><i></i></a><div id="fragbit-1982" class="collapse"><div class="fragmentcode">                  L += beta * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>;
                  terminated = true;
                  return false;</div></div>
           } else if (mode == 1) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleregularscatteringeventformediumsample-0">Handle regular scattering event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1983" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1983"><i></i></a><div id="fragbit-1983" class="collapse"><div class="fragmentcode">                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1984" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1984"><i></i></a><div id="fragbit-1984" class="collapse"><div class="fragmentcode">                     if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
                         terminated = true;
                         return false;
                     }</div></div>
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionformediumscatteringevent-0">Sample phase function for medium scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1985" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1985"><i></i></a><div id="fragbit-1985" class="collapse"><div class="fragmentcode">                     <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(), rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;()};
                     pstd::optional&lt;PhaseFunctionSample&gt; ps = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
                     if (!ps) {
                         terminated = true;
                         return false;
                     }</div></div>
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatestateforrecursiveevaluationofL_romani-0">Update state for recursive evaluation of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1986" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1986"><i></i></a><div id="fragbit-1986" class="collapse"><div class="fragmentcode">                     beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                     ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
                     ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                     scattered = true;
                     return false;</div></div></div></div>
           } else {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenull-scatteringeventformediumsample-0">Handle null-scattering event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1987" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1987"><i></i></a><div id="fragbit-1987" class="collapse"><div class="fragmentcode">                  uMode = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;();
                  return true;</div></div>
           }</div></div>
    });</div><p>


</p>
<p>For each sample returned by <tt>SampleT_maj()</tt>, it is necessary
to select which type of scattering it represents.  The first step is to
compute the probability of each possibility.  Because we have specified
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.474ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1065 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="808" y="-213"></use>
</g>
</svg> such that it is nonnegative and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.096ex" height="2.676ex" style="vertical-align: -1.005ex;" viewBox="0 -719.6 8652.3 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a Baseline plus sigma Subscript normal s Baseline plus sigma Subscript normal n Baseline equals sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="1247" y="0"></use>
<g transform="translate(2248,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="3421" y="0"></use>
<g transform="translate(4421,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="808" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="5764" y="0"></use>
<g transform="translate(6820,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</svg>, the null-scattering probability can be found as one minus the
other two probabilities.  A call to <tt>std::max()</tt> ensures that any
slightly negative values due to floating-point round-off error are clamped at
zero.

</p>
<p></p>
<span class="anchor" id="fragment-Computemediumeventprobabilitiesforinteraction-0"></span><div class="fragmentname">&lt;&lt;Compute medium event probabilities for interaction&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pAbsorb = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a>[0] / sigma_maj[0];
Float pScatter = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0] / sigma_maj[0];
Float pNull = std::max&lt;Float&gt;(0, 1 - pAbsorb - pScatter);</div><p>


</p>
<p>A call to <tt>SampleDiscrete()</tt> then selects one of the three terms of
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.729ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1175 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="963" y="-213"></use>
</g>
</svg> using the specified probabilities.

</p>
<p></p>
<span class="anchor" id="fragment-Randomlysamplemediumscatteringeventfordeltatracking-0"></span><div class="fragmentname">&lt;&lt;Randomly sample medium scattering event for delta tracking&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int mode = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>({pAbsorb, pScatter, pNull}, uMode);
if (mode == 0) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleabsorptioneventformediumsample-0">Handle absorption event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1988" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1988"><i></i></a><div id="fragbit-1988" class="collapse"><div class="fragmentcode">       L += beta * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>;
       terminated = true;
       return false;</div></div>
} else if (mode == 1) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleregularscatteringeventformediumsample-0">Handle regular scattering event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1989" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1989"><i></i></a><div id="fragbit-1989" class="collapse"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1990" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1990"><i></i></a><div id="fragbit-1990" class="collapse"><div class="fragmentcode">          if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
              terminated = true;
              return false;
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionformediumscatteringevent-0">Sample phase function for medium scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1991" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1991"><i></i></a><div id="fragbit-1991" class="collapse"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(), rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;()};
          pstd::optional&lt;PhaseFunctionSample&gt; ps = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
          if (!ps) {
              terminated = true;
              return false;
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatestateforrecursiveevaluationofL_romani-0">Update state for recursive evaluation of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1992" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1992"><i></i></a><div id="fragbit-1992" class="collapse"><div class="fragmentcode">          beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
          ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
          ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
          scattered = true;
          return false;</div></div></div></div>
} else {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenull-scatteringeventformediumsample-0">Handle null-scattering event for medium sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1993" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1993"><i></i></a><div id="fragbit-1993" class="collapse"><div class="fragmentcode">       uMode = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;();
       return true;</div></div>
}</div><p>


</p>
<p>If absorption is chosen, the path terminates.  Any emission is added to the
radiance estimate, and evaluation of
Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:delta-tracking-path-estimator">14.19</a>) is complete. The
fragment therefore sets <tt>terminated</tt> to indicate that the path is
finished and returns <tt>false</tt> from the lambda function so that no further
samples are generated along the ray.

</p>
<p></p>
<span class="anchor" id="fragment-Handleabsorptioneventformediumsample-0"></span><div class="fragmentname">&lt;&lt;Handle absorption event for medium sample&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">L += beta * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>;
terminated = true;
return false;</div><p>


</p>
<p>For a scattering event, <tt>beta</tt> is updated according to the ratio of phase
function and its directional sampling probability from
Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:delta-tracking-path-estimator">14.19</a>).

</p>
<p></p>
<span class="anchor" id="fragment-Handleregularscatteringeventformediumsample-0"></span><div class="fragmentname">&lt;&lt;Handle regular scattering event for medium sample&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1994" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1994"><i></i></a><div id="fragbit-1994" class="collapse"><div class="fragmentcode">   if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
       terminated = true;
       return false;
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionformediumscatteringevent-0">Sample phase function for medium scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1995" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1995"><i></i></a><div id="fragbit-1995" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(), rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;()};
   pstd::optional&lt;PhaseFunctionSample&gt; ps = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
   if (!ps) {
       terminated = true;
       return false;
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatestateforrecursiveevaluationofL_romani-0">Update state for recursive evaluation of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1996" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1996"><i></i></a><div id="fragbit-1996" class="collapse"><div class="fragmentcode">   beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
   ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
   ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
   scattered = true;
   return false;</div></div></div><p>


</p>
<p>The counter for the number of scattering events is only incremented for
real-scattering events; we do not want the number of null-scattering events
to affect path termination.  If this scattering event causes the
limit to be reached, the path is terminated.

</p>
<p></p>
<span class="anchor" id="fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0"></span><div class="fragmentname">&lt;&lt;Stop path sampling if maximum depth has been reached&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
    terminated = true;
    return false;
}</div><p>


</p>
<p>If the path is not terminated, then a new direction is sampled from the
phase function&rsquo;s distribution.

</p>
<p></p>
<span class="anchor" id="fragment-Samplephasefunctionformediumscatteringevent-0"></span><div class="fragmentname">&lt;&lt;Sample phase function for medium scattering event&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(), rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;()};
pstd::optional&lt;PhaseFunctionSample&gt; ps = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
if (!ps) {
    terminated = true;
    return false;
}</div><p>


</p>
<p>Given a sampled direction, the <tt>beta</tt> factor must be updated.
Volumetric path-tracing
implementations often assume that the phase function sampling
distribution matches the phase function&rsquo;s actual distribution and dispense
with <tt>beta</tt> entirely since it is always equal to&nbsp;1.  This variation is worth pausing to consider: in
that case, emitted radiance at the end of the path is always returned,
unscaled.  All of the effect of transmittance, phase functions, and so forth
is entirely encapsulated in the distribution of how often
various terms are evaluated and in the distribution of scattered ray
directions.
<tt>pbrt</tt> does not impose the requirement on phase functions that their
importance sampling technique be perfect, though this is the case for the
Henyey&ndash;Greenstein phase function in <tt>pbrt</tt>.

</p>
<p>Be it with <tt>beta</tt> or without, there is no need to do any further work
along the current ray after a scattering event, so after
the following code updates the path state to account for
scattering, it too returns <tt>false</tt> to direct that no further
samples should be taken along the ray.

</p>
<p></p>
<span class="anchor" id="fragment-UpdatestateforrecursiveevaluationofL_romani-0"></span><div class="fragmentname">&lt;&lt;Update state for recursive evaluation of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
scattered = true;
return false;</div><p>


</p>
<p>Null-scattering events are ignored, so there is nothing to do but to return
<tt>true</tt> to indicate that additional samples along the
current ray should be taken.  Similar to the real-scattering case, this can be
interpreted as starting a recursive evaluation of
Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:eot-null">14.3</a>) from the current sampled position without
incurring the
overhead of actually doing so.  Since this is the only case that may lead
to another invocation of the lambda function, <tt>uMode</tt> must be
refreshed with a new uniform sample value in case another sample is
generated.

</p>
<p></p>
<span class="anchor" id="fragment-Handlenull-scatteringeventformediumsample-0"></span><div class="fragmentname">&lt;&lt;Handle null-scattering event for medium sample&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">uMode = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;();
return true;</div><p>


</p>
<p>

</p>
<p>If the path was terminated due to absorption,
then there is no more work to do in the <tt>Li()</tt>
method; the final
radiance value can be returned.  Further, if the ray was scattered, then
there is nothing more to do but to restart the <tt>while</tt> loop and start
sampling the scattered ray.  Otherwise, the ray either underwent no
scattering events or only underwent null scattering.

</p>
<p></p>
<span class="anchor" id="fragment-Handleterminatedandunscatteredraysaftermediumsampling-0"></span><div class="fragmentname">&lt;&lt;Handle terminated and unscattered rays after medium sampling&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (terminated) return L;
if (scattered) continue;
&lt;&lt;<span class="fragmentname"><a href="#fragment-Addemissiontosurvivingray-0">Add emission to surviving ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1997" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1997"><i></i></a><div id="fragbit-1997" class="collapse"><div class="fragmentcode">   if (si)
       L += beta * si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, lambda);
   else {
       for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>)
           L += beta * light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda);
       return L;
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Handlesurfaceintersectionalongraypath-0">Handle surface intersection along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1998" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1998"><i></i></a><div id="fragbit-1998" class="collapse"><div class="fragmentcode">   <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, buf, sampler);
   if (!bsdf)
       si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
   else {
       &lt;&lt;<span class="fragmentname">Report error if BSDF returns a valid sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1999" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1999"><i></i></a><div id="fragbit-1999" class="collapse"><div class="fragmentcode">          Float uc = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
          <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
          if (bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, uc, u))
              <a href="../Utilities/User_Interaction.html#ErrorExit" class="code">ErrorExit</a>("SimpleVolPathIntegrator doesn't support surface scattering.");
          else
              break;</div></div>
   }</div></div></div><p>


</p>
<p>If the ray is unscattered and unabsorbed, then any emitters it interacts
with contribute radiance to the path.  Either surface emission or emission
from infinite light sources is accounted for, depending on whether an
intersection with a surface was found.  Further, if the ray did not
intersect a surface, then the path is finished and the radiance estimate
can be returned.

</p>
<p></p>
<span class="anchor" id="fragment-Addemissiontosurvivingray-0"></span><div class="fragmentname">&lt;&lt;Add emission to surviving ray&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (si)
    L += beta * si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, lambda);
else {
    for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>)
        L += beta * light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda);
    return L;
}</div><p>


</p>
<p>It is still necessary to consider surface intersections, even if scattering
from them is not handled by this integrator.  There are three cases to consider:
</p>
<ul>
<li> If the surface has no BSDF, it represents a transition between different
types of participating media.  A call to <tt>SkipIntersection()</tt> moves
the ray past the intersection and updates its medium appropriately.
<li> If there is a valid <tt>BSDF</tt> and that <tt>BDSF</tt> also returns a valid
sample from <tt>Sample_f()</tt>, then we have a BSDF that scatters; an error
is issued and rendering stops.
<li> A valid but zero-valued BSDF is allowed; such a BSDF should be
assigned to area light sources in scenes to be rendered using this
integrator.
</ul><p>


</p>
<p></p>
<span class="anchor" id="fragment-Handlesurfaceintersectionalongraypath-0"></span><div class="fragmentname">&lt;&lt;Handle surface intersection along ray path&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, buf, sampler);
if (!bsdf)
    si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
else {
    &lt;&lt;<span class="fragmentname">Report error if BSDF returns a valid sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2000" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2000"><i></i></a><div id="fragbit-2000" class="collapse"><div class="fragmentcode">       Float uc = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
       <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
       if (bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, uc, u))
           <a href="../Utilities/User_Interaction.html#ErrorExit" class="code">ErrorExit</a>("SimpleVolPathIntegrator doesn't support surface scattering.");
       else
           break;</div></div>
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p>
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#ImprovingtheSamplingTechniques"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:volpath-improving-sampling"></span><span id="ImprovingtheSamplingTechniques"></span><h3>14.2.2  Improving the Sampling Techniques<button data-toggle="tooltip" data-placement="right" class="btn difficult-button"
title="This section contains advanced content and may be skipped on a first reading.">
<i class="fas fa-exclamation-triangle midredtext"></i></button>
</h3><p>



</p>
<p>The <tt>VolPathIntegrator</tt>
adds three significant improvements to the approach
implemented in <a href="#SimpleVolPathIntegrator"><tt>SimpleVolPathIntegrator</tt></a>: it supports scattering from surfaces
as well as from volumes; it
handles spectrally varying medium scattering properties without falling
back to sampling a single wavelength; 
and it samples lights directly, using multiple
importance sampling to reduce variance when doing so.  
The first improvement&mdash;including surface scattering&mdash;is mostly a matter
of applying the ideas of
Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:volpath-surf-vol-simple-estimator">14.7</a>), sampling distances
in volumes but then choosing surface scattering if the sampled distance is
past the closest intersection.  For the other two, we will here discuss
the underlying foundations before turning to their implementation.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x2-ChromaticMedia"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x2-ChromaticMedia"></span><h4>Chromatic Media</h4><p>


</p>
<p>We have thus far glossed over some of the implications of spectrally varying medium
properties.  Because <tt>pbrt</tt> uses point-sampled spectra, they introduce no
complications in terms of evaluating things
like the modified path throughput <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.957ex" height="3.343ex" style="vertical-align: -0.838ex;" viewBox="0 -1078.4 2564.6 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove upper T With caret left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="704" y="0"></use>
<g transform="translate(1094,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2175" y="0"></use>
</g>
</svg> or the path throughput
weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.655ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2434.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="574" y="0"></use>
<g transform="translate(964,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2045" y="0"></use>
</g>
</svg>: given a set of path
vertices, such quantities can be evaluated for all the wavelength
samples simultaneously using the <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum"><tt>SampledSpectrum</tt></a> class.

</p>
<p>The problem with spectrally varying medium properties comes from sampling.
Consider a wavelength-dependent function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.469ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2354.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript lamda Baseline left-parenthesis x right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="693" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1003" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1392" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1965" y="0"></use>
</g>
</svg> that we would like
to integrate at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
</g>
</svg> wavelengths <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.155ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 927.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">lamda Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="825" y="-213"></use>
</g>
</svg>.  
If we draw samples <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.608ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 3275.7 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x tilde p Subscript lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-223C" d="M717 354c-4 -116 -34 -183 -119 -211c-15 -4 -30 -7 -45 -7c-66 0 -130 46 -184 95c-44 39 -93 81 -146 81c-10 0 -21 -1 -31 -5c-70 -23 -109 -67 -112 -161c0 -7 -6 -12 -12 -12c-7 0 -12 5 -12 12c4 116 34 183 120 211c14 4 29 7 44 7c66 0 130 -46 184 -95 c44 -39 93 -81 146 -81c11 0 21 1 32 5c69 23 108 67 111 161c0 7 6 12 12 12c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-223C" x="850" y="0"></use>
<g transform="translate(1901,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</svg> from a wavelength-dependent
PDF based on the first wavelength and then evaluate <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.283ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 552.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
</svg> at all the
wavelengths, we have the estimators
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="27.245ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 11730.5 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartFraction left-bracket f Subscript lamda 1 Baseline left-parenthesis x right-parenthesis comma f Subscript lamda 2 Baseline left-parenthesis x right-parenthesis comma ellipsis comma f Subscript lamda Sub Subscript n Subscript Baseline left-parenthesis x right-parenthesis right-bracket Over p Subscript lamda 1 Baseline left-parenthesis x right-parenthesis EndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(120,0)">
<rect stroke="none" width="11211" height="60" x="0" y="220"></rect>
<g transform="translate(60,809)">
 <use xlink:href="#E1-LATINMODERNMAIN-5B"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="2029" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2601" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2991" y="0"></use>
<g transform="translate(3436,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4797" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="5186" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5759" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6148" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="6594" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7598" y="0"></use>
<g transform="translate(8043,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="718" y="-185"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="9461" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="9851" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10423" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="10813" y="0"></use>
</g>
<g transform="translate(4243,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1374" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1763" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2336" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="11451" y="0"></use>
</g>
</svg>
</div>
<p>

Even if the PDF <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.265ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1405.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</svg> that was used for sampling matches
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.161ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1361.1 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</svg> well, it may be a
poor match for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.283ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 552.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
</svg> at the other wavelengths.  It may not
even be a valid PDF for them, if it is zero-valued where the function is
nonzero.  However, falling back to integrating a single wavelength at a
time would be unfortunately inefficient, as shown in
Section&nbsp;<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#sec:sampled-spectral-distributions">4.5.4</a>.

</p>
<p>This problem of a single sampling PDF possibly mismatched with
a wavelength-dependent function comes
up repeatedly in volumetric path tracing.  For example,
sampling the majorant transmittance at one wavelength may be a poor
approach for sampling it at others.  That could be handled by
selecting a majorant that bounds all wavelengths&rsquo; extinction coefficients,
but such a majorant would lead to many null-scattering events at
wavelengths that could have used a much lower majorant, which would harm
performance.

</p>
<p>The path tracer&rsquo;s choice among absorption, real scattering, and null
scattering at a sampled point cannot be
sidestepped in a similar way: different wavelengths may have quite
different probabilities for each of these types of medium interaction, yet with
path tracing the
integrator must choose only one of them.  Splitting up the computation to
let each wavelength choose individually would be nearly as inefficient as only
considering a single wavelength at a time.

</p>
<p>However, if a single type of interaction is chosen based on a single wavelength and we
evaluate the modified path contribution function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.752ex" height="2.843ex" style="vertical-align: -0.338ex;" viewBox="0 -1078.4 754.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove upper P With caret</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D443" d="M754 532c0 -112 -139 -216 -281 -216h-170l-62 -250c-1 -6 -3 -11 -3 -17c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -20 -20c-21 0 -43 2 -65 2l-64 1l-127 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l134 537c3 12 4 15 4 19 c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h324c131 0 197 -74 197 -151zM661 556c0 69 -53 96 -136 96h-96c-43 0 -45 -3 -54 -38l-68 -272h141c44 0 104 8 154 53c39 36 59 122 59 161Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D443" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="672" y="205"></use>
</g>
</svg> for all
wavelengths, we could have arbitrarily high variance in the other wavelengths.
To see why, note how all the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.223ex" height="2.509ex" style="vertical-align: -1.171ex;" viewBox="0 -576.1 2248.7 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript StartSet normal s comma normal n EndSet</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7B" d="M425 -238c0 -7 -5 -12 -12 -12c-105 0 -196 52 -196 125v250c0 58 -55 113 -130 113c-7 0 -12 5 -12 12s5 12 12 12c75 0 130 55 130 113v250c0 73 91 125 196 125c7 0 12 -5 12 -12s-5 -12 -12 -12c-75 0 -130 -49 -130 -101v-250c0 -58 -48 -104 -115 -125 c67 -21 115 -67 115 -125v-250c0 -52 55 -101 130 -101c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7D" d="M425 250c0 -7 -5 -12 -12 -12c-75 0 -130 -55 -130 -113v-250c0 -73 -91 -125 -196 -125c-7 0 -12 5 -12 12s5 12 12 12c75 0 130 49 130 101v250c0 58 48 104 115 125c-67 21 -115 67 -115 125v250c0 52 -55 101 -130 101c-7 0 -12 5 -12 12s5 12 12 12 c105 0 196 -52 196 -125v-250c0 -58 55 -113 130 -113c7 0 12 -5 12 -12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-187)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-7B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="894" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="1173" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-7D" x="1730" y="0"></use>
</g>
</g>
</svg> factors that came from
the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.106ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2629.1 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal e Baseline left-parenthesis normal p Subscript Baseline Subscript i Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="917" y="0"></use>
<g transform="translate(1307,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2208" y="0"></use>
</g>
</svg> factors in
Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:delta-tracking-wip2">14.18</a>) canceled out to give the
delta-tracking estimator, Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:delta-tracking-path-estimator">14.19</a>).  In
the spectral case, if, for example, real scattering is chosen based on a
wavelength <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.355ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 583.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">lamda</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
</g>
</svg>&rsquo;s scattering coefficient <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg> and if a wavelength
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.257ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 971.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">lamda prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="825" y="513"></use>
</g>
</svg> has scattering coefficient <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.229ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 959.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma prime Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="808" y="392"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-217"></use>
</g>
</svg>, then the final estimator
for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.257ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 971.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">lamda prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="825" y="513"></use>
</g>
</svg> will include a factor of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.599ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2410.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma prime Subscript normal s Baseline slash sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="808" y="392"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-217"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="959" y="0"></use>
<g transform="translate(1460,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</g>
</svg> that can be
arbitrarily large.

</p>
<p>The fact that <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj"><tt>SampleT_maj()</tt></a> nevertheless samples according to a single
wavelength&rsquo;s majorant transmittance suggests that there is a solution to
this problem.  That solution, yet again, is multiple importance sampling.
In this case, we are using a single sampling technique rather than
MIS-weighting multiple techniques, so we use the single-sample MIS
estimator from Equation&nbsp;(<a href="../Monte_Carlo_Integration/Improving_Efficiency.html#eq:mis-single-sample-estimator">2.16</a>), which here gives
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="34.906ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 15029.1 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartFraction w Subscript lamda 1 Baseline left-parenthesis x right-parenthesis Over q EndFraction StartFraction left-bracket f Subscript lamda 1 Baseline left-parenthesis x right-parenthesis comma f Subscript lamda 2 Baseline left-parenthesis x right-parenthesis comma ellipsis comma f Subscript lamda Sub Subscript n Subscript Baseline left-parenthesis x right-parenthesis right-bracket Over p Subscript lamda 1 Baseline left-parenthesis x right-parenthesis EndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(120,0)">
<rect stroke="none" width="3058" height="60" x="0" y="220"></rect>
<g transform="translate(60,809)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
<g transform="translate(716,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1587" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1976" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2549" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="1303" y="-686"></use>
</g>
<g transform="translate(3298,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="11211" height="60" x="0" y="220"></rect>
<g transform="translate(60,809)">
 <use xlink:href="#E1-LATINMODERNMAIN-5B"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="2029" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2601" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2991" y="0"></use>
<g transform="translate(3436,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4797" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="5186" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5759" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6148" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="6594" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7598" y="0"></use>
<g transform="translate(8043,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="718" y="-185"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="9461" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="9851" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10423" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="10813" y="0"></use>
</g>
<g transform="translate(4243,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1374" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1763" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2336" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="14750" y="0"></use>
</g>
</svg>
</div>
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.051ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 452.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">q</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
</g>
</svg> is the discrete probability of sampling using the wavelength <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.409ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1037.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="825" y="-213"></use>
</g>
</svg>,
here uniform at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.72ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 1601.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1001" y="0"></use>
</g>
</svg> with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
</g>
</svg> the number of spectral samples.

</p>
<p>The balance heuristic is optimal for single-sample MIS. It gives the MIS
weight
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="21.59ex" height="6.676ex" style="vertical-align: -2.838ex;" viewBox="0 -1652.5 9295.6 2874.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript lamda 1 Baseline left-parenthesis x right-parenthesis equals StartFraction p Subscript lamda 1 Baseline left-parenthesis x right-parenthesis Over sigma-summation Underscript i Overscript n Endscripts p Subscript lamda Sub Subscript i Subscript Baseline left-parenthesis x right-parenthesis EndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNOPERATORS-2211" d="M999 -1l-86 -249h-829c-18 0 -27 0 -27 11c0 4 1 6 9 16l355 439l-365 502c0 31 1 32 28 32h829l86 -234h-25c-70 187 -300 194 -414 194h-396l325 -446c6 -9 7 -10 7 -14s-2 -7 -9 -16l-347 -429h425c147 0 216 24 232 29c85 29 152 90 177 165h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
<g transform="translate(716,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1587" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1976" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2549" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3216" y="0"></use>
<g transform="translate(3994,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="4504" height="60" x="0" y="220"></rect>
<g transform="translate(889,809)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1374" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1763" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2336" y="0"></use>
</g>
<g transform="translate(60,-811)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1494" y="675"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
<g transform="translate(1747,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="3032" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="3422" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3994" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="9017" y="0"></use>
</g>
</svg>
</div>
<p>

which gives the estimator
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:spectral-mis-estimator"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="74.816ex" height="7.009ex" style="vertical-align: -3.171ex;" viewBox="0 -1652.5 32212.2 3017.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartStartFraction p Subscript lamda 1 Baseline left-parenthesis x right-parenthesis OverOver StartFraction 1 Over n EndFraction sigma-summation Underscript i Overscript n Endscripts p Subscript lamda Sub Subscript i Subscript Baseline left-parenthesis x right-parenthesis EndEndFraction StartFraction left-bracket f Subscript lamda 1 Baseline left-parenthesis x right-parenthesis comma f Subscript lamda 2 Baseline left-parenthesis x right-parenthesis comma ellipsis comma f Subscript lamda Sub Subscript n Subscript Baseline left-parenthesis x right-parenthesis right-bracket Over p Subscript lamda 1 Baseline left-parenthesis x right-parenthesis EndFraction equals StartStartFraction left-bracket f Subscript lamda 1 Baseline left-parenthesis x right-parenthesis comma f Subscript lamda 2 Baseline left-parenthesis x right-parenthesis comma ellipsis comma f Subscript lamda Sub Subscript n Subscript Baseline left-parenthesis x right-parenthesis right-bracket OverOver StartFraction 1 Over n EndFraction sigma-summation Underscript i Overscript n Endscripts p Subscript lamda Sub Subscript i Subscript Baseline left-parenthesis x right-parenthesis EndEndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNOPERATORS-2211" d="M999 -1l-86 -249h-829c-18 0 -27 0 -27 11c0 4 1 6 9 16l355 439l-365 502c0 31 1 32 28 32h829l86 -234h-25c-70 187 -300 194 -414 194h-396l325 -446c6 -9 7 -10 7 -14s-2 -7 -9 -16l-347 -429h425c147 0 216 24 232 29c85 29 152 90 177 165h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2026" d="M193 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM472 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM751 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(120,0)">
<rect stroke="none" width="5455" height="60" x="0" y="220"></rect>
<g transform="translate(1365,809)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1374" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1763" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2336" y="0"></use>
</g>
<g transform="translate(60,-937)">
<g transform="translate(120,0)">
<rect stroke="none" width="544" height="60" x="0" y="220"></rect>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="134" y="629"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="84" y="-488"></use>
</g>
<g transform="translate(951,0)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1494" y="675"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
</g>
<g transform="translate(2699,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="3984" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="4373" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4946" y="0"></use>
</g>
</g>
<g transform="translate(5695,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="11211" height="60" x="0" y="220"></rect>
<g transform="translate(60,809)">
 <use xlink:href="#E1-LATINMODERNMAIN-5B"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="2029" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2601" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2991" y="0"></use>
<g transform="translate(3436,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4797" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="5186" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5759" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6148" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="6594" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7598" y="0"></use>
<g transform="translate(8043,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="718" y="-185"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="9461" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="9851" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10423" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="10813" y="0"></use>
</g>
<g transform="translate(4243,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1374" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="1763" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2336" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="17425" y="0"></use>
<g transform="translate(18203,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="11211" height="60" x="0" y="220"></rect>
<g transform="translate(60,809)">
 <use xlink:href="#E1-LATINMODERNMAIN-5B"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1639" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="2029" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2601" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2991" y="0"></use>
<g transform="translate(3436,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4797" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="5186" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5759" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="6148" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2026" x="6594" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7598" y="0"></use>
<g transform="translate(8043,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="718" y="-185"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="9461" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="9851" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10423" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="10813" y="0"></use>
</g>
<g transform="translate(2938,-937)">
<g transform="translate(120,0)">
<rect stroke="none" width="544" height="60" x="0" y="220"></rect>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="134" y="629"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="84" y="-488"></use>
</g>
<g transform="translate(951,0)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1494" y="675"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
</g>
<g transform="translate(2699,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="3984" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="4373" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4946" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="29933" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:spectral-mis-estimator">14.20</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

See Figure&nbsp;<a href="#fig:volumetric-chromatic">14.7</a> for an example
that shows the benefits of MIS for chromatic media.

</p>
<p>
</p>
<span class="anchor" id="fig:volumetric-chromatic"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 46.250%;  position:relative;">
<div id="xa_Without_spectral_MIS59" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_Without_spectral_MIS59'), {
  title: '(a)_Without_spectral_MIS59', children: [
 { title: '(a) Without spectral MIS', image: 'chromatic-media-nomis.exr' },  { title: '(b) With spectral MIS', image: 'chromatic-media-mis.exr' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 14.7: Chromatic Volumetric Media. <span class="legend">
(a)&nbsp;When rendered without spectral MIS, variance is high.
(b)&nbsp;Results are much better with spectral MIS, as implemented in the
<a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a>.  For this scene, MSE is reduced by a
factor of 149.
<em>(Scene courtesty of Jim Price.)</em>
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x2-DirectLighting"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x2-DirectLighting"></span><h4>Direct Lighting</h4><p>


</p>
<p>Multiple importance sampling is also at the heart of how the
<a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a> samples direct
illumination.  As with the <a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>, we would like to combine
the strategies of sampling the light sources with sampling the BSDF or
phase function to find light-carrying paths and
then to weight the contributions of each sampling technique using MIS.
Doing so is more complex than it is in the absence of volumetric
scattering, however, because not only does the sampling distribution used
at the last path vertex differ (as before) but the <a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a>
also uses ratio
tracking to estimate the transmittance along the shadow ray.  That is a
different distance sampling technique than the delta-tracking approach used when
sampling ray paths, and so it leads to a different path PDF.

</p>
<p>In the following, we will say that the two path-sampling techniques used in
the <a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a> are <em>unidirectional path sampling</em> and
<em>light path sampling</em>; we will write their respective path PDFs as
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.389ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1028.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="712" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.932ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 831.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="712" y="-213"></use>
</g>
</svg>.  The first corresponds to the sampling
approach from Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#sec:evaluating-volumetric-path-integral">14.1.5</a>, with
delta tracking used to find real-scattering vertices and with the phase function
or BSDF sampled to find the new direction at each vertex.  Light path
sampling follows the same approach up to the last real-scattering vertex

before the light vertex; there, the light selects the direction and then
ratio tracking gives the transmittance along the last path segment. (See
Figure&nbsp;<a href="#fig:volpath-directlighting-mis-context">14.8</a>.)
Given a path <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.612ex" height="2.676ex" style="vertical-align: -1.005ex;" viewBox="0 -719.6 1985.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline overbar Subscript n minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
</svg>, both approaches share the same path
throughput weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> up to the vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.612ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1985.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript n minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
</svg> and the same


path PDF up to that vertex, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.81ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3793 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n minus 1 Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="997" y="0"></use>
<g transform="translate(1386,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3372" y="0"></use>
</g>
</svg>.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="Strictly speaking,
two such paths ending at the same point on a light may have a different
number of vertices due to different numbers of null-scattering vertices
along the last segment.  To simplify notation, we will here describe both
as <i>n</i> vertex paths with p<sub><i>n</i></sub> the point on the light and p<sub><i>n-1</i></sub>
the scattering vertex immediately before it; we will index
intermediate vertices on the last segment independently.">
      <sup>&dagger;</sup>
    </button>
		  


</p>
<p></p>
<span class="anchor" id="fig:volpath-directlighting-mis-context"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha14f08.svg" title=""><img src="pha14f08.svg" width=577 height=169 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.8: <span class="legend">
In the direct lighting calculation, at each path vertex a point is sampled
on a light source and a shadow ray (dotted line) is traced. The
<a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a> uses ratio tracking to compute the transmittance
along the ray by accumulating the product <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.89ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 3397 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal n Baseline slash sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="1065" y="0"></use>
<g transform="translate(1565,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</svg> at sampled
points along the ray (open circles).  For the MIS weight, it is necessary
to be able not only to compute the PDF for sampling the corresponding direction at
the last path vertex but also to compute the probability of
generating these samples using delta tracking, since that is how the path
would be sampled with unidirectional path sampling.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>For the full PDF for unidirectional path sampling, at the last scattering
vertex we have the probability of scattering,
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.045ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 6047 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s Baseline left-parenthesis normal p Subscript Baseline Subscript n minus 1 Baseline right-parenthesis slash sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="950" y="0"></use>
<g transform="translate(1339,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3325" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="3714" y="0"></use>
<g transform="translate(4215,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</svg> times the directional probability for
sampling the new direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.971ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3001.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript omega Sub Subscript Baseline left-parenthesis omega Subscript Baseline Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D714" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1043" y="0"></use>
<g transform="translate(1433,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2580" y="0"></use>
</g>
</svg>, which is given by the sampling
strategy used for the BSDF or phase function.  Then, for the path to find an
emitter at the vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.511ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 1081.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
</svg>, it must have only sampled null-scattering
vertices between <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.612ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1985.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript n minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.511ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 1081.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
</svg>; absorption or
a real-scattering vertex preclude making it to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.511ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 1081.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
</svg>.

</p>
<p>Using the results from
Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#sec:evaluating-volumetric-path-integral">14.1.5</a>, we can find that the
path PDF between two points <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.092ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 900.8 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="787" y="-326"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.202ex" height="2.509ex" style="vertical-align: -1.171ex;" viewBox="0 -576.1 948.2 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="787" y="-326"></use>
</g>
</svg> with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.04ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 878.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">m</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45A" d="M848 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 4 31 13 55c20 53 62 167 62 224c0 36 -11 70 -54 70c-109 0 -162 -120 -165 -133l-60 -241c-8 -32 -14 -57 -45 -57c-15 0 -29 9 -29 27c0 5 9 39 13 59c9 33 10 39 20 76l28 116c8 30 15 58 15 83 c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84c0 38 -15 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23 c0 0 -12 0 -12 10c0 3 13 62 31 97c9 18 28 57 74 57c45 0 87 -30 92 -87c17 23 66 87 156 87c25 0 57 -5 82 -26c28 -24 31 -58 32 -71c37 53 88 97 163 97s115 -42 115 -107c0 -57 -42 -168 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="0" y="0"></use>
</g>
</svg> intermediate
null-scattering vertices indexed by <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.211ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 521.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">k</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D458" x="0" y="0"></use>
</g>
</svg> is given by the product of
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="38.499ex" height="10.176ex" style="vertical-align: -4.222ex; margin-bottom: -0.283ex;" viewBox="0 -2441.8 16575.7 4381.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column p Subscript normal e Baseline left-parenthesis normal p Subscript Baseline Subscript i plus k Baseline right-parenthesis 2nd Column equals StartFraction sigma Subscript normal n Baseline left-parenthesis normal p Subscript Baseline Subscript i plus k Baseline right-parenthesis Over sigma Subscript normal m normal a normal j Baseline EndFraction and 2nd Row 1st Column p Subscript normal m normal a normal j Baseline left-parenthesis normal p Subscript Baseline Subscript i plus k Baseline right-parenthesis 2nd Column equals sigma Subscript normal m normal a normal j Baseline upper T Subscript normal m normal a normal j Baseline left-parenthesis normal p Subscript Baseline Subscript i plus k minus 1 Baseline right-arrow normal p Subscript Baseline Subscript i plus k Baseline right-parenthesis EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(-11,0)">
<g transform="translate(845,759)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="917" y="0"></use>
<g transform="translate(1307,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3127" y="0"></use>
</g>
<g transform="translate(0,-1523)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1763" y="0"></use>
<g transform="translate(2153,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3973" y="0"></use>
</g>
</g>
<g transform="translate(4629,0)">
<g transform="translate(0,759)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(778,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3784" height="60" x="0" y="220"></rect>
<g transform="translate(60,809)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1065" y="0"></use>
<g transform="translate(1454,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3274" y="0"></use>
</g>
<g transform="translate(976,-686)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</g>
<g transform="translate(5413,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-61"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="1057" y="0"></use>
</g>
</g>
<g transform="translate(0,-1523)">
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(1056,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
<g transform="translate(2887,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4732" y="0"></use>
<g transform="translate(5121,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="1645" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="2424" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="8124" y="0"></use>
<g transform="translate(9402,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="11222" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>

for all null-scattering vertices.
The <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.254ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1831.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg> factors cancel and the null-scattering path probability&nbsp;is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="68.794ex" height="7.509ex" style="vertical-align: -3.171ex; margin-left: -0.073ex;" viewBox="-31.5 -1867.7 29619.4 3233.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal n normal u normal l normal l Baseline left-parenthesis normal p Subscript Baseline Subscript i Baseline comma normal p Subscript Baseline Subscript j Baseline right-parenthesis equals left-parenthesis product Underscript k equals 1 Overscript m Endscripts sigma Subscript normal n Baseline left-parenthesis normal p Subscript Baseline Subscript i plus k Baseline right-parenthesis upper T Subscript normal m normal a normal j Baseline left-parenthesis normal p Subscript Baseline Subscript i plus k minus 1 Baseline right-arrow normal p Subscript Baseline Subscript i plus k Baseline right-parenthesis right-parenthesis upper T Subscript normal m normal a normal j Baseline left-parenthesis normal p Subscript Baseline Subscript i plus m Baseline right-arrow normal p Subscript Baseline Subscript j Baseline right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-220F" d="M1221 -450h-481v54c132 0 164 45 164 110v1182h-531v-1182c0 -64 31 -110 164 -110v-54h-481v54c132 0 164 45 164 110v1072c0 64 -31 110 -164 110v54h1165v-54c-132 0 -164 -45 -164 -110v-1072c0 -64 31 -110 164 -110v-54Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45A" d="M848 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 4 31 13 55c20 53 62 167 62 224c0 36 -11 70 -54 70c-109 0 -162 -120 -165 -133l-60 -241c-8 -32 -14 -57 -45 -57c-15 0 -29 9 -29 27c0 5 9 39 13 59c9 33 10 39 20 76l28 116c8 30 15 58 15 83 c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84c0 38 -15 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23 c0 0 -12 0 -12 10c0 3 13 62 31 97c9 18 28 57 74 57c45 0 87 -30 92 -87c17 23 66 87 156 87c25 0 57 -5 82 -26c28 -24 31 -58 32 -71c37 53 88 97 163 97s115 -42 115 -107c0 -57 -42 -168 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-28" d="M823 -1224c0 -11 -10 -21 -21 -21c-5 0 -9 2 -12 4c-268 202 -513 751 -513 1241v500c0 490 245 1039 513 1241c3 2 7 4 12 4c11 0 21 -10 21 -21c0 -7 -3 -13 -9 -17c-255 -192 -435 -739 -435 -1207v-500c0 -468 180 -1015 435 -1207c6 -4 9 -10 9 -17Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-29" d="M598 0c0 -490 -245 -1039 -513 -1241c-3 -2 -7 -4 -12 -4c-11 0 -21 10 -21 21c0 7 3 13 9 17c255 192 435 739 435 1207v500c0 468 -180 1015 -435 1207c-6 4 -9 10 -9 17c0 11 10 21 21 21c5 0 9 -2 12 -4c268 -202 513 -751 513 -1241v-500Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1113" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1391" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1784" y="0"></use>
<g transform="translate(2173,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3074" y="0"></use>
<g transform="translate(3519,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4468" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="5135" y="0"></use>
<g transform="translate(6191,0)">
 <use xlink:href="#E1-LATINMODERNSIZE7-28"></use>
<g transform="translate(875,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-220F" x="0" y="0"></use>
<g transform="translate(2,-1110)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="521" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1300" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="464" y="1627"></use>
</g>
<g transform="translate(2320,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="808" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="3385" y="0"></use>
<g transform="translate(3775,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5595" y="0"></use>
<g transform="translate(6151,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="7995" y="0"></use>
<g transform="translate(8385,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="1645" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="2424" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="11387" y="0"></use>
<g transform="translate(12665,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="14485" y="0"></use>
 <use xlink:href="#E1-LATINMODERNSIZE7-29" x="14875" y="0"></use>
</g>
<g transform="translate(22109,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="23953" y="0"></use>
<g transform="translate(24343,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="26693" y="0"></use>
<g transform="translate(27971,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="28919" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="29309" y="0"></use>
</g>
</svg>
</div>
<p>


</p>
<p>The full unidirectional path probability is then given by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:volpath-unidir-path-probability"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="50.437ex" height="6.343ex" style="vertical-align: -2.505ex; margin-left: -0.073ex;" viewBox="-31.5 -1652.5 21715.9 2730.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis equals p Subscript normal u Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n minus 1 Baseline right-parenthesis StartFraction sigma Subscript normal s Baseline left-parenthesis normal p Subscript Baseline Subscript n minus 1 Baseline right-parenthesis Over sigma Subscript normal m normal a normal j Baseline EndFraction p Subscript omega Baseline left-parenthesis omega Subscript Baseline Subscript n Baseline right-parenthesis p Subscript normal n normal u normal l normal l Baseline left-parenthesis normal p Subscript Baseline Subscript n minus 1 Baseline comma normal p Subscript Baseline Subscript n Baseline right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="997" y="0"></use>
<g transform="translate(1386,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2467" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3134" y="0"></use>
<g transform="translate(4191,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="712" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5188" y="0"></use>
<g transform="translate(5577,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7563" y="0"></use>
<g transform="translate(8119,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="3834" height="60" x="0" y="220"></rect>
<g transform="translate(60,809)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="950" y="0"></use>
<g transform="translate(1339,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3325" y="0"></use>
</g>
<g transform="translate(1001,-686)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</g>
<g transform="translate(12194,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D714" x="712" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13237" y="0"></use>
<g transform="translate(13627,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="14774" y="0"></use>
<g transform="translate(15330,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1113" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1391" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="17115" y="0"></use>
<g transform="translate(17504,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="19490" y="0"></use>
<g transform="translate(19935,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="21016" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="21405" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:volpath-unidir-path-probability">14.21</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>


</p>
<p>For light sampling, we again have the discrete probability
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.045ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 6047 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s Baseline left-parenthesis normal p Subscript Baseline Subscript n minus 1 Baseline right-parenthesis slash sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="950" y="0"></use>
<g transform="translate(1339,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3325" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="3714" y="0"></use>
<g transform="translate(4215,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</svg> for scattering at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.612ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1985.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript n minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
</svg> but the
directional PDF at the vertex is determined by the light&rsquo;s sampling
distribution, which we will denote by <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.886ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3395.2 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal l comma omega Baseline left-parenthesis omega Subscript Baseline Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D714" x="557" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1437" y="0"></use>
<g transform="translate(1827,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2974" y="0"></use>
</g>
</svg>.  The
only missing piece is the PDF of the last segment (the shadow ray),
where ratio tracking is used.  In that case, points are sampled according to
the majorant transmittance and so the PDF for a path sampled between points
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.092ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 900.8 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="787" y="-326"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.202ex" height="2.509ex" style="vertical-align: -1.171ex;" viewBox="0 -576.1 948.2 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline Subscript j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="787" y="-326"></use>
</g>
</svg> with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.04ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 878.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">m</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45A" d="M848 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 4 31 13 55c20 53 62 167 62 224c0 36 -11 70 -54 70c-109 0 -162 -120 -165 -133l-60 -241c-8 -32 -14 -57 -45 -57c-15 0 -29 9 -29 27c0 5 9 39 13 59c9 33 10 39 20 76l28 116c8 30 15 58 15 83 c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84c0 38 -15 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23 c0 0 -12 0 -12 10c0 3 13 62 31 97c9 18 28 57 74 57c45 0 87 -30 92 -87c17 23 66 87 156 87c25 0 57 -5 82 -26c28 -24 31 -58 32 -71c37 53 88 97 163 97s115 -42 115 -107c0 -57 -42 -168 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="0" y="0"></use>
</g>
</svg> intermediate vertices is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:ratio-tracking-pdf"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="70.86ex" height="7.509ex" style="vertical-align: -3.171ex; margin-left: -0.073ex;" viewBox="-31.5 -1867.7 30508.9 3233.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r normal a normal t normal i normal o Baseline left-parenthesis normal p Subscript Baseline Subscript i Baseline comma normal p Subscript Baseline Subscript j Baseline right-parenthesis equals left-parenthesis product Underscript k equals 1 Overscript m Endscripts upper T Subscript normal m normal a normal j Baseline left-parenthesis normal p Subscript Baseline Subscript i plus k minus 1 Baseline right-arrow normal p Subscript Baseline Subscript i plus k Baseline right-parenthesis sigma Subscript normal m normal a normal j Baseline right-parenthesis comma upper T Subscript normal m normal a normal j Baseline left-parenthesis normal p Subscript Baseline Subscript i plus m Baseline right-arrow normal p Subscript Baseline Subscript j Baseline right-parenthesis comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-220F" d="M1221 -450h-481v54c132 0 164 45 164 110v1182h-531v-1182c0 -64 31 -110 164 -110v-54h-481v54c132 0 164 45 164 110v1072c0 64 -31 110 -164 110v54h1165v-54c-132 0 -164 -45 -164 -110v-1072c0 -64 31 -110 164 -110v-54Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D458" d="M508 379c0 -39 -29 -61 -55 -61c-27 0 -38 19 -38 35c0 12 9 51 57 54c-2 2 -2 3 -4 4c-8 6 -9 6 -21 8c-2 1 -3 1 -9 1c-49 0 -95 -43 -143 -96c-23 -24 -55 -56 -86 -74c85 -11 148 -40 148 -105c0 -10 0 -14 -4 -31c-4 -16 -8 -39 -8 -56c0 -36 13 -47 32 -47 c44 0 67 51 87 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -11 -57 -36 -101c-22 -37 -49 -53 -79 -53c-52 0 -92 40 -92 99c0 11 2 23 4 35c3 10 3 14 3 21c0 66 -82 82 -116 85c-6 -25 -51 -210 -56 -219c-6 -12 -21 -21 -34 -21c-9 0 -29 5 -29 28c0 6 0 8 4 22l145 576 l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 18 11 19 19 20c26 2 99 10 122 10c13 0 13 -11 13 -11l-104 -422c38 15 77 55 111 93c72 80 118 88 146 88c45 0 68 -33 68 -63Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45A" d="M848 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 4 31 13 55c20 53 62 167 62 224c0 36 -11 70 -54 70c-109 0 -162 -120 -165 -133l-60 -241c-8 -32 -14 -57 -45 -57c-15 0 -29 9 -29 27c0 5 9 39 13 59c9 33 10 39 20 76l28 116c8 30 15 58 15 83 c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84c0 38 -15 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23 c0 0 -12 0 -12 10c0 3 13 62 31 97c9 18 28 57 74 57c45 0 87 -30 92 -87c17 23 66 87 156 87c25 0 57 -5 82 -26c28 -24 31 -58 32 -71c37 53 88 97 163 97s115 -42 115 -107c0 -57 -42 -168 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-28" d="M823 -1224c0 -11 -10 -21 -21 -21c-5 0 -9 2 -12 4c-268 202 -513 751 -513 1241v500c0 490 245 1039 513 1241c3 2 7 4 12 4c11 0 21 -10 21 -21c0 -7 -3 -13 -9 -17c-255 -192 -435 -739 -435 -1207v-500c0 -468 180 -1015 435 -1207c6 -4 9 -10 9 -17Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-29" d="M598 0c0 -490 -245 -1039 -513 -1241c-3 -2 -7 -4 -12 -4c-11 0 -21 10 -21 21c0 7 3 13 9 17c255 192 435 739 435 1207v500c0 468 -180 1015 -435 1207c-6 4 -9 10 -9 17c0 11 10 21 21 21c5 0 9 -2 12 -4c268 -202 513 -751 513 -1241v-500Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="392" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="892" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="1282" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="1560" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2061" y="0"></use>
<g transform="translate(2450,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3351" y="0"></use>
<g transform="translate(3796,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4744" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="5412" y="0"></use>
<g transform="translate(6468,0)">
 <use xlink:href="#E1-LATINMODERNSIZE7-28"></use>
<g transform="translate(875,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-220F" x="0" y="0"></use>
<g transform="translate(2,-1110)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-3D" x="521" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1300" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="464" y="1627"></use>
</g>
<g transform="translate(2320,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4165" y="0"></use>
<g transform="translate(4554,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="1645" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="2424" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="7556" y="0"></use>
<g transform="translate(8835,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D458" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10655" y="0"></use>
<g transform="translate(11211,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE7-29" x="13042" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="20553" y="0"></use>
<g transform="translate(20998,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="22843" y="0"></use>
<g transform="translate(23232,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="25582" y="0"></use>
<g transform="translate(26861,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="27809" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="28198" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:ratio-tracking-pdf">14.22</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

and the full light sampling path PDF is given by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:volpath-light-path-probability"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="51.538ex" height="6.343ex" style="vertical-align: -2.505ex; margin-left: -0.073ex;" viewBox="-31.5 -1652.5 22190.1 2730.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal l Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis equals p Subscript normal u Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n minus 1 Baseline right-parenthesis StartFraction sigma Subscript normal s Baseline left-parenthesis normal p Subscript Baseline Subscript n minus 1 Baseline right-parenthesis Over sigma Subscript normal m normal a normal j Baseline EndFraction p Subscript normal l comma omega Baseline left-parenthesis omega Subscript Baseline Subscript n Baseline right-parenthesis p Subscript normal r normal a normal t normal i normal o Baseline left-parenthesis normal p Subscript Baseline Subscript n minus 1 Baseline comma normal p Subscript Baseline Subscript n Baseline right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="800" y="0"></use>
<g transform="translate(1189,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2271" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2938" y="0"></use>
<g transform="translate(3994,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="712" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4991" y="0"></use>
<g transform="translate(5381,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7366" y="0"></use>
<g transform="translate(7922,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="3834" height="60" x="0" y="220"></rect>
<g transform="translate(60,809)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="950" y="0"></use>
<g transform="translate(1339,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3325" y="0"></use>
</g>
<g transform="translate(1001,-686)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</g>
<g transform="translate(11997,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D714" x="557" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="13435" y="0"></use>
<g transform="translate(13824,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="14971" y="0"></use>
<g transform="translate(15528,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="392" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="892" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="1282" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="1560" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="17589" y="0"></use>
<g transform="translate(17978,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="19964" y="0"></use>
<g transform="translate(20409,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="21490" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="21880" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:volpath-light-path-probability">14.23</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>


</p>
<p>The <a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a> samples both types of paths according to the
first wavelength <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.409ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1037.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="825" y="-213"></use>
</g>
</svg> but evaluates these PDFs at all wavelengths so
that MIS over wavelengths can be used.  Given the path <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.511ex" height="2.509ex" style="vertical-align: -0.838ex;" viewBox="0 -719.6 1081.1 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline overbar Subscript n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
</svg> sampled
using unidirectional path sampling and then the path  sampled
using light path sampling, the two-sample MIS estimator is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:volpath-two-sample-mis-estimator"></span><div class="displaymath"></div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:volpath-two-sample-mis-estimator">14.24</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

Note that because the paths share the same vertices for all of
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.612ex" height="2.676ex" style="vertical-align: -1.005ex;" viewBox="0 -719.6 1985.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline overbar Subscript n minus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
</svg>, not only do the two <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.636ex" height="2.843ex" style="vertical-align: -0.338ex;" viewBox="0 -1078.4 704.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove upper T With caret</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
</g>
</svg> factors share common factors,
but <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.956ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3856.2 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u comma lamda 1 Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1964" y="0"></use>
<g transform="translate(2354,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3435" y="0"></use>
</g>
</svg> and
 do as well, following
Equations&nbsp;(<a href="#eq:volpath-unidir-path-probability">14.21</a>)
and&nbsp;(<a href="#eq:volpath-light-path-probability">14.23</a>).

</p>
<p>In this case, the MIS weights can account not only for the differences between
unidirectional and light path sampling but also for the different
per-wavelength probabilities for each sampling strategy.  For example, with the
balance heuristic, the MIS weight for the unidirectional strategy works out
to be
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:unidir-light-spectral-mis-weight"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="44.569ex" height="7.009ex" style="vertical-align: -3.171ex;" viewBox="0 -1652.5 19189.4 3017.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript normal u Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis equals StartStartFraction p Subscript normal u comma lamda 1 Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis OverOver StartFraction 1 Over m EndFraction left-parenthesis sigma-summation Underscript i Overscript m Endscripts p Subscript normal u comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis plus sigma-summation Underscript i Overscript m Endscripts p Subscript normal l comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis right-parenthesis EndEndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45A" d="M848 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 4 31 13 55c20 53 62 167 62 224c0 36 -11 70 -54 70c-109 0 -162 -120 -165 -133l-60 -241c-8 -32 -14 -57 -45 -57c-15 0 -29 9 -29 27c0 5 9 39 13 59c9 33 10 39 20 76l28 116c8 30 15 58 15 83 c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84c0 38 -15 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23 c0 0 -12 0 -12 10c0 3 13 62 31 97c9 18 28 57 74 57c45 0 87 -30 92 -87c17 23 66 87 156 87c25 0 57 -5 82 -26c28 -24 31 -58 32 -71c37 53 88 97 163 97s115 -42 115 -107c0 -57 -42 -168 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNOPERATORS-2211" d="M999 -1l-86 -249h-829c-18 0 -27 0 -27 11c0 4 1 6 9 16l355 439l-365 502c0 31 1 32 28 32h829l86 -234h-25c-70 187 -300 194 -414 194h-396l325 -446c6 -9 7 -10 7 -14s-2 -7 -9 -16l-347 -429h425c147 0 216 24 232 29c85 29 152 90 177 165h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="1013" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1210" y="0"></use>
<g transform="translate(1599,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2680" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3347" y="0"></use>
<g transform="translate(4126,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="14266" height="60" x="0" y="220"></rect>
<g transform="translate(5221,809)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1964" y="0"></use>
<g transform="translate(2354,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3435" y="0"></use>
</g>
<g transform="translate(60,-937)">
<g transform="translate(120,0)">
<rect stroke="none" width="741" height="60" x="0" y="220"></rect>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="273" y="629"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="84" y="-488"></use>
</g>
<g transform="translate(981,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-28"></use>
<g transform="translate(389,0)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="1494" y="675"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
</g>
<g transform="translate(2333,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4209" y="0"></use>
<g transform="translate(4598,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5680" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="6291" y="0"></use>
<g transform="translate(7292,0)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="1494" y="675"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
</g>
<g transform="translate(9236,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="10915" y="0"></use>
<g transform="translate(11305,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="12386" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="12775" y="0"></use>
</g>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="18910" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:unidir-light-spectral-mis-weight">14.25</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.04ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 878.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">m</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45A" d="M848 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 4 31 13 55c20 53 62 167 62 224c0 36 -11 70 -54 70c-109 0 -162 -120 -165 -133l-60 -241c-8 -32 -14 -57 -45 -57c-15 0 -29 9 -29 27c0 5 9 39 13 59c9 33 10 39 20 76l28 116c8 30 15 58 15 83 c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84c0 38 -15 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23 c0 0 -12 0 -12 10c0 3 13 62 31 97c9 18 28 57 74 57c45 0 87 -30 92 -87c17 23 66 87 156 87c25 0 57 -5 82 -26c28 -24 31 -58 32 -71c37 53 88 97 163 97s115 -42 115 -107c0 -57 -42 -168 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="0" y="0"></use>
</g>
</svg> the number of spectral samples.
The MIS weight for light sampling is equivalent, but with the
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.636ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1996.1 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u comma lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</svg> function in the numerator replaced with
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.179ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1799.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal l comma lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</svg>.

</p>
<p>

</p>
<p>
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#ImprovedVolumetricIntegrator"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:volumetric-path-tracing"></span><span id="ImprovedVolumetricIntegrator"></span><h3>14.2.3  Improved Volumetric Integrator<button data-toggle="tooltip" data-placement="right" class="btn difficult-button"
title="This section contains advanced content and may be skipped on a first reading.">
<i class="fas fa-exclamation-triangle midredtext"></i></button>
</h3><p>



</p>
<p> </p>
<span class="anchor" id="fig:volumetric-lightbulbs"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
<img src="volumetric-lightbulbs.png" style="max-width: 100%; height: auto;" width=1920 height=1080>
</div>
<p>

</p>
<figcaption class="caption">Figure 14.9: Volumetric Emission inside Lightbulbs. <span class="legend">
The flames in each lightbulb are modeled with participating media and 
rendered with the <a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a>.
<em>(Scene courtesy of Jim Price.)</em>
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fig:volumetric-paint-water"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
<img src="volumetric-paint-water.png" style="max-width: 100%; height: auto;" width=1688 height=2000>
</div>
<p>

</p>
<figcaption class="caption">Figure 14.10: Volumetric Scattering in Liquid. <span class="legend">
Scattering in the paint-infused water is modeled with participating media and 
rendered with the <a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a>.
<em>(Scene courtesy of Angelo Ferretti.)</em>
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The <a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a> pulls together all of these ideas to robustly
handle both surface and volume transport.  See
Figures&nbsp;<a href="#fig:volumetric-lightbulbs">14.9</a> and&nbsp;<a href="#fig:volumetric-paint-water">14.10</a> for images
rendered with this integrator that show off the visual complexity that
comes from volumetric emission, chromatic media, and multiple scattering in
participating media.

</p>
<p></p>
<span class="anchor" id="fragment-VolPathIntegratorDefinition-0"></span><div class="fragmentname">&lt;&lt;VolPathIntegrator Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="VolPathIntegrator"></span>VolPathIntegrator : public <a href="../Introduction/pbrt_System_Overview.html#RayIntegrator" class="code">RayIntegrator</a> {
  public:
    &lt;&lt;<span class="fragmentname">VolPathIntegrator Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2001" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2001"><i></i></a><div id="fragbit-2001" class="collapse"><div class="fragmentcode">       VolPathIntegrator(int maxDepth, <a href="../Cameras_and_Film/Camera_Interface.html#Camera" class="code">Camera</a> camera, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler,
                         <a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive" class="code">Primitive</a> aggregate, std::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights,
                         const std::string &amp;lightSampleStrategy = "bvh",
                         bool regularize = false)
           : RayIntegrator(camera, sampler, aggregate, lights),
             maxDepth(maxDepth),
             lightSampler(
                 <a href="../Light_Sources/Light_Sampling.html#LightSampler" class="code">LightSampler</a>::Create(lightSampleStrategy, lights, Allocator())),
             regularize(regularize) {}
       
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Li(<a href="../Geometry_and_Transformations/Rays.html#RayDifferential" class="code">RayDifferential</a> ray, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda,
                          <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler, <a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer" class="code">ScratchBuffer</a> &amp;scratchBuffer,
                          <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a> *visibleSurface) const;
       
       static std::unique_ptr&lt;VolPathIntegrator&gt; Create(
           const ParameterDictionary &amp;parameters, <a href="../Cameras_and_Film/Camera_Interface.html#Camera" class="code">Camera</a> camera, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler,
           <a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive" class="code">Primitive</a> aggregate, std::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights, const FileLoc *loc);
       
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname">VolPathIntegrator Private Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2002" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2002"><i></i></a><div id="fragbit-2002" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> SampleLd(const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;intr, const <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> *bsdf, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda,
                                <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> beta,
                                <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> inv_w_u) const;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-VolPathIntegratorPrivateMembers-0">VolPathIntegrator Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2003" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2003"><i></i></a><div id="fragbit-2003" class="collapse"><div class="fragmentcode">       int maxDepth;
       <a href="../Light_Sources/Light_Sampling.html#LightSampler" class="code">LightSampler</a> lightSampler;
       bool regularize;</div></div>
};</div><p>


</p>
<p>

</p>
<p>As with the other <tt>Integrator</tt> constructors that we have seen so far,
the <tt>VolPathIntegrator</tt> constructor does not perform any meaningful
computation, but just initializes member variables with provided values.
These three are all equivalent to their parallels in the
<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-VolPathIntegratorPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;VolPathIntegrator Private Members&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int <span class="anchor" id="VolPathIntegrator::maxDepth"></span>maxDepth;
<a href="../Light_Sources/Light_Sampling.html#LightSampler" class="code">LightSampler</a> <span class="anchor" id="VolPathIntegrator::lightSampler"></span>lightSampler;
bool <span class="anchor" id="VolPathIntegrator::regularize"></span>regularize;</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-VolPathIntegratorMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;VolPathIntegrator Method Definitions&gt;&gt;=&nbsp;<a href="#fragment-VolPathIntegratorMethodDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="VolPathIntegrator::Li"></span>VolPathIntegrator::Li(<a href="../Geometry_and_Transformations/Rays.html#RayDifferential" class="code">RayDifferential</a> ray,
        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler,
        <a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer" class="code">ScratchBuffer</a> &amp;scratchBuffer, <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a> *visibleSurf) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Declarestatevariablesforvolumetricpathsampling-0">Declare state variables for volumetric path sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2004" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2004"><i></i></a><div id="fragbit-2004" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> L(0.f), beta(1.f), r_u(1.f), r_l(1.f);
       bool specularBounce = false, anyNonSpecularBounces = false;
       int depth = 0;
       Float etaScale = 1;
       <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> prevIntrContext;</div></div>  
    while (true) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplesegmentofvolumetricscatteringpath-0">Sample segment of volumetric scattering path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2005" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2005"><i></i></a><div id="fragbit-2005" class="collapse"><div class="fragmentcode">           pstd::optional&lt;ShapeIntersection&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(ray);
           if (ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampletheparticipatingmedium-0">Sample the participating medium</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2006" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2006"><i></i></a><div id="fragbit-2006" class="collapse"><div class="fragmentcode">                  bool scattered = false, terminated = false;
                  Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : <a href="../Shapes/Managing_Rounding_Error.html#Infinity" class="code">Infinity</a>;
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonoRNGforsamplingthemajoranttransmittance-0">Initialize <tt>RNG</tt> for sampling the majorant transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2007" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2007"><i></i></a><div id="fragbit-2007" class="collapse"><div class="fragmentcode">                     uint64_t hash0 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
                     uint64_t hash1 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
                     <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(hash0, hash1);</div></div>
                  <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj = <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(ray, tMax, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>(), rng, lambda,
                          [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
                              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) {
                              &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlemediumscatteringeventforray-0">Handle medium scattering event for ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2008" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2008"><i></i></a><div id="fragbit-2008" class="collapse"><div class="fragmentcode">                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemissionfrommediumscatteringevent-0">Add emission from medium scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2009" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2009"><i></i></a><div id="fragbit-2009" class="collapse"><div class="fragmentcode">                                    if (depth &lt; <a href="#VolPathIntegrator::maxDepth" class="code">maxDepth</a> &amp;&amp; mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>) {
                                        &lt;&lt;<span class="fragmentname"><a href="#fragment-Computebetaatnewpathvertex-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.242ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 965.1 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="815" y="513"></use>
</g>
</svg> at new path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2010" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2010"><i></i></a><div id="fragbit-2010" class="collapse"><div class="fragmentcode">                                           Float pdf = sigma_maj[0] * T_maj[0];
                                           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> betap = beta * T_maj / pdf;</div></div>
                                        &lt;&lt;<span class="fragmentname"><a href="#fragment-Computerescaledpathprobabilityforabsorptionatpathvertex-0">Compute rescaled path probability for absorption at path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2011" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2011"><i></i></a><div id="fragbit-2011" class="collapse"><div class="fragmentcode">                                           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> r_e = r_u * sigma_maj * T_maj / pdf;</div></div>
                                        &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoLformediumemission-0">Update <tt>L</tt> for medium emission</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2012" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2012"><i></i></a><div id="fragbit-2012" class="collapse"><div class="fragmentcode">                                           if (r_e)
                                               L += betap * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a> / r_e.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
                                    }</div></div>
                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Computemediumeventprobabilitiesforinteraction-0">Compute medium event probabilities for interaction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2013" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2013"><i></i></a><div id="fragbit-2013" class="collapse"><div class="fragmentcode">                                    Float pAbsorb = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a>[0] / sigma_maj[0];
                                    Float pScatter = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0] / sigma_maj[0];
                                    Float pNull = std::max&lt;Float&gt;(0, 1 - pAbsorb - pScatter);</div></div>
                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplemediumscatteringeventtypeandupdatepath-0">Sample medium scattering event type and update path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2014" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2014"><i></i></a><div id="fragbit-2014" class="collapse"><div class="fragmentcode">                                    Float um = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::Uniform" class="code">Uniform</a>&lt;Float&gt;();
                                    int mode = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>({pAbsorb, pScatter, pNull}, um);
                                    if (mode == 0) {
                                        &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleabsorptionalongraypath-0">Handle absorption along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2015" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2015"><i></i></a><div id="fragbit-2015" class="collapse"><div class="fragmentcode">                                           terminated = true;
                                           return false;</div></div>
                                    } else if (mode == 1) {
                                        &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlescatteringalongraypath-0">Handle scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2016" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2016"><i></i></a><div id="fragbit-2016" class="collapse"><div class="fragmentcode">                                           &lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2017" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2017"><i></i></a><div id="fragbit-2017" class="collapse"><div class="fragmentcode">                                              if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
                                                  terminated = true;
                                                  return false;
                                              }</div></div>
                                           &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonobetaandmonor_uforreal-scatteringevent-0">Update <tt>beta</tt> and <tt>r_u</tt> for real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2018" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2018"><i></i></a><div id="fragbit-2018" class="collapse"><div class="fragmentcode">                                              Float pdf = T_maj[0] * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0];
                                              beta *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;
                                              r_u *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;</div></div>
                                           if (beta &amp;&amp; r_u) {
                                               &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectlightingatvolume-scatteringevent-0">Sample direct lighting at volume-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2019" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2019"><i></i></a><div id="fragbit-2019" class="collapse"><div class="fragmentcode">                                                  <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction" class="code">MediumInteraction</a> intr(p, -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>, mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>);
                                                  L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(intr, nullptr, lambda, sampler, beta, r_u);</div></div>
                                               &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewdirectionatreal-scatteringevent-0">Sample new direction at real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2020" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2020"><i></i></a><div id="fragbit-2020" class="collapse"><div class="fragmentcode">                                                  <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
                                                  pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = intr.<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
                                                  if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0)
                                                      terminated = true;
                                                  else {
                                                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraypathstateforindirectvolumescattering-0">Update ray path state for indirect volume scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2021" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2021"><i></i></a><div id="fragbit-2021" class="collapse"><div class="fragmentcode">                                                         beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                                         r_l = r_u / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                                         prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);
                                                         scattered = true;
                                                         ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
                                                         ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                                                         specularBounce = false;
                                                         anyNonSpecularBounces = true;</div></div>
                                                  }</div></div>
                                           }
                                           return false;</div></div>
                                    } else {
                                        &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenullscatteringalongraypath-0">Handle null scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2022" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2022"><i></i></a><div id="fragbit-2022" class="collapse"><div class="fragmentcode">                                           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = ClampZero(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
                                           Float pdf = T_maj[0] * sigma_n[0];
                                           beta *= T_maj * sigma_n / pdf;
                                           if (pdf == 0) beta = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
                                           r_u *= T_maj * sigma_n / pdf;
                                           r_l *= T_maj * sigma_maj / pdf;
                                           return beta &amp;&amp; r_u;</div></div>
                                    }</div></div></div></div> 
                          });
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleterminatedscatteredandunscatteredmediumrays-0">Handle terminated, scattered, and unscattered medium rays</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2023" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2023"><i></i></a><div id="fragbit-2023" class="collapse"><div class="fragmentcode">                     if (terminated || !beta || !r_u) return L;
                     if (scattered) continue;
                     beta *= T_maj / T_maj[0];
                     r_u *= T_maj / T_maj[0];
                     r_l *= T_maj / T_maj[0];</div></div></div></div>
           }
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlesurvivingunscatteredrays-0">Handle surviving unscattered rays</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2024" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2024"><i></i></a><div id="fragbit-2024" class="collapse"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemittedlightatvolumepathvertexorfromtheenvironment-0">Add emitted light at volume path vertex or from the environment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2025" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2025"><i></i></a><div id="fragbit-2025" class="collapse"><div class="fragmentcode">                 if (!si) {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Accumulatecontributionsfrominfinitelightsources-0">Accumulate contributions from infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2026" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2026"><i></i></a><div id="fragbit-2026" class="collapse"><div class="fragmentcode">                        for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
                            if (<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda); <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>) {
                                if (depth == 0 || specularBounce)
                                    L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> / r_u.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
                                else {
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-AddinfinitelightcontributionusingbothPDFswithMIS-0">Add infinite light contribution using both PDFs with MIS</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2027" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2027"><i></i></a><div id="fragbit-2027" class="collapse"><div class="fragmentcode">                                       Float lightPDF = <a href="#VolPathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrContext, light) *
                                                        light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrContext, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
                                       r_l *= lightPDF;
                                       L += beta * Le / (r_u + r_l).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
                                }
                            }
                        }</div></div>
                     break;
                 }
                 <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;isect = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
                 if (<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a> = isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, lambda); <a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>) {
                     &lt;&lt;<span class="fragmentname">Add contribution of emission from intersected surface</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2028" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2028"><i></i></a><div id="fragbit-2028" class="collapse"><div class="fragmentcode">                        if (depth == 0 || specularBounce)
                            L += beta * Le / r_u.Average();
                        else {
                            &lt;&lt;<span class="fragmentname">Add surface light contribution using both PDFs with MIS</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2029" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2029"><i></i></a><div id="fragbit-2029" class="collapse"><div class="fragmentcode">                               <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> areaLight(isect.areaLight);
                               Float lightPDF =
                                   lightSampler.PMF(prevIntrContext, areaLight) *
                                   areaLight.PDF_Li(prevIntrContext, ray.d, true);
                               r_l *= lightPDF;
                               L += beta * Le / (r_u + r_l).Average();</div></div>
                        }</div></div>
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#fragment-GetBSDFandskipovermediumboundaries-0">Get BSDF and skip over medium boundaries</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2030" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2030"><i></i></a><div id="fragbit-2030" class="collapse"><div class="fragmentcode">                 <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = isect.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, scratchBuffer, sampler);
                 if (!bsdf) {
                     isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
                     continue;
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-InitializemonovisibleSurfatfirstintersection-0">Initialize <tt>visibleSurf</tt> at first intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2031" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2031"><i></i></a><div id="fragbit-2031" class="collapse"><div class="fragmentcode">                 if (depth == 0 &amp;&amp; visibleSurf) {
                     &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-EstimateBSDFsalbedo-0">Estimate BSDF&rsquo;s albedo</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2032" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2032"><i></i></a><div id="fragbit-2032" class="collapse"><div class="fragmentcode">                        &lt;&lt;<span class="fragmentname">Define sample arrays <tt>ucRho</tt> and <tt>uRho</tt> for reflectance estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2033" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2033"><i></i></a><div id="fragbit-2033" class="collapse"><div class="fragmentcode">                           constexpr int nRhoSamples = 16;
                           const Float ucRho[nRhoSamples] = { 0.75741637, 0.37870818, 0.7083487, 0.18935409, 0.9149363, 0.35417435, 0.5990858, 0.09467703, 0.8578725, 0.45746812, 0.686759, 0.17708716, 0.9674518, 0.2995429, 0.5083201, 0.047338516 };
                           const <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uRho[nRhoSamples] = { <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.855985, 0.570367), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.381823, 0.851844), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.285328, 0.764262), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.733380, 0.114073), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.542663, 0.344465), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.127274, 0.414848), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.964700, 0.947162), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.594089, 0.643463), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.095109, 0.170369), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.825444, 0.263359), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.429467, 0.454469), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.244460, 0.816459), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.756135, 0.731258), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.516165, 0.152852), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.180888, 0.214174), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.898579, 0.503897) };</div></div>
                        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> albedo = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::rho" class="code">rho</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, ucRho, uRho);</div></div>
                     *visibleSurf = <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a>(isect, albedo, lambda);
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Terminatepathifmaximumdepthreached-0">Terminate path if maximum depth reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2034" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2034"><i></i></a><div id="fragbit-2034" class="collapse"><div class="fragmentcode">                 if (depth++ &gt;= <a href="#VolPathIntegrator::maxDepth" class="code">maxDepth</a>)
                     return L;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-PossiblyregularizetheBSDF-0">Possibly regularize the BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2035" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2035"><i></i></a><div id="fragbit-2035" class="collapse"><div class="fragmentcode">                 if (<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator::regularize" class="code">regularize</a> &amp;&amp; anyNonSpecularBounces)
                     bsdf.<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#BSDF::Regularize" class="code">Regularize</a>();
                 </div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleilluminationfromlightstofindattenuatedpathcontribution-0">Sample illumination from lights to find attenuated path contribution</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2036" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2036"><i></i></a><div id="fragbit-2036" class="collapse"><div class="fragmentcode">                 if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>()))
                     L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(isect, &amp;bsdf, lambda, sampler, beta, r_u);
                 prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(isect);</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFtogetnewvolumetricpathdirection-0">Sample BSDF to get new volumetric path direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2037" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2037"><i></i></a><div id="fragbit-2037" class="collapse"><div class="fragmentcode">                 <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>;
                 Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
                 pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
                 if (!bs) break;
                 &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonobetaandrescaledpathprobabilitiesforBSDFscattering-0">Update <tt>beta</tt> and rescaled path probabilities for BSDF scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2038" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2038"><i></i></a><div id="fragbit-2038" class="collapse"><div class="fragmentcode">                    beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, isect.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                    if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional" class="code">pdfIsProportional</a>)
                        r_l = r_u / bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>);
                    else
                        r_l = r_u / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatevolumetricintegratorpathstateaftersurfacescattering-0">Update volumetric integrator path state after surface scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2039" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2039"><i></i></a><div id="fragbit-2039" class="collapse"><div class="fragmentcode">                    specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
                    anyNonSpecularBounces |= !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
                    if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>())
                        etaScale *= <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);
                    ray = isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(ray, bsdf, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::flags" class="code">flags</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);</div></div></div></div>
              &lt;&lt;<span class="fragmentname">Account for attenuated subsurface scattering, if applicable</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2040" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2040"><i></i></a><div id="fragbit-2040" class="collapse"><div class="fragmentcode">                 BSSRDF bssrdf = isect.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSSRDF" class="code">GetBSSRDF</a>(ray, lambda, <a href="../Introduction/pbrt_System_Overview.html#ImageTileIntegrator::camera" class="code">camera</a>, scratchBuffer);
                 if (bssrdf &amp;&amp; bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>()) {
                     &lt;&lt;<span class="fragmentname">Sample BSSRDF probe segment to find exit point</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2041" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2041"><i></i></a><div id="fragbit-2041" class="collapse"><div class="fragmentcode">                        Float uc = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
                        <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> up = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
                        pstd::optional&lt;BSSRDFProbeSegment&gt; probeSeg = bssrdf.SampleSp(uc, up);
                        if (!probeSeg) break;</div></div>
                     &lt;&lt;<span class="fragmentname">Sample random intersection along BSSRDF probe segment</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2042" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2042"><i></i></a><div id="fragbit-2042" class="collapse"><div class="fragmentcode">                        uint64_t seed = <a href="../Utilities/Mathematical_Infrastructure.html#MixBits" class="code">MixBits</a>(<a href="../Shapes/Managing_Rounding_Error.html#FloatToBits" class="code">FloatToBits</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>()));
                        <a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler" class="code">WeightedReservoirSampler</a>&lt;SubsurfaceInteraction&gt; interactionSampler(seed);
                        &lt;&lt;<span class="fragmentname">Intersect BSSRDF sampling ray against the scene geometry</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2043" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2043"><i></i></a><div id="fragbit-2043" class="collapse"><div class="fragmentcode">                           <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> base(probeSeg-&gt;p0, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, <a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>());
                           while (true) {
                               <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> r = base.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(probeSeg-&gt;p1);
                               pstd::optional&lt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection" class="code">ShapeIntersection</a>&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(r, 1);
                               if (!si) break;
                               base = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
                               if (si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a> == isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a>)
                                   interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::Add" class="code">Add</a>(SubsurfaceInteraction(si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>), 1.f);
                           }</div></div>
                        if (!interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::HasSample" class="code">HasSample</a>())
                            break;</div></div>
                     &lt;&lt;<span class="fragmentname">Convert probe intersection to <tt>BSSRDFSample</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2044" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2044"><i></i></a><div id="fragbit-2044" class="collapse"><div class="fragmentcode">                        SubsurfaceInteraction ssi = interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::GetSample" class="code">GetSample</a>();
                        BSSRDFSample bssrdfSample =
                            bssrdf.ProbeIntersectionToSample(ssi, scratchBuffer);
                        if (!bssrdfSample.Sp || !bssrdfSample.pdf) break;</div></div>
                     &lt;&lt;<span class="fragmentname">Update path state for subsurface scattering</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2045" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2045"><i></i></a><div id="fragbit-2045" class="collapse"><div class="fragmentcode">                        Float pdf = interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::SampleProbability" class="code">SampleProbability</a>() * bssrdfSample.pdf[0];
                        beta *= bssrdfSample.Sp / pdf;
                        r_u *= bssrdfSample.pdf / bssrdfSample.pdf[0];
                        <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> pi = ssi;
                        pi.wo = bssrdfSample.wo;
                        prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(pi);
                        &lt;&lt;<span class="fragmentname">Possibly regularize subsurface BSDF</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2046" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2046"><i></i></a><div id="fragbit-2046" class="collapse"><div class="fragmentcode">                           <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> &amp;Sw = bssrdfSample.Sw;
                           anyNonSpecularBounces = true;
                           if (<a href="#VolPathIntegrator::regularize" class="code">regularize</a>)
                               Sw.<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#BSDF::Regularize" class="code">Regularize</a>();
                           </div></div></div></div>
                     &lt;&lt;<span class="fragmentname">Account for attenuated direct illumination subsurface scattering</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2047" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2047"><i></i></a><div id="fragbit-2047" class="collapse"><div class="fragmentcode">                        L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(pi, &amp;Sw, lambda, sampler, beta, r_u);</div></div>
                     &lt;&lt;<span class="fragmentname">Sample ray for indirect subsurface scattering</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2048" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2048"><i></i></a><div id="fragbit-2048" class="collapse"><div class="fragmentcode">                        Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
                        pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = Sw.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(pi.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
                        if (!bs) break;
                        beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, pi.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                        r_l = r_u / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                        specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
                        ray = <a href="../Geometry_and_Transformations/Rays.html#RayDifferential" class="code">RayDifferential</a>(pi.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));</div></div>
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatevolumetricpathwithRussianroulette-0">Possibly terminate volumetric path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2049" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2049"><i></i></a><div id="fragbit-2049" class="collapse"><div class="fragmentcode">                 <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> rrBeta = beta * etaScale / r_u.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
                 Float uRR = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
                 if (rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 1 &amp;&amp; depth &gt; 1) {
                     Float q = std::max&lt;Float&gt;(0, 1 - rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
                     if (uRR &lt; q) break;
                     beta /= 1 - q;
                 }</div></div></div></div></div></div>
    }
    return L;
}</div><p>


</p>
<p>There is a common factor of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.956ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3856.2 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u comma lamda 1 Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1964" y="0"></use>
<g transform="translate(2354,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3435" y="0"></use>
</g>
</svg> in the
denominator of the first term of the two-sample MIS estimator,
Equation&nbsp;(<a href="#eq:volpath-two-sample-mis-estimator">14.24</a>), and the numerator of
the MIS weights, Equation&nbsp;(<a href="#eq:unidir-light-spectral-mis-weight">14.25</a>).
There is a corresponding <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.179ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1799.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal l comma lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</svg> factor in the second
term of the estimator and in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.354ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1013.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript normal l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1013" y="-213"></use>
</g>
</svg> weight.  It is tempting to
cancel these out; in that case, the path state to be tracked by the
integrator would consist of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.957ex" height="3.343ex" style="vertical-align: -0.838ex;" viewBox="0 -1078.4 2564.6 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove upper T With caret left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="704" y="0"></use>
<g transform="translate(1094,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2175" y="0"></use>
</g>
</svg> and the
wavelength-dependent probabilities <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.709ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2888.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="997" y="0"></use>
<g transform="translate(1386,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2467" y="0"></use>
</g>
</svg> and
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.253ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2692 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal l Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="800" y="0"></use>
<g transform="translate(1189,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2271" y="0"></use>
</g>
</svg>.  Doing so is mathematically valid and would
provide all the quantities necessary to evaluate
Equation&nbsp;(<a href="#eq:volpath-two-sample-mis-estimator">14.24</a>), but suffers from the
problem that the quantities involved may overflow or underflow the range of
representable floating-point values.

</p>
<p>To understand the problem, consider a highly specular surface&mdash;the BSDF will have a large
value for directions around its peak, but the PDF for sampling those
directions will also be large.  That causes no problems in the
<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>, since its <tt>beta</tt> variable tracks their ratio,
which ends up being close to&nbsp;1.  However, with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.957ex" height="3.343ex" style="vertical-align: -0.838ex;" viewBox="0 -1078.4 2564.6 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove upper T With caret left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="704" y="0"></use>
<g transform="translate(1094,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2175" y="0"></use>
</g>
</svg>
maintained independently, a series of specular bounces could lead to
overflow.  (Many null-scattering events along a path can cause similar
problems.)

</p>
<p>Therefore, the <tt>VolPathIntegrator</tt> tracks the path throughput weight for the
sampled path
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="19.119ex" height="6.843ex" style="vertical-align: -2.671ex;" viewBox="0 -1796 8231.9 2946.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis equals StartFraction ModifyingAbove upper T With caret left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis Over p Subscript normal u comma lamda 1 Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis EndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="574" y="0"></use>
<g transform="translate(964,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2045" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2712" y="0"></use>
<g transform="translate(3490,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3944" height="60" x="0" y="220"></rect>
<g transform="translate(690,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="652" y="199"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="704" y="0"></use>
<g transform="translate(1094,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2175" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1964" y="0"></use>
<g transform="translate(2354,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3435" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7953" y="0"></use>
</g>
</svg>
</div>
<p>

which is numerically well behaved.  Directly tracking the probabilities 
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.709ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2888.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="997" y="0"></use>
<g transform="translate(1386,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2467" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.253ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2692 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal l Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="800" y="0"></use>
<g transform="translate(1189,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2271" y="0"></use>
</g>
</svg> would also stress the
range of floating-point numbers, so instead it tracks the <em>rescaled
path probabilities</em>
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:volpath-rescaled-path-probabilities"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="56.232ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 24210.8 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript normal u comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis equals StartFraction p Subscript normal u comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis Over p Subscript normal p normal a normal t normal h Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis EndFraction and r Subscript normal l comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis equals StartFraction p Subscript normal l comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis Over p Subscript normal p normal a normal t normal h Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis EndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1823" y="0"></use>
<g transform="translate(2213,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3294" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3961" y="0"></use>
<g transform="translate(4739,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3999" height="60" x="0" y="220"></rect>
<g transform="translate(132,812)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1875" y="0"></use>
<g transform="translate(2265,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3346" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="1057" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-68" x="1446" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2019" y="0"></use>
<g transform="translate(2409,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3490" y="0"></use>
</g>
</g>
</g>
<g transform="translate(11257,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-61"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="1057" y="0"></use>
</g>
<g transform="translate(14871,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="16498" y="0"></use>
<g transform="translate(16887,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="17968" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="18636" y="0"></use>
<g transform="translate(19414,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="3999" height="60" x="0" y="220"></rect>
<g transform="translate(230,812)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1679" y="0"></use>
<g transform="translate(2068,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3149" y="0"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="1057" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-68" x="1446" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2019" y="0"></use>
<g transform="translate(2409,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3490" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="23932" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:volpath-rescaled-path-probabilities">14.26</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.085ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3911.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal p normal a normal t normal h Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="1057" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-68" x="1446" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2019" y="0"></use>
<g transform="translate(2409,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3490" y="0"></use>
</g>
</svg> is the probability for sampling the
current path.  It is equal to the light path probability
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.179ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1799.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal l comma lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</svg> for paths that end with a shadow ray from light
path sampling and the unidirectional path probability otherwise.  (Later in
the implementation, we will take advantage of the fact that these two
probabilities are the same until the last scattering vertex, which in turn
implies that whichever of them is chosen for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.764ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 2051.3 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal p normal a normal t normal h</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="1057" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-68" x="1446" y="0"></use>
</g>
</g>
</svg> does not
affect the values of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.656ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 4588.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript normal u comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n minus 1 Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1823" y="0"></use>
<g transform="translate(2213,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4198" y="0"></use>
</g>
</svg> and 
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.2ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 4391.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">r Subscript normal l comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n minus 1 Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1627" y="0"></use>
<g transform="translate(2016,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4002" y="0"></use>
</g>
</svg>.)

</p>
<p>These rescaled path probabilities are all easily incrementally updated during path
sampling.  If <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.426ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 5350 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal p normal a normal t normal h Baseline equals p Subscript normal u comma lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="1057" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-68" x="1446" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2297" y="0"></use>
<g transform="translate(3353,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</g>
</svg>, then MIS weights like those in
Equation&nbsp;(<a href="#eq:unidir-light-spectral-mis-weight">14.25</a>) can be found with
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:volpath-wu-from-rescaled-probabilities"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="44.327ex" height="6.509ex" style="vertical-align: -3.171ex;" viewBox="0 -1437.2 19085.4 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript normal u Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis equals StartStartFraction 1 OverOver StartFraction 1 Over m EndFraction left-parenthesis sigma-summation Underscript i Overscript m Endscripts r Subscript normal u comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis plus sigma-summation Underscript i Overscript m Endscripts r Subscript normal l comma lamda Sub Subscript i Subscript Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis right-parenthesis EndEndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45A" d="M848 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 4 31 13 55c20 53 62 167 62 224c0 36 -11 70 -54 70c-109 0 -162 -120 -165 -133l-60 -241c-8 -32 -14 -57 -45 -57c-15 0 -29 9 -29 27c0 5 9 39 13 59c9 33 10 39 20 76l28 116c8 30 15 58 15 83 c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84c0 38 -15 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23 c0 0 -12 0 -12 10c0 3 13 62 31 97c9 18 28 57 74 57c45 0 87 -30 92 -87c17 23 66 87 156 87c25 0 57 -5 82 -26c28 -24 31 -58 32 -71c37 53 88 97 163 97s115 -42 115 -107c0 -57 -42 -168 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNOPERATORS-2211" d="M999 -1l-86 -249h-829c-18 0 -27 0 -27 11c0 4 1 6 9 16l355 439l-365 502c0 31 1 32 28 32h829l86 -234h-25c-70 187 -300 194 -414 194h-396l325 -446c6 -9 7 -10 7 -14s-2 -7 -9 -16l-347 -429h425c147 0 216 24 232 29c85 29 152 90 177 165h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="1013" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1210" y="0"></use>
<g transform="translate(1599,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2680" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3347" y="0"></use>
<g transform="translate(4126,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="14162" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="6831" y="676"></use>
<g transform="translate(60,-937)">
<g transform="translate(120,0)">
<rect stroke="none" width="741" height="60" x="0" y="220"></rect>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="273" y="629"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="84" y="-488"></use>
</g>
<g transform="translate(981,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-28"></use>
<g transform="translate(389,0)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="1494" y="675"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
</g>
<g transform="translate(2333,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4157" y="0"></use>
<g transform="translate(4546,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5628" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="6239" y="0"></use>
<g transform="translate(7240,0)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="1494" y="675"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
</g>
<g transform="translate(9184,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="10811" y="0"></use>
<g transform="translate(11201,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="12282" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="12671" y="0"></use>
</g>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="18806" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:volpath-wu-from-rescaled-probabilities">14.27</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

and similarly for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.354ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1013.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript normal l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1013" y="-213"></use>
</g>
</svg> when
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.969ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 5153.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal p normal a normal t normal h Baseline equals p Subscript normal l comma lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="1057" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-68" x="1446" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2297" y="0"></use>
<g transform="translate(3353,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</g>
</svg>.

</p>
<p>The remaining variables in the following fragment have the same function as
the variables of the same names in the <a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-Declarestatevariablesforvolumetricpathsampling-0"></span><div class="fragmentname">&lt;&lt;Declare state variables for volumetric path sampling&gt;&gt;=&nbsp;<a href="#fragment-Declarestatevariablesforvolumetricpathsampling-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> L(0.f), beta(1.f), r_u(1.f), r_l(1.f);
bool specularBounce = false, anyNonSpecularBounces = false;
int depth = 0;
Float etaScale = 1;</div><p>


</p>
<p>The <tt>while</tt> loop for each ray segment starts out similarly to the 
corresponding loop in the <a href="#SimpleVolPathIntegrator"><tt>SimpleVolPathIntegrator</tt></a>:
the integrator traces a ray to find a <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.131ex" height="2.343ex" style="vertical-align: -0.671ex;" viewBox="0 -719.6 1778.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t Subscript normal m normal a normal x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
<g transform="translate(361,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-78" x="1334" y="0"></use>
</g>
</g>
</svg> value at the closest surface
intersection before sampling the medium, if any, between the ray origin and
the intersection point.

</p>
<p></p>
<span class="anchor" id="fragment-Samplesegmentofvolumetricscatteringpath-0"></span><div class="fragmentname">&lt;&lt;Sample segment of volumetric scattering path&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::optional&lt;ShapeIntersection&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(ray);
if (ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampletheparticipatingmedium-0">Sample the participating medium</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2050" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2050"><i></i></a><div id="fragbit-2050" class="collapse"><div class="fragmentcode">       bool scattered = false, terminated = false;
       Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : <a href="../Shapes/Managing_Rounding_Error.html#Infinity" class="code">Infinity</a>;
       &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonoRNGforsamplingthemajoranttransmittance-0">Initialize <tt>RNG</tt> for sampling the majorant transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2051" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2051"><i></i></a><div id="fragbit-2051" class="collapse"><div class="fragmentcode">          uint64_t hash0 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
          uint64_t hash1 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
          <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(hash0, hash1);</div></div>
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj = <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(ray, tMax, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>(), rng, lambda,
               [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
                   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) {
                   &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlemediumscatteringeventforray-0">Handle medium scattering event for ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2052" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2052"><i></i></a><div id="fragbit-2052" class="collapse"><div class="fragmentcode">                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemissionfrommediumscatteringevent-0">Add emission from medium scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2053" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2053"><i></i></a><div id="fragbit-2053" class="collapse"><div class="fragmentcode">                         if (depth &lt; <a href="#VolPathIntegrator::maxDepth" class="code">maxDepth</a> &amp;&amp; mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>) {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Computebetaatnewpathvertex-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.242ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 965.1 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="815" y="513"></use>
</g>
</svg> at new path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2054" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2054"><i></i></a><div id="fragbit-2054" class="collapse"><div class="fragmentcode">                                Float pdf = sigma_maj[0] * T_maj[0];
                                <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> betap = beta * T_maj / pdf;</div></div>
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Computerescaledpathprobabilityforabsorptionatpathvertex-0">Compute rescaled path probability for absorption at path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2055" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2055"><i></i></a><div id="fragbit-2055" class="collapse"><div class="fragmentcode">                                <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> r_e = r_u * sigma_maj * T_maj / pdf;</div></div>
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoLformediumemission-0">Update <tt>L</tt> for medium emission</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2056" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2056"><i></i></a><div id="fragbit-2056" class="collapse"><div class="fragmentcode">                                if (r_e)
                                    L += betap * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a> / r_e.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
                         }</div></div>
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Computemediumeventprobabilitiesforinteraction-0">Compute medium event probabilities for interaction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2057" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2057"><i></i></a><div id="fragbit-2057" class="collapse"><div class="fragmentcode">                         Float pAbsorb = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a>[0] / sigma_maj[0];
                         Float pScatter = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0] / sigma_maj[0];
                         Float pNull = std::max&lt;Float&gt;(0, 1 - pAbsorb - pScatter);</div></div>
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplemediumscatteringeventtypeandupdatepath-0">Sample medium scattering event type and update path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2058" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2058"><i></i></a><div id="fragbit-2058" class="collapse"><div class="fragmentcode">                         Float um = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::Uniform" class="code">Uniform</a>&lt;Float&gt;();
                         int mode = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>({pAbsorb, pScatter, pNull}, um);
                         if (mode == 0) {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleabsorptionalongraypath-0">Handle absorption along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2059" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2059"><i></i></a><div id="fragbit-2059" class="collapse"><div class="fragmentcode">                                terminated = true;
                                return false;</div></div>
                         } else if (mode == 1) {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlescatteringalongraypath-0">Handle scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2060" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2060"><i></i></a><div id="fragbit-2060" class="collapse"><div class="fragmentcode">                                &lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2061" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2061"><i></i></a><div id="fragbit-2061" class="collapse"><div class="fragmentcode">                                   if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
                                       terminated = true;
                                       return false;
                                   }</div></div>
                                &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonobetaandmonor_uforreal-scatteringevent-0">Update <tt>beta</tt> and <tt>r_u</tt> for real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2062" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2062"><i></i></a><div id="fragbit-2062" class="collapse"><div class="fragmentcode">                                   Float pdf = T_maj[0] * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0];
                                   beta *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;
                                   r_u *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;</div></div>
                                if (beta &amp;&amp; r_u) {
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectlightingatvolume-scatteringevent-0">Sample direct lighting at volume-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2063" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2063"><i></i></a><div id="fragbit-2063" class="collapse"><div class="fragmentcode">                                       <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction" class="code">MediumInteraction</a> intr(p, -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>, mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>);
                                       L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(intr, nullptr, lambda, sampler, beta, r_u);</div></div>
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewdirectionatreal-scatteringevent-0">Sample new direction at real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2064" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2064"><i></i></a><div id="fragbit-2064" class="collapse"><div class="fragmentcode">                                       <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
                                       pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = intr.<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
                                       if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0)
                                           terminated = true;
                                       else {
                                           &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraypathstateforindirectvolumescattering-0">Update ray path state for indirect volume scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2065" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2065"><i></i></a><div id="fragbit-2065" class="collapse"><div class="fragmentcode">                                              beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                              r_l = r_u / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                              prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);
                                              scattered = true;
                                              ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
                                              ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                                              specularBounce = false;
                                              anyNonSpecularBounces = true;</div></div>
                                       }</div></div>
                                }
                                return false;</div></div>
                         } else {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenullscatteringalongraypath-0">Handle null scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2066" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2066"><i></i></a><div id="fragbit-2066" class="collapse"><div class="fragmentcode">                                <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = ClampZero(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
                                Float pdf = T_maj[0] * sigma_n[0];
                                beta *= T_maj * sigma_n / pdf;
                                if (pdf == 0) beta = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
                                r_u *= T_maj * sigma_n / pdf;
                                r_l *= T_maj * sigma_maj / pdf;
                                return beta &amp;&amp; r_u;</div></div>
                         }</div></div></div></div> 
               });
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleterminatedscatteredandunscatteredmediumrays-0">Handle terminated, scattered, and unscattered medium rays</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2067" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2067"><i></i></a><div id="fragbit-2067" class="collapse"><div class="fragmentcode">          if (terminated || !beta || !r_u) return L;
          if (scattered) continue;
          beta *= T_maj / T_maj[0];
          r_u *= T_maj / T_maj[0];
          r_l *= T_maj / T_maj[0];</div></div></div></div>
}
&lt;&lt;<span class="fragmentname"><a href="#fragment-Handlesurvivingunscatteredrays-0">Handle surviving unscattered rays</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2068" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2068"><i></i></a><div id="fragbit-2068" class="collapse"><div class="fragmentcode">   &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemittedlightatvolumepathvertexorfromtheenvironment-0">Add emitted light at volume path vertex or from the environment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2069" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2069"><i></i></a><div id="fragbit-2069" class="collapse"><div class="fragmentcode">      if (!si) {
          &lt;&lt;<span class="fragmentname"><a href="#fragment-Accumulatecontributionsfrominfinitelightsources-0">Accumulate contributions from infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2070" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2070"><i></i></a><div id="fragbit-2070" class="collapse"><div class="fragmentcode">             for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
                 if (<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda); <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>) {
                     if (depth == 0 || specularBounce)
                         L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> / r_u.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
                     else {
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-AddinfinitelightcontributionusingbothPDFswithMIS-0">Add infinite light contribution using both PDFs with MIS</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2071" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2071"><i></i></a><div id="fragbit-2071" class="collapse"><div class="fragmentcode">                            Float lightPDF = <a href="#VolPathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrContext, light) *
                                             light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrContext, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
                            r_l *= lightPDF;
                            L += beta * Le / (r_u + r_l).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
                     }
                 }
             }</div></div>
          break;
      }
      <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;isect = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
      if (<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a> = isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, lambda); <a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>) {
          &lt;&lt;<span class="fragmentname">Add contribution of emission from intersected surface</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2072" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2072"><i></i></a><div id="fragbit-2072" class="collapse"><div class="fragmentcode">             if (depth == 0 || specularBounce)
                 L += beta * Le / r_u.Average();
             else {
                 &lt;&lt;<span class="fragmentname">Add surface light contribution using both PDFs with MIS</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2073" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2073"><i></i></a><div id="fragbit-2073" class="collapse"><div class="fragmentcode">                    <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> areaLight(isect.areaLight);
                    Float lightPDF =
                        lightSampler.PMF(prevIntrContext, areaLight) *
                        areaLight.PDF_Li(prevIntrContext, ray.d, true);
                    r_l *= lightPDF;
                    L += beta * Le / (r_u + r_l).Average();</div></div>
             }</div></div>
      }</div></div>
   &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#fragment-GetBSDFandskipovermediumboundaries-0">Get BSDF and skip over medium boundaries</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2074" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2074"><i></i></a><div id="fragbit-2074" class="collapse"><div class="fragmentcode">      <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = isect.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, scratchBuffer, sampler);
      if (!bsdf) {
          isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
          continue;
      }</div></div>
   &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-InitializemonovisibleSurfatfirstintersection-0">Initialize <tt>visibleSurf</tt> at first intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2075" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2075"><i></i></a><div id="fragbit-2075" class="collapse"><div class="fragmentcode">      if (depth == 0 &amp;&amp; visibleSurf) {
          &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-EstimateBSDFsalbedo-0">Estimate BSDF&rsquo;s albedo</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2076" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2076"><i></i></a><div id="fragbit-2076" class="collapse"><div class="fragmentcode">             &lt;&lt;<span class="fragmentname">Define sample arrays <tt>ucRho</tt> and <tt>uRho</tt> for reflectance estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2077" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2077"><i></i></a><div id="fragbit-2077" class="collapse"><div class="fragmentcode">                constexpr int nRhoSamples = 16;
                const Float ucRho[nRhoSamples] = { 0.75741637, 0.37870818, 0.7083487, 0.18935409, 0.9149363, 0.35417435, 0.5990858, 0.09467703, 0.8578725, 0.45746812, 0.686759, 0.17708716, 0.9674518, 0.2995429, 0.5083201, 0.047338516 };
                const <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uRho[nRhoSamples] = { <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.855985, 0.570367), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.381823, 0.851844), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.285328, 0.764262), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.733380, 0.114073), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.542663, 0.344465), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.127274, 0.414848), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.964700, 0.947162), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.594089, 0.643463), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.095109, 0.170369), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.825444, 0.263359), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.429467, 0.454469), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.244460, 0.816459), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.756135, 0.731258), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.516165, 0.152852), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.180888, 0.214174), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.898579, 0.503897) };</div></div>
             <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> albedo = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::rho" class="code">rho</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, ucRho, uRho);</div></div>
          *visibleSurf = <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a>(isect, albedo, lambda);
      }</div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-Terminatepathifmaximumdepthreached-0">Terminate path if maximum depth reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2078" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2078"><i></i></a><div id="fragbit-2078" class="collapse"><div class="fragmentcode">      if (depth++ &gt;= <a href="#VolPathIntegrator::maxDepth" class="code">maxDepth</a>)
          return L;</div></div>
   &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-PossiblyregularizetheBSDF-0">Possibly regularize the BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2079" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2079"><i></i></a><div id="fragbit-2079" class="collapse"><div class="fragmentcode">      if (<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator::regularize" class="code">regularize</a> &amp;&amp; anyNonSpecularBounces)
          bsdf.<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#BSDF::Regularize" class="code">Regularize</a>();
      </div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleilluminationfromlightstofindattenuatedpathcontribution-0">Sample illumination from lights to find attenuated path contribution</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2080" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2080"><i></i></a><div id="fragbit-2080" class="collapse"><div class="fragmentcode">      if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>()))
          L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(isect, &amp;bsdf, lambda, sampler, beta, r_u);
      prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(isect);</div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFtogetnewvolumetricpathdirection-0">Sample BSDF to get new volumetric path direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2081" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2081"><i></i></a><div id="fragbit-2081" class="collapse"><div class="fragmentcode">      <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>;
      Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
      pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
      if (!bs) break;
      &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonobetaandrescaledpathprobabilitiesforBSDFscattering-0">Update <tt>beta</tt> and rescaled path probabilities for BSDF scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2082" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2082"><i></i></a><div id="fragbit-2082" class="collapse"><div class="fragmentcode">         beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, isect.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
         if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional" class="code">pdfIsProportional</a>)
             r_l = r_u / bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>);
         else
             r_l = r_u / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
      &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatevolumetricintegratorpathstateaftersurfacescattering-0">Update volumetric integrator path state after surface scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2083" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2083"><i></i></a><div id="fragbit-2083" class="collapse"><div class="fragmentcode">         specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
         anyNonSpecularBounces |= !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
         if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>())
             etaScale *= <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);
         ray = isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(ray, bsdf, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::flags" class="code">flags</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);</div></div></div></div>
   &lt;&lt;<span class="fragmentname">Account for attenuated subsurface scattering, if applicable</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2084" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2084"><i></i></a><div id="fragbit-2084" class="collapse"><div class="fragmentcode">      BSSRDF bssrdf = isect.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSSRDF" class="code">GetBSSRDF</a>(ray, lambda, <a href="../Introduction/pbrt_System_Overview.html#ImageTileIntegrator::camera" class="code">camera</a>, scratchBuffer);
      if (bssrdf &amp;&amp; bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>()) {
          &lt;&lt;<span class="fragmentname">Sample BSSRDF probe segment to find exit point</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2085" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2085"><i></i></a><div id="fragbit-2085" class="collapse"><div class="fragmentcode">             Float uc = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
             <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> up = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
             pstd::optional&lt;BSSRDFProbeSegment&gt; probeSeg = bssrdf.SampleSp(uc, up);
             if (!probeSeg) break;</div></div>
          &lt;&lt;<span class="fragmentname">Sample random intersection along BSSRDF probe segment</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2086" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2086"><i></i></a><div id="fragbit-2086" class="collapse"><div class="fragmentcode">             uint64_t seed = <a href="../Utilities/Mathematical_Infrastructure.html#MixBits" class="code">MixBits</a>(<a href="../Shapes/Managing_Rounding_Error.html#FloatToBits" class="code">FloatToBits</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>()));
             <a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler" class="code">WeightedReservoirSampler</a>&lt;SubsurfaceInteraction&gt; interactionSampler(seed);
             &lt;&lt;<span class="fragmentname">Intersect BSSRDF sampling ray against the scene geometry</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2087" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2087"><i></i></a><div id="fragbit-2087" class="collapse"><div class="fragmentcode">                <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> base(probeSeg-&gt;p0, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, <a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>());
                while (true) {
                    <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> r = base.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(probeSeg-&gt;p1);
                    pstd::optional&lt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection" class="code">ShapeIntersection</a>&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(r, 1);
                    if (!si) break;
                    base = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
                    if (si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a> == isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a>)
                        interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::Add" class="code">Add</a>(SubsurfaceInteraction(si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>), 1.f);
                }</div></div>
             if (!interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::HasSample" class="code">HasSample</a>())
                 break;</div></div>
          &lt;&lt;<span class="fragmentname">Convert probe intersection to <tt>BSSRDFSample</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2088" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2088"><i></i></a><div id="fragbit-2088" class="collapse"><div class="fragmentcode">             SubsurfaceInteraction ssi = interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::GetSample" class="code">GetSample</a>();
             BSSRDFSample bssrdfSample =
                 bssrdf.ProbeIntersectionToSample(ssi, scratchBuffer);
             if (!bssrdfSample.Sp || !bssrdfSample.pdf) break;</div></div>
          &lt;&lt;<span class="fragmentname">Update path state for subsurface scattering</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2089" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2089"><i></i></a><div id="fragbit-2089" class="collapse"><div class="fragmentcode">             Float pdf = interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::SampleProbability" class="code">SampleProbability</a>() * bssrdfSample.pdf[0];
             beta *= bssrdfSample.Sp / pdf;
             r_u *= bssrdfSample.pdf / bssrdfSample.pdf[0];
             <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> pi = ssi;
             pi.wo = bssrdfSample.wo;
             prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(pi);
             &lt;&lt;<span class="fragmentname">Possibly regularize subsurface BSDF</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2090" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2090"><i></i></a><div id="fragbit-2090" class="collapse"><div class="fragmentcode">                <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> &amp;Sw = bssrdfSample.Sw;
                anyNonSpecularBounces = true;
                if (<a href="#VolPathIntegrator::regularize" class="code">regularize</a>)
                    Sw.<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#BSDF::Regularize" class="code">Regularize</a>();
                </div></div></div></div>
          &lt;&lt;<span class="fragmentname">Account for attenuated direct illumination subsurface scattering</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2091" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2091"><i></i></a><div id="fragbit-2091" class="collapse"><div class="fragmentcode">             L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(pi, &amp;Sw, lambda, sampler, beta, r_u);</div></div>
          &lt;&lt;<span class="fragmentname">Sample ray for indirect subsurface scattering</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2092" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2092"><i></i></a><div id="fragbit-2092" class="collapse"><div class="fragmentcode">             Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
             pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = Sw.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(pi.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
             if (!bs) break;
             beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, pi.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
             r_l = r_u / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
             specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
             ray = <a href="../Geometry_and_Transformations/Rays.html#RayDifferential" class="code">RayDifferential</a>(pi.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));</div></div>
      }</div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatevolumetricpathwithRussianroulette-0">Possibly terminate volumetric path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2093" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2093"><i></i></a><div id="fragbit-2093" class="collapse"><div class="fragmentcode">      <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> rrBeta = beta * etaScale / r_u.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
      Float uRR = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
      if (rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 1 &amp;&amp; depth &gt; 1) {
          Float q = std::max&lt;Float&gt;(0, 1 - rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
          if (uRR &lt; q) break;
          beta /= 1 - q;
      }</div></div></div></div></div><p>


</p>
<p>The form of the fragment for sampling the medium is similar as well:
<tt>tMax</tt> is set using the ray intersection <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg>, if available, and an
<a href="../Utilities/Mathematical_Infrastructure.html#RNG"><tt>RNG</tt></a> is prepared before medium sampling proceeds. If the path is
terminated or undergoes real scattering in the medium, then no further work
is done to sample surface scattering at a ray intersection point.

</p>
<p></p>
<span class="anchor" id="fragment-Sampletheparticipatingmedium-0"></span><div class="fragmentname">&lt;&lt;Sample the participating medium&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">bool scattered = false, terminated = false;
Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : <a href="../Shapes/Managing_Rounding_Error.html#Infinity" class="code">Infinity</a>;
&lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonoRNGforsamplingthemajoranttransmittance-0">Initialize <tt>RNG</tt> for sampling the majorant transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2094" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2094"><i></i></a><div id="fragbit-2094" class="collapse"><div class="fragmentcode">   uint64_t hash0 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
   uint64_t hash1 = <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>());
   <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(hash0, hash1);</div></div>
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj = <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(ray, tMax, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>(), rng, lambda,
        [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
            <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) {
            &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlemediumscatteringeventforray-0">Handle medium scattering event for ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2095" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2095"><i></i></a><div id="fragbit-2095" class="collapse"><div class="fragmentcode">               &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemissionfrommediumscatteringevent-0">Add emission from medium scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2096" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2096"><i></i></a><div id="fragbit-2096" class="collapse"><div class="fragmentcode">                  if (depth &lt; <a href="#VolPathIntegrator::maxDepth" class="code">maxDepth</a> &amp;&amp; mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Computebetaatnewpathvertex-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.242ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 965.1 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="815" y="513"></use>
</g>
</svg> at new path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2097" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2097"><i></i></a><div id="fragbit-2097" class="collapse"><div class="fragmentcode">                         Float pdf = sigma_maj[0] * T_maj[0];
                         <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> betap = beta * T_maj / pdf;</div></div>
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Computerescaledpathprobabilityforabsorptionatpathvertex-0">Compute rescaled path probability for absorption at path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2098" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2098"><i></i></a><div id="fragbit-2098" class="collapse"><div class="fragmentcode">                         <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> r_e = r_u * sigma_maj * T_maj / pdf;</div></div>
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoLformediumemission-0">Update <tt>L</tt> for medium emission</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2099" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2099"><i></i></a><div id="fragbit-2099" class="collapse"><div class="fragmentcode">                         if (r_e)
                             L += betap * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a> / r_e.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
                  }</div></div>
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Computemediumeventprobabilitiesforinteraction-0">Compute medium event probabilities for interaction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2100" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2100"><i></i></a><div id="fragbit-2100" class="collapse"><div class="fragmentcode">                  Float pAbsorb = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a>[0] / sigma_maj[0];
                  Float pScatter = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0] / sigma_maj[0];
                  Float pNull = std::max&lt;Float&gt;(0, 1 - pAbsorb - pScatter);</div></div>
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplemediumscatteringeventtypeandupdatepath-0">Sample medium scattering event type and update path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2101" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2101"><i></i></a><div id="fragbit-2101" class="collapse"><div class="fragmentcode">                  Float um = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::Uniform" class="code">Uniform</a>&lt;Float&gt;();
                  int mode = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>({pAbsorb, pScatter, pNull}, um);
                  if (mode == 0) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleabsorptionalongraypath-0">Handle absorption along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2102" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2102"><i></i></a><div id="fragbit-2102" class="collapse"><div class="fragmentcode">                         terminated = true;
                         return false;</div></div>
                  } else if (mode == 1) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlescatteringalongraypath-0">Handle scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2103" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2103"><i></i></a><div id="fragbit-2103" class="collapse"><div class="fragmentcode">                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2104" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2104"><i></i></a><div id="fragbit-2104" class="collapse"><div class="fragmentcode">                            if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
                                terminated = true;
                                return false;
                            }</div></div>
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonobetaandmonor_uforreal-scatteringevent-0">Update <tt>beta</tt> and <tt>r_u</tt> for real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2105" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2105"><i></i></a><div id="fragbit-2105" class="collapse"><div class="fragmentcode">                            Float pdf = T_maj[0] * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0];
                            beta *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;
                            r_u *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;</div></div>
                         if (beta &amp;&amp; r_u) {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectlightingatvolume-scatteringevent-0">Sample direct lighting at volume-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2106" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2106"><i></i></a><div id="fragbit-2106" class="collapse"><div class="fragmentcode">                                <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction" class="code">MediumInteraction</a> intr(p, -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>, mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>);
                                L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(intr, nullptr, lambda, sampler, beta, r_u);</div></div>
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewdirectionatreal-scatteringevent-0">Sample new direction at real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2107" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2107"><i></i></a><div id="fragbit-2107" class="collapse"><div class="fragmentcode">                                <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
                                pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = intr.<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
                                if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0)
                                    terminated = true;
                                else {
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraypathstateforindirectvolumescattering-0">Update ray path state for indirect volume scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2108" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2108"><i></i></a><div id="fragbit-2108" class="collapse"><div class="fragmentcode">                                       beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                       r_l = r_u / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                       prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);
                                       scattered = true;
                                       ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
                                       ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                                       specularBounce = false;
                                       anyNonSpecularBounces = true;</div></div>
                                }</div></div>
                         }
                         return false;</div></div>
                  } else {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenullscatteringalongraypath-0">Handle null scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2109" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2109"><i></i></a><div id="fragbit-2109" class="collapse"><div class="fragmentcode">                         <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = ClampZero(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
                         Float pdf = T_maj[0] * sigma_n[0];
                         beta *= T_maj * sigma_n / pdf;
                         if (pdf == 0) beta = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
                         r_u *= T_maj * sigma_n / pdf;
                         r_l *= T_maj * sigma_maj / pdf;
                         return beta &amp;&amp; r_u;</div></div>
                  }</div></div></div></div> 
        });
&lt;&lt;<span class="fragmentname"><a href="#fragment-Handleterminatedscatteredandunscatteredmediumrays-0">Handle terminated, scattered, and unscattered medium rays</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2110" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2110"><i></i></a><div id="fragbit-2110" class="collapse"><div class="fragmentcode">   if (terminated || !beta || !r_u) return L;
   if (scattered) continue;
   beta *= T_maj / T_maj[0];
   r_u *= T_maj / T_maj[0];
   r_l *= T_maj / T_maj[0];</div></div></div><p>


</p>
<p>Given a sampled point <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.194ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 944.6 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="513"></use>
</g>
</svg> in the medium, the lambda function&rsquo;s task is
to evaluate the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.729ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1175 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="963" y="-213"></use>
</g>
</svg> source function, taking care of the second
case of Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:volpath-surf-vol-simple-estimator">14.7</a>).

</p>
<p></p>
<span class="anchor" id="fragment-Handlemediumscatteringeventforray-0"></span><div class="fragmentname">&lt;&lt;Handle medium scattering event for ray&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Addemissionfrommediumscatteringevent-0">Add emission from medium scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2111" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2111"><i></i></a><div id="fragbit-2111" class="collapse"><div class="fragmentcode">   if (depth &lt; <a href="#VolPathIntegrator::maxDepth" class="code">maxDepth</a> &amp;&amp; mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computebetaatnewpathvertex-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.242ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 965.1 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="815" y="513"></use>
</g>
</svg> at new path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2112" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2112"><i></i></a><div id="fragbit-2112" class="collapse"><div class="fragmentcode">          Float pdf = sigma_maj[0] * T_maj[0];
          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> betap = beta * T_maj / pdf;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computerescaledpathprobabilityforabsorptionatpathvertex-0">Compute rescaled path probability for absorption at path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2113" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2113"><i></i></a><div id="fragbit-2113" class="collapse"><div class="fragmentcode">          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> r_e = r_u * sigma_maj * T_maj / pdf;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoLformediumemission-0">Update <tt>L</tt> for medium emission</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2114" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2114"><i></i></a><div id="fragbit-2114" class="collapse"><div class="fragmentcode">          if (r_e)
              L += betap * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a> / r_e.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Computemediumeventprobabilitiesforinteraction-0">Compute medium event probabilities for interaction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2115" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2115"><i></i></a><div id="fragbit-2115" class="collapse"><div class="fragmentcode">   Float pAbsorb = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a>[0] / sigma_maj[0];
   Float pScatter = mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0] / sigma_maj[0];
   Float pNull = std::max&lt;Float&gt;(0, 1 - pAbsorb - pScatter);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Samplemediumscatteringeventtypeandupdatepath-0">Sample medium scattering event type and update path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2116" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2116"><i></i></a><div id="fragbit-2116" class="collapse"><div class="fragmentcode">   Float um = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::Uniform" class="code">Uniform</a>&lt;Float&gt;();
   int mode = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>({pAbsorb, pScatter, pNull}, um);
   if (mode == 0) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleabsorptionalongraypath-0">Handle absorption along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2117" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2117"><i></i></a><div id="fragbit-2117" class="collapse"><div class="fragmentcode">          terminated = true;
          return false;</div></div>
   } else if (mode == 1) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlescatteringalongraypath-0">Handle scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2118" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2118"><i></i></a><div id="fragbit-2118" class="collapse"><div class="fragmentcode">          &lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2119" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2119"><i></i></a><div id="fragbit-2119" class="collapse"><div class="fragmentcode">             if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
                 terminated = true;
                 return false;
             }</div></div>
          &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonobetaandmonor_uforreal-scatteringevent-0">Update <tt>beta</tt> and <tt>r_u</tt> for real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2120" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2120"><i></i></a><div id="fragbit-2120" class="collapse"><div class="fragmentcode">             Float pdf = T_maj[0] * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0];
             beta *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;
             r_u *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;</div></div>
          if (beta &amp;&amp; r_u) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectlightingatvolume-scatteringevent-0">Sample direct lighting at volume-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2121" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2121"><i></i></a><div id="fragbit-2121" class="collapse"><div class="fragmentcode">                 <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction" class="code">MediumInteraction</a> intr(p, -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>, mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>);
                 L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(intr, nullptr, lambda, sampler, beta, r_u);</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewdirectionatreal-scatteringevent-0">Sample new direction at real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2122" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2122"><i></i></a><div id="fragbit-2122" class="collapse"><div class="fragmentcode">                 <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
                 pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = intr.<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
                 if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0)
                     terminated = true;
                 else {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraypathstateforindirectvolumescattering-0">Update ray path state for indirect volume scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2123" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2123"><i></i></a><div id="fragbit-2123" class="collapse"><div class="fragmentcode">                        beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                        r_l = r_u / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                        prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);
                        scattered = true;
                        ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
                        ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                        specularBounce = false;
                        anyNonSpecularBounces = true;</div></div>
                 }</div></div>
          }
          return false;</div></div>
   } else {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenullscatteringalongraypath-0">Handle null scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2124" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2124"><i></i></a><div id="fragbit-2124" class="collapse"><div class="fragmentcode">          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = ClampZero(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
          Float pdf = T_maj[0] * sigma_n[0];
          beta *= T_maj * sigma_n / pdf;
          if (pdf == 0) beta = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
          r_u *= T_maj * sigma_n / pdf;
          r_l *= T_maj * sigma_maj / pdf;
          return beta &amp;&amp; r_u;</div></div>
   }</div></div></div><p>


</p>
<p>A small difference from the <a href="#SimpleVolPathIntegrator"><tt>SimpleVolPathIntegrator</tt></a> is that
volumetric emission is added at every point that is sampled in the medium
rather than only when the absorption case is sampled.  There is no reason
not to do so, since emission is already available via the
<a href="../Volume_Scattering/Media.html#MediumProperties"><tt>MediumProperties</tt></a> passed to the lambda function.

</p>
<p></p>
<span class="anchor" id="fragment-Addemissionfrommediumscatteringevent-0"></span><div class="fragmentname">&lt;&lt;Add emission from medium scattering event&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (depth &lt; <a href="#VolPathIntegrator::maxDepth" class="code">maxDepth</a> &amp;&amp; mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a>) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Computebetaatnewpathvertex-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.242ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 965.1 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="815" y="513"></use>
</g>
</svg> at new path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2125" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2125"><i></i></a><div id="fragbit-2125" class="collapse"><div class="fragmentcode">       Float pdf = sigma_maj[0] * T_maj[0];
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> betap = beta * T_maj / pdf;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Computerescaledpathprobabilityforabsorptionatpathvertex-0">Compute rescaled path probability for absorption at path vertex</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2126" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2126"><i></i></a><div id="fragbit-2126" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> r_e = r_u * sigma_maj * T_maj / pdf;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoLformediumemission-0">Update <tt>L</tt> for medium emission</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2127" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2127"><i></i></a><div id="fragbit-2127" class="collapse"><div class="fragmentcode">       if (r_e)
           L += betap * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a> / r_e.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
}</div><p>


</p>
<p>In the following, we will sometimes use the notation <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.839ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3805.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket normal p Subscript Baseline overbar Subscript n Baseline plus normal p prime right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="1581" y="0"></use>
<g transform="translate(2582,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="3527" y="0"></use>
</g>
</svg> to denote
the path <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.511ex" height="2.509ex" style="vertical-align: -0.838ex;" viewBox="0 -719.6 1081.1 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline overbar Subscript n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
</svg> with the vertex <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.194ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 944.6 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="513"></use>
</g>
</svg> appended to it.  Thus, for
example, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.866ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 7261.7 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript Baseline overbar Subscript n Baseline equals left-bracket normal p Subscript Baseline overbar Subscript n minus 1 Baseline plus normal p Subscript Baseline Subscript n Baseline right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1358" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="2415" y="0"></use>
<g transform="translate(2693,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1379" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="4901" y="0"></use>
<g transform="translate(5902,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="6983" y="0"></use>
</g>
</svg>.
The estimator that gives the contribution for volumetric emission at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.194ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 944.6 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="513"></use>
</g>
</svg>
is then
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:volpath-emission-basic-estimator"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="32.462ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 13976.7 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta left-parenthesis left-bracket normal p Subscript Baseline overbar Subscript n Baseline plus normal p Superscript prime Baseline right-bracket right-parenthesis sigma Subscript normal a Baseline left-parenthesis normal p Superscript prime Baseline right-parenthesis upper L Subscript normal e Baseline left-parenthesis normal p prime right-arrow normal p Subscript Baseline Subscript n Baseline right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="574" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="964" y="0"></use>
<g transform="translate(1242,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="2545" y="0"></use>
<g transform="translate(3546,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="4491" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4769" y="0"></use>
<g transform="translate(5325,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6351" y="0"></use>
<g transform="translate(6740,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7685" y="0"></use>
<g transform="translate(8241,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="9337" y="0"></use>
<g transform="translate(9726,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="10949" y="0"></use>
<g transform="translate(12227,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="13308" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="13698" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:volpath-emission-basic-estimator">14.28</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

<tt>beta</tt> holds <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.655ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2434.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="574" y="0"></use>
<g transform="translate(964,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2045" y="0"></use>
</g>
</svg>, so we can incrementally compute
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.983ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 5159.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta left-parenthesis left-bracket normal p Subscript Baseline overbar Subscript n Baseline plus normal p prime right-bracket right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="574" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="964" y="0"></use>
<g transform="translate(1242,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="2545" y="0"></use>
<g transform="translate(3546,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="4491" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4769" y="0"></use>
</g>
</svg> by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="37.018ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 15938.4 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta left-parenthesis left-bracket normal p Subscript Baseline overbar Subscript n Baseline plus normal p Superscript prime Baseline right-bracket right-parenthesis equals StartFraction beta left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis upper T Subscript normal m normal a normal j Baseline left-parenthesis normal p Subscript Baseline Subscript n Baseline right-arrow normal p Superscript prime Baseline right-parenthesis Over p Subscript normal e Baseline left-parenthesis normal p Superscript prime Baseline right-parenthesis p Subscript normal m normal a normal j Baseline left-parenthesis normal p prime vertical-bar normal p Subscript Baseline Subscript n Baseline comma omega Subscript Baseline right-parenthesis EndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="574" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="964" y="0"></use>
<g transform="translate(1242,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="2545" y="0"></use>
<g transform="translate(3546,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="4491" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4769" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="5436" y="0"></use>
<g transform="translate(6215,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="8926" height="60" x="0" y="220"></rect>
<g transform="translate(60,815)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="574" y="0"></use>
<g transform="translate(964,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2045" y="0"></use>
<g transform="translate(2601,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4445" y="0"></use>
<g transform="translate(4835,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="6194" y="0"></use>
<g transform="translate(7472,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="8417" y="0"></use>
</g>
<g transform="translate(102,-771)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="917" y="0"></use>
<g transform="translate(1307,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2251" y="0"></use>
<g transform="translate(2808,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4571" y="0"></use>
<g transform="translate(4961,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="5905" y="0"></use>
<g transform="translate(6184,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7265" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="7710" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="8333" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="15659" y="0"></use>
</g>
</svg>
</div>
<p>

From Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#sec:evaluating-volumetric-path-integral">14.1.5</a>, we know that
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="29.169ex" height="3.176ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 12558.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal m normal a normal j Baseline left-parenthesis normal p Subscript Baseline Subscript i plus 1 Baseline vertical-bar normal p Subscript Baseline Subscript i Baseline comma omega Subscript Baseline right-parenthesis equals sigma Subscript normal m normal a normal j Baseline normal e Superscript minus sigma Super Subscript normal m normal a normal j Superscript t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1763" y="0"></use>
<g transform="translate(2153,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="345" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1124" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="3958" y="0"></use>
<g transform="translate(4236,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="5137" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="5582" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6205" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="6872" y="0"></use>
<g transform="translate(7928,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
<g transform="translate(9760,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="0" y="0"></use>
<g transform="translate(444,362)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
<g transform="translate(550,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(404,-135)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="2781" y="0"></use>
</g>
</g>
</g>
</svg>.  Because we are always sampling absorption (at least as far as
including emission goes), <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.205ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 949.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="712" y="-213"></use>
</g>
</svg> is&nbsp;1 here.

</p>
<p></p>
<span class="anchor" id="fragment-Computebetaatnewpathvertex-0"></span><div class="fragmentname">&lt;&lt;Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.242ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 965.1 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="815" y="513"></use>
</g>
</svg> at new path vertex&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pdf = sigma_maj[0] * T_maj[0];
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> betap = beta * T_maj / pdf;</div><p>


</p>
<p>Even though this is the only sampling technique for volumetric emission,
different wavelengths may sample this vertex with different probabilities,
so it is worthwhile to apply MIS over the wavelengths&rsquo; probabilities.  With
<tt>r_u</tt> storing the rescaled unidirectional probabilities up to the
previous path vertex, the rescaled path probabilities for sampling the
emissive vertex, <tt>r_e</tt>, can be found by multiplying <tt>r_u</tt> by
the per-wavelength <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.169ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1795 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg> probabilities and dividing by the
probability for the wavelength that was used for sampling <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.194ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 944.6 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="513"></use>
</g>
</svg>, which is
already available in <tt>pdf</tt>.  (Note that in monochromatic media, these
ratios are all&nbsp;1.)

</p>
<p></p>
<span class="anchor" id="fragment-Computerescaledpathprobabilityforabsorptionatpathvertex-0"></span><div class="fragmentname">&lt;&lt;Compute rescaled path probability for absorption at path vertex&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> r_e = r_u * sigma_maj * T_maj / pdf;</div><p>


</p>
<p>Here we have a single-sample MIS estimator with balance heuristic weights
given&nbsp;by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:volpath-emission-spectral-mis"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="39.738ex" height="6.509ex" style="vertical-align: -3.171ex;" viewBox="0 -1437.2 17109.4 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript normal e Baseline left-parenthesis left-bracket normal p Subscript Baseline overbar Subscript n Baseline plus normal p Superscript prime Baseline right-bracket right-parenthesis equals StartStartFraction 1 OverOver StartFraction 1 Over m EndFraction sigma-summation Underscript i Overscript m Endscripts r Subscript normal e comma lamda Sub Subscript i Subscript Baseline left-parenthesis left-bracket normal p Subscript Baseline overbar Subscript n Baseline plus normal p Superscript prime Baseline right-bracket right-parenthesis EndEndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45A" d="M848 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 20 4 31 13 55c20 53 62 167 62 224c0 36 -11 70 -54 70c-109 0 -162 -120 -165 -133l-60 -241c-8 -32 -14 -57 -45 -57c-15 0 -29 9 -29 27c0 5 9 39 13 59c9 33 10 39 20 76l28 116c8 30 15 58 15 83 c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84c0 38 -15 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23 c0 0 -12 0 -12 10c0 3 13 62 31 97c9 18 28 57 74 57c45 0 87 -30 92 -87c17 23 66 87 156 87c25 0 57 -5 82 -26c28 -24 31 -58 32 -71c37 53 88 97 163 97s115 -42 115 -107c0 -57 -42 -168 -61 -220c-9 -22 -18 -46 -18 -71c0 -23 7 -33 24 -33c55 0 87 71 102 124 c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNOPERATORS-2211" d="M999 -1l-86 -249h-829c-18 0 -27 0 -27 11c0 4 1 6 9 16l355 439l-365 502c0 31 1 32 28 32h829l86 -234h-25c-70 187 -300 194 -414 194h-396l325 -446c6 -9 7 -10 7 -14s-2 -7 -9 -16l-347 -429h425c147 0 216 24 232 29c85 29 152 90 177 165h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="1013" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1130" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="1520" y="0"></use>
<g transform="translate(1798,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="3102" y="0"></use>
<g transform="translate(4102,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="5047" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5326" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="5993" y="0"></use>
<g transform="translate(6771,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="9541" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="4520" y="676"></use>
<g transform="translate(60,-937)">
<g transform="translate(120,0)">
<rect stroke="none" width="741" height="60" x="0" y="220"></rect>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="273" y="629"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="84" y="-488"></use>
</g>
<g transform="translate(1147,0)">
 <use xlink:href="#E1-LATINMODERNOPERATORS-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45A" x="1494" y="675"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="1494" y="-405"></use>
</g>
<g transform="translate(3092,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
<g transform="translate(451,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="444" y="0"></use>
<g transform="translate(511,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="718" y="-238"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4836" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="5226" y="0"></use>
<g transform="translate(5504,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="6807" y="0"></use>
<g transform="translate(7808,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="408"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="8753" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="9031" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="16830" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:volpath-emission-spectral-mis">14.29</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>


</p>
<p>The absorption coefficient and emitted radiance for evaluating
Equation&nbsp;(<a href="#eq:volpath-emission-basic-estimator">14.28</a>) are available in
<a href="../Volume_Scattering/Media.html#MediumProperties"><tt>MediumProperties</tt></a> and the <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average"><tt>SampledSpectrum::Average()</tt></a> method
conveniently computes the average of rescaled probabilities in the
denominator of Equation&nbsp;(<a href="#eq:volpath-emission-spectral-mis">14.29</a>).

</p>
<p></p>
<span class="anchor" id="fragment-UpdatemonoLformediumemission-0"></span><div class="fragmentname">&lt;&lt;Update <tt>L</tt> for medium emission&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (r_e)
    L += betap * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::Le" class="code">Le</a> / r_e.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div><p>


</p>
<p>Briefly returning to the initialization of <tt>betap</tt> and <tt>r_e</tt> in
the previous fragments: it may seem tempting to cancel out the
<tt>T_maj</tt> factors from them, but note how the final estimator does not
perform a component-wise division of these two quantities but instead
divides by the average of the rescaled probabilities when computing the MIS
weight.  Thus, performing such cancellations would lead to incorrect
results.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="This misconception periodically played a role in our
initial development of this integrator.">
      <sup>&dagger;</sup>
    </button>
		

</p>
<p>After emission is handled, the next step is to determine which term of
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.729ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1175 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="963" y="-213"></use>
</g>
</svg> to evaluate; this follows the same
approach as in the <tt>SimpleVolPathIntegrator</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Samplemediumscatteringeventtypeandupdatepath-0"></span><div class="fragmentname">&lt;&lt;Sample medium scattering event type and update path&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float um = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::Uniform" class="code">Uniform</a>&lt;Float&gt;();
int mode = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>({pAbsorb, pScatter, pNull}, um);
if (mode == 0) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleabsorptionalongraypath-0">Handle absorption along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2128" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2128"><i></i></a><div id="fragbit-2128" class="collapse"><div class="fragmentcode">       terminated = true;
       return false;</div></div>
} else if (mode == 1) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlescatteringalongraypath-0">Handle scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2129" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2129"><i></i></a><div id="fragbit-2129" class="collapse"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2130" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2130"><i></i></a><div id="fragbit-2130" class="collapse"><div class="fragmentcode">          if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
              terminated = true;
              return false;
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonobetaandmonor_uforreal-scatteringevent-0">Update <tt>beta</tt> and <tt>r_u</tt> for real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2131" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2131"><i></i></a><div id="fragbit-2131" class="collapse"><div class="fragmentcode">          Float pdf = T_maj[0] * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0];
          beta *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;
          r_u *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;</div></div>
       if (beta &amp;&amp; r_u) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectlightingatvolume-scatteringevent-0">Sample direct lighting at volume-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2132" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2132"><i></i></a><div id="fragbit-2132" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction" class="code">MediumInteraction</a> intr(p, -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>, mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>);
              L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(intr, nullptr, lambda, sampler, beta, r_u);</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewdirectionatreal-scatteringevent-0">Sample new direction at real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2133" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2133"><i></i></a><div id="fragbit-2133" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
              pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = intr.<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
              if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0)
                  terminated = true;
              else {
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraypathstateforindirectvolumescattering-0">Update ray path state for indirect volume scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2134" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2134"><i></i></a><div id="fragbit-2134" class="collapse"><div class="fragmentcode">                     beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                     r_l = r_u / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                     prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);
                     scattered = true;
                     ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
                     ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                     specularBounce = false;
                     anyNonSpecularBounces = true;</div></div>
              }</div></div>
       }
       return false;</div></div>
} else {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenullscatteringalongraypath-0">Handle null scattering along ray path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2135" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2135"><i></i></a><div id="fragbit-2135" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = ClampZero(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
       Float pdf = T_maj[0] * sigma_n[0];
       beta *= T_maj * sigma_n / pdf;
       if (pdf == 0) beta = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
       r_u *= T_maj * sigma_n / pdf;
       r_l *= T_maj * sigma_maj / pdf;
       return beta &amp;&amp; r_u;</div></div>
}</div><p>


</p>
<p>As before, the ray path is terminated in the event of absorption.  Since
any volumetric emission at the sampled point has already been added, there
is nothing to do but handle the details associated with ending the path.

</p>
<p></p>
<span class="anchor" id="fragment-Handleabsorptionalongraypath-0"></span><div class="fragmentname">&lt;&lt;Handle absorption along ray path&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">terminated = true;
return false;</div><p>


</p>
<p>For a real-scattering event, a shadow ray is traced to a light to sample
direct lighting, and the path state is updated to account for the new ray.
A <tt>false</tt> value returned from the lambda function prevents further
sample generation along the current ray.

</p>
<p></p>
<span class="anchor" id="fragment-Handlescatteringalongraypath-0"></span><div class="fragmentname">&lt;&lt;Handle scattering along ray path&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Stoppathsamplingifmaximumdepthhasbeenreached-0">Stop path sampling if maximum depth has been reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2136" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2136"><i></i></a><div id="fragbit-2136" class="collapse"><div class="fragmentcode">   if (depth++ &gt;= <a href="#SimpleVolPathIntegrator::maxDepth" class="code">maxDepth</a>) {
       terminated = true;
       return false;
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonobetaandmonor_uforreal-scatteringevent-0">Update <tt>beta</tt> and <tt>r_u</tt> for real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2137" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2137"><i></i></a><div id="fragbit-2137" class="collapse"><div class="fragmentcode">   Float pdf = T_maj[0] * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0];
   beta *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;
   r_u *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;</div></div>
if (beta &amp;&amp; r_u) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectlightingatvolume-scatteringevent-0">Sample direct lighting at volume-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2138" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2138"><i></i></a><div id="fragbit-2138" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction" class="code">MediumInteraction</a> intr(p, -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>, mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>);
       L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(intr, nullptr, lambda, sampler, beta, r_u);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplenewdirectionatreal-scatteringevent-0">Sample new direction at real-scattering event</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2139" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2139"><i></i></a><div id="fragbit-2139" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
       pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = intr.<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
       if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0)
           terminated = true;
       else {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraypathstateforindirectvolumescattering-0">Update ray path state for indirect volume scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2140" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2140"><i></i></a><div id="fragbit-2140" class="collapse"><div class="fragmentcode">              beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
              r_l = r_u / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
              prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);
              scattered = true;
              ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
              ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
              specularBounce = false;
              anyNonSpecularBounces = true;</div></div>
       }</div></div>
}
return false;</div><p>


</p>
<p>The PDF for real scattering at this vertex is the product of the PDF for
sampling its distance along the ray, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.068ex" height="3.176ex" style="vertical-align: -1.005ex;" viewBox="0 -934.9 4765.4 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal m normal a normal j Baseline normal e Superscript minus sigma Super Subscript normal m normal a normal j Superscript t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
<g transform="translate(1998,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="0" y="0"></use>
<g transform="translate(444,362)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
<g transform="translate(550,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(404,-135)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D461" x="2781" y="0"></use>
</g>
</g>
</g>
</svg>, and the probability for sampling real scattering,
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.627ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 5006.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s Baseline left-parenthesis normal p prime right-parenthesis slash sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="950" y="0"></use>
<g transform="translate(1339,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="787" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2284" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="2674" y="0"></use>
<g transform="translate(3174,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</svg>.  The <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.254ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1831.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg> values cancel.

</p>
<p>Given the PDF value, <tt>beta</tt> can be updated to include <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.284ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1844.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg>
along the segment up to the new vertex divided by the PDF.  The rescaled
probabilities are computed in the same way as the path sampling PDF before
being divided by it, following
Equation&nbsp;(<a href="#eq:volpath-rescaled-path-probabilities">14.26</a>).  The rescaled
light path probabilities will be set shortly, after a new ray direction is
sampled.

</p>
<p></p>
<span class="anchor" id="fragment-Updatemonobetaandmonor_uforreal-scatteringevent-0"></span><div class="fragmentname">&lt;&lt;Update <tt>beta</tt> and <tt>r_u</tt> for real-scattering event&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pdf = T_maj[0] * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>[0];
beta *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;
r_u *= T_maj * mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a> / pdf;</div><p>


</p>
<p>Direct lighting is handled by the <tt>SampleLd()</tt> method, which we will
defer until later in this section.

</p>
<p></p>
<span class="anchor" id="fragment-Sampledirectlightingatvolume-scatteringevent-0"></span><div class="fragmentname">&lt;&lt;Sample direct lighting at volume-scattering event&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction" class="code">MediumInteraction</a> intr(p, -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>, mp.<a href="../Volume_Scattering/Media.html#MediumProperties::phase" class="code">phase</a>);
L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(intr, nullptr, lambda, sampler, beta, r_u);</div><p>


</p>
<p>Sampling the phase function gives a new direction at the
scattering event.  

</p>
<p></p>
<span class="anchor" id="fragment-Samplenewdirectionatreal-scatteringevent-0"></span><div class="fragmentname">&lt;&lt;Sample new direction at real-scattering event&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = intr.<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::Sample_p" class="code">Sample_p</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, u);
if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0)
    terminated = true;
else {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraypathstateforindirectvolumescattering-0">Update ray path state for indirect volume scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2141" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2141"><i></i></a><div id="fragbit-2141" class="collapse"><div class="fragmentcode">       beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
       r_l = r_u / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
       prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);
       scattered = true;
       ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
       ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
       specularBounce = false;
       anyNonSpecularBounces = true;</div></div>
}</div><p>


</p>
<p>There is a bit of bookkeeping to take care of after a real-scattering
event.  We can now incorporate the phase function value into <tt>beta</tt>,
which completes the contribution of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.283ex" height="3.176ex" style="vertical-align: -0.671ex;" viewBox="0 -1078.4 552.5 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove f With caret</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="539" y="227"></use>
</g>
</svg> from
Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:scatfun-generalized">14.12</a>).  Because both unidirectional path
sampling and light path sampling use the same set of sampling operations up
to a real-scattering vertex, an initial value for the rescaled light path
sampling probabilities <tt>r_l</tt> comes from the value of the rescaled
unidirectional probabilities before scattering.  It is divided by the
directional PDF from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.636ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1996.1 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u comma lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</svg> for this vertex here.  The
associated directional PDF for light sampling at this vertex will be
incorporated into <tt>r_l</tt> later.  There is no need to update
<tt>r_u</tt> here, since the scattering direction&rsquo;s probability is the same
for all wavelengths and so the update factor would always be&nbsp;1.

</p>
<p>At this point, the integrator also updates various variables that record the scattering
history and updates the current ray.

</p>
<p></p>
<span class="anchor" id="fragment-Updateraypathstateforindirectvolumescattering-0"></span><div class="fragmentname">&lt;&lt;Update ray path state for indirect volume scattering&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">beta *= ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
r_l = r_u / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);
scattered = true;
ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a> = <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a>;
ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
specularBounce = false;
anyNonSpecularBounces = true;</div><p>


</p>
<p>If the ray intersects a light source, the
<a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a> from the previous path vertex will be needed to
compute MIS weights; <tt>prevIntrContext</tt> is updated to store it
after each scattering event, whether in a medium or on a surface.

</p>
<p></p>
<span class="anchor" id="fragment-Declarestatevariablesforvolumetricpathsampling-1"></span><div class="fragmentname">&lt;&lt;Declare state variables for volumetric path sampling&gt;&gt;+=&nbsp;<a href="#fragment-Declarestatevariablesforvolumetricpathsampling-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> prevIntrContext;</div><p>


</p>
<p>If null scattering is selected, the updates to <tt>beta</tt> and the rescaled
path sampling probabilities follow the same form as we have seen
previously: the former is given by
Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:throughput-generalized">14.11</a>) and the latter with a
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.193ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 5680.4 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal e Baseline equals sigma Subscript normal n Baseline slash sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1195" y="0"></use>
<g transform="translate(2251,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="808" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="3316" y="0"></use>
<g transform="translate(3817,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</svg> factor where, as with real scattering, the
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.254ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1831.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg> cancels with a corresponding factor from the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.169ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1795 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg>
probability (Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#sec:evaluating-volumetric-path-integral">14.1.5</a>).

</p>
<p>In this case, we also must update the rescaled path probabilities for sampling
this path vertex via light path sampling, which samples path vertices
according to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.169ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1795 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg>.

</p>
<p>This fragment concludes the implementation of the lambda function that is
passed to the <tt>SampleT_maj()</tt> function.

</p>
<p></p>
<span class="anchor" id="fragment-Handlenullscatteringalongraypath-0"></span><div class="fragmentname">&lt;&lt;Handle null scattering along ray path&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = ClampZero(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
Float pdf = T_maj[0] * sigma_n[0];
beta *= T_maj * sigma_n / pdf;
if (pdf == 0) beta = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
r_u *= T_maj * sigma_n / pdf;
r_l *= T_maj * sigma_maj / pdf;
return beta &amp;&amp; r_u;</div><p>


</p>
<p>Returning to the <tt>Li()</tt> method immediately after the
<tt>SampleT_maj()</tt> call, if the path terminated due to absorption, it is
only here that we can break out and return the radiance estimate to the
caller of the <tt>Li()</tt> method.  Further, it is only here that we can
jump back to the start of the <tt>while</tt> loop for rays that were
scattered in the medium.

</p>
<p></p>
<span class="anchor" id="fragment-Handleterminatedscatteredandunscatteredmediumrays-0"></span><div class="fragmentname">&lt;&lt;Handle terminated, scattered, and unscattered medium rays&gt;&gt;=&nbsp;<a href="#fragment-Handleterminatedscatteredandunscatteredmediumrays-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">if (terminated || !beta || !r_u) return L;
if (scattered) continue;</div><p>


</p>
<p>With those cases taken care of, we are left with rays that either underwent
no scattering events in the medium or only underwent null scattering.  For
those cases, both the path throughput weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> and the rescaled path probabilities
must be updated. <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> takes a factor of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.284ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1844.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg> to account for
the transmittance from either the last null-scattering event or the ray&rsquo;s
origin to the ray&rsquo;s <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.131ex" height="2.343ex" style="vertical-align: -0.671ex;" viewBox="0 -719.6 1778.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t Subscript normal m normal a normal x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
<g transform="translate(361,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-78" x="1334" y="0"></use>
</g>
</g>
</svg> position.
The rescaled unidirectional and light sampling probabilities also take the
same <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.284ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1844.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg>, which corresponds to the final factors outside of the
parenthesis in the definitions of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.218ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 1815.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal n normal u normal l normal l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="556" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1113" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1391" y="0"></use>
</g>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.86ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 2092.7 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r normal a normal t normal i normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="392" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="892" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="1282" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="1560" y="0"></use>
</g>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fragment-Handleterminatedscatteredandunscatteredmediumrays-1"></span><div class="fragmentname">&lt;&lt;Handle terminated, scattered, and unscattered medium rays&gt;&gt;+=&nbsp;<a href="#fragment-Handleterminatedscatteredandunscatteredmediumrays-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">beta *= T_maj / T_maj[0];
r_u *= T_maj / T_maj[0];
r_l *= T_maj / T_maj[0];</div><p>


</p>
<p>There is much more to do for rays that have either escaped the scene or have
intersected a surface without medium scattering or absorption.  We will
defer discussion of the first following fragment, &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemittedlightatvolumepathvertexorfromtheenvironment-0">Add emitted
light at volume path vertex or from the environment</a></span>&gt;&gt;, until later in the
section when we discuss the direct lighting calculation.  A few of the
others are implemented reusing fragments from earlier integrators.

</p>
<p></p>
<span class="anchor" id="fragment-Handlesurvivingunscatteredrays-0"></span><div class="fragmentname">&lt;&lt;Handle surviving unscattered rays&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Addemittedlightatvolumepathvertexorfromtheenvironment-0">Add emitted light at volume path vertex or from the environment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2142" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2142"><i></i></a><div id="fragbit-2142" class="collapse"><div class="fragmentcode">   if (!si) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Accumulatecontributionsfrominfinitelightsources-0">Accumulate contributions from infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2143" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2143"><i></i></a><div id="fragbit-2143" class="collapse"><div class="fragmentcode">          for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
              if (<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda); <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>) {
                  if (depth == 0 || specularBounce)
                      L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> / r_u.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
                  else {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-AddinfinitelightcontributionusingbothPDFswithMIS-0">Add infinite light contribution using both PDFs with MIS</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2144" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2144"><i></i></a><div id="fragbit-2144" class="collapse"><div class="fragmentcode">                         Float lightPDF = <a href="#VolPathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrContext, light) *
                                          light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrContext, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
                         r_l *= lightPDF;
                         L += beta * Le / (r_u + r_l).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
                  }
              }
          }</div></div>
       break;
   }
   <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;isect = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
   if (<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a> = isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, lambda); <a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>) {
       &lt;&lt;<span class="fragmentname">Add contribution of emission from intersected surface</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2145" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2145"><i></i></a><div id="fragbit-2145" class="collapse"><div class="fragmentcode">          if (depth == 0 || specularBounce)
              L += beta * Le / r_u.Average();
          else {
              &lt;&lt;<span class="fragmentname">Add surface light contribution using both PDFs with MIS</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2146" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2146"><i></i></a><div id="fragbit-2146" class="collapse"><div class="fragmentcode">                 <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> areaLight(isect.areaLight);
                 Float lightPDF =
                     lightSampler.PMF(prevIntrContext, areaLight) *
                     areaLight.PDF_Li(prevIntrContext, ray.d, true);
                 r_l *= lightPDF;
                 L += beta * Le / (r_u + r_l).Average();</div></div>
          }</div></div>
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#fragment-GetBSDFandskipovermediumboundaries-0">Get BSDF and skip over medium boundaries</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2147" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2147"><i></i></a><div id="fragbit-2147" class="collapse"><div class="fragmentcode">   <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = isect.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, scratchBuffer, sampler);
   if (!bsdf) {
       isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
       continue;
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-InitializemonovisibleSurfatfirstintersection-0">Initialize <tt>visibleSurf</tt> at first intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2148" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2148"><i></i></a><div id="fragbit-2148" class="collapse"><div class="fragmentcode">   if (depth == 0 &amp;&amp; visibleSurf) {
       &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-EstimateBSDFsalbedo-0">Estimate BSDF&rsquo;s albedo</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2149" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2149"><i></i></a><div id="fragbit-2149" class="collapse"><div class="fragmentcode">          &lt;&lt;<span class="fragmentname">Define sample arrays <tt>ucRho</tt> and <tt>uRho</tt> for reflectance estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2150" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2150"><i></i></a><div id="fragbit-2150" class="collapse"><div class="fragmentcode">             constexpr int nRhoSamples = 16;
             const Float ucRho[nRhoSamples] = { 0.75741637, 0.37870818, 0.7083487, 0.18935409, 0.9149363, 0.35417435, 0.5990858, 0.09467703, 0.8578725, 0.45746812, 0.686759, 0.17708716, 0.9674518, 0.2995429, 0.5083201, 0.047338516 };
             const <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uRho[nRhoSamples] = { <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.855985, 0.570367), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.381823, 0.851844), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.285328, 0.764262), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.733380, 0.114073), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.542663, 0.344465), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.127274, 0.414848), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.964700, 0.947162), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.594089, 0.643463), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.095109, 0.170369), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.825444, 0.263359), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.429467, 0.454469), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.244460, 0.816459), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.756135, 0.731258), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.516165, 0.152852), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.180888, 0.214174), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.898579, 0.503897) };</div></div>
          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> albedo = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::rho" class="code">rho</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, ucRho, uRho);</div></div>
       *visibleSurf = <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a>(isect, albedo, lambda);
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Terminatepathifmaximumdepthreached-0">Terminate path if maximum depth reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2151" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2151"><i></i></a><div id="fragbit-2151" class="collapse"><div class="fragmentcode">   if (depth++ &gt;= <a href="#VolPathIntegrator::maxDepth" class="code">maxDepth</a>)
       return L;</div></div>
&lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-PossiblyregularizetheBSDF-0">Possibly regularize the BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2152" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2152"><i></i></a><div id="fragbit-2152" class="collapse"><div class="fragmentcode">   if (<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator::regularize" class="code">regularize</a> &amp;&amp; anyNonSpecularBounces)
       bsdf.<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#BSDF::Regularize" class="code">Regularize</a>();
   </div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleilluminationfromlightstofindattenuatedpathcontribution-0">Sample illumination from lights to find attenuated path contribution</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2153" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2153"><i></i></a><div id="fragbit-2153" class="collapse"><div class="fragmentcode">   if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>()))
       L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(isect, &amp;bsdf, lambda, sampler, beta, r_u);
   prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(isect);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFtogetnewvolumetricpathdirection-0">Sample BSDF to get new volumetric path direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2154" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2154"><i></i></a><div id="fragbit-2154" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>;
   Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
   pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
   if (!bs) break;
   &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonobetaandrescaledpathprobabilitiesforBSDFscattering-0">Update <tt>beta</tt> and rescaled path probabilities for BSDF scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2155" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2155"><i></i></a><div id="fragbit-2155" class="collapse"><div class="fragmentcode">      beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, isect.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
      if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional" class="code">pdfIsProportional</a>)
          r_l = r_u / bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>);
      else
          r_l = r_u / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatevolumetricintegratorpathstateaftersurfacescattering-0">Update volumetric integrator path state after surface scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2156" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2156"><i></i></a><div id="fragbit-2156" class="collapse"><div class="fragmentcode">      specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
      anyNonSpecularBounces |= !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
      if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>())
          etaScale *= <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);
      ray = isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(ray, bsdf, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::flags" class="code">flags</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);</div></div></div></div>
&lt;&lt;<span class="fragmentname">Account for attenuated subsurface scattering, if applicable</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2157" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2157"><i></i></a><div id="fragbit-2157" class="collapse"><div class="fragmentcode">   BSSRDF bssrdf = isect.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSSRDF" class="code">GetBSSRDF</a>(ray, lambda, <a href="../Introduction/pbrt_System_Overview.html#ImageTileIntegrator::camera" class="code">camera</a>, scratchBuffer);
   if (bssrdf &amp;&amp; bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>()) {
       &lt;&lt;<span class="fragmentname">Sample BSSRDF probe segment to find exit point</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2158" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2158"><i></i></a><div id="fragbit-2158" class="collapse"><div class="fragmentcode">          Float uc = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
          <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> up = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
          pstd::optional&lt;BSSRDFProbeSegment&gt; probeSeg = bssrdf.SampleSp(uc, up);
          if (!probeSeg) break;</div></div>
       &lt;&lt;<span class="fragmentname">Sample random intersection along BSSRDF probe segment</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2159" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2159"><i></i></a><div id="fragbit-2159" class="collapse"><div class="fragmentcode">          uint64_t seed = <a href="../Utilities/Mathematical_Infrastructure.html#MixBits" class="code">MixBits</a>(<a href="../Shapes/Managing_Rounding_Error.html#FloatToBits" class="code">FloatToBits</a>(sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>()));
          <a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler" class="code">WeightedReservoirSampler</a>&lt;SubsurfaceInteraction&gt; interactionSampler(seed);
          &lt;&lt;<span class="fragmentname">Intersect BSSRDF sampling ray against the scene geometry</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2160" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2160"><i></i></a><div id="fragbit-2160" class="collapse"><div class="fragmentcode">             <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> base(probeSeg-&gt;p0, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::time" class="code">time</a>, <a href="../Volume_Scattering/Media.html#Medium" class="code">Medium</a>());
             while (true) {
                 <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> r = base.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(probeSeg-&gt;p1);
                 pstd::optional&lt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection" class="code">ShapeIntersection</a>&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(r, 1);
                 if (!si) break;
                 base = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
                 if (si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a> == isect.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a>)
                     interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::Add" class="code">Add</a>(SubsurfaceInteraction(si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>), 1.f);
             }</div></div>
          if (!interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::HasSample" class="code">HasSample</a>())
              break;</div></div>
       &lt;&lt;<span class="fragmentname">Convert probe intersection to <tt>BSSRDFSample</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2161" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2161"><i></i></a><div id="fragbit-2161" class="collapse"><div class="fragmentcode">          SubsurfaceInteraction ssi = interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::GetSample" class="code">GetSample</a>();
          BSSRDFSample bssrdfSample =
              bssrdf.ProbeIntersectionToSample(ssi, scratchBuffer);
          if (!bssrdfSample.Sp || !bssrdfSample.pdf) break;</div></div>
       &lt;&lt;<span class="fragmentname">Update path state for subsurface scattering</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2162" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2162"><i></i></a><div id="fragbit-2162" class="collapse"><div class="fragmentcode">          Float pdf = interactionSampler.<a href="../Sampling_Algorithms/Reservoir_Sampling.html#WeightedReservoirSampler::SampleProbability" class="code">SampleProbability</a>() * bssrdfSample.pdf[0];
          beta *= bssrdfSample.Sp / pdf;
          r_u *= bssrdfSample.pdf / bssrdfSample.pdf[0];
          <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> pi = ssi;
          pi.wo = bssrdfSample.wo;
          prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(pi);
          &lt;&lt;<span class="fragmentname">Possibly regularize subsurface BSDF</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2163" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2163"><i></i></a><div id="fragbit-2163" class="collapse"><div class="fragmentcode">             <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> &amp;Sw = bssrdfSample.Sw;
             anyNonSpecularBounces = true;
             if (<a href="#VolPathIntegrator::regularize" class="code">regularize</a>)
                 Sw.<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#BSDF::Regularize" class="code">Regularize</a>();
             </div></div></div></div>
       &lt;&lt;<span class="fragmentname">Account for attenuated direct illumination subsurface scattering</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2164" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2164"><i></i></a><div id="fragbit-2164" class="collapse"><div class="fragmentcode">          L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(pi, &amp;Sw, lambda, sampler, beta, r_u);</div></div>
       &lt;&lt;<span class="fragmentname">Sample ray for indirect subsurface scattering</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2165" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2165"><i></i></a><div id="fragbit-2165" class="collapse"><div class="fragmentcode">          Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
          pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = Sw.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(pi.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
          if (!bs) break;
          beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, pi.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
          r_l = r_u / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
          specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
          ray = <a href="../Geometry_and_Transformations/Rays.html#RayDifferential" class="code">RayDifferential</a>(pi.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));</div></div>
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatevolumetricpathwithRussianroulette-0">Possibly terminate volumetric path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2166" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2166"><i></i></a><div id="fragbit-2166" class="collapse"><div class="fragmentcode">   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> rrBeta = beta * etaScale / r_u.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
   Float uRR = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
   if (rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 1 &amp;&amp; depth &gt; 1) {
       Float q = std::max&lt;Float&gt;(0, 1 - rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
       if (uRR &lt; q) break;
       beta /= 1 - q;
   }</div></div></div><p>


</p>
<p>

</p>
<p>As with the <a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>, path termination due to reaching the
maximum depth only occurs after accounting for illumination from any
emissive surfaces that are intersected.

</p>
<p></p>
<span class="anchor" id="fragment-Terminatepathifmaximumdepthreached-0"></span><div class="fragmentname">&lt;&lt;Terminate path if maximum depth reached&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (depth++ &gt;= <a href="#VolPathIntegrator::maxDepth" class="code">maxDepth</a>)
    return L;</div><p>


</p>
<p>Sampling the light source at a surface intersection is handled by the same
<tt>SampleLd()</tt> method that is called for real-scattering vertices in the
medium.  As with medium scattering, the <a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a>
corresponding to this scattering event is recorded for possible later use
in MIS weight calculations.

</p>
<p></p>
<span class="anchor" id="fragment-Sampleilluminationfromlightstofindattenuatedpathcontribution-0"></span><div class="fragmentname">&lt;&lt;Sample illumination from lights to find attenuated path contribution&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>()))
    L += <a href="#VolPathIntegrator::SampleLd" class="code">SampleLd</a>(isect, &amp;bsdf, lambda, sampler, beta, r_u);
prevIntrContext = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(isect);</div><p>


</p>
<p>The logic for sampling scattering at a surface is very similar to the
corresponding logic in the <a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-SampleBSDFtogetnewvolumetricpathdirection-0"></span><div class="fragmentname">&lt;&lt;Sample BSDF to get new volumetric path direction&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>;
Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
if (!bs) break;
&lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonobetaandrescaledpathprobabilitiesforBSDFscattering-0">Update <tt>beta</tt> and rescaled path probabilities for BSDF scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2167" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2167"><i></i></a><div id="fragbit-2167" class="collapse"><div class="fragmentcode">   beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, isect.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
   if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional" class="code">pdfIsProportional</a>)
       r_l = r_u / bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>);
   else
       r_l = r_u / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Updatevolumetricintegratorpathstateaftersurfacescattering-0">Update volumetric integrator path state after surface scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2168" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2168"><i></i></a><div id="fragbit-2168" class="collapse"><div class="fragmentcode">   specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
   anyNonSpecularBounces |= !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
   if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>())
       etaScale *= <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);
   ray = isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(ray, bsdf, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::flags" class="code">flags</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);</div></div></div><p>


</p>
<p>Given a BSDF sample, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> is first multiplied by the value of the BSDF, which takes care of
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.283ex" height="3.176ex" style="vertical-align: -0.671ex;" viewBox="0 -1078.4 552.5 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">ModifyingAbove f With caret</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-302" d="M-82 607l-12 -20c-58 25 -115 54 -170 85c-55 -31 -112 -60 -170 -85l-12 20c56 49 117 91 182 127c65 -36 126 -78 182 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-302" x="539" y="227"></use>
</g>
</svg> from Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:scatfun-generalized">14.12</a>).  This is also a
good time to incorporate the cosine factor from the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.808ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1209 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper C Subscript normal p Sub Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D436" d="M760 695l-63 -255c-5 -18 -5 -20 -18 -20c-4 0 -15 0 -15 10s3 11 3 51c0 116 -59 193 -161 193c-89 0 -183 -50 -244 -121c-100 -117 -121 -279 -121 -336c0 -156 106 -208 196 -208c52 0 115 17 184 73c69 58 92 129 101 158c2 8 7 10 13 10c0 0 12 0 12 -10 c0 -3 -17 -94 -110 -176c-53 -46 -129 -86 -216 -86c-153 0 -271 109 -271 274c0 232 225 453 448 453c111 0 157 -75 166 -89l70 77c11 11 12 12 15 12c9 0 11 -7 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D436" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-70" x="1011" y="-213"></use>
</g>
</svg> factor of
the generalized geometric term, Equation&nbsp;(<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#eq:g-generalized">14.13</a>).

</p>
<p>Updates to the rescaled path probabilities follow how they were done for
medium scattering: first, there is no need to update <tt>r_u</tt> since the
probabilities are the same over all wavelengths.  The rescaled light path
sampling probabilities are also initialized from <tt>r_u</tt>, here also
with only the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.888ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 2965.6 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash p Subscript normal u comma lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
<g transform="translate(1001,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</g>
</svg> factor included.  The other
factors in <tt>r_l</tt> will only be computed and included if the ray
intersects an emitter; otherwise <tt>r_l</tt> is unused.

</p>
<p>One nit in updating <tt>r_l</tt> is that the BSDF and PDF value
returned in the <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample"><tt>BSDFSample</tt></a> may only be correct up to a (common) scale
factor.  This case comes up with sampling techniques like the random walk
used by the <a href="../Light_Transport_II_Volume_Rendering/Scattering_from_Layered_Materials.html#LayeredBxDF"><tt>LayeredBxDF</tt></a> that is described in
Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/Scattering_from_Layered_Materials.html#sec:layered-bxdf-implementation">14.3.2</a>.  In that case, a call to
<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF"><tt>BSDF::PDF()</tt></a> gives an independent value for the PDF that can be used.
 
</p>
<span class="anchor" id="fragment-UpdatemonobetaandrescaledpathprobabilitiesforBSDFscattering-0"></span><div class="fragmentname">&lt;&lt;Update <tt>beta</tt> and rescaled path probabilities for BSDF scattering&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, isect.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional" class="code">pdfIsProportional</a>)
    r_l = r_u / bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>);
else
    r_l = r_u / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div><p>


</p>
<p>A few additional state variables must be updated after surface scattering,
as&nbsp;well.

</p>
<p></p>
<span class="anchor" id="fragment-Updatevolumetricintegratorpathstateaftersurfacescattering-0"></span><div class="fragmentname">&lt;&lt;Update volumetric integrator path state after surface scattering&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
anyNonSpecularBounces |= !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>())
    etaScale *= <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);
ray = isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(ray, bsdf, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::flags" class="code">flags</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);</div><p>


</p>
<p>Russian roulette follows the same general approach as before, though we
scale <tt>beta</tt> by
the accumulated effect of radiance scaling for transmission that is encoded in
<tt>etaScale</tt> and use the balance heuristic over wavelengths.
If the Russian roulette test passes, <tt>beta</tt> is updated
with a factor that accounts for the survival probability, <tt>1 - q</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-PossiblyterminatevolumetricpathwithRussianroulette-0"></span><div class="fragmentname">&lt;&lt;Possibly terminate volumetric path with Russian roulette&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> rrBeta = beta * etaScale / r_u.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
Float uRR = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
if (rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 1 &amp;&amp; depth &gt; 1) {
    Float q = std::max&lt;Float&gt;(0, 1 - rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
    if (uRR &lt; q) break;
    beta /= 1 - q;
}</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x3-EstimatingDirectIllumination"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x3-EstimatingDirectIllumination"></span><h4>Estimating Direct Illumination</h4><p>


</p>
<p>All that remains in the <a href="#VolPathIntegrator"><tt>VolPathIntegrator</tt></a>&rsquo;s implementation is direct
illumination.  We will start with the <tt>SampleLd()</tt> method, which is
called to estimate scattered radiance due to direct illumination by
sampling a light source, both at scattering points in media and on
surfaces.  (It is responsible for computing the second term of
Equation&nbsp;(<a href="#eq:volpath-two-sample-mis-estimator">14.24</a>).)
The purpose of most of its parameters should be evident.  The last,
<tt>r_p</tt>, gives the rescaled path probabilities up to the vertex
<tt>intr</tt>.  (A separate variable named <tt>r_u</tt> will be used in
the function&rsquo;s implementation, so a new name is needed here.)

</p>
<p></p>
<span class="anchor" id="fragment-VolPathIntegratorMethodDefinitions-1"></span><div class="fragmentname">&lt;&lt;VolPathIntegrator Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-VolPathIntegratorMethodDefinitions-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="VolPathIntegrator::SampleLd"></span>VolPathIntegrator::SampleLd(const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;intr,
        const <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> *bsdf, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler,
        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> beta, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> r_p) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Estimatelight-sampleddirectilluminationatmonointr-0">Estimate light-sampled direct illumination at <tt>intr</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2169" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2169"><i></i></a><div id="fragbit-2169" class="collapse"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonoLightSampleContextforvolumetriclightsampling-0">Initialize <tt>LightSampleContext</tt> for volumetric light sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2170" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2170"><i></i></a><div id="fragbit-2170" class="collapse"><div class="fragmentcode">          <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx;
          if (<a href="../Reflection_Models/BSDF_Representation.html#BSDF::operator_bool" class="code">bsdf</a>) {
              ctx = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsSurface" class="code">AsSurface</a>());
              &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-Trytonudgethelightsamplingpositiontocorrectsideofthesurface-0">Try to nudge the light sampling position to correct side of the surface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2171" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2171"><i></i></a><div id="fragbit-2171" class="collapse"><div class="fragmentcode">                 <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> flags = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>();
                 if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags))
                     ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);
                 else if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags))
                     ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(-intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);</div></div>
          }
          else ctx = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplealightsourceusingmonolightSampler-0">Sample a light source using <tt>lightSampler</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2172" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2172"><i></i></a><div id="fragbit-2172" class="collapse"><div class="fragmentcode">          Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
          pstd::optional&lt;<a href="../Light_Sources/Light_Sampling.html#SampledLight" class="code">SampledLight</a>&gt; sampledLight = lightSampler.<a href="../Light_Sources/Light_Sampling.html#LightSampler::Sample" class="code">Sample</a>(ctx, u);
          <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
          if (!sampledLight)
              return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
          <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> <a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a> = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a>;
          </div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleapointonthelightsource-0">Sample a point on the light source</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2173" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2173"><i></i></a><div id="fragbit-2173" class="collapse"><div class="fragmentcode">          pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt; ls =
              light.<a href="../Light_Sources/Light_Interface.html#Light::SampleLi" class="code">SampleLi</a>(ctx, uLight, lambda, true);
          if (!ls || !ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> || ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a> == 0)
              return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
          Float lightPDF = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::p" class="code">p</a> * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a>;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluateBSDForphasefunctionforlightsampledirection-0">Evaluate BSDF or phase function for light sample direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2174" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2174"><i></i></a><div id="fragbit-2174" class="collapse"><div class="fragmentcode">          Float scatterPDF;
          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> f_hat;
          <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, <a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a> = ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a>;
          if (<a href="../Reflection_Models/BSDF_Representation.html#BSDF::operator_bool" class="code">bsdf</a>) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonof_hatandmonoscatterPDFaccountingfortheBSDF-0">Update <tt>f_hat</tt> and <tt>scatterPDF</tt> accounting for the BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2175" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2175"><i></i></a><div id="fragbit-2175" class="collapse"><div class="fragmentcode">                 f_hat = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a>(wo, wi) * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsSurface" class="code">AsSurface</a>().shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>);
                 scatterPDF = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, wi);</div></div>
          } else {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonof_hatandmonoscatterPDFaccountingforthephasefunction-0">Update <tt>f_hat</tt> and <tt>scatterPDF</tt> accounting for the phase function</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2176" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2176"><i></i></a><div id="fragbit-2176" class="collapse"><div class="fragmentcode">                 <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction" class="code">PhaseFunction</a> <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a> = intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsMedium" class="code">AsMedium</a>().<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>;
                 f_hat = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>(wo, wi));
                 scatterPDF = <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::PDF" class="code">PDF</a>(wo, wi);</div></div>
          }
          if (!f_hat) return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Declarepathstatevariablesforraytolightsource-0">Declare path state variables for ray to light source</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2177" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2177"><i></i></a><div id="fragbit-2177" class="collapse"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> lightRay = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pLight" class="code">pLight</a>);
          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_ray(1.f), r_l(1.f), r_u(1.f);
          <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>));</div></div>
       while (lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> != <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(0, 0, 0)) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Traceraythroughmediatoestimatetransmittance-0">Trace ray through media to estimate transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2178" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2178"><i></i></a><div id="fragbit-2178" class="collapse"><div class="fragmentcode">              pstd::optional&lt;ShapeIntersection&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(lightRay, 1-<a href="../Shapes/Managing_Rounding_Error.html#ShadowEpsilon" class="code">ShadowEpsilon</a>);
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleopaquesurfacealongrayspath-0">Handle opaque surface along ray&rsquo;s path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2179" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2179"><i></i></a><div id="fragbit-2179" class="collapse"><div class="fragmentcode">                 if (si &amp;&amp; si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a>)
                     return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatetransmittanceforcurrentraysegment-0">Update transmittance for current ray segment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2180" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2180"><i></i></a><div id="fragbit-2180" class="collapse"><div class="fragmentcode">                 if (lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>) {
                     Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : (1 - <a href="../Shapes/Managing_Rounding_Error.html#ShadowEpsilon" class="code">ShadowEpsilon</a>);
                     Float u = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;();
                     <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj = <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(lightRay, tMax, u, rng, lambda,
                             [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
                                 <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) { 
                                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraytransmittanceestimateatsampledpoint-0">Update ray transmittance estimate at sampled point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2181" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2181"><i></i></a><div id="fragbit-2181" class="collapse"><div class="fragmentcode">                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoT_rayandPDFsusingratio-trackingestimator-0">Update <tt>T_ray</tt> and PDFs using ratio-tracking estimator</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2182" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2182"><i></i></a><div id="fragbit-2182" class="collapse"><div class="fragmentcode">                                       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::ClampZero" class="code">ClampZero</a>(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
                                       Float pdf = T_maj[0] * sigma_maj[0];
                                       T_ray *= T_maj * sigma_n / pdf;
                                       r_l *= T_maj * sigma_maj / pdf;
                                       r_u *= T_maj * sigma_n / pdf;</div></div>
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatetransmittancecomputationusingRussianroulette-0">Possibly terminate transmittance computation using Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2183" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2183"><i></i></a><div id="fragbit-2183" class="collapse"><div class="fragmentcode">                                       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Tr = T_ray / (r_l + r_u).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
                                       if (Tr.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.05f) {
                                           Float q = 0.75f;
                                           if (rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;() &lt; q)
                                               T_ray = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.);
                                           else
                                               T_ray /= 1 - q;
                                       }</div></div>
                                    return true;</div></div>
                             });
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatetransmittanceestimateforfinalsegment-0">Update transmittance estimate for final segment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2184" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2184"><i></i></a><div id="fragbit-2184" class="collapse"><div class="fragmentcode">                        T_ray *= T_maj / T_maj[0];
                        r_l *= T_maj / T_maj[0];
                        r_u *= T_maj / T_maj[0];</div></div>
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Generatenextraysegmentorreturnfinaltransmittance-0">Generate next ray segment or return final transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2185" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2185"><i></i></a><div id="fragbit-2185" class="collapse"><div class="fragmentcode">                 if (!T_ray) return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
                 if (!si) break;
                 lightRay = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pLight" class="code">pLight</a>);</div></div></div></div>
       }
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnpathcontributionfunctionestimatefordirectlighting-0">Return path contribution function estimate for direct lighting</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2186" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2186"><i></i></a><div id="fragbit-2186" class="collapse"><div class="fragmentcode">          r_l *= r_p * lightPDF;
          r_u *= r_p * scatterPDF;
          if (<a href="../Light_Sources/Light_Interface.html#IsDeltaLight" class="code">IsDeltaLight</a>(light.<a href="../Light_Sources/Light_Interface.html#Light::Type" class="code">Type</a>()))
              return beta * f_hat * T_ray * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> / r_l.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
          else
              return beta * f_hat * T_ray * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> / (r_l + r_u).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div></div></div>
}</div><p>


</p>
<p>The overall structure of this method&rsquo;s implementation is similar to the
<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>&rsquo;s
<tt>SampleLd()</tt> method: a light
source and a point on it are sampled, the vertex&rsquo;s scattering function is
evaluated, and then the light&rsquo;s visibility is determined.  Here we have the
added complexity of needing to compute the transmittance between the
scattering point and the point on the light rather than finding a binary visibility
factor, as well as the need to compute spectral path sampling weights for
MIS.

</p>
<p></p>
<span class="anchor" id="fragment-Estimatelight-sampleddirectilluminationatmonointr-0"></span><div class="fragmentname">&lt;&lt;Estimate light-sampled direct illumination at <tt>intr</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonoLightSampleContextforvolumetriclightsampling-0">Initialize <tt>LightSampleContext</tt> for volumetric light sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2187" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2187"><i></i></a><div id="fragbit-2187" class="collapse"><div class="fragmentcode">   <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx;
   if (<a href="../Reflection_Models/BSDF_Representation.html#BSDF::operator_bool" class="code">bsdf</a>) {
       ctx = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsSurface" class="code">AsSurface</a>());
       &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-Trytonudgethelightsamplingpositiontocorrectsideofthesurface-0">Try to nudge the light sampling position to correct side of the surface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2188" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2188"><i></i></a><div id="fragbit-2188" class="collapse"><div class="fragmentcode">          <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> flags = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>();
          if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags))
              ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);
          else if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags))
              ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(-intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);</div></div>
   }
   else ctx = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-SamplealightsourceusingmonolightSampler-0">Sample a light source using <tt>lightSampler</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2189" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2189"><i></i></a><div id="fragbit-2189" class="collapse"><div class="fragmentcode">   Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
   pstd::optional&lt;<a href="../Light_Sources/Light_Sampling.html#SampledLight" class="code">SampledLight</a>&gt; sampledLight = lightSampler.<a href="../Light_Sources/Light_Sampling.html#LightSampler::Sample" class="code">Sample</a>(ctx, u);
   <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
   if (!sampledLight)
       return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
   <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> <a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a> = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a>;
   </div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleapointonthelightsource-0">Sample a point on the light source</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2190" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2190"><i></i></a><div id="fragbit-2190" class="collapse"><div class="fragmentcode">   pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt; ls =
       light.<a href="../Light_Sources/Light_Interface.html#Light::SampleLi" class="code">SampleLi</a>(ctx, uLight, lambda, true);
   if (!ls || !ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> || ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a> == 0)
       return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
   Float lightPDF = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::p" class="code">p</a> * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a>;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluateBSDForphasefunctionforlightsampledirection-0">Evaluate BSDF or phase function for light sample direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2191" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2191"><i></i></a><div id="fragbit-2191" class="collapse"><div class="fragmentcode">   Float scatterPDF;
   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> f_hat;
   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, <a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a> = ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a>;
   if (<a href="../Reflection_Models/BSDF_Representation.html#BSDF::operator_bool" class="code">bsdf</a>) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonof_hatandmonoscatterPDFaccountingfortheBSDF-0">Update <tt>f_hat</tt> and <tt>scatterPDF</tt> accounting for the BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2192" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2192"><i></i></a><div id="fragbit-2192" class="collapse"><div class="fragmentcode">          f_hat = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a>(wo, wi) * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsSurface" class="code">AsSurface</a>().shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>);
          scatterPDF = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, wi);</div></div>
   } else {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonof_hatandmonoscatterPDFaccountingforthephasefunction-0">Update <tt>f_hat</tt> and <tt>scatterPDF</tt> accounting for the phase function</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2193" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2193"><i></i></a><div id="fragbit-2193" class="collapse"><div class="fragmentcode">          <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction" class="code">PhaseFunction</a> <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a> = intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsMedium" class="code">AsMedium</a>().<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>;
          f_hat = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>(wo, wi));
          scatterPDF = <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::PDF" class="code">PDF</a>(wo, wi);</div></div>
   }
   if (!f_hat) return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Declarepathstatevariablesforraytolightsource-0">Declare path state variables for ray to light source</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2194" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2194"><i></i></a><div id="fragbit-2194" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> lightRay = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pLight" class="code">pLight</a>);
   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_ray(1.f), r_l(1.f), r_u(1.f);
   <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>));</div></div>
while (lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a> != <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(0, 0, 0)) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Traceraythroughmediatoestimatetransmittance-0">Trace ray through media to estimate transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2195" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2195"><i></i></a><div id="fragbit-2195" class="collapse"><div class="fragmentcode">       pstd::optional&lt;ShapeIntersection&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(lightRay, 1-<a href="../Shapes/Managing_Rounding_Error.html#ShadowEpsilon" class="code">ShadowEpsilon</a>);
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleopaquesurfacealongrayspath-0">Handle opaque surface along ray&rsquo;s path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2196" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2196"><i></i></a><div id="fragbit-2196" class="collapse"><div class="fragmentcode">          if (si &amp;&amp; si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a>)
              return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatetransmittanceforcurrentraysegment-0">Update transmittance for current ray segment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2197" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2197"><i></i></a><div id="fragbit-2197" class="collapse"><div class="fragmentcode">          if (lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>) {
              Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : (1 - <a href="../Shapes/Managing_Rounding_Error.html#ShadowEpsilon" class="code">ShadowEpsilon</a>);
              Float u = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;();
              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj = <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(lightRay, tMax, u, rng, lambda,
                      [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
                          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) { 
                          &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraytransmittanceestimateatsampledpoint-0">Update ray transmittance estimate at sampled point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2198" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2198"><i></i></a><div id="fragbit-2198" class="collapse"><div class="fragmentcode">                             &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoT_rayandPDFsusingratio-trackingestimator-0">Update <tt>T_ray</tt> and PDFs using ratio-tracking estimator</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2199" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2199"><i></i></a><div id="fragbit-2199" class="collapse"><div class="fragmentcode">                                <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::ClampZero" class="code">ClampZero</a>(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
                                Float pdf = T_maj[0] * sigma_maj[0];
                                T_ray *= T_maj * sigma_n / pdf;
                                r_l *= T_maj * sigma_maj / pdf;
                                r_u *= T_maj * sigma_n / pdf;</div></div>
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatetransmittancecomputationusingRussianroulette-0">Possibly terminate transmittance computation using Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2200" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2200"><i></i></a><div id="fragbit-2200" class="collapse"><div class="fragmentcode">                                <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Tr = T_ray / (r_l + r_u).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
                                if (Tr.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.05f) {
                                    Float q = 0.75f;
                                    if (rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;() &lt; q)
                                        T_ray = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.);
                                    else
                                        T_ray /= 1 - q;
                                }</div></div>
                             return true;</div></div>
                      });
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatetransmittanceestimateforfinalsegment-0">Update transmittance estimate for final segment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2201" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2201"><i></i></a><div id="fragbit-2201" class="collapse"><div class="fragmentcode">                 T_ray *= T_maj / T_maj[0];
                 r_l *= T_maj / T_maj[0];
                 r_u *= T_maj / T_maj[0];</div></div>
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Generatenextraysegmentorreturnfinaltransmittance-0">Generate next ray segment or return final transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2202" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2202"><i></i></a><div id="fragbit-2202" class="collapse"><div class="fragmentcode">          if (!T_ray) return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
          if (!si) break;
          lightRay = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pLight" class="code">pLight</a>);</div></div></div></div>
}
&lt;&lt;<span class="fragmentname"><a href="#fragment-Returnpathcontributionfunctionestimatefordirectlighting-0">Return path contribution function estimate for direct lighting</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2203" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2203"><i></i></a><div id="fragbit-2203" class="collapse"><div class="fragmentcode">   r_l *= r_p * lightPDF;
   r_u *= r_p * scatterPDF;
   if (<a href="../Light_Sources/Light_Interface.html#IsDeltaLight" class="code">IsDeltaLight</a>(light.<a href="../Light_Sources/Light_Interface.html#Light::Type" class="code">Type</a>()))
       return beta * f_hat * T_ray * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> / r_l.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
   else
       return beta * f_hat * T_ray * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> / (r_l + r_u).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div></div><p>


</p>
<p>Because it is called for both surface and volumetric scattering path
vertices, <tt>SampleLd()</tt> takes a plain <a href="../Geometry_and_Transformations/Interactions.html#Interaction"><tt>Interaction</tt></a> to represent
the scattering point.  Some extra care is therefore needed when
initializing the <a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a>: if scattering is from a surface,
it is important to interpret that interaction as the
<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction"><tt>SurfaceInteraction</tt></a> that it is so that the shading normal is included
in the <a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a>.  This case also presents an opportunity,
as was done in the <a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>, to
shift the light sampling point to avoid incorrectly sampling
self-illumination from area lights.

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonoLightSampleContextforvolumetriclightsampling-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>LightSampleContext</tt> for volumetric light sampling&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx;
if (<a href="../Reflection_Models/BSDF_Representation.html#BSDF::operator_bool" class="code">bsdf</a>) {
    ctx = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsSurface" class="code">AsSurface</a>());
    &lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-Trytonudgethelightsamplingpositiontocorrectsideofthesurface-0">Try to nudge the light sampling position to correct side of the surface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2204" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2204"><i></i></a><div id="fragbit-2204" class="collapse"><div class="fragmentcode">       <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> flags = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>();
       if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags))
           ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);
       else if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags))
           ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(-intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);</div></div>
}
else ctx = <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>(intr);</div><p>


</p>
<p>Sampling a point on the light follows in the usual way.  Note that the
implementation is careful to consume the two sample dimensions from the
<tt>Sampler</tt> regardless of whether sampling a light was successful, in
order to keep the association of sampler dimensions with integration
dimensions fixed across pixel samples.

</p>
<p></p>
<span class="anchor" id="fragment-SamplealightsourceusingmonolightSampler-0"></span><div class="fragmentname">&lt;&lt;Sample a light source using <tt>lightSampler</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
pstd::optional&lt;<a href="../Light_Sources/Light_Sampling.html#SampledLight" class="code">SampledLight</a>&gt; sampledLight = lightSampler.<a href="../Light_Sources/Light_Sampling.html#LightSampler::Sample" class="code">Sample</a>(ctx, u);
<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
if (!sampledLight)
    return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> <a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a> = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a>;
</div><p>


</p>
<p>The light samples a direction from the reference point in the usual manner.
The <tt>true</tt> value passed for the <tt>allowIncompletePDF</tt> parameter of
<a href="../Light_Sources/Light_Interface.html#Light::SampleLi"><tt>Light::SampleLi()</tt></a> indicates the use of MIS here.

</p>
<p></p>
<span class="anchor" id="fragment-Sampleapointonthelightsource-0"></span><div class="fragmentname">&lt;&lt;Sample a point on the light source&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt; ls =
    light.<a href="../Light_Sources/Light_Interface.html#Light::SampleLi" class="code">SampleLi</a>(ctx, uLight, lambda, true);
if (!ls || !ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> || ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a> == 0)
    return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
Float lightPDF = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::p" class="code">p</a> * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a>;</div><p>


</p>
<p>As in <a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator::SampleLd"><tt>PathIntegrator::SampleLd()</tt></a>, it is worthwhile to evaluate the BSDF
or phase function before tracing the shadow ray: if it turns out to be
zero-valued for the direction to the light source, then it is possible to
exit early and perform no further work.

</p>
<p></p>
<span class="anchor" id="fragment-EvaluateBSDForphasefunctionforlightsampledirection-0"></span><div class="fragmentname">&lt;&lt;Evaluate BSDF or phase function for light sample direction&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float scatterPDF;
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> f_hat;
<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, <a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a> = ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a>;
if (<a href="../Reflection_Models/BSDF_Representation.html#BSDF::operator_bool" class="code">bsdf</a>) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonof_hatandmonoscatterPDFaccountingfortheBSDF-0">Update <tt>f_hat</tt> and <tt>scatterPDF</tt> accounting for the BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2205" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2205"><i></i></a><div id="fragbit-2205" class="collapse"><div class="fragmentcode">       f_hat = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a>(wo, wi) * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsSurface" class="code">AsSurface</a>().shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>);
       scatterPDF = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, wi);</div></div>
} else {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatemonof_hatandmonoscatterPDFaccountingforthephasefunction-0">Update <tt>f_hat</tt> and <tt>scatterPDF</tt> accounting for the phase function</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2206" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2206"><i></i></a><div id="fragbit-2206" class="collapse"><div class="fragmentcode">       <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction" class="code">PhaseFunction</a> <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a> = intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsMedium" class="code">AsMedium</a>().<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>;
       f_hat = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>(wo, wi));
       scatterPDF = <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::PDF" class="code">PDF</a>(wo, wi);</div></div>
}
if (!f_hat) return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);</div><p>


</p>
<p>The <tt>f_hat</tt> variable that holds the value of the scattering function
is slightly misnamed: it also includes the cosine factor for scattering
from surfaces and does not include the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg> for scattering from
participating media, as that has already been included in the provided
value of <tt>beta</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Updatemonof_hatandmonoscatterPDFaccountingfortheBSDF-0"></span><div class="fragmentname">&lt;&lt;Update <tt>f_hat</tt> and <tt>scatterPDF</tt> accounting for the BSDF&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">f_hat = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a>(wo, wi) * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsSurface" class="code">AsSurface</a>().shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>);
scatterPDF = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, wi);</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Updatemonof_hatandmonoscatterPDFaccountingforthephasefunction-0"></span><div class="fragmentname">&lt;&lt;Update <tt>f_hat</tt> and <tt>scatterPDF</tt> accounting for the phase function&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction" class="code">PhaseFunction</a> <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a> = intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::AsMedium" class="code">AsMedium</a>().<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>;
f_hat = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(<a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::p" class="code">p</a>(wo, wi));
scatterPDF = <a href="../Geometry_and_Transformations/Interactions.html#MediumInteraction::phase" class="code">phase</a>.<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction::PDF" class="code">PDF</a>(wo, wi);</div><p>


</p>
<p>A handful of variables keep track of some useful quantities for the
ray-tracing and medium sampling operations that are performed to compute
transmittance.  <tt>T_ray</tt> holds the transmittance along the ray
and <tt>r_u</tt> and <tt>r_l</tt> respectively hold
the rescaled path probabilities for unidirectional sampling and light sampling,
though only along the ray.  Maintaining these values independently of the
full path contribution and PDFs facilitates the use of Russian roulette in
the transmittance computation.

</p>
<p></p>
<span class="anchor" id="fragment-Declarepathstatevariablesforraytolightsource-0"></span><div class="fragmentname">&lt;&lt;Declare path state variables for ray to light source&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> lightRay = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pLight" class="code">pLight</a>);
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_ray(1.f), r_l(1.f), r_u(1.f);
<a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>));</div><p>


</p>
<p><tt>SampleLd()</tt> successively intersects the shadow ray with the scene
geometry, returning zero contribution if an opaque surface is found and
otherwise sampling the medium to estimate the transmittance up to the
intersection.  For intersections that represent transitions between
different media, this process repeats until the ray reaches the light
source.

</p>
<p>For some scenes, it could be more efficient to instead first check that
there are no intersections with opaque surfaces before sampling the media
to compute the transmittance.  With the current implementation, it is
possible to do wasted work estimating transmittance before
finding an opaque surface farther along the ray.

</p>
<p></p>
<span class="anchor" id="fragment-Traceraythroughmediatoestimatetransmittance-0"></span><div class="fragmentname">&lt;&lt;Trace ray through media to estimate transmittance&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::optional&lt;ShapeIntersection&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(lightRay, 1-<a href="../Shapes/Managing_Rounding_Error.html#ShadowEpsilon" class="code">ShadowEpsilon</a>);
&lt;&lt;<span class="fragmentname"><a href="#fragment-Handleopaquesurfacealongrayspath-0">Handle opaque surface along ray&rsquo;s path</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2207" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2207"><i></i></a><div id="fragbit-2207" class="collapse"><div class="fragmentcode">   if (si &amp;&amp; si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a>)
       return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Updatetransmittanceforcurrentraysegment-0">Update transmittance for current ray segment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2208" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2208"><i></i></a><div id="fragbit-2208" class="collapse"><div class="fragmentcode">   if (lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>) {
       Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : (1 - <a href="../Shapes/Managing_Rounding_Error.html#ShadowEpsilon" class="code">ShadowEpsilon</a>);
       Float u = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;();
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj = <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(lightRay, tMax, u, rng, lambda,
               [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
                   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) { 
                   &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraytransmittanceestimateatsampledpoint-0">Update ray transmittance estimate at sampled point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2209" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2209"><i></i></a><div id="fragbit-2209" class="collapse"><div class="fragmentcode">                      &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoT_rayandPDFsusingratio-trackingestimator-0">Update <tt>T_ray</tt> and PDFs using ratio-tracking estimator</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2210" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2210"><i></i></a><div id="fragbit-2210" class="collapse"><div class="fragmentcode">                         <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::ClampZero" class="code">ClampZero</a>(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
                         Float pdf = T_maj[0] * sigma_maj[0];
                         T_ray *= T_maj * sigma_n / pdf;
                         r_l *= T_maj * sigma_maj / pdf;
                         r_u *= T_maj * sigma_n / pdf;</div></div>
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatetransmittancecomputationusingRussianroulette-0">Possibly terminate transmittance computation using Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2211" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2211"><i></i></a><div id="fragbit-2211" class="collapse"><div class="fragmentcode">                         <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Tr = T_ray / (r_l + r_u).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
                         if (Tr.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.05f) {
                             Float q = 0.75f;
                             if (rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;() &lt; q)
                                 T_ray = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.);
                             else
                                 T_ray /= 1 - q;
                         }</div></div>
                      return true;</div></div>
               });
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatetransmittanceestimateforfinalsegment-0">Update transmittance estimate for final segment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2212" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2212"><i></i></a><div id="fragbit-2212" class="collapse"><div class="fragmentcode">          T_ray *= T_maj / T_maj[0];
          r_l *= T_maj / T_maj[0];
          r_u *= T_maj / T_maj[0];</div></div>
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Generatenextraysegmentorreturnfinaltransmittance-0">Generate next ray segment or return final transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2213" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2213"><i></i></a><div id="fragbit-2213" class="collapse"><div class="fragmentcode">   if (!T_ray) return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
   if (!si) break;
   lightRay = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pLight" class="code">pLight</a>);</div></div></div><p>


</p>
<p>If an intersection is found with a surface that has a non-<tt>nullptr</tt>
<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#Material"><tt>Material</tt></a>, the visibility term is zero and the method can return
immediately.

</p>
<p></p>
<span class="anchor" id="fragment-Handleopaquesurfacealongrayspath-0"></span><div class="fragmentname">&lt;&lt;Handle opaque surface along ray&rsquo;s path&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (si &amp;&amp; si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::material" class="code">material</a>)
    return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);</div><p>


</p>
<p>Otherwise, if participating media is present, <tt>SampleT_maj()</tt> is
called to sample it along the ray up to whichever is closer&mdash;the surface
intersection or the sampled point on the light.

</p>
<p></p>
<span class="anchor" id="fragment-Updatetransmittanceforcurrentraysegment-0"></span><div class="fragmentname">&lt;&lt;Update transmittance for current ray segment&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (lightRay.<a href="../Geometry_and_Transformations/Rays.html#Ray::medium" class="code">medium</a>) {
    Float tMax = si ? si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a> : (1 - <a href="../Shapes/Managing_Rounding_Error.html#ShadowEpsilon" class="code">ShadowEpsilon</a>);
    Float u = rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;();
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj = <a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#SampleT_maj" class="code">SampleT_maj</a>(lightRay, tMax, u, rng, lambda,
            [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Volume_Scattering/Media.html#MediumProperties" class="code">MediumProperties</a> mp, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj,
                <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> T_maj) { 
                &lt;&lt;<span class="fragmentname"><a href="#fragment-Updateraytransmittanceestimateatsampledpoint-0">Update ray transmittance estimate at sampled point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2214" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2214"><i></i></a><div id="fragbit-2214" class="collapse"><div class="fragmentcode">                   &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoT_rayandPDFsusingratio-trackingestimator-0">Update <tt>T_ray</tt> and PDFs using ratio-tracking estimator</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2215" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2215"><i></i></a><div id="fragbit-2215" class="collapse"><div class="fragmentcode">                      <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::ClampZero" class="code">ClampZero</a>(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
                      Float pdf = T_maj[0] * sigma_maj[0];
                      T_ray *= T_maj * sigma_n / pdf;
                      r_l *= T_maj * sigma_maj / pdf;
                      r_u *= T_maj * sigma_n / pdf;</div></div>
                   &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatetransmittancecomputationusingRussianroulette-0">Possibly terminate transmittance computation using Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2216" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2216"><i></i></a><div id="fragbit-2216" class="collapse"><div class="fragmentcode">                      <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Tr = T_ray / (r_l + r_u).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
                      if (Tr.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.05f) {
                          Float q = 0.75f;
                          if (rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;() &lt; q)
                              T_ray = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.);
                          else
                              T_ray /= 1 - q;
                      }</div></div>
                   return true;</div></div>
            });
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatetransmittanceestimateforfinalsegment-0">Update transmittance estimate for final segment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2217" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2217"><i></i></a><div id="fragbit-2217" class="collapse"><div class="fragmentcode">       T_ray *= T_maj / T_maj[0];
       r_l *= T_maj / T_maj[0];
       r_u *= T_maj / T_maj[0];</div></div>
}</div><p>


</p>
<p>For each sampled point in the medium, the transmittance and rescaled path
probabilities are updated before Russian roulette is considered.

</p>
<p></p>
<span class="anchor" id="fragment-Updateraytransmittanceestimateatsampledpoint-0"></span><div class="fragmentname">&lt;&lt;Update ray transmittance estimate at sampled point&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonoT_rayandPDFsusingratio-trackingestimator-0">Update <tt>T_ray</tt> and PDFs using ratio-tracking estimator</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2218" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2218"><i></i></a><div id="fragbit-2218" class="collapse"><div class="fragmentcode">   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::ClampZero" class="code">ClampZero</a>(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
   Float pdf = T_maj[0] * sigma_maj[0];
   T_ray *= T_maj * sigma_n / pdf;
   r_l *= T_maj * sigma_maj / pdf;
   r_u *= T_maj * sigma_n / pdf;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatetransmittancecomputationusingRussianroulette-0">Possibly terminate transmittance computation using Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2219" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2219"><i></i></a><div id="fragbit-2219" class="collapse"><div class="fragmentcode">   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Tr = T_ray / (r_l + r_u).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
   if (Tr.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.05f) {
       Float q = 0.75f;
       if (rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;() &lt; q)
           T_ray = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.);
       else
           T_ray /= 1 - q;
   }</div></div>
return true;</div><p>


</p>
<p>
In the context of the equation of transfer, using ratio tracking to compute
transmittance can be seen as sampling distances along the ray according to
the majorant transmittance and then only including the null-scattering
component of the source function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.729ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1175 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="963" y="-213"></use>
</g>
</svg> to correct any underestimate of
transmittance from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.284ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 1844.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
<g transform="translate(584,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg>.  Because only null-scattering vertices
are sampled along transmittance rays, the logic for updating the
transmittance and rescaled path probabilities at each vertex exactly
follows that in the &lt;&lt;<span class="fragmentname"><a href="#fragment-Handlenullscatteringalongraypath-0">Handle null scattering along ray path</a></span>&gt;&gt;
fragment.

</p>
<p></p>
<span class="anchor" id="fragment-UpdatemonoT_rayandPDFsusingratio-trackingestimator-0"></span><div class="fragmentname">&lt;&lt;Update <tt>T_ray</tt> and PDFs using ratio-tracking estimator&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_n = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::ClampZero" class="code">ClampZero</a>(sigma_maj - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_a" class="code">sigma_a</a> - mp.<a href="../Volume_Scattering/Media.html#MediumProperties::sigma_s" class="code">sigma_s</a>);
Float pdf = T_maj[0] * sigma_maj[0];
T_ray *= T_maj * sigma_n / pdf;
r_l *= T_maj * sigma_maj / pdf;
r_u *= T_maj * sigma_n / pdf;</div><p>


</p>
<p>Russian roulette is used to randomly terminate rays with low transmittance.
A natural choice might seem to be setting the survival probability equal to
the transmittance&mdash;along the lines of how Russian roulette is used for
terminating ray paths from the camera according to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg>.  However, doing so would effectively
transform ratio tracking to delta tracking, with the transmittance always
equal to zero or one.  The implementation therefore applies a less
aggressive termination probability, only to highly attenuated rays.

</p>
<p>In the computation of the transmittance value used for the Russian roulette
test, note that an MIS weight that accounts for both the unidirectional and
light sampling strategies is used, along the lines of
Equation&nbsp;(<a href="#eq:volpath-wu-from-rescaled-probabilities">14.27</a>).

</p>
<p></p>
<span class="anchor" id="fragment-PossiblyterminatetransmittancecomputationusingRussianroulette-0"></span><div class="fragmentname">&lt;&lt;Possibly terminate transmittance computation using Russian roulette&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Tr = T_ray / (r_l + r_u).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
if (Tr.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.05f) {
    Float q = 0.75f;
    if (rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;() &lt; q)
        T_ray = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.);
    else
        T_ray /= 1 - q;
}</div><p>


</p>
<p>After the <tt>SampleT_maj()</tt> call returns, the transmittance and
rescaled path probabilities
all must be multiplied by the <tt>T_maj</tt> returned from
<tt>SampleT_maj()</tt> for the final ray segment.  (See the discussion for
the earlier &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleterminatedscatteredandunscatteredmediumrays-0">Handle terminated, scattered, and unscattered medium rays</a></span>&gt;&gt;
fragment for why each is updated as it is.)

</p>
<p></p>
<span class="anchor" id="fragment-Updatetransmittanceestimateforfinalsegment-0"></span><div class="fragmentname">&lt;&lt;Update transmittance estimate for final segment&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">T_ray *= T_maj / T_maj[0];
r_l *= T_maj / T_maj[0];
r_u *= T_maj / T_maj[0];</div><p>


</p>
<p>If the transmittance is zero (e.g., due to Russian roulette termination), it
is possible to return immediately.  Furthermore, if there is no surface
intersection, then there is no further medium sampling to be done and we
can move on to computing the scattered radiance from the light.
Alternatively, if there is an intersection, it must be with a surface that
represents the boundary between two media; the <tt>SpawnRayTo()</tt> method
call returns the continuation ray on the other side of the surface, with
its <tt>medium</tt> member variable set appropriately.

</p>
<p></p>
<span class="anchor" id="fragment-Generatenextraysegmentorreturnfinaltransmittance-0"></span><div class="fragmentname">&lt;&lt;Generate next ray segment or return final transmittance&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (!T_ray) return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
if (!si) break;
lightRay = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::SpawnRayTo" class="code">SpawnRayTo</a>(ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pLight" class="code">pLight</a>);</div><p>


</p>
<p>After the <tt>while</tt> loop terminates, we can compute the final rescaled
path probabilities, compute MIS weights, and return the final estimate of the path
contribution function for the light sample.

</p>
<p>The <tt>r_p</tt> variable passed in to <tt>SampleLd()</tt> stores the rescaled
path probabilities for unidirectional sampling of the path up to the vertex
where direct lighting is being computed&mdash;though here, <tt>r_u</tt> and
<tt>r_l</tt> have been rescaled using the light path sampling probability,
since that is how the vertices were sampled along the shadow ray.  However,
recall from Equations&nbsp;(<a href="#eq:volpath-unidir-path-probability">14.21</a>)
and&nbsp;(<a href="#eq:volpath-light-path-probability">14.23</a>) that
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.481ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 8818.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal u comma lamda 1 Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis equals p Subscript normal l comma lamda 1 Baseline left-parenthesis normal p Subscript Baseline overbar Subscript n Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-75" d="M535 0l-144 -11v90c-29 -62 -73 -90 -129 -90c-152 0 -152 91 -152 169v150c0 89 0 92 -78 92v31l147 11v-332c0 -52 4 -99 88 -99c73 0 121 68 121 155v178c0 49 -8 56 -78 56v31l147 11v-355c0 -49 8 -56 78 -56v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="556" y="0"></use>
<g transform="translate(590,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1964" y="0"></use>
<g transform="translate(2354,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3435" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="4102" y="0"></use>
<g transform="translate(5158,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6926" y="0"></use>
<g transform="translate(7316,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="8397" y="0"></use>
</g>
</svg> for
the path up to the scattering vertex.  Thus, <tt>r_p</tt> can be interpreted
as being rescaled using <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.431ex" height="3.176ex" style="vertical-align: -1.171ex;" viewBox="0 -863.1 2769 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash p Subscript normal l comma lamda 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D706" d="M548 -1c0 -3 -1 -9 -11 -10h-22c-27 0 -37 0 -53 22c-16 23 -64 176 -105 281l-241 -284c-8 -10 -17 -21 -33 -21s-30 12 -30 29c0 13 6 19 18 31l276 274l-97 272c-25 68 -32 74 -65 80c0 0 -9 2 -9 10c0 11 13 11 18 11c47 0 101 -13 122 -71l204 -569 c7 -20 13 -35 23 -46c3 -4 5 -6 5 -9Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
<g transform="translate(1001,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
<g transform="translate(503,-231)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2C" x="278" y="0"></use>
<g transform="translate(393,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D706" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="718" y="-243"></use>
</g>
</g>
</g>
</g>
</svg>.  This allows
multiplying <tt>r_l</tt> and <tt>r_u</tt> by <tt>r_p</tt> to compute final
rescaled path probabilities.

</p>
<p>If the light source is described by a delta distribution, only the light
sampling technique is applicable; there is no chance of intersecting such a
light via sampling the BSDF or phase function.  In that case, we still apply MIS using
all the wavelengths&rsquo; individual path PDFs in order to reduce variance in
chromatic media.

</p>
<p>For area lights, we are able to use both light source and the scattering
function samples, giving two primary sampling strategies, each of which has
a separate weight for each wavelength.

</p>
<p></p>
<span class="anchor" id="fragment-Returnpathcontributionfunctionestimatefordirectlighting-0"></span><div class="fragmentname">&lt;&lt;Return path contribution function estimate for direct lighting&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">r_l *= r_p * lightPDF;
r_u *= r_p * scatterPDF;
if (<a href="../Light_Sources/Light_Interface.html#IsDeltaLight" class="code">IsDeltaLight</a>(light.<a href="../Light_Sources/Light_Interface.html#Light::Type" class="code">Type</a>()))
    return beta * f_hat * T_ray * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> / r_l.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
else
    return beta * f_hat * T_ray * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> / (r_l + r_u).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div><p>


</p>
<p>With <tt>SampleLd()</tt> implemented, we will return to the fragments in the
<tt>Li()</tt> method that handle the cases where a ray escapes from the
scene and possibly finds illumination from infinite area lights, as well as where a
ray intersects an emissive surface.  These handle the first term in
the direct lighting MIS estimator, Equation&nbsp;(<a href="#eq:volpath-two-sample-mis-estimator">14.24</a>).

</p>
<p></p>
<span class="anchor" id="fragment-Addemittedlightatvolumepathvertexorfromtheenvironment-0"></span><div class="fragmentname">&lt;&lt;Add emitted light at volume path vertex or from the environment&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (!si) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Accumulatecontributionsfrominfinitelightsources-0">Accumulate contributions from infinite light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2220" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2220"><i></i></a><div id="fragbit-2220" class="collapse"><div class="fragmentcode">       for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
           if (<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda); <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>) {
               if (depth == 0 || specularBounce)
                   L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> / r_u.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
               else {
                   &lt;&lt;<span class="fragmentname"><a href="#fragment-AddinfinitelightcontributionusingbothPDFswithMIS-0">Add infinite light contribution using both PDFs with MIS</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2221" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2221"><i></i></a><div id="fragbit-2221" class="collapse"><div class="fragmentcode">                      Float lightPDF = <a href="#VolPathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrContext, light) *
                                       light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrContext, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
                      r_l *= lightPDF;
                      L += beta * Le / (r_u + r_l).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
               }
           }
       }</div></div>
    break;
}
<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;isect = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
if (<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a> = isect.<a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>(-ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, lambda); <a href="../Light_Sources/Area_Lights.html#SurfaceInteraction::Le" class="code">Le</a>) {
    &lt;&lt;<span class="fragmentname">Add contribution of emission from intersected surface</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2222" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2222"><i></i></a><div id="fragbit-2222" class="collapse"><div class="fragmentcode">       if (depth == 0 || specularBounce)
           L += beta * Le / r_u.Average();
       else {
           &lt;&lt;<span class="fragmentname">Add surface light contribution using both PDFs with MIS</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2223" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2223"><i></i></a><div id="fragbit-2223" class="collapse"><div class="fragmentcode">              <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> areaLight(isect.areaLight);
              Float lightPDF =
                  lightSampler.PMF(prevIntrContext, areaLight) *
                  areaLight.PDF_Li(prevIntrContext, ray.d, true);
              r_l *= lightPDF;
              L += beta * Le / (r_u + r_l).Average();</div></div>
       }</div></div>
}</div><p>


</p>
<p>As with the <tt>PathIntegrator</tt>, if the previous
scattering event was due to a delta-distribution scattering function, then
sampling the light is not a useful strategy.  In that case, the MIS weight
is only based on the per-wavelength PDFs for the unidirectional sampling
strategy.

</p>
<p></p>
<span class="anchor" id="fragment-Accumulatecontributionsfrominfinitelightsources-0"></span><div class="fragmentname">&lt;&lt;Accumulate contributions from infinite light sources&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
    if (<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda); <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>) {
        if (depth == 0 || specularBounce)
            L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> / r_u.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();
        else {
            &lt;&lt;<span class="fragmentname"><a href="#fragment-AddinfinitelightcontributionusingbothPDFswithMIS-0">Add infinite light contribution using both PDFs with MIS</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2224" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2224"><i></i></a><div id="fragbit-2224" class="collapse"><div class="fragmentcode">               Float lightPDF = <a href="#VolPathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrContext, light) *
                                light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrContext, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
               r_l *= lightPDF;
               L += beta * Le / (r_u + r_l).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div></div>
        }
    }
}</div><p>


</p>
<p>Otherwise, the MIS weight should account for both sampling techniques.  At
this point, <tt>r_l</tt> has everything but the probabilities for sampling
the light itself.  (Recall that we deferred that when initializing
<tt>r_l</tt> at the real-scattering vertex earlier.)  After incorporating
that factor, all that is left is to compute the final weight, accounting for
both sampling strategies.

</p>
<p></p>
<span class="anchor" id="fragment-AddinfinitelightcontributionusingbothPDFswithMIS-0"></span><div class="fragmentname">&lt;&lt;Add infinite light contribution using both PDFs with MIS&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float lightPDF = <a href="#VolPathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrContext, light) *
                 light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrContext, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
r_l *= lightPDF;
L += beta * Le / (r_u + r_l).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>();</div><p>


</p>
<p>The work done in the &lt;&lt;<span class="fragmentname">Add contribution of emission from
intersected surface</span>&gt;&gt; fragment is very similar to that done for infinite
lights, so it is not included here.

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
<div class="container-fluid">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>,<br>
<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">&copy; 2004-2023</a> Matt Pharr, Wenzel Jakob, and Greg Humphreys.
<a href="https://github.com/mmp/pbr-book-website/"><span class="fab fa-github"></span></a><br>
Purchase a printed copy: <a href="https://www.amazon.com/Physically-Based-Rendering-fourth-Implementation/dp/0262048027?keywords=physically+based+rendering+4th+edition&qid=1671730412&sprefix=physically+based%!C(MISSING)aps%!C(MISSING)145&sr=8-1&linkCode=ll1&tag=pharr-20&linkId=81a816d90f0c7e872617f1f930a51fd6&language=en_US&ref_=as_li_ss_tl"><span class="fab fa-amazon"></span></a>
<a href="https://mitpress.mit.edu/9780262048026/physically-based-rendering/"><img src="/mitpress.png" width=10 height=16></a>
</span>
</div>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Light_Transport_II_Volume_Rendering/Scattering_from_Layered_Materials.html">Light Transport II: Volume Rendering / Scattering from Layered Materials</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
