
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.ico?v=2" /> <!-- force refresh -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

<script async src="https://cse.google.com/cse.js?cx=22a43cef261a245ea"></script>  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>Media</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Volume_Scattering.html">Volume Scattering</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Media</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Volume_Scattering/Phase_Functions.html">(Previous: Phase Functions)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:media"></span><h2>11.4 Media</h2><p>



</p>
<p>Implementations of the <tt>Medium</tt> interface provide
various representations of volumetric scattering properties in a region of
space.  In a complex scene, there may be multiple <tt>Medium</tt> instances,
each representing different types of scattering in different parts of the
scene.  For example, an outdoor lake scene might have one <tt>Medium</tt> to
model atmospheric scattering, another to model mist rising from the lake,
and a third to model particles suspended in the water of the lake.

</p>
<p>The <tt>Medium</tt> interface is also defined in the file
<a href="https://github.com/mmp/pbrt-v4/tree/master/src/pbrt/base/media.h"><tt>base/media.h</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-MediumDefinition-0"></span><div class="fragmentname">&lt;&lt;Medium Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="Medium"></span>Medium : public <a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer" class="code">TaggedPointer</a>&lt;&lt;&lt;<span class="fragmentname"><a href="#fragment-MediumTypes-0">Medium Types</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1564" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1564"><i></i></a><div id="fragbit-1564" class="collapse"><div class="fragmentcode">        <a href="#HomogeneousMedium" class="code">HomogeneousMedium</a>, <a href="#GridMedium" class="code">GridMedium</a>, <a href="#RGBGridMedium" class="code">RGBGridMedium</a>, <a href="#CloudMedium" class="code">CloudMedium</a>, <a href="#NanoVDBMedium" class="code">NanoVDBMedium</a></div></div>&gt; {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-MediumInterface-0">Medium Interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1565" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1565"><i></i></a><div id="fragbit-1565" class="collapse"><div class="fragmentcode">       using <a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer" class="code">TaggedPointer</a>::<a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer" class="code">TaggedPointer</a>;
       
       static <a href="#Medium" class="code">Medium</a> Create(const std::string &amp;name,
                                  const ParameterDictionary &amp;parameters,
                                  const <a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> &amp;renderFromMedium, const FileLoc *loc,
                                  Allocator alloc);
       
       std::string ToString() const;
       bool IsEmissive() const;
       MediumProperties SamplePoint(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p,
                                    const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const;</div></div>
    &lt;&lt;<span class="fragmentname">Medium Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1566" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1566"><i></i></a><div id="fragbit-1566" class="collapse"><div class="fragmentcode">       <a href="#RayMajorantIterator" class="code">RayMajorantIterator</a> SampleRay(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float tMax,
           const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda, <a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer" class="code">ScratchBuffer</a> &amp;buf) const;</div></div>
};</div><p>


</p>
<p><tt>pbrt</tt> provides five medium implementations.


The first three will be discussed in the book, but
<tt>CloudMedium</tt><span class="anchor" id="CloudMedium"></span> is only included in the online
edition of the book and the last,

<tt>NanoVDBMedium</tt><span class="anchor" id="NanoVDBMedium"></span>, will not be presented at all. (It provides
support for using volumes defined in the <em>NanoVDB</em> format in <tt>pbrt</tt>.
As elsewhere, we avoid discussion of the use of third-party APIs in the
book text.)

</p>
<p></p>
<span class="anchor" id="fragment-MediumTypes-0"></span><div class="fragmentname">&lt;&lt;Medium Types&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="#HomogeneousMedium" class="code">HomogeneousMedium</a>, <a href="#GridMedium" class="code">GridMedium</a>, <a href="#RGBGridMedium" class="code">RGBGridMedium</a>, <a href="#CloudMedium" class="code">CloudMedium</a>, <a href="#NanoVDBMedium" class="code">NanoVDBMedium</a></div><p>


</p>
<p>

</p>
<p>Before we get to the specification of the methods in the interface, we will
describe a few details related to how media are represented in <tt>pbrt</tt>.

</p>
<p>The spatial distribution and extent of media in a scene is defined by
associating <tt>Medium</tt> instances with the camera, lights, and primitives
in the scene.  For example, <a href="../Cameras_and_Film/Camera_Interface.html#Camera"><tt>Camera</tt></a>s store a <tt>Medium</tt> that
represents the medium that the camera is inside. Rays
leaving the camera then have the <tt>Medium</tt> associated with them.
In a similar fashion, each <a href="../Light_Sources/Light_Interface.html#Light"><tt>Light</tt></a> stores a <tt>Medium</tt>
representing its medium. A <tt>nullptr</tt> value can be used to indicate a
vacuum (where no volumetric scattering occurs).

</p>
<p>In <tt>pbrt</tt>, the boundary between two different types of
scattering media is always represented by the surface of a primitive.
Rather than storing a single <tt>Medium</tt> like lights and cameras each do,
primitives may store a <tt>MediumInterface</tt>, which stores the medium on
each side of the primitive&rsquo;s surface.

</p>
<p></p>
<span class="anchor" id="fragment-MediumInterfaceDefinition-0"></span><div class="fragmentname">&lt;&lt;MediumInterface Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct <span class="anchor" id="MediumInterface"></span>MediumInterface {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-MediumInterfacePublicMethods-0">MediumInterface Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1567" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1567"><i></i></a><div id="fragbit-1567" class="collapse"><div class="fragmentcode">       std::string ToString() const;
       <a href="#MediumInterface" class="code">MediumInterface</a>(<a href="#Medium" class="code">Medium</a> medium) : <a href="#MediumInterface::inside" class="code">inside</a>(medium), <a href="#MediumInterface::outside" class="code">outside</a>(medium) {}
       <a href="#MediumInterface" class="code">MediumInterface</a>(<a href="#Medium" class="code">Medium</a> <a href="#MediumInterface::inside" class="code">inside</a>, <a href="#Medium" class="code">Medium</a> <a href="#MediumInterface::outside" class="code">outside</a>)
           : <a href="#MediumInterface::inside" class="code">inside</a>(<a href="#MediumInterface::inside" class="code">inside</a>), <a href="#MediumInterface::outside" class="code">outside</a>(<a href="#MediumInterface::outside" class="code">outside</a>) {}
       bool IsMediumTransition() const { return <a href="#MediumInterface::inside" class="code">inside</a> != <a href="#MediumInterface::outside" class="code">outside</a>; }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-MediumInterfacePublicMembers-0">MediumInterface Public Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1568" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1568"><i></i></a><div id="fragbit-1568" class="collapse"><div class="fragmentcode">       <a href="#Medium" class="code">Medium</a> inside, outside;</div></div>
};</div><p>


</p>
<p><tt>MediumInterface</tt> holds two <a href="#Medium"><tt>Medium</tt></a>s, one for the interior of
the primitive and one for the exterior.  

</p>
<p></p>
<span class="anchor" id="fragment-MediumInterfacePublicMembers-0"></span><div class="fragmentname">&lt;&lt;MediumInterface Public Members&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="#Medium" class="code">Medium</a> <span class="anchor" id="MediumInterface::inside"></span>inside, <span class="anchor" id="MediumInterface::outside"></span>outside;</div><p>


</p>
<p>

</p>
<p>Specifying the extent of participating media in this way does allow the
user to specify impossible or inconsistent configurations.  For example, a
primitive could be specified as having one medium outside of it, and the
camera could be specified as being in a different medium without there
being a
<tt>MediumInterface</tt> between the camera and the surface of the primitive.
In this case, a ray leaving the primitive toward the camera would be
treated as being in a different medium from a ray leaving the camera toward
the primitive.  In turn, light transport algorithms would be unable to
compute consistent results.  For <tt>pbrt</tt>&rsquo;s purposes, we think it is reasonable
to expect that the user will be able to specify a consistent configuration
of media in the scene and that the added complexity of code to check this
is not worthwhile.

</p>
<p>A <tt>MediumInterface</tt> can be initialized with either one or two
<tt>Medium</tt> values.  If only one is provided, then it represents an
interface with the same medium on both sides.

</p>
<p></p>
<span class="anchor" id="fragment-MediumInterfacePublicMethods-0"></span><div class="fragmentname">&lt;&lt;MediumInterface Public Methods&gt;&gt;=&nbsp;<a href="#fragment-MediumInterfacePublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="#MediumInterface" class="code">MediumInterface</a>(<a href="#Medium" class="code">Medium</a> medium) : <a href="#MediumInterface::inside" class="code">inside</a>(medium), <a href="#MediumInterface::outside" class="code">outside</a>(medium) {}
<a href="#MediumInterface" class="code">MediumInterface</a>(<a href="#Medium" class="code">Medium</a> <a href="#MediumInterface::inside" class="code">inside</a>, <a href="#Medium" class="code">Medium</a> <a href="#MediumInterface::outside" class="code">outside</a>)
    : <a href="#MediumInterface::inside" class="code">inside</a>(<a href="#MediumInterface::inside" class="code">inside</a>), <a href="#MediumInterface::outside" class="code">outside</a>(<a href="#MediumInterface::outside" class="code">outside</a>) {}</div><p>


</p>
<p>The <tt>IsMediumTransition()</tt> method indicates whether a particular
<tt>MediumInterface</tt> instance marks a transition between two distinct
media.

</p>
<p></p>
<span class="anchor" id="fragment-MediumInterfacePublicMethods-1"></span><div class="fragmentname">&lt;&lt;MediumInterface Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-MediumInterfacePublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="MediumInterface::IsMediumTransition"></span>IsMediumTransition() const { return <a href="#MediumInterface::inside" class="code">inside</a> != <a href="#MediumInterface::outside" class="code">outside</a>; }</div><p>


</p>
<p>With this context in hand, we can now provide a missing piece in the
implementation of the <a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#SurfaceInteraction::SetIntersectionProperties"><tt>SurfaceInteraction::SetIntersectionProperties()</tt></a>
method&mdash;the implementation of the &lt;&lt;<span class="fragmentname"><a href="#fragment-Setmediumpropertiesatsurfaceintersection-0">Set medium properties at
surface intersection</a></span>&gt;&gt; fragment.  (Recall that this method is called by
<a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive"><tt>Primitive</tt></a> <tt>Intersect()</tt>
methods when an intersection has been found.)

</p>
<p>Instead of simply copying the value of the primitive&rsquo;s
<a href="#MediumInterface"><tt>MediumInterface</tt></a> into the <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction"><tt>SurfaceInteraction</tt></a>, it follows a
slightly different approach and
only uses this <a href="#MediumInterface"><tt>MediumInterface</tt></a> if it specifies a
proper transition between participating media. Otherwise, the
<tt>Ray::medium</tt> field takes precedence.
Setting the <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction"><tt>SurfaceInteraction</tt></a>&rsquo;s <tt>mediumInterface</tt> field in this
way greatly simplifies the specification of scenes containing media: in
particular, it is not necessary to provide corresponding <tt>Medium</tt>s at
every scene surface that is in
contact with a medium. Instead, only non-opaque surfaces that have
different media on each side require an explicit medium interface. In the
simplest case where a scene containing opaque objects is filled with a
participating medium (e.g., haze), it is enough for the camera and light
sources to have their media specified accordingly.

</p>
<p></p>
<span class="anchor" id="fragment-Setmediumpropertiesatsurfaceintersection-0"></span><div class="fragmentname">&lt;&lt;Set medium properties at surface intersection&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (primMediumInterface &amp;&amp; primMediumInterface-&gt;<a href="#MediumInterface::IsMediumTransition" class="code">IsMediumTransition</a>())
    <a href="../Geometry_and_Transformations/Interactions.html#Interaction::mediumInterface" class="code">mediumInterface</a> = primMediumInterface;
else
    <a href="../Geometry_and_Transformations/Interactions.html#Interaction::medium" class="code">medium</a> = rayMedium;</div><p>


</p>
<p>Once <tt>mediumInterface</tt> or <tt>medium</tt> is set, it is possible
to implement methods that return information about the local media.  For
surface interactions, a direction <tt>w</tt> can be specified to select a
side of the surface.  If a <tt>MediumInterface</tt> has been stored, the dot
product with the surface normal determines whether the inside or outside
medium should be returned.  Otherwise, <tt>medium</tt> is returned.

</p>
<p></p>
<span class="anchor" id="fragment-InteractionPublicMethods-8"></span><div class="fragmentname">&lt;&lt;Interaction Public Methods&gt;&gt;+=&nbsp;<a href="../Shapes/Managing_Rounding_Error.html#fragment-InteractionPublicMethods-7"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-InteractionPublicMethods-9"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="#Medium" class="code">Medium</a> <span class="anchor" id="Interaction::GetMedium"></span>GetMedium(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w) const {
    if (<a href="../Geometry_and_Transformations/Interactions.html#Interaction::mediumInterface" class="code">mediumInterface</a>)
        return <a href="../Geometry_and_Transformations/Vectors.html#Dot" class="code">Dot</a>(w, n) &gt; 0 ? <a href="../Geometry_and_Transformations/Interactions.html#Interaction::mediumInterface" class="code">mediumInterface</a>-&gt;outside :
                               <a href="../Geometry_and_Transformations/Interactions.html#Interaction::mediumInterface" class="code">mediumInterface</a>-&gt;inside;
    return <a href="../Geometry_and_Transformations/Interactions.html#Interaction::medium" class="code">medium</a>;
}</div><p>


</p>
<p>For interactions that are known to be inside participating media, another
variant of <tt>GetMedium()</tt> that does not take the irrelevant outgoing
direction vector is available.  In this case, if a <tt>MediumInterface *</tt>
has been stored, it should point to the same medium for both &ldquo;inside&rdquo; and
&ldquo;outside.&rdquo;

</p>
<p></p>
<span class="anchor" id="fragment-InteractionPublicMethods-9"></span><div class="fragmentname">&lt;&lt;Interaction Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-InteractionPublicMethods-8"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="#Medium" class="code">Medium</a> GetMedium() const {
    return <a href="../Geometry_and_Transformations/Interactions.html#Interaction::mediumInterface" class="code">mediumInterface</a> ? <a href="../Geometry_and_Transformations/Interactions.html#Interaction::mediumInterface" class="code">mediumInterface</a>-&gt;inside : <a href="../Geometry_and_Transformations/Interactions.html#Interaction::medium" class="code">medium</a>;
}</div><p>


</p>
<p>Primitives associated with shapes that represent medium boundaries
generally have a <a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#Material"><tt>Material</tt></a> associated with them.  For example, the
surface of a lake might use an instance of <a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#DielectricMaterial"><tt>DielectricMaterial</tt></a> to
describe scattering at the lake surface, which also acts as the boundary
between the rising mist&rsquo;s <tt>Medium</tt> and the lake water&rsquo;s <tt>Medium</tt>.
However, sometimes we only need the shape for the boundary surface that it
provides to delimit a participating medium boundary and we do not want to
see the surface itself.  For example, the medium representing a cloud might
be bounded by a box made of triangles where the triangles are only there to
delimit the cloud&rsquo;s extent and should not otherwise affect light passing
through them.

</p>
<p>While such a surface that disappears and does not affect ray paths could be
accurately described by a BTDF that represents perfect specular
transmission with the same index of refraction on both sides, dealing with
such surfaces places extra burden on the <tt>Integrator</tt>s (not all of
which handle this type of specular light transport well).  Therefore,
<tt>pbrt</tt> allows such surfaces to have a <a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#Material"><tt>Material</tt></a> that is
<tt>nullptr</tt>, indicating that they do not affect light passing through
them; in turn, <a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF"><tt>SurfaceInteraction::GetBSDF()</tt></a> will return an unset
<tt>BSDF</tt>.  The light transport routines then do not worry about light
scattering from such surfaces and only account for changes in the current
medium at them. For an example of the difference that scattering at the
surface makes, see
Figure&nbsp;<a href="#fig:media-boundary-and-no">11.16</a>, which has two instances of
the Ganesha model filled with scattering media; one has a scattering surface
at the boundary and the other does not.

</p>
<p></p>
<span class="anchor" id="fig:media-boundary-and-no"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 62.500%; position:relative;">
<div id="ganesha-interface-and-none.png45" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('ganesha-interface-and-none.png45'), { image: 'ganesha-interface-and-none.png' });
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 11.16: Scattering Media inside the Ganesha. <span class="legend">
Both models have the same isotropic homogeneous scattering media inside of
them. On the left, the <tt>Material</tt> is <tt>nullptr</tt>, which indicates
that the sur- face should be ignored by rays and is only used to delineate a
participating medium&rsquo;s extent.  On the right, the model&rsquo;s surface has a
dielectric interface that both makes the interface visible and scatters
some of the incident light, making the interior darker.
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#MediumInterface"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:medium-interface-definition"></span><span id="MediumInterface"></span><h3>11.4.1  Medium Interface</h3><p>



</p>
<p><a href="#Medium"><tt>Medium</tt></a> implementations must include three methods.
The first is <tt>IsEmissive()</tt>, which indicates whether they include any
volumetric emission.  This method is used solely so that <tt>pbrt</tt> can check
if a scene has been specified without any light sources and print an
informative message if so.

</p>
<p></p>
<span class="anchor" id="fragment-MediumInterface-0"></span><div class="fragmentname">&lt;&lt;Medium Interface&gt;&gt;=&nbsp;<a href="#fragment-MediumInterface-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="Medium::IsEmissive"></span>IsEmissive() const;</div><p>


</p>
<p>
The <tt>SamplePoint()</tt> method returns information about the scattering and
emission properties of the medium at a specified rendering-space point in the form of a
<a href="#MediumProperties"><tt>MediumProperties</tt></a> object.

</p>
<p></p>
<span class="anchor" id="fragment-MediumInterface-1"></span><div class="fragmentname">&lt;&lt;Medium Interface&gt;&gt;+=&nbsp;<a href="#fragment-MediumInterface-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">MediumProperties <span class="anchor" id="Medium::SamplePoint"></span>SamplePoint(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p,
                             const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const;</div><p>


</p>
<p><tt>MediumProperties</tt> is a simple structure that wraps up the values that
describe scattering and emission at a point inside a medium.  When
initialized to their default
values, its member variables together indicate no scattering or emission.
Thus, implementations of <tt>SamplePoint()</tt> can directly return a
<tt>MediumProperties</tt> with no further initialization if the specified
point is outside of the medium&rsquo;s spatial extent.

</p>
<p></p>
<span class="anchor" id="fragment-MediumPropertiesDefinition-0"></span><div class="fragmentname">&lt;&lt;MediumProperties Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct <span class="anchor" id="MediumProperties"></span>MediumProperties {
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="MediumProperties::sigma_a"></span>sigma_a, <span class="anchor" id="MediumProperties::sigma_s"></span>sigma_s;
    <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunction" class="code">PhaseFunction</a> <span class="anchor" id="MediumProperties::phase"></span>phase;
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="MediumProperties::Le"></span>Le;
};</div><p>


</p>
<p>The third method that <tt>Medium</tt> implementations must implement is
<tt>SampleRay()</tt>, which provides information about the medium&rsquo;s majorant
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.254ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1831.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg> along the ray&rsquo;s extent.  It does so using one or more
<tt>RayMajorantSegment</tt> objects.  Each describes a constant majorant over
a segment of a ray.

</p>
<p></p>
<span class="anchor" id="fragment-RayMajorantSegmentDefinition-0"></span><div class="fragmentname">&lt;&lt;RayMajorantSegment Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct <span class="anchor" id="RayMajorantSegment"></span>RayMajorantSegment {
    Float <span class="anchor" id="RayMajorantSegment::tMin"></span>tMin, <span class="anchor" id="RayMajorantSegment::tMax"></span>tMax;
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="RayMajorantSegment::sigma_maj"></span>sigma_maj;
};</div><p>


</p>
<p>Some <tt>Medium</tt> implementations have a single medium-wide majorant
(e.g., <a href="#HomogeneousMedium"><tt>HomogeneousMedium</tt></a>), though for media where the scattering
coefficients vary significantly over their extent, it is usually better to
have distinct local majorants that bound <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.199ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 946.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
</g>
</svg> over smaller regions.
These tighter majorants can improve rendering performance by reducing the
frequency of null scattering when sampling interactions along a ray.

</p>
<p>The number of segments along a ray is variable, depending on both the ray&rsquo;s
geometry and how the medium discretizes space.  However, we would not like
to return variable-sized arrays of <tt>RayMajorantSegment</tt>s from
<tt>SampleRay()</tt> method implementations.  Although dynamic memory
allocation to store them could be efficiently handled using a
<a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer"><tt>ScratchBuffer</tt></a>, another motivation not to immediately return all of
them is that often not all the <tt>RayMajorantSegment</tt>s along the ray
are needed; if the ray path terminates or scattering occurs along the ray,
then any additional <tt>RayMajorantSegment</tt>s past the corresponding point
would be unused and their initialization would be wasted work.

</p>
<p> </p>
<span class="anchor" id="fig:medium-ray-iterator"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha11f17.svg" title=""><img src="pha11f17.svg" width=486 height=150 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 11.17: <span class="legend"> <a href="#RayMajorantIterator"><tt>RayMajorantIterator</tt></a> implementations return a series of
segments in parametric <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> along a ray where each segment has
a majorant that is an upper bound of the medium&rsquo;s <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.199ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 946.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
</g>
</svg> value along the segment.
Implementations are free to specify segments of varying lengths and to skip
regions of space with no scattering, though they must provide segments in
front-to-back order. 
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Therefore, the <tt>RayMajorantIterator</tt> interface provides a mechanism
for <tt>Medium</tt> implementations to return <a href="#RayMajorantSegment"><tt>RayMajorantSegment</tt></a>s one
at a time as they are needed.  There is a single method in this interface:
<tt>Next()</tt>.  Implementations of it should return majorant segments from
the front to the back of the ray with no overlap in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> between segments,
though it may skip over ranges of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> corresponding to regions of space
where there is no scattering. (See Figure&nbsp;<a href="#fig:medium-ray-iterator">11.17</a>.)
After it has returned all segments along the ray, an unset <tt>optional</tt>
value should be returned.  Thanks to this interface, different
<tt>Medium</tt> implementations can generate <a href="#RayMajorantSegment"><tt>RayMajorantSegment</tt></a>s in
different ways depending on their internal medium representation.

</p>
<p></p>
<span class="anchor" id="fragment-RayMajorantIteratorDefinition-0"></span><div class="fragmentname">&lt;&lt;RayMajorantIterator Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="RayMajorantIterator"></span>RayMajorantIterator : public <a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer" class="code">TaggedPointer</a>&lt;<a href="#HomogeneousMajorantIterator" class="code">HomogeneousMajorantIterator</a>,
                                                 <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a>&gt; {
  public:
    pstd::optional&lt;RayMajorantSegment&gt; <span class="anchor" id="RayMajorantIterator::Next"></span>Next();
};</div><p>


</p>
<p>Turning back now to the <tt>SampleRay()</tt> interface method: in
Chapters&nbsp;<a href="../Light_Transport_II_Volume_Rendering.html#chap:volume-integration">14</a> and&nbsp;<a href="../Wavefront_Rendering_on_GPUs.html#chap:gpu">15</a> we will find it
useful to know the type of <a href="#RayMajorantIterator"><tt>RayMajorantIterator</tt></a> that is associated
with a specific <tt>Medium</tt> type.  We can then declare the iterator as a
local variable that is stored on the stack, which improves efficiency both
from avoiding dynamic memory allocation for it and from allowing the
compiler to more easily store it in registers.  Therefore, <tt>pbrt</tt> requires
that <tt>Medium</tt> implementations include a local type definition for
<tt>MajorantIterator</tt> in their class definition that gives the type of
their <a href="#RayMajorantIterator"><tt>RayMajorantIterator</tt></a>.  Their <tt>SampleRay()</tt> method itself
should then directly return their majorant iterator type.  Concretely, a
<tt>Medium</tt> implementation should include declarations like the following
in its class definition, with the ellipsis replaced with its
<tt>RayMajorantIterator</tt> type.

</p>
<p></p>
<div class="fragmentcode">using MajorantIterator = ...;
MajorantIterator SampleRay(Ray ray, Float tMax,
                           const SampledWavelengths &amp;lambda) const;</div><p>


</p>
<p>(The form of this type and method definition is similar to the
<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#Material::GetBxDF"><tt>Material::GetBxDF()</tt></a> methods in Section&nbsp;<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#sec:material-interface">10.5</a>.)

</p>
<p>For cases where the medium&rsquo;s type is not known at compile time, the
<tt>Medium</tt> class itself provides the implementation of a different
<tt>SampleRay()</tt> method that takes a <a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer"><tt>ScratchBuffer</tt></a>, uses it to
allocate the appropriate amount of storage for the medium&rsquo;s ray iterator,
and then calls the <tt>Medium</tt>&rsquo;s <tt>SampleRay()</tt> method implementation
to initialize it.  The returned <a href="#RayMajorantIterator"><tt>RayMajorantIterator</tt></a> can then be used
to iterate over the majorant segments.

</p>
<p>

</p>
<p>The implementation of this method uses the same trick that
<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#Material::GetBSDF"><tt>Material::GetBSDF()</tt></a> does: the <a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer"><tt>TaggedPointer</tt></a>&rsquo;s dynamic dispatch
capabilities are used to automatically generate a separate call to the
provided lambda function for each medium type, with the <tt>medium</tt>
parameter specialized to be of the <tt>Medium</tt>&rsquo;s concrete type.

</p>
<p></p>
<span class="anchor" id="fragment-MediumSamplingFunctionDefinitions-0"></span><div class="fragmentname">&lt;&lt;Medium Sampling Function Definitions&gt;&gt;=&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#fragment-MediumSamplingFunctionDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="#RayMajorantIterator" class="code">RayMajorantIterator</a> <span class="anchor" id="Medium::SampleRay"></span><a href="#Medium" class="code">Medium</a>::SampleRay(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float tMax,
        const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda, <a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer" class="code">ScratchBuffer</a> &amp;buf) const {
    auto sample = [ray,tMax,lambda,&amp;buf](auto medium) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnmonoRayMajorantIteratorformediumsmajorantiterator-0">Return <tt>RayMajorantIterator</tt> for medium&rsquo;s majorant iterator</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1569" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1569"><i></i></a><div id="fragbit-1569" class="collapse"><div class="fragmentcode">           using ConcreteMedium = typename std::remove_reference_t&lt;decltype(*medium)&gt;;
           using Iter = typename ConcreteMedium::MajorantIterator;
           Iter *iter = (Iter *)buf.<a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer::Alloc" class="code">Alloc</a>(sizeof(Iter), alignof(Iter));
           *iter = medium-&gt;SampleRay(ray, tMax, lambda);
           return <a href="#RayMajorantIterator" class="code">RayMajorantIterator</a>(iter);</div></div>
    };
    return <a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer::DispatchCPU" class="code">DispatchCPU</a>(sample);
}</div><p>


</p>
<p>The <a href="#Medium"><tt>Medium</tt></a> passed to the lambda function arrives as a reference to a
pointer to the medium type; those are easily removed to get the basic
underlying type.  From it, the iterator type follows from the
<tt>MajorantIterator</tt> type declaration in the associated class.  In turn,
storage can be allocated for the iterator type and it can be initialized.
Since the returned value is of the <a href="#RayMajorantIterator"><tt>RayMajorantIterator</tt></a> interface
type, the caller can proceed without concern for the actual&nbsp;type.

</p>
<p></p>
<span class="anchor" id="fragment-ReturnmonoRayMajorantIteratorformediumsmajorantiterator-0"></span><div class="fragmentname">&lt;&lt;Return <tt>RayMajorantIterator</tt> for medium&rsquo;s majorant iterator&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">using ConcreteMedium = typename std::remove_reference_t&lt;decltype(*medium)&gt;;
using Iter = typename ConcreteMedium::MajorantIterator;
Iter *iter = (Iter *)buf.<a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer::Alloc" class="code">Alloc</a>(sizeof(Iter), alignof(Iter));
*iter = medium-&gt;SampleRay(ray, tMax, lambda);
return <a href="#RayMajorantIterator" class="code">RayMajorantIterator</a>(iter);</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#HomogeneousMedium"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="HomogeneousMedium"></span><h3>11.4.2  Homogeneous Medium</h3><p>


</p>
<p>The <tt>HomogeneousMedium</tt> is the simplest possible medium.  It represents
a region of space with constant <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg>, and
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.545ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1095.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
</g>
</svg> values throughout its extent.  It uses the Henyey&ndash;Greenstein phase
function to represent scattering in the medium, also with a constant
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.109ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 477.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">g</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D454" d="M474 395c0 -7 -2 -12 -3 -18l-111 -444c-15 -60 -87 -138 -212 -138c-96 0 -133 20 -133 61c0 40 32 58 54 58c27 0 38 -19 38 -35c0 -17 -11 -43 -41 -52c28 -9 61 -10 80 -10c106 0 140 99 144 108l33 132l-1 1c-10 -11 -57 -58 -116 -58c-72 0 -133 59 -133 158 c0 144 124 284 238 284c40 0 75 -26 93 -63c4 36 31 43 41 43c17 0 29 -10 29 -27zM392 334c0 5 -14 86 -80 86c-42 0 -85 -40 -112 -89c-27 -51 -56 -169 -56 -217c0 -40 15 -92 65 -92c29 0 60 18 81 36c22 19 45 44 51 70l48 191c1 4 3 10 3 15Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D454" x="0" y="0"></use>
</g>
</svg>.  Its definition is in the files <a href="https://github.com/mmp/pbrt-v4/tree/master/src/pbrt/media.h"><tt>media.h</tt></a> and
<a href="https://github.com/mmp/pbrt-v4/tree/master/src/pbrt/media.cpp"><tt>media.cpp</tt></a>.  This medium was used for the images in
Figures&nbsp;<a href="../Volume_Scattering/Phase_Functions.html#fig:hg-renderings">11.15</a> and&nbsp;<a href="#fig:media-boundary-and-no">11.16</a>.

</p>
<p></p>
<span class="anchor" id="fragment-HomogeneousMediumDefinition-0"></span><div class="fragmentname">&lt;&lt;HomogeneousMedium Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="HomogeneousMedium"></span>HomogeneousMedium {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-HomogeneousMediumPublicTypeDefinitions-0">HomogeneousMedium Public Type Definitions</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1570" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1570"><i></i></a><div id="fragbit-1570" class="collapse"><div class="fragmentcode">       using MajorantIterator = HomogeneousMajorantIterator;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-HomogeneousMediumPublicMethods-0">HomogeneousMedium Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1571" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1571"><i></i></a><div id="fragbit-1571" class="collapse"><div class="fragmentcode">       HomogeneousMedium(<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum" class="code">Spectrum</a> sigma_a, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum" class="code">Spectrum</a> sigma_s,
                         Float sigmaScale, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum" class="code">Spectrum</a> Le, Float LeScale, Float g, Allocator alloc)
           : <a href="#HomogeneousMedium::sigma_a_spec" class="code">sigma_a_spec</a>(sigma_a, alloc), <a href="#HomogeneousMedium::sigma_s_spec" class="code">sigma_s_spec</a>(sigma_s, alloc),
             <a href="#HomogeneousMedium::Le_spec" class="code">Le_spec</a>(Le, alloc), <a href="#HomogeneousMedium::phase" class="code">phase</a>(g) {
           <a href="#HomogeneousMedium::sigma_a_spec" class="code">sigma_a_spec</a>.Scale(sigmaScale);
           <a href="#HomogeneousMedium::sigma_s_spec" class="code">sigma_s_spec</a>.Scale(sigmaScale);
           <a href="#HomogeneousMedium::Le_spec" class="code">Le_spec</a>.Scale(LeScale);
       }
       static HomogeneousMedium *Create(const ParameterDictionary &amp;parameters,
                                        const FileLoc *loc, Allocator alloc);
       bool IsEmissive() const { return <a href="#HomogeneousMedium::Le_spec" class="code">Le_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::MaxValue" class="code">MaxValue</a>() &gt; 0; }
       MediumProperties SamplePoint(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p,
                                    const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#HomogeneousMedium::sigma_a_spec" class="code">sigma_a_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#HomogeneousMedium::sigma_s_spec" class="code">sigma_s_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le = <a href="#HomogeneousMedium::Le_spec" class="code">Le_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
           return MediumProperties{sigma_a, sigma_s, &amp;<a href="#HomogeneousMedium::phase" class="code">phase</a>, Le};
       }
       HomogeneousMajorantIterator SampleRay(
               <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float tMax, const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#HomogeneousMedium::sigma_a_spec" class="code">sigma_a_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#HomogeneousMedium::sigma_s_spec" class="code">sigma_s_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
           return HomogeneousMajorantIterator(0, tMax, sigma_a + sigma_s);
       }
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-HomogeneousMediumPrivateData-0">HomogeneousMedium Private Data</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1572" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1572"><i></i></a><div id="fragbit-1572" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum" class="code">DenselySampledSpectrum</a> sigma_a_spec, sigma_s_spec, Le_spec;
       <a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> phase;</div></div>
};</div><p>


</p>
<p>

</p>
<p>Its constructor (not included here) initializes the following member
variables from provided parameters.  It takes spectral values in the general
form of <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum"><tt>Spectrum</tt></a>s but converts them to the form of
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum"><tt>DenselySampledSpectrum</tt></a>s.  While this incurs a memory cost of a
kilobyte or so for each one, it ensures that sampling the spectrum will be
fairly efficient and will not require, for example, the binary search that
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#PiecewiseLinearSpectrum"><tt>PiecewiseLinearSpectrum</tt></a> uses.  It is unlikely that there will be
enough distinct instances of <tt>HomogeneousMedium</tt> in a scene that this
memory cost will be significant.

</p>
<p></p>
<span class="anchor" id="fragment-HomogeneousMediumPrivateData-0"></span><div class="fragmentname">&lt;&lt;HomogeneousMedium Private Data&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum" class="code">DenselySampledSpectrum</a> <span class="anchor" id="HomogeneousMedium::sigma_a_spec"></span>sigma_a_spec, <span class="anchor" id="HomogeneousMedium::sigma_s_spec"></span>sigma_s_spec, <span class="anchor" id="HomogeneousMedium::Le_spec"></span>Le_spec;
<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> <span class="anchor" id="HomogeneousMedium::phase"></span>phase;</div><p>


</p>
<p>

</p>
<p>Implementation of the <tt>IsEmissive()</tt> interface method is
straightforward.

</p>
<p></p>
<span class="anchor" id="fragment-HomogeneousMediumPublicMethods-0"></span><div class="fragmentname">&lt;&lt;HomogeneousMedium Public Methods&gt;&gt;=&nbsp;<a href="#fragment-HomogeneousMediumPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="HomogeneousMedium::IsEmissive"></span>IsEmissive() const { return <a href="#HomogeneousMedium::Le_spec" class="code">Le_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::MaxValue" class="code">MaxValue</a>() &gt; 0; }</div><p>


</p>
<p><tt>SamplePoint()</tt> just needs to sample the various constant scattering
properties at the specified wavelengths.

</p>
<p></p>
<span class="anchor" id="fragment-HomogeneousMediumPublicMethods-1"></span><div class="fragmentname">&lt;&lt;HomogeneousMedium Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-HomogeneousMediumPublicMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-HomogeneousMediumPublicMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">MediumProperties <span class="anchor" id="HomogeneousMedium::SamplePoint"></span>SamplePoint(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p,
                             const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#HomogeneousMedium::sigma_a_spec" class="code">sigma_a_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#HomogeneousMedium::sigma_s_spec" class="code">sigma_s_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le = <a href="#HomogeneousMedium::Le_spec" class="code">Le_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
    return MediumProperties{sigma_a, sigma_s, &amp;<a href="#HomogeneousMedium::phase" class="code">phase</a>, Le};
}</div><p>


</p>
<p><tt>SampleRay()</tt> uses the <a href="#HomogeneousMajorantIterator"><tt>HomogeneousMajorantIterator</tt></a> class
for its <a href="#RayMajorantIterator"><tt>RayMajorantIterator</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-HomogeneousMediumPublicTypeDefinitions-0"></span><div class="fragmentname">&lt;&lt;HomogeneousMedium Public Type Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">using <span class="anchor" id="HomogeneousMedium::MajorantIterator"></span>MajorantIterator = HomogeneousMajorantIterator;</div><p>


</p>
<p>There is no need for null scattering in a homogeneous medium and so a
single <a href="#RayMajorantSegment"><tt>RayMajorantSegment</tt></a> for the ray&rsquo;s entire extent suffices.
<tt>HomogeneousMajorantIterator</tt> therefore stores such a segment
directly.

</p>
<p></p>
<span class="anchor" id="fragment-HomogeneousMajorantIteratorDefinition-0"></span><div class="fragmentname">&lt;&lt;HomogeneousMajorantIterator Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="HomogeneousMajorantIterator"></span>HomogeneousMajorantIterator {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-HomogeneousMajorantIteratorPublicMethods-0">HomogeneousMajorantIterator Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1573" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1573"><i></i></a><div id="fragbit-1573" class="collapse"><div class="fragmentcode">       HomogeneousMajorantIterator() : <a href="#HomogeneousMajorantIterator::called" class="code">called</a>(true) {}
       HomogeneousMajorantIterator(Float tMin, Float tMax,
                                   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj)
           : <a href="#HomogeneousMajorantIterator::seg" class="code">seg</a>{tMin, tMax, sigma_maj}, <a href="#HomogeneousMajorantIterator::called" class="code">called</a>(false) {}
       pstd::optional&lt;<a href="#RayMajorantSegment" class="code">RayMajorantSegment</a>&gt; Next() {
           if (<a href="#HomogeneousMajorantIterator::called" class="code">called</a>) return {};
           <a href="#HomogeneousMajorantIterator::called" class="code">called</a> = true;
           return <a href="#HomogeneousMajorantIterator::seg" class="code">seg</a>;
       }
       std::string ToString() const;</div></div>
  private:
    RayMajorantSegment <span class="anchor" id="HomogeneousMajorantIterator::seg"></span>seg;
    bool <span class="anchor" id="HomogeneousMajorantIterator::called"></span>called;
};</div><p>


</p>
<p>Its default constructor sets <tt>called</tt> to true and stores no segment;
in this way, the case of a ray missing a medium and there being no valid
segment can be handled with a default-initialized
<tt>HomogeneousMajorantIterator</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-HomogeneousMajorantIteratorPublicMethods-0"></span><div class="fragmentname">&lt;&lt;HomogeneousMajorantIterator Public Methods&gt;&gt;=&nbsp;<a href="#fragment-HomogeneousMajorantIteratorPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">HomogeneousMajorantIterator() : called(true) {}
HomogeneousMajorantIterator(Float tMin, Float tMax,
                            <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj)
    : seg{tMin, tMax, sigma_maj}, called(false) {}</div><p>


</p>
<p>If a segment was specified, it is returned the first time <tt>Next()</tt> is
called.  Subsequent calls return an unset value, indicating that there are
no more segments.

</p>
<p></p>
<span class="anchor" id="fragment-HomogeneousMajorantIteratorPublicMethods-1"></span><div class="fragmentname">&lt;&lt;HomogeneousMajorantIterator Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-HomogeneousMajorantIteratorPublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#RayMajorantSegment" class="code">RayMajorantSegment</a>&gt; <span class="anchor" id="HomogeneousMajorantIterator::Next"></span>Next() {
    if (<a href="#HomogeneousMajorantIterator::called" class="code">called</a>) return {};
    <a href="#HomogeneousMajorantIterator::called" class="code">called</a> = true;
    return <a href="#HomogeneousMajorantIterator::seg" class="code">seg</a>;
}</div><p>


</p>
<p>

</p>
<p>The implementation of <tt>HomogeneousMedium::SampleRay()</tt> is now trivial.
Its only task is to compute the majorant, which is equal to
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.727ex" height="2.343ex" style="vertical-align: -0.671ex;" viewBox="0 -719.6 5479.8 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t Baseline equals sigma Subscript normal a Baseline plus sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1224" y="0"></use>
<g transform="translate(2280,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="3528" y="0"></use>
<g transform="translate(4529,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fragment-HomogeneousMediumPublicMethods-2"></span><div class="fragmentname">&lt;&lt;HomogeneousMedium Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-HomogeneousMediumPublicMethods-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">HomogeneousMajorantIterator <span class="anchor" id="HomogeneousMedium::SampleRay"></span>SampleRay(
        <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float tMax, const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#HomogeneousMedium::sigma_a_spec" class="code">sigma_a_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#HomogeneousMedium::sigma_s_spec" class="code">sigma_s_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::Sample" class="code">Sample</a>(lambda);
    return HomogeneousMajorantIterator(0, tMax, sigma_a + sigma_s);
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#DDAMajorantIterator"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="DDAMajorantIterator"></span><h3>11.4.3  DDA Majorant Iterator</h3><p>


</p>
<p>Before moving on to the remaining two <tt>Medium</tt> implementations, we
will describe another <a href="#RayMajorantIterator"><tt>RayMajorantIterator</tt></a> that is much more efficient
than the <a href="#HomogeneousMajorantIterator"><tt>HomogeneousMajorantIterator</tt></a> when the medium&rsquo;s scattering
coefficients vary over its extent.  To understand the problem
with a single majorant in this case, recall that the mean free path is the
average distance between scattering events.  It is one over the attenuation
coefficient and so the average <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> step returned by a call to
<a href="../Sampling_Algorithms/Sampling_1D_Functions.html#SampleExponential"><tt>SampleExponential()</tt></a> given a majorant <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.254ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1831.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg> will be
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.579ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 2832.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
<g transform="translate(1001,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</g>
</svg>.  Now consider a medium that has a <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.46ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2781.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t Baseline equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2280" y="0"></use>
</g>
</svg> almost
everywhere but has <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.785ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 3782.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t Baseline equals 100</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1224" y="0"></use>
<g transform="translate(2280,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1001" y="0"></use>
</g>
</g>
</svg> in a small region.  If <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.84ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 4667.1 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal m normal a normal j Baseline equals 100</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2109" y="0"></use>
<g transform="translate(3165,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1001" y="0"></use>
</g>
</g>
</svg> everywhere,
then in the less dense region 99% of the sampled distances will be
null-scattering events and the ray will take steps that are 100 times
shorter than it would take if <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.254ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1831.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal m normal a normal j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6A" d="M210 -50c0 -91 -62 -155 -137 -155c-57 0 -113 28 -113 80c0 26 18 46 46 46s46 -20 46 -46c0 -27 -20 -41 -35 -45c26 -13 49 -13 54 -13c64 0 73 86 73 131v396c0 49 -9 56 -86 56v31l152 11v-492zM210 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53 c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
<g transform="translate(571,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6A" x="1334" y="0"></use>
</g>
</g>
</svg> was&nbsp;1.  Rendering performance suffers
accordingly.

</p>
<p>This issue motivates using a data structure to store spatially varying
majorants, which allows tighter majorants and more efficient sampling
operations.  A variety of data structures have been used for this problem;
the &ldquo;Further Reading&rdquo; section has details.  The remainder of <tt>pbrt</tt>&rsquo;s
<tt>Medium</tt> implementations all use a simple grid where each cell stores a
majorant over the corresponding region of the volume.  In turn, as a ray
passes through the medium, it is split into segments through this grid and
sampled based on the local majorant.

</p>
<p>More precisely, the local majorant is found with the combination of a regular grid of
voxels of scalar densities and a <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum"><tt>SampledSpectrum</tt></a> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.199ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 946.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
</g>
</svg> value.
The majorant in each voxel is given by the product of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.199ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 946.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
</g>
</svg> and the
voxel&rsquo;s density.  The <a href="#MajorantGrid"><tt>MajorantGrid</tt></a> class stores that grid of
voxels.

</p>
<p></p>
<span class="anchor" id="fragment-MajorantGridDefinition-0"></span><div class="fragmentname">&lt;&lt;MajorantGrid Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct <span class="anchor" id="MajorantGrid"></span>MajorantGrid {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-MajorantGridPublicMethods-0">MajorantGrid Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1574" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1574"><i></i></a><div id="fragbit-1574" class="collapse"><div class="fragmentcode">       MajorantGrid() = default;
       MajorantGrid(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> bounds, Point3i <a href="#MajorantGrid::res" class="code">res</a>, Allocator alloc)
           : bounds(bounds), <a href="#MajorantGrid::voxels" class="code">voxels</a>(<a href="#MajorantGrid::res" class="code">res</a>.x * <a href="#MajorantGrid::res" class="code">res</a>.y * <a href="#MajorantGrid::res" class="code">res</a>.z, alloc), <a href="#MajorantGrid::res" class="code">res</a>(<a href="#MajorantGrid::res" class="code">res</a>) {}
       Float Lookup(int x, int y, int z) const {
           return <a href="#MajorantGrid::voxels" class="code">voxels</a>[x + <a href="#MajorantGrid::res" class="code">res</a>.x * (y + <a href="#MajorantGrid::res" class="code">res</a>.y * z)];
       }
       void Set(int x, int y, int z, Float v) {
           <a href="#MajorantGrid::voxels" class="code">voxels</a>[x + <a href="#MajorantGrid::res" class="code">res</a>.x * (y + <a href="#MajorantGrid::res" class="code">res</a>.y * z)] = v;
       }
       <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> VoxelBounds(int x, int y, int z) const {
           <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p0(Float(x)   / <a href="#MajorantGrid::res" class="code">res</a>.x, Float(y)   / <a href="#MajorantGrid::res" class="code">res</a>.y, Float(z)   / <a href="#MajorantGrid::res" class="code">res</a>.z);
           <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p1(Float(x+1) / <a href="#MajorantGrid::res" class="code">res</a>.x, Float(y+1) / <a href="#MajorantGrid::res" class="code">res</a>.y, Float(z+1) / <a href="#MajorantGrid::res" class="code">res</a>.z);
           return <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a>(p0, p1);
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-MajorantGridPublicMembers-0">MajorantGrid Public Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1575" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1575"><i></i></a><div id="fragbit-1575" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> bounds;
       pstd::vector&lt;Float&gt; voxels;
       Point3i res;</div></div>
};</div><p>


</p>
<p><tt>MajorantGrid</tt> just stores an axis-aligned bounding box for the grid,
its voxel values, and its resolution in each dimension.

</p>
<p></p>
<span class="anchor" id="fragment-MajorantGridPublicMembers-0"></span><div class="fragmentname">&lt;&lt;MajorantGrid Public Members&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> <span class="anchor" id="MajorantGrid::bounds"></span>bounds;
pstd::vector&lt;Float&gt; <span class="anchor" id="MajorantGrid::voxels"></span>voxels;
Point3i <span class="anchor" id="MajorantGrid::res"></span>res;</div><p>


</p>
<p>

</p>
<p>The voxel array is indexed in the usual manner, with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> values laid out
consecutively in memory, then <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg>, and then <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg>.  Two simple methods handle
the indexing math for setting and looking up values in the grid.

</p>
<p></p>
<span class="anchor" id="fragment-MajorantGridPublicMethods-0"></span><div class="fragmentname">&lt;&lt;MajorantGrid Public Methods&gt;&gt;=&nbsp;<a href="#fragment-MajorantGridPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="MajorantGrid::Lookup"></span>Lookup(int x, int y, int z) const {
    return <a href="#MajorantGrid::voxels" class="code">voxels</a>[x + <a href="#MajorantGrid::res" class="code">res</a>.x * (y + <a href="#MajorantGrid::res" class="code">res</a>.y * z)];
}
void <span class="anchor" id="MajorantGrid::Set"></span>Set(int x, int y, int z, Float v) {
    <a href="#MajorantGrid::voxels" class="code">voxels</a>[x + <a href="#MajorantGrid::res" class="code">res</a>.x * (y + <a href="#MajorantGrid::res" class="code">res</a>.y * z)] = v;
}</div><p>


</p>
<p>Next, the <tt>VoxelBounds()</tt> method returns the bounding box
corresponding to the specified voxel in the grid.  Note that the returned
bounds are with respect to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket cubed</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-33" x="393" y="513"></use>
</g>
</g>
</svg> and not the <tt>bounds</tt> member
variable.

</p>
<p></p>
<span class="anchor" id="fragment-MajorantGridPublicMethods-1"></span><div class="fragmentname">&lt;&lt;MajorantGrid Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-MajorantGridPublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> <span class="anchor" id="MajorantGrid::VoxelBounds"></span>VoxelBounds(int x, int y, int z) const {
    <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p0(Float(x)   / <a href="#MajorantGrid::res" class="code">res</a>.x, Float(y)   / <a href="#MajorantGrid::res" class="code">res</a>.y, Float(z)   / <a href="#MajorantGrid::res" class="code">res</a>.z);
    <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p1(Float(x+1) / <a href="#MajorantGrid::res" class="code">res</a>.x, Float(y+1) / <a href="#MajorantGrid::res" class="code">res</a>.y, Float(z+1) / <a href="#MajorantGrid::res" class="code">res</a>.z);
    return <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a>(p0, p1);
}</div><p>


</p>
<p>Efficiently enumerating the voxels that the ray passes through can be done
with a technique that is similar in spirit to Bresenham&rsquo;s classic line
drawing algorithm, which incrementally finds series of pixels that a line
passes through using just addition and comparisons to step from one pixel
to the next.  (This type of algorithm is known as a <em>digital
differential analyzer</em> (DDA)&mdash;hence the name of the
<tt>DDAMajorantIterator</tt>.) The main difference between the ray stepping
algorithm and Bresenham&rsquo;s is that we would like to find <em>all</em> of the
voxels that the ray passes through, while Bresenham&rsquo;s algorithm typically
only turns on one pixel per row or column that a line passes through.

</p>
<p></p>
<span class="anchor" id="fragment-DDAMajorantIteratorDefinition-0"></span><div class="fragmentname">&lt;&lt;DDAMajorantIterator Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="DDAMajorantIterator"></span>DDAMajorantIterator {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-DDAMajorantIteratorPublicMethods-0">DDAMajorantIterator Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1576" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1576"><i></i></a><div id="fragbit-1576" class="collapse"><div class="fragmentcode">       DDAMajorantIterator(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float <a href="#DDAMajorantIterator::tMin" class="code">tMin</a>, Float <a href="#DDAMajorantIterator::tMax" class="code">tMax</a>,
                           const MajorantGrid *grid, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_t)
           : <a href="#DDAMajorantIterator::tMin" class="code">tMin</a>(<a href="#DDAMajorantIterator::tMin" class="code">tMin</a>), <a href="#DDAMajorantIterator::tMax" class="code">tMax</a>(<a href="#DDAMajorantIterator::tMax" class="code">tMax</a>), grid(grid), sigma_t(sigma_t) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Setup3DDDAforraythroughthemajorantgrid-0">Set up 3D DDA for ray through the majorant grid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1577" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1577"><i></i></a><div id="fragbit-1577" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> diag = <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>();
              <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> rayGrid(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Offset" class="code">Offset</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>)),
                          <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>.x / diag.x, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>.y / diag.y, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>.z / diag.z));
              <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> gridIntersect = rayGrid(tMin);
              for (int axis = 0; axis &lt; 3; ++axis) {
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Initializeraysteppingparametersformonoaxis-0">Initialize ray stepping parameters for <tt>axis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1578" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1578"><i></i></a><div id="fragbit-1578" class="collapse"><div class="fragmentcode">                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Computecurrentvoxelforaxisandhandlenegativezerodirection-0">Compute current voxel for axis and handle negative zero direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1579" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1579"><i></i></a><div id="fragbit-1579" class="collapse"><div class="fragmentcode">                        <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[axis] = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(gridIntersect[axis] * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis],
                                            0, <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis] - 1);
                        <a href="#DDAMajorantIterator::deltaT" class="code">deltaT</a>[axis] = 1 / (std::abs(rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis]) * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis]);
                        if (rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] == -0.f)
                            rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] = 0.f;</div></div>
                     if (rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] &gt;= 0) {
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleraywithpositivedirectionforvoxelstepping-0">Handle ray with positive direction for voxel stepping</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1580" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1580"><i></i></a><div id="fragbit-1580" class="collapse"><div class="fragmentcode">                            Float nextVoxelPos = Float(voxel[axis] + 1) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
                            <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                                                          rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
                            <a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = 1;
                            <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];</div></div>
                     } else {
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleraywithnegativedirectionforvoxelstepping-0">Handle ray with negative direction for voxel stepping</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1581" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1581"><i></i></a><div id="fragbit-1581" class="collapse"><div class="fragmentcode">                            Float nextVoxelPos = Float(voxel[axis]) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
                            <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                                                          rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
                            <a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = -1;
                            <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = -1;</div></div>
                     }</div></div>
              }</div></div>
       }
       pstd::optional&lt;<a href="#RayMajorantSegment" class="code">RayMajorantSegment</a>&gt; Next() {
           if (<a href="#DDAMajorantIterator::tMin" class="code">tMin</a> &gt;= <a href="#DDAMajorantIterator::tMax" class="code">tMax</a>) return {};
           &lt;&lt;<span class="fragmentname"><a href="#fragment-FindmonostepAxisforsteppingtonextvoxelandexitpointmonotVoxelExit-0">Find <tt>stepAxis</tt> for stepping to next voxel and exit point <tt>tVoxelExit</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1582" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1582"><i></i></a><div id="fragbit-1582" class="collapse"><div class="fragmentcode">              int bits = ((<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[0] &lt; <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[1]) &lt;&lt; 2) +
                         ((<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[0] &lt; <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[2]) &lt;&lt; 1) +
                         ((<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[1] &lt; <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[2]));
              const int cmpToAxis[8] = {2, 1, 2, 1, 2, 2, 0, 0};
              int stepAxis = cmpToAxis[bits];
              Float tVoxelExit = std::min(tMax, <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[stepAxis]);</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-GetmonomaxDensityforcurrentvoxelandinitializemonoRayMajorantSegmentmonoseg-0">Get <tt>maxDensity</tt> for current voxel and initialize <tt>RayMajorantSegment</tt>, <tt>seg</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1583" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1583"><i></i></a><div id="fragbit-1583" class="collapse"><div class="fragmentcode">              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj = <a href="#DDAMajorantIterator::sigma_t" class="code">sigma_t</a> *
                                          <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::Lookup" class="code">Lookup</a>(<a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[0], <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[1], <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[2]);
              <a href="#RayMajorantSegment" class="code">RayMajorantSegment</a> seg{<a href="#DDAMajorantIterator::tMin" class="code">tMin</a>, tVoxelExit, sigma_maj};</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Advancetonextvoxelinmaximumdensitygrid-0">Advance to next voxel in maximum density grid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1584" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1584"><i></i></a><div id="fragbit-1584" class="collapse"><div class="fragmentcode">              <a href="#DDAMajorantIterator::tMin" class="code">tMin</a> = tVoxelExit;
              if (<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[stepAxis] &gt; tMax) <a href="#DDAMajorantIterator::tMin" class="code">tMin</a> = tMax;
              <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[stepAxis] += <a href="#DDAMajorantIterator::step" class="code">step</a>[stepAxis];
              if (<a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[stepAxis] == <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[stepAxis]) <a href="#DDAMajorantIterator::tMin" class="code">tMin</a> = tMax;
              <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[stepAxis] += <a href="#DDAMajorantIterator::deltaT" class="code">deltaT</a>[stepAxis];</div></div>
           return seg;
       }
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-DDAMajorantIteratorPrivateMembers-0">DDAMajorantIterator Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1585" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1585"><i></i></a><div id="fragbit-1585" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_t;
       Float tMin = Infinity, tMax = -Infinity;
       const MajorantGrid *grid;
       Float nextCrossingT[3], deltaT[3];
       int step[3], voxelLimit[3], voxel[3];</div></div>
};</div><p>


</p>
<p>After copying parameters passed to it to member variables, the
constructor&rsquo;s main task is to compute a number of values that represent the
DDA&rsquo;s state.

</p>
<p></p>
<span class="anchor" id="fragment-DDAMajorantIteratorPublicMethods-0"></span><div class="fragmentname">&lt;&lt;DDAMajorantIterator Public Methods&gt;&gt;=&nbsp;<a href="#fragment-DDAMajorantIteratorPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">DDAMajorantIterator(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float tMin, Float tMax,
                    const MajorantGrid *grid, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_t)
    : tMin(tMin), tMax(tMax), grid(grid), sigma_t(sigma_t) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Setup3DDDAforraythroughthemajorantgrid-0">Set up 3D DDA for ray through the majorant grid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1586" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1586"><i></i></a><div id="fragbit-1586" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> diag = <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>();
       <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> rayGrid(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Offset" class="code">Offset</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>)),
                   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>.x / diag.x, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>.y / diag.y, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>.z / diag.z));
       <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> gridIntersect = rayGrid(tMin);
       for (int axis = 0; axis &lt; 3; ++axis) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Initializeraysteppingparametersformonoaxis-0">Initialize ray stepping parameters for <tt>axis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1587" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1587"><i></i></a><div id="fragbit-1587" class="collapse"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-Computecurrentvoxelforaxisandhandlenegativezerodirection-0">Compute current voxel for axis and handle negative zero direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1588" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1588"><i></i></a><div id="fragbit-1588" class="collapse"><div class="fragmentcode">                 <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[axis] = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(gridIntersect[axis] * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis],
                                     0, <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis] - 1);
                 <a href="#DDAMajorantIterator::deltaT" class="code">deltaT</a>[axis] = 1 / (std::abs(rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis]) * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis]);
                 if (rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] == -0.f)
                     rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] = 0.f;</div></div>
              if (rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] &gt;= 0) {
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleraywithpositivedirectionforvoxelstepping-0">Handle ray with positive direction for voxel stepping</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1589" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1589"><i></i></a><div id="fragbit-1589" class="collapse"><div class="fragmentcode">                     Float nextVoxelPos = Float(voxel[axis] + 1) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
                     <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                                                   rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
                     <a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = 1;
                     <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];</div></div>
              } else {
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleraywithnegativedirectionforvoxelstepping-0">Handle ray with negative direction for voxel stepping</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1590" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1590"><i></i></a><div id="fragbit-1590" class="collapse"><div class="fragmentcode">                     Float nextVoxelPos = Float(voxel[axis]) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
                     <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                                                   rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
                     <a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = -1;
                     <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = -1;</div></div>
              }</div></div>
       }</div></div>
}</div><p>


</p>
<p>The <tt>tMin</tt> and <tt>tMax</tt> member variables store the parametric range
of the ray for which majorant segments are yet to be generated; <tt>tMin</tt>
is advanced after each step.  Their
default values specify a degenerate range, which causes a default-initialized
<tt>DDAMajorantIterator</tt>  to return no segments when its <tt>Next()</tt>
method is called.

</p>
<p></p>
<span class="anchor" id="fragment-DDAMajorantIteratorPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;DDAMajorantIterator Private Members&gt;&gt;=&nbsp;<a href="#fragment-DDAMajorantIteratorPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="DDAMajorantIterator::sigma_t"></span>sigma_t;
Float <span class="anchor" id="DDAMajorantIterator::tMin"></span>tMin = Infinity, <span class="anchor" id="DDAMajorantIterator::tMax"></span>tMax = -Infinity;
const MajorantGrid *<span class="anchor" id="DDAMajorantIterator::grid"></span>grid;</div><p>


</p>
<p>Grid voxel traversal is handled by an incremental algorithm that tracks the
current voxel and the parametric <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> where the ray enters the next voxel in each direction.
It successively takes a step in the direction that has the smallest such <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg>
until the ray exits the grid or traversal is halted.  The values that the
algorithm needs to keep track of are the following:

</p>
<p></p>
<ol>
<li> The integer coordinates of the voxel currently being considered, <tt>voxel</tt>.

<li> The parametric <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> position along the ray where it makes its next
crossing into another voxel in each of the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg>, and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> directions,
<tt>nextCrossingT</tt> (Figure&nbsp;<a href="#fig:grid-dda">11.18</a>).

<span class="anchor" id="fig:grid-dda"></span><div class="card outerfigure"><div class="card-body figure">


<div class="figure-row">
  <a href="pha11f18.svg" title=""><img src="pha11f18.svg" width=645 height=306 style="max-width: 100%;"></a>
</div>


<figcaption class="caption">Figure 11.18: Stepping a Ray through a Voxel Grid. <span class="legend">
The parametric distance along the ray to the point where it crosses into the next
voxel in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> direction is stored in <tt>nextCrossingT[0]</tt>, and similarly
for the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> directions (not shown).  When the ray crosses into the next <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>
voxel, for example, it is immediately possible to update the value of
<tt>nextCrossingT[0]</tt> by adding a fixed value, the voxel width in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> divided
by the ray&rsquo;s <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> direction, <tt>deltaT[0]</tt>.</span>
</figcaption>

</div></div>

<li> The change in the current voxel coordinates after a step in each
direction (<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.162ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 500.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
</g>
</svg> or <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.971ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 1279 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">negative 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="778" y="0"></use>
</g>
</svg>), stored in <tt>step</tt>.

<li> The parametric distance along the ray between voxels in each direction,
<tt>deltaT</tt>.

<li> The coordinates of the voxel after the last one the ray passes through when it
exits the grid, <tt>voxelLimit</tt>.
</ol><p>


</p>
<p>The first two values are updated as the ray steps through the grid,
while the last three are constant for each ray.  All are stored in member
variables.

</p>
<p></p>
<span class="anchor" id="fragment-DDAMajorantIteratorPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;DDAMajorantIterator Private Members&gt;&gt;+=&nbsp;<a href="#fragment-DDAMajorantIteratorPrivateMembers-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="DDAMajorantIterator::nextCrossingT"></span>nextCrossingT[3], <span class="anchor" id="DDAMajorantIterator::deltaT"></span>deltaT[3];
int <span class="anchor" id="DDAMajorantIterator::step"></span>step[3], <span class="anchor" id="DDAMajorantIterator::voxelLimit"></span>voxelLimit[3], <span class="anchor" id="DDAMajorantIterator::voxel"></span>voxel[3];</div><p>


</p>
<p>For the DDA computations, we will transform the ray to a coordinate system
where the grid spans <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket cubed</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-33" x="393" y="513"></use>
</g>
</g>
</svg>, giving the ray
<tt>rayGrid</tt>.  Working in this space simplifies some of the calculations
related to the DDA.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="If you are wondering why it is correct to use
the value of <tt>tMin</tt> that was computed using <tt>ray</tt> with
<tt>rayGrid</tt> to find the point <tt>gridIntersect</tt>, review
Section&nbsp;<a href="../Shapes/Basic_Shape_Interface.html#sec:isect-coordinate-spaces">6.1.4</a> and carefully consider how the
components of <tt>rayGrid</tt> are initialized.">
      <sup>&dagger;</sup>
    </button>
		

</p>
<p></p>
<span class="anchor" id="fragment-Setup3DDDAforraythroughthemajorantgrid-0"></span><div class="fragmentname">&lt;&lt;Set up 3D DDA for ray through the majorant grid&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> diag = <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>();
<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> rayGrid(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Offset" class="code">Offset</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>)),
            <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>.x / diag.x, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>.y / diag.y, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>.z / diag.z));
<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> gridIntersect = rayGrid(tMin);
for (int axis = 0; axis &lt; 3; ++axis) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Initializeraysteppingparametersformonoaxis-0">Initialize ray stepping parameters for <tt>axis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1591" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1591"><i></i></a><div id="fragbit-1591" class="collapse"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computecurrentvoxelforaxisandhandlenegativezerodirection-0">Compute current voxel for axis and handle negative zero direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1592" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1592"><i></i></a><div id="fragbit-1592" class="collapse"><div class="fragmentcode">          <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[axis] = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(gridIntersect[axis] * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis],
                              0, <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis] - 1);
          <a href="#DDAMajorantIterator::deltaT" class="code">deltaT</a>[axis] = 1 / (std::abs(rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis]) * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis]);
          if (rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] == -0.f)
              rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] = 0.f;</div></div>
       if (rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] &gt;= 0) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleraywithpositivedirectionforvoxelstepping-0">Handle ray with positive direction for voxel stepping</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1593" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1593"><i></i></a><div id="fragbit-1593" class="collapse"><div class="fragmentcode">              Float nextVoxelPos = Float(voxel[axis] + 1) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
              <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                                            rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
              <a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = 1;
              <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];</div></div>
       } else {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleraywithnegativedirectionforvoxelstepping-0">Handle ray with negative direction for voxel stepping</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1594" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1594"><i></i></a><div id="fragbit-1594" class="collapse"><div class="fragmentcode">              Float nextVoxelPos = Float(voxel[axis]) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
              <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                                            rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
              <a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = -1;
              <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = -1;</div></div>
       }</div></div>
}</div><p>


</p>
<p>

</p>
<p>Some of the DDA state values for each dimension are always
computed in the same way, while others depend on the sign of the ray&rsquo;s
direction in that dimension.

</p>
<p></p>
<span class="anchor" id="fragment-Initializeraysteppingparametersformonoaxis-0"></span><div class="fragmentname">&lt;&lt;Initialize ray stepping parameters for <tt>axis</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Computecurrentvoxelforaxisandhandlenegativezerodirection-0">Compute current voxel for axis and handle negative zero direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1595" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1595"><i></i></a><div id="fragbit-1595" class="collapse"><div class="fragmentcode">   <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[axis] = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(gridIntersect[axis] * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis],
                       0, <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis] - 1);
   <a href="#DDAMajorantIterator::deltaT" class="code">deltaT</a>[axis] = 1 / (std::abs(rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis]) * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis]);
   if (rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] == -0.f)
       rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] = 0.f;</div></div>
if (rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] &gt;= 0) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleraywithpositivedirectionforvoxelstepping-0">Handle ray with positive direction for voxel stepping</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1596" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1596"><i></i></a><div id="fragbit-1596" class="collapse"><div class="fragmentcode">       Float nextVoxelPos = Float(voxel[axis] + 1) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
       <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                                     rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
       <a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = 1;
       <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];</div></div>
} else {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Handleraywithnegativedirectionforvoxelstepping-0">Handle ray with negative direction for voxel stepping</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1597" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1597"><i></i></a><div id="fragbit-1597" class="collapse"><div class="fragmentcode">       Float nextVoxelPos = Float(voxel[axis]) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
       <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                                     rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
       <a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = -1;
       <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = -1;</div></div>
}</div><p>


</p>
<p>The integer coordinates of the initial voxel are easily found using the
grid intersection point.  Because it is with respect to the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket cubed</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-33" x="393" y="513"></use>
</g>
</g>
</svg> cube,
all that is necessary is to scale by the resolution in each dimension and
take the integer component of that value.  It is, however, important to
clamp this value to the valid range in case round-off error leads to an
out-of-bounds value.

</p>
<p>
Next, <tt>deltaT</tt> is found by dividing the voxel width, which is one over
its resolution since we are working in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket cubed</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-33" x="393" y="513"></use>
</g>
</g>
</svg>, by the absolute value of
the ray&rsquo;s direction component for the current axis.  (The absolute value is
taken since <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> only increases as the DDA visits successive voxels.)

</p>
<p>Finally, a rare and subtle case related to the IEEE floating-point
representation must be handled.  Recall from Section&nbsp;<a href="../Shapes/Managing_Rounding_Error.html#sec:ieee-fp">6.8.1</a> that
both &ldquo;positive&rdquo; and &ldquo;negative&rdquo; zero values can be represented as
floats.  Normally there is no need to distinguish between them as
the distinction is mostly not evident&mdash;for example, comparing a negative zero to a
positive zero gives a true result.  However, the fragment after this one
will take advantage of the fact that it is legal to compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.165ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2223.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 circled-division-slash 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2298" d="M691 250c0 123 -74 229 -180 276l-206 -566c26 -8 55 -12 84 -12c167 0 302 135 302 302zM473 540c-26 8 -55 12 -84 12c-167 0 -302 -135 -302 -302c0 -123 74 -229 180 -276zM731 250c0 -189 -153 -342 -342 -342s-342 153 -342 342s153 342 342 342s342 -153 342 -342 Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2298" x="722" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1723" y="0"></use>
</g>
</svg>
in floating point, which gives an infinite value.  There, we would always
like the positive infinity, and thus negative zeros are cleaned up here.

</p>
<p></p>
<span class="anchor" id="fragment-Computecurrentvoxelforaxisandhandlenegativezerodirection-0"></span><div class="fragmentname">&lt;&lt;Compute current voxel for axis and handle negative zero direction&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[axis] = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(gridIntersect[axis] * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis],
                    0, <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis] - 1);
<a href="#DDAMajorantIterator::deltaT" class="code">deltaT</a>[axis] = 1 / (std::abs(rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis]) * <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis]);
if (rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] == -0.f)
    rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis] = 0.f;</div><p>


</p>
<p>The parametric <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> value where the ray exits the current voxel,
<tt>nextCrossingT[axis]</tt>, is found with the ray&ndash;slab intersection
algorithm from Section&nbsp;<a href="../Shapes/Basic_Shape_Interface.html#sec:ray-bounds-intersect">6.1.2</a>, using the plane that
passes through the corresponding voxel face.
Given a zero-valued direction component, <tt>nextCrossingT</tt>
ends up with the positive floating-point <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.324ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 1000.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal infinity</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-221E" d="M943 216c0 -118 -76 -227 -192 -227c-79 0 -138 42 -170 69c-22 19 -23 20 -90 101c-13 -22 -102 -170 -246 -170c-119 0 -189 115 -189 226c0 118 76 227 192 227c79 0 138 -42 170 -69c22 -19 23 -20 90 -101c13 22 102 170 246 170c119 0 189 -115 189 -226zM921 216 c0 90 -54 194 -160 194c-113 0 -189 -105 -227 -173c28 -34 73 -97 101 -128c45 -49 86 -72 132 -72c84 0 154 79 154 179zM465 194c-28 34 -73 97 -101 128c-45 49 -86 72 -132 72c-84 0 -154 -79 -154 -179c0 -90 54 -194 160 -194c113 0 189 105 227 173Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-221E" x="0" y="0"></use>
</g>
</svg> value.  The voxel
stepping logic will always decide to step in one of the other directions
and will correctly never step in this direction.

</p>
<p>For positive directions, rays exit at the upper end of a voxel&rsquo;s extent and
therefore advance plus one voxel in each dimension.  Traversal completes when the
upper limit of the grid is reached.

</p>
<p></p>
<span class="anchor" id="fragment-Handleraywithpositivedirectionforvoxelstepping-0"></span><div class="fragmentname">&lt;&lt;Handle ray with positive direction for voxel stepping&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float nextVoxelPos = Float(voxel[axis] + 1) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                              rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
<a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = 1;
<a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];</div><p>


</p>
<p>Similar expressions give these values for rays with negative direction
components.

</p>
<p></p>
<span class="anchor" id="fragment-Handleraywithnegativedirectionforvoxelstepping-0"></span><div class="fragmentname">&lt;&lt;Handle ray with negative direction for voxel stepping&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float nextVoxelPos = Float(voxel[axis]) / <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::res" class="code">res</a>[axis];
<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[axis] = tMin + (nextVoxelPos - gridIntersect[axis]) /
                              rayGrid.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>[axis];
<a href="#DDAMajorantIterator::step" class="code">step</a>[axis] = -1;
<a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[axis] = -1;</div><p>


</p>
<p>The <tt>Next()</tt> method takes care of generating the majorant segment for the
current voxel and taking a step to the next using the DDA.  Traversal
terminates when the remaining parametric range <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.27ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4422 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket t Subscript normal m normal i normal n Baseline comma t Subscript normal m normal a normal x Baseline right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
<g transform="translate(361,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6E" x="1112" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1919" y="0"></use>
<g transform="translate(2364,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
<g transform="translate(361,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-78" x="1334" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="4143" y="0"></use>
</g>
</svg> is
degenerate.

</p>
<p></p>
<span class="anchor" id="fragment-DDAMajorantIteratorPublicMethods-1"></span><div class="fragmentname">&lt;&lt;DDAMajorantIterator Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-DDAMajorantIteratorPublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#RayMajorantSegment" class="code">RayMajorantSegment</a>&gt; <span class="anchor" id="DDAMajorantIterator::Next"></span>Next() {
    if (<a href="#DDAMajorantIterator::tMin" class="code">tMin</a> &gt;= <a href="#DDAMajorantIterator::tMax" class="code">tMax</a>) return {};
    &lt;&lt;<span class="fragmentname"><a href="#fragment-FindmonostepAxisforsteppingtonextvoxelandexitpointmonotVoxelExit-0">Find <tt>stepAxis</tt> for stepping to next voxel and exit point <tt>tVoxelExit</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1598" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1598"><i></i></a><div id="fragbit-1598" class="collapse"><div class="fragmentcode">       int bits = ((<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[0] &lt; <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[1]) &lt;&lt; 2) +
                  ((<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[0] &lt; <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[2]) &lt;&lt; 1) +
                  ((<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[1] &lt; <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[2]));
       const int cmpToAxis[8] = {2, 1, 2, 1, 2, 2, 0, 0};
       int stepAxis = cmpToAxis[bits];
       Float tVoxelExit = std::min(tMax, <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[stepAxis]);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-GetmonomaxDensityforcurrentvoxelandinitializemonoRayMajorantSegmentmonoseg-0">Get <tt>maxDensity</tt> for current voxel and initialize <tt>RayMajorantSegment</tt>, <tt>seg</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1599" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1599"><i></i></a><div id="fragbit-1599" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj = <a href="#DDAMajorantIterator::sigma_t" class="code">sigma_t</a> *
                                   <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::Lookup" class="code">Lookup</a>(<a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[0], <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[1], <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[2]);
       <a href="#RayMajorantSegment" class="code">RayMajorantSegment</a> seg{<a href="#DDAMajorantIterator::tMin" class="code">tMin</a>, tVoxelExit, sigma_maj};</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Advancetonextvoxelinmaximumdensitygrid-0">Advance to next voxel in maximum density grid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1600" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1600"><i></i></a><div id="fragbit-1600" class="collapse"><div class="fragmentcode">       <a href="#DDAMajorantIterator::tMin" class="code">tMin</a> = tVoxelExit;
       if (<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[stepAxis] &gt; tMax) <a href="#DDAMajorantIterator::tMin" class="code">tMin</a> = tMax;
       <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[stepAxis] += <a href="#DDAMajorantIterator::step" class="code">step</a>[stepAxis];
       if (<a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[stepAxis] == <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[stepAxis]) <a href="#DDAMajorantIterator::tMin" class="code">tMin</a> = tMax;
       <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[stepAxis] += <a href="#DDAMajorantIterator::deltaT" class="code">deltaT</a>[stepAxis];</div></div>
    return seg;
}</div><p>


</p>
<p>

</p>
<p>The first order of business when <tt>Next()</tt> executes is to figure out
which axis to step along to visit the next voxel.
This gives the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> value at which the ray exits the current voxel, <tt>tVoxelExit</tt>.
Determining this axis requires
finding the smallest of three numbers&mdash;the parametric <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> values where the
ray enters the next
voxel in each dimension, which is a straightforward task.  However, in
this case an optimization is possible because we do not care about the
<em>value</em> of the smallest number, just its corresponding index in the
<tt>nextCrossingT</tt> array.  It is possible to compute this index in
straight-line code without any branches, which can be beneficial to
performance.

</p>
<p>The following tricky bit of code determines which of the three
<tt>nextCrossingT</tt> values is the smallest and sets <tt>stepAxis</tt>
accordingly.  It encodes this logic by setting each of the three low-order
bits in an integer to the results of three comparisons between pairs of
<tt>nextCrossingT</tt> values.  It then uses a table (<tt>cmpToAxis)</tt> to
map the resulting integer to the direction with the smallest value.   

</p>
<p></p>
<span class="anchor" id="fragment-FindmonostepAxisforsteppingtonextvoxelandexitpointmonotVoxelExit-0"></span><div class="fragmentname">&lt;&lt;Find <tt>stepAxis</tt> for stepping to next voxel and exit point <tt>tVoxelExit</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int bits = ((<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[0] &lt; <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[1]) &lt;&lt; 2) +
           ((<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[0] &lt; <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[2]) &lt;&lt; 1) +
           ((<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[1] &lt; <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[2]));
const int cmpToAxis[8] = {2, 1, 2, 1, 2, 2, 0, 0};
int stepAxis = cmpToAxis[bits];
Float tVoxelExit = std::min(tMax, <a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[stepAxis]);</div><p>


</p>
<p>Computing the majorant for the current voxel is a matter of multiplying
<tt>sigma_t</tt> with the maximum density value over the voxel&rsquo;s volume.

</p>
<p></p>
<span class="anchor" id="fragment-GetmonomaxDensityforcurrentvoxelandinitializemonoRayMajorantSegmentmonoseg-0"></span><div class="fragmentname">&lt;&lt;Get <tt>maxDensity</tt> for current voxel and initialize <tt>RayMajorantSegment</tt>, <tt>seg</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_maj = <a href="#DDAMajorantIterator::sigma_t" class="code">sigma_t</a> *
                            <a href="#DDAMajorantIterator::grid" class="code">grid</a>-&gt;<a href="#MajorantGrid::Lookup" class="code">Lookup</a>(<a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[0], <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[1], <a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[2]);
<a href="#RayMajorantSegment" class="code">RayMajorantSegment</a> seg{<a href="#DDAMajorantIterator::tMin" class="code">tMin</a>, tVoxelExit, sigma_maj};</div><p>


</p>
<p>With the majorant segment initialized, the method finishes
by updating the <tt>DDAMajorantIterator</tt>&rsquo;s state to
reflect stepping to the next voxel in the ray&rsquo;s path.  That is easy to do
given that the &lt;&lt;<span class="fragmentname"><a href="#fragment-FindmonostepAxisforsteppingtonextvoxelandexitpointmonotVoxelExit-0">Find <tt>stepAxis</tt> for stepping to next voxel
and exit point <tt>tVoxelExit</tt></a></span>&gt;&gt; fragment has already set <tt>stepAxis</tt>
to the dimension with the smallest <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> step that advances to the next voxel.
First, <tt>tMin</tt> is tentatively set to correspond to the current voxel&rsquo;s exit
point, though if stepping causes the ray to exit the grid, it is advanced
to <tt>tMax</tt>.  This way, the <tt>if</tt> test at the start of the
<tt>Next()</tt> method will return immediately the next time it is called.

</p>
<p>Otherwise, the DDA steps to the next voxel coordinates and increments the
chosen direction&rsquo;s <tt>nextCrossingT</tt> by its <tt>deltaT</tt> value so that
future traversal steps will know how far it is necessary to go before
stepping in this direction again.

</p>
<p></p>
<span class="anchor" id="fragment-Advancetonextvoxelinmaximumdensitygrid-0"></span><div class="fragmentname">&lt;&lt;Advance to next voxel in maximum density grid&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="#DDAMajorantIterator::tMin" class="code">tMin</a> = tVoxelExit;
if (<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[stepAxis] &gt; tMax) <a href="#DDAMajorantIterator::tMin" class="code">tMin</a> = tMax;
<a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[stepAxis] += <a href="#DDAMajorantIterator::step" class="code">step</a>[stepAxis];
if (<a href="#DDAMajorantIterator::voxel" class="code">voxel</a>[stepAxis] == <a href="#DDAMajorantIterator::voxelLimit" class="code">voxelLimit</a>[stepAxis]) <a href="#DDAMajorantIterator::tMin" class="code">tMin</a> = tMax;
<a href="#DDAMajorantIterator::nextCrossingT" class="code">nextCrossingT</a>[stepAxis] += <a href="#DDAMajorantIterator::deltaT" class="code">deltaT</a>[stepAxis];</div><p>


</p>
<p> </p>
<span class="anchor" id="fig:max-density-grid-perf"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
<img src="pha11f19.png" style="max-width: 100%; height: auto;" width=1163 height=600>
</div>
<p>


</p>
<figcaption class="caption">Figure 11.19: Rendering Performance versus Maximum Density Grid Resolution. <span class="legend">
Performance is measured when rendering the cloud model in
Figure&nbsp;<a href="../Volume_Scattering/Volume_Scattering_Processes.html#fig:cloud-inscattering">11.8</a> on both the CPU and the GPU; results
are normalized to the performance on the corresponding processor with a
single-voxel grid.  Low-resolution grids give poor performance from many
null-scattering events due to loose majorants, while high-resolution grids
harm performance from grid traversal overhead.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p> </p>
<span class="anchor" id="fig:ray-density-majorant"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
<img src="pha11f20.png" style="max-width: 100%; height: auto;" width=1235 height=362>
</div>
<p>


</p>
<figcaption class="caption">Figure 11.20: Extinction Coefficient and Majorant along a Ray. <span class="legend">
These quantities are plotted for a randomly selected ray that was traced
when rendering the image in Figure&nbsp;<a href="../Volume_Scattering/Volume_Scattering_Processes.html#fig:cloud-inscattering">11.8</a>.
The majorant grid resolution was 256 voxels on a side, which leads to a good
fit to the actual extinction coefficient along the ray.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Although the grid can significantly improve the efficiency of volume sampling
by providing majorants that are a better fit to the local medium density
and thence reducing the number of null-scattering events, it also
introduces the overhead of additional computations for stepping
through voxels with the DDA.  Too low a grid resolution and the majorants
may not fit the volume well; too high a resolution and too much time will
be spent walking through the grid.  Figure&nbsp;<a href="#fig:max-density-grid-perf">11.19</a>
has a graph that illustrates these trade-offs, plotting voxel grid
resolution versus execution time when rendering the cloud model used in
Figures&nbsp;<a href="../Volume_Scattering/Volume_Scattering_Processes.html#fig:cloud-absorption">11.2</a> and&nbsp;<a href="../Volume_Scattering/Volume_Scattering_Processes.html#fig:cloud-inscattering">11.8</a>.  
We can see that the performance characteristics are similar on both the CPU
and the GPU, with both exhibiting good performance with grid resolutions
that span roughly 64 through 256 voxels on a side.
Figure&nbsp;<a href="#fig:ray-density-majorant">11.20</a> shows the extinction coefficient and the
majorant along a randomly selected ray that was traced when rendering the
cloud scene; we can see that the majorants end up fitting the extinction
coefficient well.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#UniformGridMedium"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:uniform-grid-medium"></span><span id="UniformGridMedium"></span><h3>11.4.4  Uniform Grid Medium</h3><p>



</p>
<p>The <a href="#GridMedium"><tt>GridMedium</tt></a> stores medium densities and (optionally) emission
at a regular 3D grid of positions, similar to the way that the image
textures represent images with a 2D grid of samples.

</p>
<p></p>
<span class="anchor" id="fragment-GridMediumDefinition-0"></span><div class="fragmentname">&lt;&lt;GridMedium Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="GridMedium"></span>GridMedium {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-GridMediumPublicTypeDefinitions-0">GridMedium Public Type Definitions</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1601" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1601"><i></i></a><div id="fragbit-1601" class="collapse"><div class="fragmentcode">       using MajorantIterator = <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a>;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-GridMediumPublicMethods-0">GridMedium Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1602" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1602"><i></i></a><div id="fragbit-1602" class="collapse"><div class="fragmentcode">       GridMedium(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;bounds, const <a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> &amp;renderFromMedium,
                  <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum" class="code">Spectrum</a> sigma_a, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum" class="code">Spectrum</a> sigma_s, Float sigmaScale, Float g,
                  SampledGrid&lt;Float&gt; density,
                  pstd::optional&lt;SampledGrid&lt;Float&gt;&gt; temperature, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum" class="code">Spectrum</a> Le,
                  SampledGrid&lt;Float&gt; LeScale, Allocator alloc);
       
       static GridMedium *Create(const ParameterDictionary &amp;parameters,
                                 const <a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> &amp;renderFromMedium,
                                 const FileLoc *loc, Allocator alloc);
       
       std::string ToString() const;
       bool IsEmissive() const { return <a href="#GridMedium::isEmissive" class="code">isEmissive</a>; }
       <a href="#MediumProperties" class="code">MediumProperties</a> SamplePoint(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p,
                                    const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplespectraforgridmediumsigmaaandsigmas-0">Sample spectra for grid medium <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1603" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1603"><i></i></a><div id="fragbit-1603" class="collapse"><div class="fragmentcode">              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#GridMedium::sigma_a_spec" class="code">sigma_a_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#GridMedium::sigma_s_spec" class="code">sigma_s_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Scalescatteringcoefficientsbymediumdensityatmonop-0">Scale scattering coefficients by medium density at <tt>p</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1604" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1604"><i></i></a><div id="fragbit-1604" class="collapse"><div class="fragmentcode">              p = <a href="#GridMedium::renderFromMedium" class="code">renderFromMedium</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(p);
              p = <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="#GridMedium::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Offset" class="code">Offset</a>(p));
              Float d = <a href="#GridMedium::densityGrid" class="code">densityGrid</a>.<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
              sigma_a *= d;
              sigma_s *= d;</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputegridemissionmonoLeatmonop-0">Compute grid emission <tt>Le</tt> at <tt>p</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1605" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1605"><i></i></a><div id="fragbit-1605" class="collapse"><div class="fragmentcode">              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le(0.f);
              if (<a href="#GridMedium::isEmissive" class="code">isEmissive</a>) {
                  Float scale = <a href="#GridMedium::LeScale" class="code">LeScale</a>.<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
                  if (scale &gt; 0) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeemittedradianceusingmonotemperatureGridormonoLe_spec-0">Compute emitted radiance using <tt>temperatureGrid</tt> or <tt>Le_spec</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1606" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1606"><i></i></a><div id="fragbit-1606" class="collapse"><div class="fragmentcode">                         if (<a href="#GridMedium::temperatureGrid" class="code">temperatureGrid</a>) {
                             Float temp = <a href="#GridMedium::temperatureGrid" class="code">temperatureGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
                             Le = scale * BlackbodySpectrum(temp).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
                         } else
                             Le = scale * <a href="#GridMedium::Le_spec" class="code">Le_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);</div></div>
                 }
              }</div></div>
           return <a href="#MediumProperties" class="code">MediumProperties</a>{sigma_a, sigma_s, &amp;<a href="#GridMedium::phase" class="code">phase</a>, Le};
       }
       <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a> SampleRay(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float raytMax,
                                     const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
           &lt;&lt;<span class="fragmentname">Transform ray to medium&rsquo;s space and compute bounds overlap</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1607" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1607"><i></i></a><div id="fragbit-1607" class="collapse"><div class="fragmentcode">              ray = renderFromMedium.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(ray, &amp;raytMax);
              Float tMin, tMax;
              if (!bounds.<a href="../Shapes/Basic_Shape_Interface.html#Bounds3::IntersectP" class="code">IntersectP</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, raytMax, &amp;tMin, &amp;tMax))
                  return {};
              </div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplespectraforgridmediumsigmaaandsigmas-0">Sample spectra for grid medium <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1608" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1608"><i></i></a><div id="fragbit-1608" class="collapse"><div class="fragmentcode">              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#GridMedium::sigma_a_spec" class="code">sigma_a_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#GridMedium::sigma_s_spec" class="code">sigma_s_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);</div></div>
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_t = sigma_a + sigma_s;
           return <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a>(ray, tMin, tMax, &amp;<a href="#GridMedium::majorantGrid" class="code">majorantGrid</a>, sigma_t);
       }</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-GridMediumPrivateMembers-0">GridMedium Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1609" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1609"><i></i></a><div id="fragbit-1609" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> bounds;
       <a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> renderFromMedium;
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum" class="code">DenselySampledSpectrum</a> sigma_a_spec, sigma_s_spec;
       <a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;Float&gt; densityGrid;
       <a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> phase;
       pstd::optional&lt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;Float&gt;&gt; temperatureGrid;
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum" class="code">DenselySampledSpectrum</a> Le_spec;
       <a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;Float&gt; LeScale;
       bool isEmissive;
       MajorantGrid majorantGrid;</div></div>
};</div><p>


</p>
<p>

</p>
<p>The constructor takes a 3D array that stores the medium&rsquo;s density and
values that define emission as well as the medium space bounds of the grid
and a transformation matrix that goes from medium space to rendering space.
Most of its work is direct initialization of member variables, which we
have elided here. Its one interesting bit is in the fragment
&lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonomajorantGridformonoGridMedium-0">Initialize <tt>majorantGrid</tt> for <tt>GridMedium</tt></a></span>&gt;&gt;, which we
will see in a few pages.

</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-GridMediumPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;GridMedium Private Members&gt;&gt;=&nbsp;<a href="#fragment-GridMediumPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> <span class="anchor" id="GridMedium::bounds"></span>bounds;
<a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> <span class="anchor" id="GridMedium::renderFromMedium"></span>renderFromMedium;</div><p>


</p>
<p>Two steps give the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg> values for
the medium at a point: first, baseline spectral values of these coefficients,
<tt>sigma_a_spec</tt> and <tt>sigma_s_spec</tt>, are sampled at the
specified wavelengths to give <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum"><tt>SampledSpectrum</tt></a> values for them.  These
are then scaled by the interpolated density from <tt>densityGrid</tt>.  The
phase function in this medium is uniform and parameterized only by the
Henyey&ndash;Greenstein <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.109ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 477.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">g</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D454" d="M474 395c0 -7 -2 -12 -3 -18l-111 -444c-15 -60 -87 -138 -212 -138c-96 0 -133 20 -133 61c0 40 32 58 54 58c27 0 38 -19 38 -35c0 -17 -11 -43 -41 -52c28 -9 61 -10 80 -10c106 0 140 99 144 108l33 132l-1 1c-10 -11 -57 -58 -116 -58c-72 0 -133 59 -133 158 c0 144 124 284 238 284c40 0 75 -26 93 -63c4 36 31 43 41 43c17 0 29 -10 29 -27zM392 334c0 5 -14 86 -80 86c-42 0 -85 -40 -112 -89c-27 -51 -56 -169 -56 -217c0 -40 15 -92 65 -92c29 0 60 18 81 36c22 19 45 44 51 70l48 191c1 4 3 10 3 15Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D454" x="0" y="0"></use>
</g>
</svg> parameter.

</p>
<p></p>
<span class="anchor" id="fragment-GridMediumPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;GridMedium Private Members&gt;&gt;+=&nbsp;<a href="#fragment-GridMediumPrivateMembers-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-GridMediumPrivateMembers-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum" class="code">DenselySampledSpectrum</a> <span class="anchor" id="GridMedium::sigma_a_spec"></span>sigma_a_spec, <span class="anchor" id="GridMedium::sigma_s_spec"></span>sigma_s_spec;
<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;Float&gt; <span class="anchor" id="GridMedium::densityGrid"></span>densityGrid;
<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> <span class="anchor" id="GridMedium::phase"></span>phase;</div><p>


</p>
<p></p>
<span class="anchor" id="fig:globe-emission"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
<img src="anemone-emission.png" style="max-width: 100%; height: auto;" width=1280 height=680>
</div>
<p>

</p>
<figcaption class="caption">Figure 11.21: Volumetric Emission Specified with a Spectrum. <span class="legend">
The emission inside the globe is specified using a fixed spectrum that
represents a purple color that is then scaled by a spatially varying
factor.
<em>(Scene courtesy of Jim Price.)</em></span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The <tt>GridMedium</tt> allows volumetric emission to be specified in one of two
ways.  First, a grid of temperature values may be provided; these are interpreted
as blackbody emission temperatures specified in degrees Kelvin
(Section&nbsp;<a href="../Radiometry,_Spectra,_and_Color/Light_Emission.html#sec:blackbody-emitters">4.4.1</a>).  Alternatively, a single general
spectral distribution may be provided.  Both are then scaled by values from
the <tt>LeScale</tt> grid.  Even though spatially varying general spectral
distributions are not supported, these representations make it possible to
specify a variety of emissive effects; Figure&nbsp;<a href="../Volume_Scattering/Volume_Scattering_Processes.html#fig:explosion-emission">11.5</a>
uses blackbody emission and Figure&nbsp;<a href="#fig:globe-emission">11.21</a> uses a scaled
spectrum.  An exercise at the end of the chapter outlines how this
representation might be generalized.

</p>
<p></p>
<span class="anchor" id="fragment-GridMediumPrivateMembers-2"></span><div class="fragmentname">&lt;&lt;GridMedium Private Members&gt;&gt;+=&nbsp;<a href="#fragment-GridMediumPrivateMembers-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-GridMediumPrivateMembers-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;Float&gt;&gt; <span class="anchor" id="GridMedium::temperatureGrid"></span>temperatureGrid;
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum" class="code">DenselySampledSpectrum</a> <span class="anchor" id="GridMedium::Le_spec"></span>Le_spec;
<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;Float&gt; <span class="anchor" id="GridMedium::LeScale"></span>LeScale;</div><p>


</p>
<p>A Boolean, <tt>isEmissive</tt>, indicates whether any emission has been
specified.  It is initialized in the <tt>GridMedium</tt> constructor, which
makes the implementation of the <tt>IsEmissive()</tt> interface method easy.

</p>
<p></p>
<span class="anchor" id="fragment-GridMediumPublicMethods-0"></span><div class="fragmentname">&lt;&lt;GridMedium Public Methods&gt;&gt;=&nbsp;<a href="#fragment-GridMediumPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="GridMedium::IsEmissive"></span>IsEmissive() const { return <a href="#GridMedium::isEmissive" class="code">isEmissive</a>; }</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-GridMediumPrivateMembers-3"></span><div class="fragmentname">&lt;&lt;GridMedium Private Members&gt;&gt;+=&nbsp;<a href="#fragment-GridMediumPrivateMembers-2"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-GridMediumPrivateMembers-4"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="GridMedium::isEmissive"></span>isEmissive;</div><p>


</p>
<p>The medium&rsquo;s properties at a given point are found by interpolating values
from the appropriate grids.

</p>
<p></p>
<span class="anchor" id="fragment-GridMediumPublicMethods-1"></span><div class="fragmentname">&lt;&lt;GridMedium Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-GridMediumPublicMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-GridMediumPublicMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="#MediumProperties" class="code">MediumProperties</a> <span class="anchor" id="GridMedium::SamplePoint"></span>SamplePoint(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p,
                             const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplespectraforgridmediumsigmaaandsigmas-0">Sample spectra for grid medium <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1610" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1610"><i></i></a><div id="fragbit-1610" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#GridMedium::sigma_a_spec" class="code">sigma_a_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#GridMedium::sigma_s_spec" class="code">sigma_s_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Scalescatteringcoefficientsbymediumdensityatmonop-0">Scale scattering coefficients by medium density at <tt>p</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1611" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1611"><i></i></a><div id="fragbit-1611" class="collapse"><div class="fragmentcode">       p = <a href="#GridMedium::renderFromMedium" class="code">renderFromMedium</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(p);
       p = <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="#GridMedium::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Offset" class="code">Offset</a>(p));
       Float d = <a href="#GridMedium::densityGrid" class="code">densityGrid</a>.<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
       sigma_a *= d;
       sigma_s *= d;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputegridemissionmonoLeatmonop-0">Compute grid emission <tt>Le</tt> at <tt>p</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1612" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1612"><i></i></a><div id="fragbit-1612" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le(0.f);
       if (<a href="#GridMedium::isEmissive" class="code">isEmissive</a>) {
           Float scale = <a href="#GridMedium::LeScale" class="code">LeScale</a>.<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
           if (scale &gt; 0) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeemittedradianceusingmonotemperatureGridormonoLe_spec-0">Compute emitted radiance using <tt>temperatureGrid</tt> or <tt>Le_spec</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1613" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1613"><i></i></a><div id="fragbit-1613" class="collapse"><div class="fragmentcode">                  if (<a href="#GridMedium::temperatureGrid" class="code">temperatureGrid</a>) {
                      Float temp = <a href="#GridMedium::temperatureGrid" class="code">temperatureGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
                      Le = scale * BlackbodySpectrum(temp).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
                  } else
                      Le = scale * <a href="#GridMedium::Le_spec" class="code">Le_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);</div></div>
          }
       }</div></div>
    return <a href="#MediumProperties" class="code">MediumProperties</a>{sigma_a, sigma_s, &amp;<a href="#GridMedium::phase" class="code">phase</a>, Le};
}</div><p>


</p>
<p>Initial values of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg> are found by sampling the
baseline values.

</p>
<p></p>
<span class="anchor" id="fragment-Samplespectraforgridmediumsigmaaandsigmas-0"></span><div class="fragmentname">&lt;&lt;Sample spectra for grid medium <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#GridMedium::sigma_a_spec" class="code">sigma_a_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#GridMedium::sigma_s_spec" class="code">sigma_s_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);</div><p>


</p>
<p>Next, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg> are scaled by the interpolated density at
<tt>p</tt>.  The provided point must be transformed from rendering space to
the medium&rsquo;s space and then remapped to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket cubed</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-33" x="393" y="513"></use>
</g>
</g>
</svg> before the grid&rsquo;s
<tt>Lookup()</tt> method is called to interpolate the density.

</p>
<p></p>
<span class="anchor" id="fragment-Scalescatteringcoefficientsbymediumdensityatmonop-0"></span><div class="fragmentname">&lt;&lt;Scale scattering coefficients by medium density at <tt>p</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">p = <a href="#GridMedium::renderFromMedium" class="code">renderFromMedium</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(p);
p = <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="#GridMedium::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Offset" class="code">Offset</a>(p));
Float d = <a href="#GridMedium::densityGrid" class="code">densityGrid</a>.<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
sigma_a *= d;
sigma_s *= d;</div><p>


</p>
<p>If emission is present, the emitted radiance at the point is computed using
whichever of the methods was used to specify it.  The implementation here
goes through some care to avoid calls to <tt>Lookup()</tt> when they are
unnecessary, in order to improve performance.

</p>
<p></p>
<span class="anchor" id="fragment-ComputegridemissionmonoLeatmonop-0"></span><div class="fragmentname">&lt;&lt;Compute grid emission <tt>Le</tt> at <tt>p</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le(0.f);
if (<a href="#GridMedium::isEmissive" class="code">isEmissive</a>) {
    Float scale = <a href="#GridMedium::LeScale" class="code">LeScale</a>.<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
    if (scale &gt; 0) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeemittedradianceusingmonotemperatureGridormonoLe_spec-0">Compute emitted radiance using <tt>temperatureGrid</tt> or <tt>Le_spec</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1614" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1614"><i></i></a><div id="fragbit-1614" class="collapse"><div class="fragmentcode">           if (<a href="#GridMedium::temperatureGrid" class="code">temperatureGrid</a>) {
               Float temp = <a href="#GridMedium::temperatureGrid" class="code">temperatureGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
               Le = scale * BlackbodySpectrum(temp).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
           } else
               Le = scale * <a href="#GridMedium::Le_spec" class="code">Le_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);</div></div>
   }
}</div><p>


</p>
<p>Given a nonzero <tt>scale</tt>, whichever method is being used to specify
emission is queried to get the <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum"><tt>SampledSpectrum</tt></a>.   

</p>
<p></p>
<span class="anchor" id="fragment-ComputeemittedradianceusingmonotemperatureGridormonoLe_spec-0"></span><div class="fragmentname">&lt;&lt;Compute emitted radiance using <tt>temperatureGrid</tt> or <tt>Le_spec</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (<a href="#GridMedium::temperatureGrid" class="code">temperatureGrid</a>) {
    Float temp = <a href="#GridMedium::temperatureGrid" class="code">temperatureGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p);
    Le = scale * BlackbodySpectrum(temp).<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
} else
    Le = scale * <a href="#GridMedium::Le_spec" class="code">Le_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);</div><p>


</p>
<p>As mentioned earlier, <a href="#GridMedium"><tt>GridMedium</tt></a> uses <a href="#DDAMajorantIterator"><tt>DDAMajorantIterator</tt></a> to
provide its majorants rather than using a single grid-wide majorant.

</p>
<p></p>
<span class="anchor" id="fragment-GridMediumPublicTypeDefinitions-0"></span><div class="fragmentname">&lt;&lt;GridMedium Public Type Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">using MajorantIterator = <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a>;</div><p>


</p>
<p>The <a href="#GridMedium"><tt>GridMedium</tt></a> constructor concludes with the following fragment,
which initializes a <a href="#MajorantGrid"><tt>MajorantGrid</tt></a> with its majorants.
Doing so is just a matter of iterating over all
the majorant cells, computing their bounds, and finding the maximum density over
them.   The maximum density is easily found with a convenient
<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid"><tt>SampledGrid</tt></a> method.

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonomajorantGridformonoGridMedium-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>majorantGrid</tt> for <tt>GridMedium</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (int z = 0; z &lt; <a href="#GridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::res" class="code">res</a>.z; ++z)
    for (int y = 0; y &lt; <a href="#GridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::res" class="code">res</a>.y; ++y)
        for (int x = 0; x &lt; <a href="#GridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::res" class="code">res</a>.x; ++x) {
            <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> bounds = <a href="#GridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::VoxelBounds" class="code">VoxelBounds</a>(x, y, z);
            <a href="#GridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::Set" class="code">Set</a>(x, y, z, <a href="#GridMedium::densityGrid" class="code">densityGrid</a>.<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::MaxValue" class="code">MaxValue</a>(bounds));
        }</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-GridMediumPrivateMembers-4"></span><div class="fragmentname">&lt;&lt;GridMedium Private Members&gt;&gt;+=&nbsp;<a href="#fragment-GridMediumPrivateMembers-3"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">MajorantGrid <span class="anchor" id="GridMedium::majorantGrid"></span>majorantGrid;</div><p>


</p>
<p>The implementation of the <tt>SampleRay()</tt> <tt>Medium</tt> interface method
is now easy.  We can find the overlap of the
ray with the medium using a straightforward fragment, not included
here, and compute the baseline <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.199ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 946.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
</g>
</svg> value.  With
that, we have enough information to initialize the
<tt>DDAMajorantIterator</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-GridMediumPublicMethods-2"></span><div class="fragmentname">&lt;&lt;GridMedium Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-GridMediumPublicMethods-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a> <span class="anchor" id="GridMedium::SampleRay"></span>SampleRay(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float raytMax,
                              const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    &lt;&lt;<span class="fragmentname">Transform ray to medium&rsquo;s space and compute bounds overlap</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1615" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1615"><i></i></a><div id="fragbit-1615" class="collapse"><div class="fragmentcode">       ray = renderFromMedium.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(ray, &amp;raytMax);
       Float tMin, tMax;
       if (!bounds.<a href="../Shapes/Basic_Shape_Interface.html#Bounds3::IntersectP" class="code">IntersectP</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, raytMax, &amp;tMin, &amp;tMax))
           return {};
       </div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplespectraforgridmediumsigmaaandsigmas-0">Sample spectra for grid medium <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1616" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1616"><i></i></a><div id="fragbit-1616" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#GridMedium::sigma_a_spec" class="code">sigma_a_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#GridMedium::sigma_s_spec" class="code">sigma_s_spec</a>.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);</div></div>
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_t = sigma_a + sigma_s;
    return <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a>(ray, tMin, tMax, &amp;<a href="#GridMedium::majorantGrid" class="code">majorantGrid</a>, sigma_t);
}</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#RGBGridMedium"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="RGBGridMedium"></span><h3>11.4.5  RGB Grid Medium</h3><p>


</p>
<p> </p>
<span class="anchor" id="fig:rgb-medium-plumes"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
<img src="rainbow-box.png" style="max-width: 100%; height: auto;" width=1280 height=720>
</div>
<p>

</p>
<figcaption class="caption">Figure 11.22: Volumetric Scattering Properties Specified Using RGB Coefficients. <span class="legend">
The <a href="#RGBGridMedium"><tt>RGBGridMedium</tt></a> class makes it possible to specify colorful
participating media like the example shown here.
<em>(Scene courtesy of Jim Price.)</em></span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The last <tt>Medium</tt> implementation that we will describe is the
<a href="#RGBGridMedium"><tt>RGBGridMedium</tt></a>.  It is a variant of <a href="#GridMedium"><tt>GridMedium</tt></a> that allows
specifying the absorption and scattering coefficients as well as volumetric
emission via RGB colors.  This makes it possible to render a variety of
colorful volumetric effects; an example is shown in
Figure&nbsp;<a href="#fig:rgb-medium-plumes">11.22</a>.

</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumDefinition-0"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="RGBGridMedium"></span>RGBGridMedium {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-RGBGridMediumPublicTypeDefinitions-0">RGBGridMedium Public Type Definitions</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1617" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1617"><i></i></a><div id="fragbit-1617" class="collapse"><div class="fragmentcode">       using MajorantIterator = <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a>;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-RGBGridMediumPublicMethods-0">RGBGridMedium Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1618" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1618"><i></i></a><div id="fragbit-1618" class="collapse"><div class="fragmentcode">       RGBGridMedium(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;bounds, const <a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> &amp;<a href="#RGBGridMedium::renderFromMedium" class="code">renderFromMedium</a>,
                     Float g,
                     pstd::optional&lt;SampledGrid&lt;RGBUnboundedSpectrum&gt;&gt; sigma_a,
                     pstd::optional&lt;SampledGrid&lt;RGBUnboundedSpectrum&gt;&gt; sigma_s,
                     Float sigmaScale,
                     pstd::optional&lt;SampledGrid&lt;RGBIlluminantSpectrum&gt;&gt; Le,
                     Float <a href="#RGBGridMedium::LeScale" class="code">LeScale</a>, Allocator alloc);
       
       static RGBGridMedium *Create(const ParameterDictionary &amp;parameters,
                                    const <a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> &amp;<a href="#RGBGridMedium::renderFromMedium" class="code">renderFromMedium</a>,
                                    const FileLoc *loc, Allocator alloc);
       
       std::string ToString() const;
       bool IsEmissive() const { return <a href="#RGBGridMedium::LeGrid" class="code">LeGrid</a> &amp;&amp; <a href="#RGBGridMedium::LeScale" class="code">LeScale</a> &gt; 0; }
       <a href="#MediumProperties" class="code">MediumProperties</a> SamplePoint(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p,
                                    const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
           p = <a href="#RGBGridMedium::renderFromMedium" class="code">renderFromMedium</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(p);
           p = <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(bounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Offset" class="code">Offset</a>(p));
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputesigmaaandsigmasformonoRGBGridMedium-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg> for <tt>RGBGridMedium</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1619" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1619"><i></i></a><div id="fragbit-1619" class="collapse"><div class="fragmentcode">              auto convert = [=] (RGBUnboundedSpectrum s) { return s.<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum::Sample" class="code">Sample</a>(lambda); };
              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#RGBGridMedium::sigmaScale" class="code">sigmaScale</a> *
                  (sigma_aGrid ? sigma_aGrid-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p, convert) : <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(1.f));
              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#RGBGridMedium::sigmaScale" class="code">sigmaScale</a> *
                  (sigma_sGrid ? sigma_sGrid-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p, convert) : <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(1.f));</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-FindemittedradiancemonoLeformonoRGBGridMedium-0">Find emitted radiance <tt>Le</tt> for <tt>RGBGridMedium</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1620" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1620"><i></i></a><div id="fragbit-1620" class="collapse"><div class="fragmentcode">              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le(0.f);
              if (<a href="#RGBGridMedium::LeGrid" class="code">LeGrid</a> &amp;&amp; <a href="#RGBGridMedium::LeScale" class="code">LeScale</a> &gt; 0) {
                  auto convert =
                    [=] (<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum" class="code">RGBIlluminantSpectrum</a> s) { return s.<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum::Sample" class="code">Sample</a>(lambda); };
                  Le = <a href="#RGBGridMedium::LeScale" class="code">LeScale</a> * <a href="#RGBGridMedium::LeGrid" class="code">LeGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p, convert);
              }</div></div>
           return <a href="#MediumProperties" class="code">MediumProperties</a>{sigma_a, sigma_s, &amp;phase, Le};
       }
       <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a> SampleRay(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float raytMax,
                                     const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
           &lt;&lt;<span class="fragmentname">Transform ray to medium&rsquo;s space and compute bounds overlap</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1621" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1621"><i></i></a><div id="fragbit-1621" class="collapse"><div class="fragmentcode">              ray = renderFromMedium.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(ray, &amp;raytMax);
              Float tMin, tMax;
              if (!bounds.<a href="../Shapes/Basic_Shape_Interface.html#Bounds3::IntersectP" class="code">IntersectP</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, raytMax, &amp;tMin, &amp;tMax))
                  return {};
              </div></div>
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_t(1);
           return <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a>(ray, tMin, tMax, &amp;<a href="#RGBGridMedium::majorantGrid" class="code">majorantGrid</a>, sigma_t);
       }</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-RGBGridMediumPrivateMembers-0">RGBGridMedium Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1622" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1622"><i></i></a><div id="fragbit-1622" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> bounds;
       <a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> renderFromMedium;
       pstd::optional&lt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum" class="code">RGBIlluminantSpectrum</a>&gt;&gt; LeGrid;
       Float LeScale;
       <a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> phase;
       pstd::optional&lt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum" class="code">RGBUnboundedSpectrum</a>&gt;&gt; sigma_aGrid, sigma_sGrid;
       Float sigmaScale;
       MajorantGrid majorantGrid;</div></div>
};</div><p>


</p>
<p>

</p>
<p>Its constructor, not included here, is similar to that of <a href="#GridMedium"><tt>GridMedium</tt></a>
in that most of what it does is to directly initialize member variables with
values passed to it.  As with <a href="#GridMedium"><tt>GridMedium</tt></a>, the medium&rsquo;s extent is
jointly specified by a medium space bounding box and a transformation from
medium space to rendering space.

</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Private Members&gt;&gt;=&nbsp;<a href="#fragment-RGBGridMediumPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> <span class="anchor" id="RGBGridMedium::bounds"></span>bounds;
<a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> <span class="anchor" id="RGBGridMedium::renderFromMedium"></span>renderFromMedium;</div><p>


</p>
<p>Emission is specified by the combination of an optional <a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid"><tt>SampledGrid</tt></a>
of <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum"><tt>RGBIlluminantSpectrum</tt></a> values and a scale factor.  The
<a href="#RGBGridMedium"><tt>RGBGridMedium</tt></a> reports itself as emissive if the grid is present and
the scale is nonzero.  This misses the case of a fully zero <tt>LeGrid</tt>,
though we assume that case to be unusual.

</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumPublicMethods-0"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Public Methods&gt;&gt;=&nbsp;<a href="#fragment-RGBGridMediumPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="RGBGridMedium::IsEmissive"></span>IsEmissive() const { return <a href="#RGBGridMedium::LeGrid" class="code">LeGrid</a> &amp;&amp; <a href="#RGBGridMedium::LeScale" class="code">LeScale</a> &gt; 0; }</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Private Members&gt;&gt;+=&nbsp;<a href="#fragment-RGBGridMediumPrivateMembers-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-RGBGridMediumPrivateMembers-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum" class="code">RGBIlluminantSpectrum</a>&gt;&gt; <span class="anchor" id="RGBGridMedium::LeGrid"></span>LeGrid;
Float <span class="anchor" id="RGBGridMedium::LeScale"></span>LeScale;</div><p>


</p>
<p>Sampling the medium at a point is mostly a matter of converting the various
RGB values to <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum"><tt>SampledSpectrum</tt></a> values and trilinearly interpolating
them to find their values at the lookup point <tt>p</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumPublicMethods-1"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-RGBGridMediumPublicMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-RGBGridMediumPublicMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="#MediumProperties" class="code">MediumProperties</a> <span class="anchor" id="RGBGridMedium::SamplePoint"></span>SamplePoint(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p,
                             const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    p = <a href="#RGBGridMedium::renderFromMedium" class="code">renderFromMedium</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(p);
    p = <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(bounds.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Offset" class="code">Offset</a>(p));
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputesigmaaandsigmasformonoRGBGridMedium-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg> for <tt>RGBGridMedium</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1623" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1623"><i></i></a><div id="fragbit-1623" class="collapse"><div class="fragmentcode">       auto convert = [=] (RGBUnboundedSpectrum s) { return s.<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum::Sample" class="code">Sample</a>(lambda); };
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#RGBGridMedium::sigmaScale" class="code">sigmaScale</a> *
           (sigma_aGrid ? sigma_aGrid-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p, convert) : <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(1.f));
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#RGBGridMedium::sigmaScale" class="code">sigmaScale</a> *
           (sigma_sGrid ? sigma_sGrid-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p, convert) : <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(1.f));</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-FindemittedradiancemonoLeformonoRGBGridMedium-0">Find emitted radiance <tt>Le</tt> for <tt>RGBGridMedium</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1624" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1624"><i></i></a><div id="fragbit-1624" class="collapse"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le(0.f);
       if (<a href="#RGBGridMedium::LeGrid" class="code">LeGrid</a> &amp;&amp; <a href="#RGBGridMedium::LeScale" class="code">LeScale</a> &gt; 0) {
           auto convert =
             [=] (<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum" class="code">RGBIlluminantSpectrum</a> s) { return s.<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum::Sample" class="code">Sample</a>(lambda); };
           Le = <a href="#RGBGridMedium::LeScale" class="code">LeScale</a> * <a href="#RGBGridMedium::LeGrid" class="code">LeGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p, convert);
       }</div></div>
    return <a href="#MediumProperties" class="code">MediumProperties</a>{sigma_a, sigma_s, &amp;phase, Le};
}</div><p>


</p>
<p>As with earlier <tt>Medium</tt> implementations, the phase function is uniform
throughout this medium.

</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumPrivateMembers-2"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Private Members&gt;&gt;+=&nbsp;<a href="#fragment-RGBGridMediumPrivateMembers-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-RGBGridMediumPrivateMembers-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> <span class="anchor" id="RGBGridMedium::phase"></span>phase;</div><p>


</p>
<p>The absorption and scattering coefficients are stored using the
<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum"><tt>RGBUnboundedSpectrum</tt></a> class.  However, this class does not support the
arithmetic operations that are necessary to perform trilinear interpolation
in the <a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup"><tt>SampledGrid::Lookup()</tt></a> method.  For such cases,
<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid"><tt>SampledGrid</tt></a> allows passing a callback function that converts the
in-memory values to another type that does support them.  Here, the implementation
provides one that converts to <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum"><tt>SampledSpectrum</tt></a>, which does allow
arithmetic and matches the type to be returned in <a href="#MediumProperties"><tt>MediumProperties</tt></a> as
well.

</p>
<p></p>
<span class="anchor" id="fragment-ComputesigmaaandsigmasformonoRGBGridMedium-0"></span><div class="fragmentname">&lt;&lt;Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg> for <tt>RGBGridMedium</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">auto convert = [=] (RGBUnboundedSpectrum s) { return s.<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum::Sample" class="code">Sample</a>(lambda); };
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_a = <a href="#RGBGridMedium::sigmaScale" class="code">sigmaScale</a> *
    (sigma_aGrid ? sigma_aGrid-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p, convert) : <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(1.f));
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_s = <a href="#RGBGridMedium::sigmaScale" class="code">sigmaScale</a> *
    (sigma_sGrid ? sigma_sGrid-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p, convert) : <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(1.f));</div><p>


</p>
<p>Because <tt>sigmaScale</tt> is applied to both <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg>, it
provides a convenient way to fine-tune the density of a medium without
needing to update all of its individual RGB values.

</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumPrivateMembers-3"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Private Members&gt;&gt;+=&nbsp;<a href="#fragment-RGBGridMediumPrivateMembers-2"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-RGBGridMediumPrivateMembers-4"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid" class="code">SampledGrid</a>&lt;<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum" class="code">RGBUnboundedSpectrum</a>&gt;&gt; <span class="anchor" id="RGBGridMedium::sigma_aGrid"></span>sigma_aGrid, <span class="anchor" id="RGBGridMedium::sigma_sGrid"></span>sigma_sGrid;
Float <span class="anchor" id="RGBGridMedium::sigmaScale"></span>sigmaScale;</div><p>


</p>
<p>Volumetric emission is handled similarly, with a lambda function that
converts the <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum"><tt>RGBIlluminantSpectrum</tt></a> values to <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum"><tt>SampledSpectrum</tt></a>s for
trilinear interpolation in the <tt>Lookup()</tt> method.

</p>
<p></p>
<span class="anchor" id="fragment-FindemittedradiancemonoLeformonoRGBGridMedium-0"></span><div class="fragmentname">&lt;&lt;Find emitted radiance <tt>Le</tt> for <tt>RGBGridMedium</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le(0.f);
if (<a href="#RGBGridMedium::LeGrid" class="code">LeGrid</a> &amp;&amp; <a href="#RGBGridMedium::LeScale" class="code">LeScale</a> &gt; 0) {
    auto convert =
      [=] (<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum" class="code">RGBIlluminantSpectrum</a> s) { return s.<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum::Sample" class="code">Sample</a>(lambda); };
    Le = <a href="#RGBGridMedium::LeScale" class="code">LeScale</a> * <a href="#RGBGridMedium::LeGrid" class="code">LeGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup" class="code">Lookup</a>(p, convert);
}</div><p>


</p>
<p>The <a href="#DDAMajorantIterator"><tt>DDAMajorantIterator</tt></a> provides majorants for the
<tt>RGBGridMedium</tt> as well.

</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumPublicTypeDefinitions-0"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Public Type Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">using MajorantIterator = <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a>;</div><p>


</p>
<p>The <a href="#MajorantGrid"><tt>MajorantGrid</tt></a> that is used by the <a href="#DDAMajorantIterator"><tt>DDAMajorantIterator</tt></a> is
initialized by the following fragment, which runs at the end of the
<a href="#RGBGridMedium"><tt>RGBGridMedium</tt></a> constructor.

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonomajorantGridformonoRGBGridMedium-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>majorantGrid</tt> for <tt>RGBGridMedium</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (int z = 0; z &lt; <a href="#RGBGridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::res" class="code">res</a>.z; ++z)
    for (int y = 0; y &lt; <a href="#RGBGridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::res" class="code">res</a>.y; ++y)
        for (int x = 0; x &lt; <a href="#RGBGridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::res" class="code">res</a>.x; ++x) {
            <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> bounds = <a href="#RGBGridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::VoxelBounds" class="code">VoxelBounds</a>(x, y, z);
            &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonomajorantGridvoxelforRGBsigmaaandsigmas-0">Initialize <tt>majorantGrid</tt> voxel for RGB <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1625" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1625"><i></i></a><div id="fragbit-1625" class="collapse"><div class="fragmentcode">               auto max = [] (<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum" class="code">RGBUnboundedSpectrum</a> s) { return s.<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::MaxValue" class="code">MaxValue</a>(); };
               Float maxSigma_t = (<a href="#RGBGridMedium::sigma_aGrid" class="code">sigma_aGrid</a> ? <a href="#RGBGridMedium::sigma_aGrid" class="code">sigma_aGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::MaxValue" class="code">MaxValue</a>(bounds, max) : 1) +
                                  (<a href="#RGBGridMedium::sigma_sGrid" class="code">sigma_sGrid</a> ? <a href="#RGBGridMedium::sigma_sGrid" class="code">sigma_sGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::MaxValue" class="code">MaxValue</a>(bounds, max) : 1);
               <a href="#RGBGridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::Set" class="code">Set</a>(x, y, z, <a href="#RGBGridMedium::sigmaScale" class="code">sigmaScale</a> * maxSigma_t);</div></div>
        }</div><p>


</p>
<p>Before explaining how the majorant grid voxels are initialized, we will
discuss why <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum"><tt>RGBUnboundedSpectrum</tt></a> values are stored in
<tt>rgbDensityGrid</tt> rather than the more obvious choice of <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGB"><tt>RGB</tt></a>
values.  The most important reason is that the RGB to spectrum conversion
approach from Section&nbsp;<a href="../Radiometry,_Spectra,_and_Color/Color.html#sec:rgb-to-spectrum">4.6.6</a> does not guarantee that the
spectral distribution&rsquo;s value will always be less than or equal to the
maximum of the original RGB components.  Thus, storing RGB and setting
majorants using bounds on RGB values would not give bounds on the eventual
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum"><tt>SampledSpectrum</tt></a> values that are computed.

</p>
<p>One might nevertheless try to store RGB, convert those RGB values to spectra when
initializing the majorant grid, and then bound those spectra to
find majorants.  That approach would also be unsuccessful, since when two
RGB values are linearly interpolated, the corresponding
<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum"><tt>RGBUnboundedSpectrum</tt></a> does not vary linearly between the
<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum"><tt>RGBUnboundedSpectrum</tt></a> distributions of the two original RGB values.

</p>
<p>Thus, <tt>RGBGridMedium</tt> stores <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum"><tt>RGBUnboundedSpectrum</tt></a> values at the
grid sample points and linearly interpolates their <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum"><tt>SampledSpectrum</tt></a>
values at lookup points.  With that approach, we can guarantee that bounds on
<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum"><tt>RGBUnboundedSpectrum</tt></a> values in a region of space (and then a bit
more, given trilinear interpolation) give bounds on the sampled spectral
values that are returned by <a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::Lookup"><tt>SampledGrid::Lookup()</tt></a> in the
<tt>SamplePoint()</tt> method, fulfilling the requirement for the majorant
grid.

</p>
<p>To compute the majorants, we use a <a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid"><tt>SampledGrid</tt></a> method that returns
its maximum value over a region of space and takes a lambda function that
converts its underlying type to another&mdash;here, <tt>Float</tt> for the
<a href="#MajorantGrid"><tt>MajorantGrid</tt></a>.

</p>
<p>One nit in how the majorants are computed is that the following code
effectively assumes that the values in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg> grids
are independent.  Although it computes a valid majorant, it is unable to
account for cases like the two being defined such that <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.535ex" height="2.343ex" style="vertical-align: -0.671ex;" viewBox="0 -719.6 4966.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s Baseline equals c minus sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D450" d="M430 107c0 -12 -84 -118 -227 -118c-104 0 -162 79 -162 169c0 141 133 284 268 284c71 0 118 -37 118 -86c0 -40 -27 -64 -56 -64c-19 0 -37 11 -37 35c0 7 2 24 18 39c14 14 28 14 44 14c-14 27 -52 40 -86 40c-55 0 -110 -43 -141 -100c-34 -62 -54 -159 -54 -200 c0 -60 27 -109 90 -109c12 0 121 0 200 99c6 8 8 10 13 10c6 0 12 -7 12 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1228" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D450" x="2284" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="2940" y="0"></use>
<g transform="translate(3940,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</g>
</svg> for some constant <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.007ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 433.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">c</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D450" d="M430 107c0 -12 -84 -118 -227 -118c-104 0 -162 79 -162 169c0 141 133 284 268 284c71 0 118 -37 118 -86c0 -40 -27 -64 -56 -64c-19 0 -37 11 -37 35c0 7 2 24 18 39c14 14 28 14 44 14c-14 27 -52 40 -86 40c-55 0 -110 -43 -141 -100c-34 -62 -54 -159 -54 -200 c0 -60 27 -109 90 -109c12 0 121 0 200 99c6 8 8 10 13 10c6 0 12 -7 12 -13Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D450" x="0" y="0"></use>
</g>
</svg>.  Then, the bound will be looser than it
could be.

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonomajorantGridvoxelforRGBsigmaaandsigmas-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>majorantGrid</tt> voxel for RGB <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.382ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1025.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="808" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.208ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 950.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
</svg>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">auto max = [] (<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBUnboundedSpectrum" class="code">RGBUnboundedSpectrum</a> s) { return s.<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::MaxValue" class="code">MaxValue</a>(); };
Float maxSigma_t = (<a href="#RGBGridMedium::sigma_aGrid" class="code">sigma_aGrid</a> ? <a href="#RGBGridMedium::sigma_aGrid" class="code">sigma_aGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::MaxValue" class="code">MaxValue</a>(bounds, max) : 1) +
                   (<a href="#RGBGridMedium::sigma_sGrid" class="code">sigma_sGrid</a> ? <a href="#RGBGridMedium::sigma_sGrid" class="code">sigma_sGrid</a>-&gt;<a href="../Utilities/Containers_and_Memory_Management.html#SampledGrid::MaxValue" class="code">MaxValue</a>(bounds, max) : 1);
<a href="#RGBGridMedium::majorantGrid" class="code">majorantGrid</a>.<a href="#MajorantGrid::Set" class="code">Set</a>(x, y, z, <a href="#RGBGridMedium::sigmaScale" class="code">sigmaScale</a> * maxSigma_t);</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumPrivateMembers-4"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Private Members&gt;&gt;+=&nbsp;<a href="#fragment-RGBGridMediumPrivateMembers-3"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">MajorantGrid <span class="anchor" id="RGBGridMedium::majorantGrid"></span>majorantGrid;</div><p>


</p>
<p>With the majorant grid initialized, the <tt>SampleRay()</tt> method&rsquo;s
implementation is trivial.  (See Exercise&nbsp;11.3 for a way in which it might
be improved, however.)

</p>
<p></p>
<span class="anchor" id="fragment-RGBGridMediumPublicMethods-2"></span><div class="fragmentname">&lt;&lt;RGBGridMedium Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-RGBGridMediumPublicMethods-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a> <span class="anchor" id="RGBGridMedium::SampleRay"></span>SampleRay(<a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> ray, Float raytMax,
                              const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    &lt;&lt;<span class="fragmentname">Transform ray to medium&rsquo;s space and compute bounds overlap</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1626" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-1626"><i></i></a><div id="fragbit-1626" class="collapse"><div class="fragmentcode">       ray = renderFromMedium.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(ray, &amp;raytMax);
       Float tMin, tMax;
       if (!bounds.<a href="../Shapes/Basic_Shape_Interface.html#Bounds3::IntersectP" class="code">IntersectP</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, raytMax, &amp;tMin, &amp;tMax))
           return {};
       </div></div>
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> sigma_t(1);
    return <a href="#DDAMajorantIterator" class="code">DDAMajorantIterator</a>(ray, tMin, tMax, &amp;<a href="#RGBGridMedium::majorantGrid" class="code">majorantGrid</a>, sigma_t);
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
<div class="container-fluid">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>,<br>
<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">&copy; 2004-2023</a> Matt Pharr, Wenzel Jakob, and Greg Humphreys.
<a href="https://github.com/mmp/pbr-book-website/"><span class="fab fa-github"></span></a><br>
Purchase a printed copy: <a href="https://www.amazon.com/Physically-Based-Rendering-fourth-Implementation/dp/0262048027?keywords=physically+based+rendering+4th+edition&qid=1671730412&sprefix=physically+based%!C(MISSING)aps%!C(MISSING)145&sr=8-1&linkCode=ll1&tag=pharr-20&linkId=81a816d90f0c7e872617f1f930a51fd6&language=en_US&ref_=as_li_ss_tl"><span class="fab fa-amazon"></span></a>
<a href="https://mitpress.mit.edu/9780262048026/physically-based-rendering/"><img src="/mitpress.png" width=10 height=16></a>
</span>
</div>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Volume_Scattering/Further_Reading.html">Volume Scattering / Further Reading</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
