
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.ico?v=2" /> <!-- force refresh -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

  <script async src="https://cse.google.com/cse.js?cx=003601324460585362024:4xwpwgaitgd"></script>
  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
        
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>Reservoir Sampling</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Sampling_Algorithms.html">Sampling Algorithms</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Reservoir Sampling</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Sampling_Algorithms/The_Alias_Method.html">(Previous: The Alias Method)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:reservoir-sampling"></span><h2>A.2 Reservoir Sampling</h2><p>



</p>
<p>To perform the sampling operation,
both <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete"><tt>SampleDiscrete()</tt></a> and alias tables require the number
of outcomes being sampled from as well as all their probabilities to
be stored in memory.
Often this is not a problem, but for cases where we would like
to draw a sample from a large number of events, or cases where each
event requires a large amount of memory, it is useful to be able to
generate samples without storing all of them at once.

</p>
<p>

</p>
<p>A family of algorithms based on a technique called <em>reservoir
sampling</em> makes this possible, by taking a stream of candidate samples one at a time
and randomly keeping just one of them in a way that ensures that the sample
that is kept is from the distribution defined by the samples that have been
seen so far.  Reservoir sampling algorithms date to the early days of computer
tape drives, where data could only be accessed sequentially and there was
often more of it than could be stored in main memory.  Reservoir sampling
made it possible to draw random samples from data stored on tape while only
reading the tape once.


</p>
<p>The basic reservoir sampling algorithm is easily expressed. Each candidate
sample is stored in the reservoir with probability equal to one over the
number of candidates that have been considered:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="32.29ex" height="16.843ex" style="vertical-align: -7.838ex;" viewBox="0 -3877 13902.7 7251.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column Blank 2nd Column normal r normal e normal s normal e normal r normal v normal o normal i normal r left-arrow normal empty-set comma n left-arrow 0 2nd Row 1st Column Blank 2nd Column while normal s normal a normal m normal p normal l normal e left-arrow GetSample left-parenthesis right-parenthesis colon 3rd Row 1st Column Blank 2nd Column n left-arrow n plus 1 4th Row 1st Column Blank 2nd Column if xi less-than 1 slash n 5th Row 1st Column Blank 2nd Column normal r normal e normal s normal e normal r normal v normal o normal i normal r left-arrow normal s normal a normal m normal p normal l normal e EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-76" d="M508 400c-66 -1 -83 -44 -92 -67l-131 -325c-4 -10 -8 -19 -21 -19s-15 5 -21 19l-144 355c-13 31 -17 37 -80 37v31c30 -2 70 -3 97 -3l109 3v-31c-18 0 -57 0 -57 -26c0 0 0 -4 6 -17l112 -279l102 255c4 11 6 15 6 24c0 19 -11 42 -48 43v31l87 -3c23 0 52 1 75 3v-31 Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2190" d="M942 250c0 -11 -9 -20 -20 -20h-766c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127 c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72h766c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2205" d="M452 345c0 -72 -3 -155 -29 -225c-18 -48 -62 -142 -174 -142c-27 0 -57 8 -81 21l-13 -45c-6 -22 -9 -32 -24 -32c-11 0 -20 9 -20 20l23 83c-87 75 -87 259 -87 320c0 93 5 183 44 264c37 77 102 107 159 107c37 0 69 -15 81 -21l13 45c6 22 9 32 24 32 c11 0 20 -9 20 -20l-5 -18l-18 -65c86 -85 87 -242 87 -324zM322 666c-26 22 -52 28 -72 28c-45 0 -103 -30 -122 -123c-14 -64 -14 -133 -14 -214c0 -95 0 -218 33 -287zM385 357c0 95 0 211 -33 269l-174 -597c24 -21 48 -29 71 -29c53 0 106 38 124 143 c12 67 12 141 12 214Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-47" d="M735 242c-65 0 -69 -5 -69 -44v-174c0 -15 0 -23 -9 -23c-11 0 -51 40 -64 62c-34 -59 -114 -85 -187 -85c-190 0 -350 159 -350 364s162 363 348 363c99 0 153 -54 185 -86l50 74c8 12 12 12 16 12c11 0 11 -7 11 -24v-237c0 -21 0 -24 -16 -24c-14 0 -14 3 -16 17 c-20 147 -111 237 -218 237c-60 0 -257 -33 -257 -332c0 -298 198 -333 263 -333c28 0 155 9 155 121v64c0 37 -3 48 -93 48h-32v31c36 -3 121 -3 161 -3l122 3v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3A" d="M192 378c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-66" d="M357 635c0 -24 -15 -44 -44 -44c-27 0 -43 20 -43 43c0 25 18 38 30 42c-15 7 -30 7 -33 7c-44 0 -92 -48 -92 -136v-116h117v-31h-114v-322c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v324h-79v31h79v115c0 106 85 159 155 159 c53 0 90 -33 90 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D709" d="M446 592c0 -31 -64 -31 -89 -31c-23 0 -46 0 -64 22c-75 -37 -111 -114 -111 -170c0 -19 4 -52 30 -78c37 12 66 12 84 12c39 0 82 -2 82 -27c0 -31 -63 -31 -93 -31c-21 0 -51 0 -88 13c-84 -42 -123 -129 -123 -170c0 -42 30 -71 75 -89l60 -24c21 -7 41 -15 61 -23 l61 -23c11 -5 48 -23 48 -71c0 -49 -42 -107 -104 -107c-56 0 -109 36 -109 48c0 4 2 11 10 11c4 0 5 -1 11 -5c11 -8 44 -32 88 -32c31 0 49 30 49 53c0 29 -20 36 -35 43c-59 23 -61 23 -121 47c-75 28 -84 32 -116 65c-2 3 -29 31 -29 79c0 36 22 130 131 202l13 10 c-47 27 -65 69 -65 106c0 77 68 157 175 187c-1 4 -7 19 -7 39c0 3 0 49 18 49c7 0 12 -5 12 -13c0 0 -5 -23 -5 -37c0 -17 2 -24 5 -33c26 5 50 5 63 5c39 0 83 -1 83 -27zM420 591c-18 5 -22 6 -56 6c-11 0 -32 0 -48 -5c11 -9 23 -9 42 -9c44 0 54 5 62 8zM352 319 c-18 5 -22 6 -57 6c-12 0 -34 0 -57 -6c18 -8 27 -8 50 -8c46 0 56 4 64 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3C" d="M689 -9c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(267,0)">
<g transform="translate(0,3000)">
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="392" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="837" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="1231" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="1676" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-76" x="2068" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="2597" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="3097" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="3376" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2190" x="4046" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2205" x="5324" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="5825" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="6270" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2190" x="7148" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="8426" y="0"></use>
</g>
<g transform="translate(0,1500)">
 <use xlink:href="#E1-LATINMODERNMAIN-77"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-68" x="722" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6C" x="1557" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="1836" y="0"></use>
<g transform="translate(2612,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-61" x="394" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6D" x="895" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1728" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6C" x="2285" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="2563" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2190" x="5898" y="0"></use>
<g transform="translate(7176,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-47"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="785" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-74" x="1230" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-53" x="1619" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-61" x="2176" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6D" x="2676" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="3510" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6C" x="4066" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="4345" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4789" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5179" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3A" x="13022" y="0"></use>
</g>
<g transform="translate(0,-49)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1000" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2190" x="1878" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="3156" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="3979" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="4980" y="0"></use>
</g>
<g transform="translate(0,-1549)">
<g transform="translate(1000,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-69"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-66" x="278" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D709" x="1917" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3C" x="2641" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="3697" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="4198" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="4698" y="0"></use>
</g>
<g transform="translate(0,-3100)">
<g transform="translate(2000,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="392" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="837" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="1231" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="1676" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-76" x="2068" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="2597" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="3097" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="3376" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2190" x="6046" y="0"></use>
<g transform="translate(7324,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-61" x="394" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6D" x="895" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1728" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6C" x="2285" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="2563" y="0"></use>
</g>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>

The correctness of this algorithm can be shown using induction.
For the base case, it is clear that if there is a single sample, it will be
stored in the reservoir, and the reservoir has successfully drawn a sample
with the appropriate probability from the sample distribution.

</p>
<p>Now consider the case where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
</g>
</svg> samples have been considered and assume
that the sample stored in the reservoir has been kept with probability
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.72ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 1601.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1001" y="0"></use>
</g>
</svg>.  When a new sample is considered, it will be kept with probability
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.532ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4103.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash left-parenthesis n plus 1 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1001" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1390" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="2213" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="3213" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3714" y="0"></use>
</g>
</svg>, which is clearly the correct probability for it. The existing
sample is kept with probability <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.764ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4203.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n slash left-parenthesis n plus 1 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="600" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1101" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1490" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="2313" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="3313" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3814" y="0"></use>
</g>
</svg>; the product of the probability
of keeping the existing sample and its probability of being stored in the
reservoir gives the correct probability, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.532ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4103.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash left-parenthesis n plus 1 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1001" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="1390" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="2213" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="3213" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3714" y="0"></use>
</g>
</svg>, as well.

</p>
<p><em>Weighted reservoir sampling</em> algorithms generalize the basic
algorithm by making it possible to associate a
nonnegative weight with each sample.  Samples are then kept with
probability given by the ratio of their weight to the sum of weights of all
of the candidate samples that have been seen so far.  The
<tt>WeightedReservoirSampler</tt> class implements this algorithm.  It is
parameterized by the type of object being sampled <tt>T</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerDefinition-0"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">template &lt;typename T&gt;
class <span class="anchor" id="WeightedReservoirSampler"></span>WeightedReservoirSampler {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-WeightedReservoirSamplerPublicMethods-0">WeightedReservoirSampler Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2646" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2646"><i></i></a><div id="fragbit-2646" class="collapse"><div class="fragmentcode">       WeightedReservoirSampler() = default;
       WeightedReservoirSampler(uint64_t rngSeed) : <a href="#WeightedReservoirSampler::rng" class="code">rng</a>(rngSeed) {}
       void Seed(uint64_t seed) { <a href="#WeightedReservoirSampler::rng" class="code">rng</a>.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::SetSequence" class="code">SetSequence</a>(seed); }
       void <a href="#WeightedReservoirSampler::Add" class="code">Add</a>(const T &amp;sample, Float weight) {
           <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a> += weight;
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Randomlyaddmonosampletoreservoir-0">Randomly add <tt>sample</tt> to reservoir</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2647" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2647"><i></i></a><div id="fragbit-2647" class="collapse"><div class="fragmentcode">              Float p = weight / <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>;
              if (rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;() &lt; p) {
                  <a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a> = sample;
                  <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a> = weight;
              }</div></div>
       }
       template &lt;typename F&gt;
       void <a href="#WeightedReservoirSampler::Add" class="code">Add</a>(F func, Float weight) {
           &lt;&lt;<span class="fragmentname">Process weighted reservoir sample via callback</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2648" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2648"><i></i></a><div id="fragbit-2648" class="collapse"><div class="fragmentcode">              weightSum += weight;
              Float p = weight / weightSum;
              if (rng.Uniform&lt;Float&gt;() &lt; p) {
                  reservoir = func();
                  reservoirWeight = weight;
              }
              </div></div> 
       }
       void Copy(const WeightedReservoirSampler &amp;wrs) {
           <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a> = wrs.<a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>;
           <a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a> = wrs.<a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a>;
           <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a> = wrs.<a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a>;
       }
       int <a href="#WeightedReservoirSampler::HasSample" class="code">HasSample</a>() const { return <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a> &gt; 0; }
       const T &amp;GetSample() const { return <a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a>; }
       Float SampleProbability() const { return <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a> / <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>; }
       Float WeightSum() const { return <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>; }
       void Reset() { <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a> = <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a> = 0; }
       void Merge(const WeightedReservoirSampler &amp;wrs) {
           if (wrs.<a href="#WeightedReservoirSampler::HasSample" class="code">HasSample</a>())
               <a href="#WeightedReservoirSampler::Add" class="code">Add</a>(wrs.<a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a>, wrs.<a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>);
       }
       std::string ToString() const {
           return StringPrintf("[ WeightedReservoirSampler <a href="#WeightedReservoirSampler::rng" class="code">rng</a>: %s "
                               "<a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>: %f <a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a>: %s <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a>: %f ]",
                               <a href="#WeightedReservoirSampler::rng" class="code">rng</a>, <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>, <a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a>, <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a>);
       }</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-WeightedReservoirSamplerPrivateMembers-0">WeightedReservoirSampler Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2649" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2649"><i></i></a><div id="fragbit-2649" class="collapse"><div class="fragmentcode">       <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng;
       Float weightSum = 0;
       Float reservoirWeight = 0;
       T reservoir;</div></div>
};</div><p>


</p>
<p><tt>WeightedReservoirSampler</tt> stores an <a href="../Utilities/Mathematical_Infrastructure.html#RNG"><tt>RNG</tt></a> object that provides
the random numbers that are used in deciding whether to add each
sample to the reservoir.  The constructor correspondingly takes a seed
value that is passed on to the <a href="../Utilities/Mathematical_Infrastructure.html#RNG"><tt>RNG</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPublicMethods-0"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Public Methods&gt;&gt;=&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">WeightedReservoirSampler() = default;
WeightedReservoirSampler(uint64_t rngSeed) : <a href="#WeightedReservoirSampler::rng" class="code">rng</a>(rngSeed) {}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Private Members&gt;&gt;=&nbsp;<a href="#fragment-WeightedReservoirSamplerPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> <span class="anchor" id="WeightedReservoirSampler::rng"></span>rng;</div><p>


</p>
<p>If an array of <tt>WeightedReservoirSampler</tt>s is allocated, then the
default constructor runs instead.  In that case, the <a href="../Utilities/Mathematical_Infrastructure.html#RNG"><tt>RNG</tt></a>s in
individual samplers can be seeded via the <tt>Seed()</tt> method.

</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPublicMethods-1"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="WeightedReservoirSampler::Seed"></span>Seed(uint64_t seed) { rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::SetSequence" class="code">SetSequence</a>(seed); }</div><p>


</p>
<p>The <tt>Add()</tt> method takes a single sample and a nonnegative weight
value and updates the reservoir so that the stored sample is from
the expected distribution.

</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPublicMethods-2"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="WeightedReservoirSampler::Add"></span>Add(const T &amp;sample, Float weight) {
    <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a> += weight;
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Randomlyaddmonosampletoreservoir-0">Randomly add <tt>sample</tt> to reservoir</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2650" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2650"><i></i></a><div id="fragbit-2650" class="collapse"><div class="fragmentcode">       Float p = weight / <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>;
       if (rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;() &lt; p) {
           <a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a> = sample;
           <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a> = weight;
       }</div></div>
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Private Members&gt;&gt;+=&nbsp;<a href="#fragment-WeightedReservoirSamplerPrivateMembers-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-WeightedReservoirSamplerPrivateMembers-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="WeightedReservoirSampler::weightSum"></span>weightSum = 0;</div><p>


</p>
<p>The probability <tt>p</tt> for storing the sample candidate in the reservoir
is easily found given <tt>weightSum</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Randomlyaddmonosampletoreservoir-0"></span><div class="fragmentname">&lt;&lt;Randomly add <tt>sample</tt> to reservoir&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float p = weight / <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>;
if (rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;() &lt; p) {
    <a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a> = sample;
    <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a> = weight;
}</div><p>


</p>
<p>The weight of the sample stored in the reservoir is stored in
<tt>reservoirWeight</tt>; it is needed to compute the value of the probability
mass function (PMF) for the sample that
is kept.

</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPrivateMembers-2"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Private Members&gt;&gt;+=&nbsp;<a href="#fragment-WeightedReservoirSamplerPrivateMembers-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="WeightedReservoirSampler::reservoirWeight"></span>reservoirWeight = 0;
T <span class="anchor" id="WeightedReservoirSampler::reservoir"></span>reservoir;</div><p>


</p>
<p>A second <tt>Add()</tt> method takes a callback function that returns a
sample.  This function is only called when the sample is to be
stored in the reservoir.  This variant is useful in cases where the
sample&rsquo;s weight can be computed independently of its value and where its
value is relatively expensive to compute.  The fragment that contains its
implementation, &lt;&lt;<span class="fragmentname">Process weighted reservoir sample via callback</span>&gt;&gt;,
otherwise follows the same structure as the first <tt>Add()</tt> method, so it
is not included here.

</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPublicMethods-3"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-2"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-4"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">template &lt;typename F&gt;
void Add(F func, Float weight) {
    &lt;&lt;<span class="fragmentname">Process weighted reservoir sample via callback</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2651" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2651"><i></i></a><div id="fragbit-2651" class="collapse"><div class="fragmentcode">       weightSum += weight;
       Float p = weight / weightSum;
       if (rng.Uniform&lt;Float&gt;() &lt; p) {
           reservoir = func();
           reservoirWeight = weight;
       }
       </div></div> 
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p>A number of methods provide access to the sample and the probability that
it was stored in the reservoir.

</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPublicMethods-4"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-3"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-5"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">int <span class="anchor" id="WeightedReservoirSampler::HasSample"></span>HasSample() const { return <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a> &gt; 0; }
const T &amp;<span class="anchor" id="WeightedReservoirSampler::GetSample"></span>GetSample() const { return <a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a>; }
Float <span class="anchor" id="WeightedReservoirSampler::SampleProbability"></span>SampleProbability() const { return <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a> / <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>; }
Float <span class="anchor" id="WeightedReservoirSampler::WeightSum"></span>WeightSum() const { return <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>; }</div><p>


</p>
<p>It is sometimes useful to reset a <tt>WeightedReservoirSampler</tt> and
restart from scratch with a new stream of samples; the <tt>Reset()</tt>
method handles this task.

</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPublicMethods-5"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-4"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-6"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="WeightedReservoirSampler::Reset"></span>Reset() { <a href="#WeightedReservoirSampler::reservoirWeight" class="code">reservoirWeight</a> = <a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a> = 0; }</div><p>


</p>
<p>Remarkably, it is possible to merge two reservoirs into one in such a way
that the stored sample is kept with the same probability as if a single
reservoir had considered all of the samples seen by the two.
Merging two reservoirs is a matter of randomly taking the sample
stored by the second reservoir with probability defined by its sum of
sample weights divided by the sum of both reservoirs&rsquo; sums of sample
weights, which in turn is exactly what the <tt>Add()</tt> method does.

</p>
<p></p>
<span class="anchor" id="fragment-WeightedReservoirSamplerPublicMethods-6"></span><div class="fragmentname">&lt;&lt;WeightedReservoirSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-WeightedReservoirSamplerPublicMethods-5"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="WeightedReservoirSampler::Merge"></span>Merge(const WeightedReservoirSampler &amp;wrs) {
    if (wrs.<a href="#WeightedReservoirSampler::HasSample" class="code">HasSample</a>())
        <a href="#WeightedReservoirSampler::Add" class="code">Add</a>(wrs.<a href="#WeightedReservoirSampler::reservoir" class="code">reservoir</a>, wrs.<a href="#WeightedReservoirSampler::weightSum" class="code">weightSum</a>);
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
<div class="container-fluid">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>,<br>
<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">&copy; 2004-2023</a> Matt Pharr, Wenzel Jakob, and Greg Humphreys.
<a href="https://github.com/mmp/pbr-book-website/"><span class="fab fa-github"></span></a><br>
Purchase a printed copy: <a href="https://www.amazon.com/Physically-Based-Rendering-fourth-Implementation/dp/0262048027?keywords=physically+based+rendering+4th+edition&qid=1671730412&sprefix=physically+based%!C(MISSING)aps%!C(MISSING)145&sr=8-1&linkCode=ll1&tag=pharr-20&linkId=81a816d90f0c7e872617f1f930a51fd6&language=en_US&ref_=as_li_ss_tl"><span class="fab fa-amazon"></span></a>
<a href="https://mitpress.mit.edu/9780262048026/physically-based-rendering/"><img src="/mitpress.png" width=10 height=16></a>
</span>
</div>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Sampling_Algorithms/The_Rejection_Method.html">Sampling Algorithms / The Rejection Method</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
