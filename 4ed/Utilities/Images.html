
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.ico?v=2" /> <!-- force refresh -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

<script async src="https://cse.google.com/cse.js?cx=22a43cef261a245ea"></script>  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>Images</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Utilities.html">Utilities</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Images</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Utilities/Containers_and_Memory_Management.html">(Previous: Containers and Memory Management)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:image-class"></span><h2>B.5 Images</h2><p>



</p>
<p>The <tt>Image</tt> class stores a 2D array of pixel values, where each pixel
stores a fixed number of scalar-valued <em>channels</em>.  (For example, an
image storing RGB color would have three channels.)  It provides a variety
of operations ranging from looking up or interpolating pixel values to
image-wide operations like resizing.  It is at the core of both the
<a href="../Textures_and_Materials/Image_Texture.html#FloatImageTexture"><tt>FloatImageTexture</tt></a> and <a href="../Textures_and_Materials/Image_Texture.html#SpectrumImageTexture"><tt>SpectrumImageTexture</tt></a> classes and is used
for lights such as the <a href="../Light_Sources/Infinite_Area_Lights.html#ImageInfiniteLight"><tt>ImageInfiniteLight</tt></a> and <a href="../Light_Sources/Point_Lights.html#ProjectionLight"><tt>ProjectionLight</tt></a>.
Furthermore, both of <tt>pbrt</tt>&rsquo;s <a href="../Cameras_and_Film/Film_and_Imaging.html#Film"><tt>Film</tt></a> implementations make use of its
capabilities for writing images to disk in a variety of file formats.

</p>
<p></p>
<span class="anchor" id="fragment-ImageDefinition-0"></span><div class="fragmentname">&lt;&lt;Image Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="Image"></span>Image {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ImagePublicMethods-0">Image Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2762" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2762"><i></i></a><div id="fragbit-2762" class="collapse"><div class="fragmentcode">       <a href="#Image" class="code">Image</a>(<a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator" class="code">Allocator</a> alloc = {})
           : p8(alloc),
             p16(alloc),
             p32(alloc),
             <a href="#Image::format" class="code">format</a>(PixelFormat::U256),
             <a href="#Image::resolution" class="code">resolution</a>(0, 0) {}
       <a href="#Image" class="code">Image</a>(pstd::vector&lt;uint8_t&gt; p8, <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> <a href="#Image::resolution" class="code">resolution</a>,
             pstd::span&lt;const std::string&gt; channels, <a href="#ColorEncoding" class="code">ColorEncoding</a> <a href="#Image::encoding" class="code">encoding</a>);
       <a href="#Image" class="code">Image</a>(pstd::vector&lt;Half&gt; p16, <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> <a href="#Image::resolution" class="code">resolution</a>,
             pstd::span&lt;const std::string&gt; channels);
       <a href="#Image" class="code">Image</a>(pstd::vector&lt;float&gt; p32, <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> <a href="#Image::resolution" class="code">resolution</a>,
             pstd::span&lt;const std::string&gt; channels);
       <a href="#Image" class="code">Image</a>(PixelFormat <a href="#Image::format" class="code">format</a>, <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> <a href="#Image::resolution" class="code">resolution</a>,
             pstd::span&lt;const std::string&gt; <a href="#Image::channelNames" class="code">channelNames</a>,
             <a href="#ColorEncoding" class="code">ColorEncoding</a> <a href="#Image::encoding" class="code">encoding</a> = nullptr, <a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator" class="code">Allocator</a> alloc = {});
       PixelFormat Format() const { return <a href="#Image::format" class="code">format</a>; }
       <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> Resolution() const { return <a href="#Image::resolution" class="code">resolution</a>; }
       int <a href="#Image::NChannels" class="code">NChannels</a>() const { return <a href="#Image::channelNames" class="code">channelNames</a>.size(); }
       std::vector&lt;std::string&gt; ChannelNames() const;
       const <a href="#ColorEncoding" class="code">ColorEncoding</a> Encoding() const { return <a href="#Image::encoding" class="code">encoding</a>; }
       operator bool() const { return <a href="#Image::resolution" class="code">resolution</a>.x &gt; 0 &amp;&amp; <a href="#Image::resolution" class="code">resolution</a>.y &gt; 0; }
       size_t PixelOffset(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p) const {
           return <a href="#Image::NChannels" class="code">NChannels</a>() * (p.y * <a href="#Image::resolution" class="code">resolution</a>.x + p.x);
       }
       Float GetChannel(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p, int c,
                        WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Remapprovidedpixelcoordinatesbeforereadingchannel-0">Remap provided pixel coordinates before reading channel</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2763" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2763"><i></i></a><div id="fragbit-2763" class="collapse"><div class="fragmentcode">              if (!RemapPixelCoords(&amp;p, resolution, wrapMode))
                  return 0;</div></div>
           switch (<a href="#Image::format" class="code">format</a>) {
           case PixelFormat::U256:  { &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnmonoU256-encodedpixelchannelvalue-0">Return <tt>U256</tt>-encoded pixel channel value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2764" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2764"><i></i></a><div id="fragbit-2764" class="collapse"><div class="fragmentcode">                      Float r;
                      encoding.<a href="#ColorEncoding::ToLinear" class="code">ToLinear</a>({&amp;<a href="#Image::p8" class="code">p8</a>[<a href="#Image::PixelOffset" class="code">PixelOffset</a>(p) + c], 1}, {&amp;r, 1});
                      return r;</div></div> }
           case PixelFormat::Half:  { &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnmonoHalf-encodedpixelchannelvalue-0">Return <tt>Half</tt>-encoded pixel channel value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2765" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2765"><i></i></a><div id="fragbit-2765" class="collapse"><div class="fragmentcode">                      return Float(<a href="#Image::p16" class="code">p16</a>[<a href="#Image::PixelOffset" class="code">PixelOffset</a>(p) + c]);</div></div> }
           case PixelFormat::Float: { &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnmonoFloat-encodedpixelchannelvalue-0">Return <tt>Float</tt>-encoded pixel channel value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2766" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2766"><i></i></a><div id="fragbit-2766" class="collapse"><div class="fragmentcode">                     return <a href="#Image::p32" class="code">p32</a>[<a href="#Image::PixelOffset" class="code">PixelOffset</a>(p) + c];</div></div> }
           }
       }
       Float BilerpChannel(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> p, int c,
                           WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Computediscretepixelcoordinatesandoffsetsformonop-0">Compute discrete pixel coordinates and offsets for <tt>p</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2767" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2767"><i></i></a><div id="fragbit-2767" class="collapse"><div class="fragmentcode">              Float x = p[0] * resolution.x - 0.5f, y = p[1] * resolution.y - 0.5f;
              int xi = pstd::floor(x), yi = pstd::floor(y);
              Float dx = x - xi, dy = y - yi;</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Loadpixelchannelvaluesandreturnbilinearlyinterpolatedvalue-0">Load pixel channel values and return bilinearly interpolated value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2768" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2768"><i></i></a><div id="fragbit-2768" class="collapse"><div class="fragmentcode">              pstd::array&lt;Float, 4&gt; v = {<a href="#Image::GetChannel" class="code">GetChannel</a>({xi,     yi},     c, wrapMode),
                                         <a href="#Image::GetChannel" class="code">GetChannel</a>({xi + 1, yi},     c, wrapMode),
                                         <a href="#Image::GetChannel" class="code">GetChannel</a>({xi,     yi + 1}, c, wrapMode),
                                         <a href="#Image::GetChannel" class="code">GetChannel</a>({xi + 1, yi + 1}, c, wrapMode)};
              return ((1 - dx) * (1 - dy) * v[0] + dx * (1 - dy) * v[1] +
                      (1 - dx) *      dy  * v[2] + dx *      dy  * v[3]);</div></div>
       }
       void SetChannel(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p, int c, Float value);
       ImageChannelValues GetChannels(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p,
                                      WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;
       ImageChannelDesc GetChannelDesc(
           pstd::span&lt;const std::string&gt; channels) const;
       ImageChannelDesc AllChannelsDesc() const {
           ImageChannelDesc desc;
           desc.offset.resize(<a href="#Image::NChannels" class="code">NChannels</a>());
           for (int i = 0; i &lt; <a href="#Image::NChannels" class="code">NChannels</a>(); ++i)
               desc.offset[i] = i;
           return desc;
       }
       ImageChannelValues GetChannels(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p, const ImageChannelDesc &amp;desc,
                                      WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;
       <a href="#Image" class="code">Image</a> SelectChannels(const ImageChannelDesc &amp;desc,
                            <a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator" class="code">Allocator</a> alloc = {}) const;
       <a href="#Image" class="code">Image</a> Crop(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> &amp;bounds, <a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator" class="code">Allocator</a> alloc = {}) const;
       void CopyRectOut(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> &amp;extent, pstd::span&lt;float&gt; buf,
                        WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;
       void CopyRectIn(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> &amp;extent, pstd::span&lt;const float&gt; buf);
       ImageChannelValues Average(const ImageChannelDesc &amp;desc) const;
       bool HasAnyInfinitePixels() const;
       bool HasAnyNaNPixels() const;
       ImageChannelValues MAE(const ImageChannelDesc &amp;desc, const <a href="#Image" class="code">Image</a> &amp;ref,
                              <a href="#Image" class="code">Image</a> *errorImage = nullptr) const;
       ImageChannelValues MSE(const ImageChannelDesc &amp;desc, const <a href="#Image" class="code">Image</a> &amp;ref,
                              <a href="#Image" class="code">Image</a> *mseImage = nullptr) const;
       ImageChannelValues MRSE(const ImageChannelDesc &amp;desc, const <a href="#Image" class="code">Image</a> &amp;ref,
                               <a href="#Image" class="code">Image</a> *mrseImage = nullptr) const;
       <a href="#Image" class="code">Image</a> GaussianFilter(const ImageChannelDesc &amp;desc, int halfWidth,
                           Float sigma) const;
       template &lt;typename F&gt;
       <a href="../Utilities/Containers_and_Memory_Management.html#Array2D" class="code">Array2D</a>&lt;Float&gt; GetSamplingDistribution(
           F dxdA, const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a> &amp;domain = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0, 0), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(1, 1)),
           <a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator" class="code">Allocator</a> alloc = {});
       <a href="../Utilities/Containers_and_Memory_Management.html#Array2D" class="code">Array2D</a>&lt;Float&gt; GetSamplingDistribution() {
           return GetSamplingDistribution([](<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>) { return Float(1); });
       }
       static ImageAndMetadata Read(std::string filename, <a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator" class="code">Allocator</a> alloc = {},
                                    <a href="#ColorEncoding" class="code">ColorEncoding</a> <a href="#Image::encoding" class="code">encoding</a> = nullptr);
       bool Write(std::string name, const ImageMetadata &amp;metadata = {}) const;
       <a href="#Image" class="code">Image</a> ConvertToFormat(PixelFormat <a href="#Image::format" class="code">format</a>,
                             <a href="#ColorEncoding" class="code">ColorEncoding</a> <a href="#Image::encoding" class="code">encoding</a> = nullptr) const;
       
       // TODO? provide an iterator to iterate over all pixels and channels?
       
       
       PBRT_CPU_GPU
       Float LookupNearestChannel(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> p, int c,
                                  WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const {
           <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> pi(p.x * <a href="#Image::resolution" class="code">resolution</a>.x, p.y * <a href="#Image::resolution" class="code">resolution</a>.y);
           return GetChannel(pi, c, wrapMode);
       }
       
       ImageChannelValues LookupNearest(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> p,
                                        WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;
       ImageChannelValues LookupNearest(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> p, const ImageChannelDesc &amp;desc,
                                        WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;
       
       ImageChannelValues Bilerp(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> p, WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;
       ImageChannelValues Bilerp(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> p, const ImageChannelDesc &amp;desc,
                                 WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;
       
       void SetChannels(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p, const ImageChannelValues &amp;values);
       void SetChannels(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p, pstd::span&lt;const Float&gt; values);
       void SetChannels(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p, const ImageChannelDesc &amp;desc,
                        pstd::span&lt;const Float&gt; values);
       
       <a href="#Image" class="code">Image</a> FloatResizeUp(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> newResolution, WrapMode2D wrap) const;
       void FlipY();
       static pstd::vector&lt;<a href="#Image" class="code">Image</a>&gt; GeneratePyramid(<a href="#Image" class="code">Image</a> image, WrapMode2D wrapMode,
                                                 <a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator" class="code">Allocator</a> alloc = {});
       
       std::vector&lt;std::string&gt; ChannelNames(const ImageChannelDesc &amp;) const;
       
       PBRT_CPU_GPU
       size_t BytesUsed() const { return p8.size() + 2 * p16.size() + 4 * p32.size(); }
       
       PBRT_CPU_GPU
       const void *RawPointer(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p) const {
           if (Is8Bit(<a href="#Image::format" class="code">format</a>))
               return p8.data() + PixelOffset(p);
           if (Is16Bit(<a href="#Image::format" class="code">format</a>))
               return p16.data() + PixelOffset(p);
           else {
               CHECK(Is32Bit(<a href="#Image::format" class="code">format</a>));
               return p32.data() + PixelOffset(p);
           }
       }
       PBRT_CPU_GPU
       void *RawPointer(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p) {
           return const_cast&lt;void *&gt;(((const <a href="#Image" class="code">Image</a> *)this)-&gt;RawPointer(p));
       }
       
       <a href="#Image" class="code">Image</a> JointBilateralFilter(const ImageChannelDesc &amp;toFilter, int halfWidth,
                                  const Float xySigma[2], const ImageChannelDesc &amp;joint,
                                  const ImageChannelValues &amp;jointSigma) const;
       
       
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname">Image Private Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2769" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2769"><i></i></a><div id="fragbit-2769" class="collapse"><div class="fragmentcode">       static std::vector&lt;ResampleWeight&gt; ResampleWeights(int oldRes, int newRes);
       bool WriteEXR(const std::string &amp;name, const ImageMetadata &amp;metadata) const;
       bool WritePFM(const std::string &amp;name, const ImageMetadata &amp;metadata) const;
       bool WritePNG(const std::string &amp;name, const ImageMetadata &amp;metadata) const;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ImagePrivateMembers-0">Image Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2770" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2770"><i></i></a><div id="fragbit-2770" class="collapse"><div class="fragmentcode">       PixelFormat format;
       <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> resolution;
       pstd::vector&lt;std::string&gt; channelNames;
       <a href="#ColorEncoding" class="code">ColorEncoding</a> encoding = nullptr;
       pstd::vector&lt;uint8_t&gt; p8;
       pstd::vector&lt;Half&gt; p16;
       pstd::vector&lt;float&gt; p32;</div></div>
};</div><p>


</p>
<p><tt>Image</tt> is defined in the files <a href="https://github.com/mmp/pbrt-v4/tree/master/src/pbrt/util/image.h"><tt>util/image.h</tt></a> and
<a href="https://github.com/mmp/pbrt-v4/tree/master/src/pbrt/util/image.cpp"><tt>util/image.cpp</tt></a>.

</p>
<p>

</p>
<p>The <tt>Image</tt> class provides a number of constructors as well as a
method (which will be discussed in Section&nbsp;<a href="#sec:image-read-write">B.5.3</a>) that
reads an image from a file. We will only describe the operation of
its most general-purpose constructor here; see the class definition for the
remainder of them.

</p>
<p>This <tt>Image</tt> constructor takes the in-memory format to use for storing
pixel data, <tt>format</tt>, the overall image resolution, and names for all
of the channels.  Optionally, both a <a href="#ColorEncoding"><tt>ColorEncoding</tt></a> and an
<a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator"><tt>Allocator</tt></a> can be provided; the former specifies a technique for
encoding fixed-precision pixel values and will be discussed in
Section&nbsp;<a href="#sec:color-encodings">B.5.6</a>.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-0"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;=&nbsp;<a href="#fragment-ImagePublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="#Image" class="code">Image</a>(PixelFormat format, <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> resolution,
      pstd::span&lt;const std::string&gt; channelNames,
      <a href="#ColorEncoding" class="code">ColorEncoding</a> encoding = nullptr, <a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator" class="code">Allocator</a> alloc = {});</div><p>


</p>
<p>Three in-memory formats are supported for pixel channel values.  Note that
<a href="#Image"><tt>Image</tt></a> uses the same encoding for all channels; it is not possible to
mix and match.  The first of them, <tt>U256</tt>, specifies an unsigned 8-bit
encoding of values between&nbsp;0 and&nbsp;1 using integers ranging from 0 to 255.  This is a
memory-efficient encoding and is widely used in image file formats, but it
provides limited range.  <tt>Half</tt> uses 16-bit floating-point values
(which were described in Section&nbsp;<a href="../Shapes/Managing_Rounding_Error.html#sec:ieee-fp">6.8.1</a>) to provide much more
dynamic range than <tt>U256</tt>, while still being memory efficient.
Finally, <tt>Float</tt> specifies full 32-bit <tt>float</tt>s.  It would not be
difficult to generalize <tt>Image</tt> to also support double-precision
floating-point storage, though we have not found a need to do so for
<tt>pbrt</tt>&rsquo;s uses of this class.

</p>
<p></p>
<span class="anchor" id="fragment-PixelFormatDefinition-0"></span><div class="fragmentname">&lt;&lt;PixelFormat Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">enum class <span class="anchor" id="PixelFormat"></span>PixelFormat { <span class="anchor" id="PixelFormat::U256"></span>U256, <span class="anchor" id="PixelFormat::Half"></span>Half, <span class="anchor" id="PixelFormat::Float"></span>Float };</div><p>


</p>
<p>A few helper functions test whether a given <tt>PixelFormat</tt> uses a
specified amount of storage.  Isolating these tests in this way makes it
easier, for example, to extend <tt>Image</tt> to also provide a 16-bit
integer representation without needing to update logic that purely relates
to memory allocation.

</p>
<p></p>
<span class="anchor" id="fragment-PixelFormatInlineFunctions-0"></span><div class="fragmentname">&lt;&lt;PixelFormat Inline Functions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">bool <span class="anchor" id="Is8Bit"></span>Is8Bit(<a href="#PixelFormat::Float" class="code">PixelFormat</a> format) { return format == <a href="#PixelFormat::Float" class="code">PixelFormat</a>::U256; }
bool <span class="anchor" id="Is16Bit"></span>Is16Bit(<a href="#PixelFormat::Float" class="code">PixelFormat</a> format) { return format == <a href="#PixelFormat::Float" class="code">PixelFormat</a>::Half; }
bool <span class="anchor" id="Is32Bit"></span>Is32Bit(<a href="#PixelFormat::Float" class="code">PixelFormat</a> format) { return format == <a href="#PixelFormat::Float" class="code">PixelFormat</a>::Float; }</div><p>


</p>
<p>The size of the provided <tt>channelNames</tt> parameter determines the
number of channels the image stores at each pixel.  The <tt>Image</tt> class
does not impose any semantics on the channels or attempt to interpret their
meaning but instead just stores values and performs the operations on them
specified by the caller.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePrivateMembers-0"></span><div class="fragmentname">&lt;&lt;Image Private Members&gt;&gt;=&nbsp;<a href="#fragment-ImagePrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">PixelFormat <span class="anchor" id="Image::format"></span>format;
<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> <span class="anchor" id="Image::resolution"></span>resolution;
pstd::vector&lt;std::string&gt; <span class="anchor" id="Image::channelNames"></span>channelNames;
<a href="#ColorEncoding" class="code">ColorEncoding</a> <span class="anchor" id="Image::encoding"></span>encoding = nullptr;</div><p>


</p>
<p>Because these values are stored as private member variables, <tt>Image</tt>
provides corresponding accessor methods.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-1"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">PixelFormat <span class="anchor" id="Image::Format"></span>Format() const { return <a href="#Image::format" class="code">format</a>; }
<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> <span class="anchor" id="Image::Resolution"></span>Resolution() const { return <a href="#Image::resolution" class="code">resolution</a>; }
int <span class="anchor" id="Image::NChannels"></span>NChannels() const { return <a href="#Image::channelNames" class="code">channelNames</a>.size(); }
std::vector&lt;std::string&gt; <span class="anchor" id="Image::ChannelNames"></span>ChannelNames() const;
const <a href="#ColorEncoding" class="code">ColorEncoding</a> <span class="anchor" id="Image::Encoding"></span>Encoding() const { return <a href="#Image::encoding" class="code">encoding</a>; }</div><p>


</p>
<p><tt>Image</tt> allows the specification of an image with no pixels;
<tt>operator bool</tt> provides a quick check for whether an image is nonempty.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-2"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">operator bool() const { return <a href="#Image::resolution" class="code">resolution</a>.x &gt; 0 &amp;&amp; <a href="#Image::resolution" class="code">resolution</a>.y &gt; 0; }</div><p>


</p>
<p>One of the following member variables stores the pixel values.  Which one
is used is determined by the specified <a href="#PixelFormat"><tt>PixelFormat</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePrivateMembers-1"></span><div class="fragmentname">&lt;&lt;Image Private Members&gt;&gt;+=&nbsp;<a href="#fragment-ImagePrivateMembers-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::vector&lt;uint8_t&gt; <span class="anchor" id="Image::p8"></span>p8;
pstd::vector&lt;Half&gt; <span class="anchor" id="Image::p16"></span>p16;
pstd::vector&lt;float&gt; <span class="anchor" id="Image::p32"></span>p32;</div><p>


</p>
<p>The <tt>PixelOffset()</tt> method returns the offset into the pixel value
array for given integer pixel coordinates.  In debug builds, a
<a href="../Utilities/User_Interaction.html#DCHECK"><tt>DCHECK()</tt></a> call, not included here, checks that the provided
coordinates are between&nbsp;0 and the image resolution in each dimension.

</p>
<p>A few factors determine the following indexing computation: first, 
the coordinate system for images has <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.168ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2225.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis 0 comma 0 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="890" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1335" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1835" y="0"></use>
</g>
</svg> at the upper left corner of
the image; images are then laid out in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> scanline order, 
and each pixel&rsquo;s channel values are laid out successively in memory.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-3"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-2"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-4"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">size_t <span class="anchor" id="Image::PixelOffset"></span>PixelOffset(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p) const {
    return <a href="#Image::NChannels" class="code">NChannels</a>() * (p.y * <a href="#Image::resolution" class="code">resolution</a>.x + p.x);
}</div><p>


</p>
<p>An alternative memory layout would first store all the pixels&rsquo; first
channel values contiguously in memory, then the second channel values, and
so forth.  In <tt>pbrt</tt>, the most common uses of <tt>Image</tt> involve accessing
all the channels in a pixel, so the layout we have chosen gives better
memory access coherence, which generally leads to better cache performance.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#WorkingwithPixelValues"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="WorkingwithPixelValues"></span><h3>B.5.1  Working with Pixel Values</h3><p>


</p>
<p>The <tt>GetChannel()</tt> method returns the floating-point value for a
single image channel, taking care of both addressing pixels and converting
the in-memory value to a <tt>Float</tt>.  Note that if this method is used,
it is the caller&rsquo;s responsibility to keep track of what is being stored in
each channel.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-4"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-3"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-5"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="Image::GetChannel"></span>GetChannel(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p, int c,
                 WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Remapprovidedpixelcoordinatesbeforereadingchannel-0">Remap provided pixel coordinates before reading channel</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2771" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2771"><i></i></a><div id="fragbit-2771" class="collapse"><div class="fragmentcode">       if (!RemapPixelCoords(&amp;p, resolution, wrapMode))
           return 0;</div></div>
    switch (format) {
    case PixelFormat::U256:  { &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnmonoU256-encodedpixelchannelvalue-0">Return <tt>U256</tt>-encoded pixel channel value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2772" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2772"><i></i></a><div id="fragbit-2772" class="collapse"><div class="fragmentcode">               Float r;
               encoding.<a href="#ColorEncoding::ToLinear" class="code">ToLinear</a>({&amp;<a href="#Image::p8" class="code">p8</a>[<a href="#Image::PixelOffset" class="code">PixelOffset</a>(p) + c], 1}, {&amp;r, 1});
               return r;</div></div> }
    case PixelFormat::Half:  { &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnmonoHalf-encodedpixelchannelvalue-0">Return <tt>Half</tt>-encoded pixel channel value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2773" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2773"><i></i></a><div id="fragbit-2773" class="collapse"><div class="fragmentcode">               return Float(<a href="#Image::p16" class="code">p16</a>[<a href="#Image::PixelOffset" class="code">PixelOffset</a>(p) + c]);</div></div> }
    case PixelFormat::Float: { &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnmonoFloat-encodedpixelchannelvalue-0">Return <tt>Float</tt>-encoded pixel channel value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2774" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2774"><i></i></a><div id="fragbit-2774" class="collapse"><div class="fragmentcode">              return <a href="#Image::p32" class="code">p32</a>[<a href="#Image::PixelOffset" class="code">PixelOffset</a>(p) + c];</div></div> }
    }
}</div><p>


</p>
<p>Like all the upcoming methods that return pixel values, the lookup point
<tt>p</tt> that is passed to <tt>GetChannel()</tt> is not required to be inside
the image bounds.  This is a convenience for code that calls these methods
and saves them from all needing to handle boundary conditions themselves.

</p>
<p><tt>WrapMode</tt> and <tt>WrapMode2D</tt> specify how out-of-bounds coordinates
should be handled.  The first three options are widely used in texture
mapping, and are respectively to return a black (zero-valued) result, to clamp
out-of-bounds coordinates to the valid bounds, and to take them modulus the
image resolution, which effectively repeats the image infinitely.  The last
option, <tt>OctahedralSphere</tt>, accounts for the layout of the octahedron
used in the definition of equi-area spherical mapping
(see Section&nbsp;<a href="../Geometry_and_Transformations/Spherical_Geometry.html#sec:equi-area-sphere">3.8.3</a>) and should be used when looking up
values in images that are based on that parameterization.

</p>
<p></p>
<span class="anchor" id="fragment-WrapModeDefinitions-0"></span><div class="fragmentname">&lt;&lt;WrapMode Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">enum class <span class="anchor" id="WrapMode"></span>WrapMode { <span class="anchor" id="WrapMode::Black"></span>Black, <span class="anchor" id="WrapMode::Clamp"></span><a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>, <span class="anchor" id="WrapMode::Repeat"></span>Repeat, <span class="anchor" id="WrapMode::OctahedralSphere"></span>OctahedralSphere };
struct <span class="anchor" id="WrapMode2D"></span>WrapMode2D {
    pstd::array&lt;WrapMode, 2&gt; <span class="anchor" id="WrapMode2D::wrap"></span>wrap;
};</div><p>


</p>
<p>The <tt>RemapPixelCoords()</tt><span class="anchor" id="RemapPixelCoords"></span> function
handles modifying the pixel coordinates as needed according to the
<tt>WrapMode</tt> for each dimension.  If an out-of-bounds coordinate has
been provided and <a href="#WrapMode::Black"><tt>WrapMode::Black</tt></a> has been specified, it returns a
false value, which is handled here by returning&nbsp;0.  The implementation of
this function is not included here.

</p>
<p></p>
<span class="anchor" id="fragment-Remapprovidedpixelcoordinatesbeforereadingchannel-0"></span><div class="fragmentname">&lt;&lt;Remap provided pixel coordinates before reading channel&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (!RemapPixelCoords(&amp;p, resolution, wrapMode))
    return 0;</div><p>


</p>
<p>

</p>
<p>Given a valid pixel coordinate, <tt>PixelOffset()</tt> gives the offset to
the first channel for that pixel.  A further offset by the channel index
<tt>c</tt> is all that is left to get to the channel value.  For <tt>U256</tt>
images, this value is decoded into a <tt>Float</tt> using the specified color
encoding (discussed in Section&nbsp;<a href="#sec:color-encodings">B.5.6</a>).

</p>
<p></p>
<span class="anchor" id="fragment-ReturnmonoU256-encodedpixelchannelvalue-0"></span><div class="fragmentname">&lt;&lt;Return <tt>U256</tt>-encoded pixel channel value&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float r;
encoding.<a href="#ColorEncoding::ToLinear" class="code">ToLinear</a>({&amp;<a href="#Image::p8" class="code">p8</a>[<a href="#Image::PixelOffset" class="code">PixelOffset</a>(p) + c], 1}, {&amp;r, 1});
return r;</div><p>


</p>
<p>For <tt>Half</tt> images, the <a href="../Shapes/Managing_Rounding_Error.html#Half"><tt>Half</tt></a> class&rsquo;s <tt>Float</tt> conversion
operator is invoked to get the return value.

</p>
<p></p>
<span class="anchor" id="fragment-ReturnmonoHalf-encodedpixelchannelvalue-0"></span><div class="fragmentname">&lt;&lt;Return <tt>Half</tt>-encoded pixel channel value&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">return Float(<a href="#Image::p16" class="code">p16</a>[<a href="#Image::PixelOffset" class="code">PixelOffset</a>(p) + c]);</div><p>


</p>
<p>And for <tt>Float</tt> images, the task is trivial.

</p>
<p></p>
<span class="anchor" id="fragment-ReturnmonoFloat-encodedpixelchannelvalue-0"></span><div class="fragmentname">&lt;&lt;Return <tt>Float</tt>-encoded pixel channel value&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">return <a href="#Image::p32" class="code">p32</a>[<a href="#Image::PixelOffset" class="code">PixelOffset</a>(p) + c];</div><p>


</p>
<p>The <tt>Image</tt> class also provides a
<tt>LookupNearestChannel()</tt><span class="anchor" id="Image::LookupNearestChannel"></span>
method, which returns the specified channel value for the pixel sample
nearest a provided coordinate with respect to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket squared</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="393" y="513"></use>
</g>
</g>
</svg>.  It is a simple
wrapper around <tt>GetChannel()</tt>, so it is not included here.

</p>
<p>Slightly more interesting in its implementation is <tt>BilerpChannel</tt>,
which uses bilinear interpolation between four image pixels to compute the
channel value.  (This is equivalent to filtering with a pixel-wide triangle
filter.)

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-5"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-4"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-6"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="Image::BilerpChannel"></span>BilerpChannel(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> p, int c,
                    WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Computediscretepixelcoordinatesandoffsetsformonop-0">Compute discrete pixel coordinates and offsets for <tt>p</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2775" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2775"><i></i></a><div id="fragbit-2775" class="collapse"><div class="fragmentcode">       Float x = p[0] * resolution.x - 0.5f, y = p[1] * resolution.y - 0.5f;
       int xi = pstd::floor(x), yi = pstd::floor(y);
       Float dx = x - xi, dy = y - yi;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Loadpixelchannelvaluesandreturnbilinearlyinterpolatedvalue-0">Load pixel channel values and return bilinearly interpolated value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2776" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2776"><i></i></a><div id="fragbit-2776" class="collapse"><div class="fragmentcode">       pstd::array&lt;Float, 4&gt; v = {<a href="#Image::GetChannel" class="code">GetChannel</a>({xi,     yi},     c, wrapMode),
                                  <a href="#Image::GetChannel" class="code">GetChannel</a>({xi + 1, yi},     c, wrapMode),
                                  <a href="#Image::GetChannel" class="code">GetChannel</a>({xi,     yi + 1}, c, wrapMode),
                                  <a href="#Image::GetChannel" class="code">GetChannel</a>({xi + 1, yi + 1}, c, wrapMode)};
       return ((1 - dx) * (1 - dy) * v[0] + dx * (1 - dy) * v[1] +
               (1 - dx) *      dy  * v[2] + dx *      dy  * v[3]);</div></div>
}</div><p>


</p>
<p>The first step is to scale the provided coordinates <tt>p</tt> by the image
resolution, turning them into continuous pixel coordinates.  Because these
are continuous coordinates and the pixels in the image are defined at
discrete pixel coordinates, it is important to carefully convert into a
common representation (Section&nbsp;<a href="../Sampling_and_Reconstruction/Sampling_Theory.html#sec:pixel-concepts">8.1.4</a>).  Here, the work
is performed using discrete coordinates, with the continuous pixel
coordinates mapped to the discrete space.

</p>
<p>For example, consider the 1D case with a continuous texture coordinate of
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2.4</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-32"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="779" y="0"></use>
</g>
</svg>: this coordinate is a distance of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="779" y="0"></use>
</g>
</svg> below the discrete texel
coordinate&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.162ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 500.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="0" y="0"></use>
</g>
</svg> (which corresponds to a continuous coordinate of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2.5</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-32"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="779" y="0"></use>
</g>
</svg>) and is
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.9</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-39" d="M457 329c0 -215 -122 -351 -251 -351c-85 0 -139 41 -139 108c0 39 30 48 46 48c22 0 46 -15 46 -46c0 -17 -8 -46 -52 -46c27 -34 81 -36 98 -36c58 0 162 46 162 280v32c-23 -58 -64 -100 -125 -100c-112 0 -200 98 -200 223c0 75 23 117 64 162c43 45 92 63 147 63 c89 0 204 -68 204 -337zM365 421c0 46 -4 109 -16 141c-17 45 -50 79 -96 79c-35 0 -73 -13 -100 -63c-21 -37 -21 -84 -21 -138c0 -49 0 -99 18 -136c31 -63 77 -63 93 -63c88 0 122 97 122 180Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-39" x="779" y="0"></use>
</g>
</svg> above the discrete coordinate&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.162ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 500.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
</g>
</svg> (continuous coordinate <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1.5</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="779" y="0"></use>
</g>
</svg>).  Thus,
if we subtract <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.5</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="779" y="0"></use>
</g>
</svg> from the continuous coordinate <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2.4</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-32"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="779" y="0"></use>
</g>
</svg>, giving <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1.9</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-39" d="M457 329c0 -215 -122 -351 -251 -351c-85 0 -139 41 -139 108c0 39 30 48 46 48c22 0 46 -15 46 -46c0 -17 -8 -46 -52 -46c27 -34 81 -36 98 -36c58 0 162 46 162 280v32c-23 -58 -64 -100 -125 -100c-112 0 -200 98 -200 223c0 75 23 117 64 162c43 45 92 63 147 63 c89 0 204 -68 204 -337zM365 421c0 46 -4 109 -16 141c-17 45 -50 79 -96 79c-35 0 -73 -13 -100 -63c-21 -37 -21 -84 -21 -138c0 -49 0 -99 18 -136c31 -63 77 -63 93 -63c88 0 122 97 122 180Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-39" x="779" y="0"></use>
</g>
</svg>, we can
correctly compute the correct distances to the discrete coordinates&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.162ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 500.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
</g>
</svg> and&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.162ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 500.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="0" y="0"></use>
</g>
</svg>
by subtracting.

</p>
<p></p>
<span class="anchor" id="fragment-Computediscretepixelcoordinatesandoffsetsformonop-0"></span><div class="fragmentname">&lt;&lt;Compute discrete pixel coordinates and offsets for <tt>p</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float x = p[0] * resolution.x - 0.5f, y = p[1] * resolution.y - 0.5f;
int xi = pstd::floor(x), yi = pstd::floor(y);
Float dx = x - xi, dy = y - yi;</div><p>


</p>
<p>After the distances are found in each dimension to the pixel at the last
integer before the given coordinates, <tt>dx</tt> and <tt>dy</tt>, the four
pixels are bilinearly interpolated.

</p>
<p></p>
<span class="anchor" id="fragment-Loadpixelchannelvaluesandreturnbilinearlyinterpolatedvalue-0"></span><div class="fragmentname">&lt;&lt;Load pixel channel values and return bilinearly interpolated value&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::array&lt;Float, 4&gt; v = {<a href="#Image::GetChannel" class="code">GetChannel</a>({xi,     yi},     c, wrapMode),
                           <a href="#Image::GetChannel" class="code">GetChannel</a>({xi + 1, yi},     c, wrapMode),
                           <a href="#Image::GetChannel" class="code">GetChannel</a>({xi,     yi + 1}, c, wrapMode),
                           <a href="#Image::GetChannel" class="code">GetChannel</a>({xi + 1, yi + 1}, c, wrapMode)};
return ((1 - dx) * (1 - dy) * v[0] + dx * (1 - dy) * v[1] +
        (1 - dx) *      dy  * v[2] + dx *      dy  * v[3]);</div><p>


</p>
<p>The <tt>SetChannel()</tt> method, the implementation of which is not included
in the book, sets the value of a channel in a specified pixel.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-6"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-5"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-7"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="Image::SetChannel"></span>SetChannel(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p, int c, Float value);</div><p>


</p>
<p>

</p>
<p>A few methods return multiple pixel channel values all at once.  Doing so
can be more efficient than repeatedly calling methods like
<tt>GetChannel()</tt> or <tt>BilerpChannel()</tt>, as various common
computations like handling the <tt>wrapMode</tt> can be done just once.

</p>
<p><tt>GetChannels()</tt> returns all the channel values for a given pixel
all at once.  (There are also <tt>LookupNearest()</tt> and <tt>Bilerp()</tt>
methods that similarly perform the corresponding lookup on all channels and
return the result using <tt>ImageChannelValues</tt>.)

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-7"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-6"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-8"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">ImageChannelValues <span class="anchor" id="Image::GetChannels"></span>GetChannels(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p,
                               WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;</div><p>


</p>
<p><tt>GetChannels()</tt> returns the channel values using an instance of the
<tt>ImageChannelValues</tt><span class="anchor" id="ImageChannelValues"></span> class, the
definition of which is not included here.  <tt>ImageChannelValues</tt> can be
operated on more or less as if it were a <tt>std::vector</tt>, though it is
based on the <a href="../Utilities/Containers_and_Memory_Management.html#InlinedVector"><tt>InlinedVector</tt></a> class that was described in
Section&nbsp;<a href="../Utilities/Containers_and_Memory_Management.html#sec:containers">B.4</a>.  It is thus able to avoid the cost of the
dynamic memory allocations that <tt>std::vector</tt> would otherwise require
if a small number of channel values were being returned.

</p>
<p>It is also possible to specify a particular subset of the channels for
these sorts of operations.  <tt>GetChannelDesc()</tt> takes one or more image
channel names and returns an instance of the <tt>ImageChannelDesc</tt><span class="anchor" id="ImageChannelDesc"></span>
class.  This class is opaque to the caller, but tracks which channel index
each of the requested channels corresponds to.  It includes an
<tt>operator bool()</tt> method that can be called to check whether the
requested channels were in fact present in the image.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-8"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-7"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-9"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">ImageChannelDesc <span class="anchor" id="Image::GetChannelDesc"></span>GetChannelDesc(
    pstd::span&lt;const std::string&gt; channels) const;</div><p>


</p>
<p>

</p>
<p>All the methods that we have seen in this section also have variants
that take an <tt>ImageChannelDesc</tt> and then return values for just the
specified channels, in the order they were requested in the call to
<tt>GetChannelDesc()</tt>.  Here is the one for <tt>GetChannels()</tt>:

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-9"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-8"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-10"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">ImageChannelValues GetChannels(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> p, const ImageChannelDesc &amp;desc,
                               WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#Image-WideOperations"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="Image-WideOperations"></span><h3>B.5.2  Image-Wide Operations</h3><p>


</p>
<p>The <tt>Image</tt> class also provides a number of operations that operate on
the entire image, again agnostic to the semantics of the values an
image stores.

</p>
<p><tt>SelectChannels()</tt> returns a new image that includes only the
specified channels of the original image, and <tt>Crop()</tt> returns an image
that contains the specified subset of pixels of the original.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-10"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-9"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-11"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="#Image" class="code">Image</a> <span class="anchor" id="Image::SelectChannels"></span>SelectChannels(const ImageChannelDesc &amp;desc,
                     Allocator alloc = {}) const;
<a href="#Image" class="code">Image</a> <span class="anchor" id="Image::Crop"></span>Crop(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> &amp;bounds, Allocator alloc = {}) const;</div><p>


</p>
<p><tt>CopyRectOut()</tt> and <tt>CopyRectIn()</tt> copy the specified rectangular
regions of the image to and from the provided buffers.  For some
performance-sensitive image processing operations, it is helpful to incur
the overhead of converting the in-memory image format to <tt>float</tt>s just
once so that subsequent operations can operate directly on <tt>float</tt>
values.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-11"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-10"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-12"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="Image::CopyRectOut"></span>CopyRectOut(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> &amp;extent, pstd::span&lt;float&gt; buf,
                 WrapMode2D wrapMode = WrapMode::<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>) const;
void <span class="anchor" id="Image::CopyRectIn"></span>CopyRectIn(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> &amp;extent, pstd::span&lt;const float&gt; buf);</div><p>


</p>
<p>

</p>
<p>A number of methods compute aggregate statistics about the image.
<tt>Average()</tt> returns the average value of each specified channel across
the entire image.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-12"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-11"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-13"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">ImageChannelValues <span class="anchor" id="Image::Average"></span>Average(const ImageChannelDesc &amp;desc) const;</div><p>


</p>
<p>Two methods respectively check for pixels with infinite or not-a-number
values.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-13"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-12"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-14"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="Image::HasAnyInfinitePixels"></span>HasAnyInfinitePixels() const;
bool <span class="anchor" id="Image::HasAnyNaNPixels"></span>HasAnyNaNPixels() const;</div><p>


</p>
<p>

</p>
<p>Three methods measure error, comparing the image to a provided reference
image, which should have the same resolution and named channels.  Each
takes a set of channels to include in the error computation and
returns the error with respect to the specified metric.  Optionally, they
return an <tt>Image</tt> where each pixel stores its error.

</p>
<p><tt>MAE()</tt> computes mean absolute error&mdash;the absolute value of the
difference with the reference image.  <tt>MSE()</tt> computes mean squared
error, and <tt>MRSE()</tt> computes mean relative squared error, which is
based on dividing the squared error by the reference value.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-14"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-13"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-15"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">ImageChannelValues <span class="anchor" id="Image::MAE"></span>MAE(const ImageChannelDesc &amp;desc, const <a href="#Image" class="code">Image</a> &amp;ref,
                       <a href="#Image" class="code">Image</a> *errorImage = nullptr) const;
ImageChannelValues <span class="anchor" id="Image::MSE"></span>MSE(const ImageChannelDesc &amp;desc, const <a href="#Image" class="code">Image</a> &amp;ref,
                       <a href="#Image" class="code">Image</a> *mseImage = nullptr) const;
ImageChannelValues <span class="anchor" id="Image::MRSE"></span>MRSE(const ImageChannelDesc &amp;desc, const <a href="#Image" class="code">Image</a> &amp;ref,
                        <a href="#Image" class="code">Image</a> *mrseImage = nullptr) const;</div><p>


</p>
<p>

</p>
<p>Finally, <tt>GetSamplingDistribution()</tt> returns a 2D array of scalar
weights for use in importance sampling.  The weights are not normalized,
but are suitable to be directly passed to the <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D"><tt>PiecewiseConstant2D</tt></a>
class&rsquo;s constructor.  The caller can optionally specify the domain of the
image as well as a function that returns a change of variables factor if
the final sampling domain is not uniform and over <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket squared</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="393" y="513"></use>
</g>
</g>
</svg>.  This factor is then included
in the sampling distribution.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-15"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-14"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-16"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">template &lt;typename F&gt;
<a href="../Utilities/Containers_and_Memory_Management.html#Array2D" class="code">Array2D</a>&lt;Float&gt; <span class="anchor" id="Image::GetSamplingDistribution"></span>GetSamplingDistribution(
    F dxdA, const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a> &amp;domain = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0, 0), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(1, 1)),
    Allocator alloc = {});
<a href="../Utilities/Containers_and_Memory_Management.html#Array2D" class="code">Array2D</a>&lt;Float&gt; GetSamplingDistribution() {
    return GetSamplingDistribution([](<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>) { return Float(1); });
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#ReadingandWritingImages"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:image-read-write"></span><span id="ReadingandWritingImages"></span><h3>B.5.3  Reading and Writing Images</h3><p>



</p>
<p>
Many image file formats have been developed over the years and it is
worthwhile to support a variety of them, especially for the convenience of
scene specification.  <tt>pbrt</tt> is able to read a variety of other image
formats, including JPG, TGA, BMP, GIF, PFM, HDR, and
OpenEXR.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="<tt>pbrt</tt>&rsquo;s PNG support is provided by Lode Vandevenne&rsquo;s
<em>lodepng</em> library, PFM support is thanks to code from Jiawen Chen,
and JPG, TGA, BMP, GIF, and HDR are thanks to Sean
Barrett&rsquo;s <em>stb_image.h</em> library.">
      <sup>&dagger;</sup>
    </button>
		

</p>
<p>For <tt>pbrt</tt>&rsquo;s image output requirements, we are mainly interested in those
that support imagery represented by floating-point pixel values.  In
particular, the images generated by <tt>pbrt</tt> will often have a large dynamic
range; such formats are crucial for being able to store the computed
radiance values directly.  Legacy image file formats that
store 8 bits of data for red, green, and blue components to represent
colors in the range <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.653ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2003.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="1724" y="0"></use>
</g>
</svg> are not a good fit for physically based
rendering.

</p>
<p><tt>pbrt</tt> supports reading and writing two floating-point image file formats:
OpenEXR and PFM.  (Support for both reading and writing PNGs is also provided, though that
format has limited dynamic range.)  OpenEXR is a floating-point file format
originally designed at Industrial Light and Magic for use in movie
productions (<a href="Further_Reading.html#cite:Kainz04">Kainz et al. 2004</a>).  We chose this format because it has a clean
design, is easy to use, and has first-class support for floating-point
image data.  Libraries that read and write OpenEXR images are freely
available, and support for the format is available in many other tools.

</p>
<p>PFM is a floating-point format based on an extension to the PPM file
format; it is very easily read and written, though it is not as widely
supported as OpenEXR.  Unlike OpenEXR, it does not support compression, so
files may be fairly large.

</p>
<p>

</p>
<p>The <a href="#Image"><tt>Image</tt></a> <tt>Read()</tt> method attempts to read an image from the
given file.  It uses the suffix at the end of the filename to determine
which image file format reader to use.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-16"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-15"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImagePublicMethods-17"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">static ImageAndMetadata <span class="anchor" id="Image::Read"></span>Read(std::string filename, Allocator alloc = {},
                             <a href="#ColorEncoding" class="code">ColorEncoding</a> encoding = nullptr);</div><p>


</p>
<p><tt>Image::Read()</tt> returns an instance of the <tt>ImageAndMetadata</tt>
structure.  In the event of an error reading the image, it issues an error
message and exits immediately, so no error handling is required of the
caller.

</p>
<p></p>
<span class="anchor" id="fragment-ImageAndMetadataDefinition-0"></span><div class="fragmentname">&lt;&lt;ImageAndMetadata Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct <span class="anchor" id="ImageAndMetadata"></span>ImageAndMetadata {
    <a href="#Image" class="code">Image</a> <span class="anchor" id="ImageAndMetadata::image"></span>image;
    ImageMetadata <span class="anchor" id="ImageAndMetadata::metadata"></span>metadata;
};</div><p>


</p>
<p>Some image formats can store additional metadata beyond the pixel values;
<tt>ImageMetadata</tt> is <tt>pbrt</tt>&rsquo;s container for this information.  OpenEXR is
particularly flexible in this regard: the user is free to add arbitrary
named metadata using a variety of data types.

</p>
<p></p>
<span class="anchor" id="fragment-ImageMetadataDefinition-0"></span><div class="fragmentname">&lt;&lt;ImageMetadata Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct <span class="anchor" id="ImageMetadata"></span>ImageMetadata {
   &lt;&lt;<span class="fragmentname">ImageMetadata Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2777" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2777"><i></i></a><div id="fragbit-2777" class="collapse"><div class="fragmentcode">      const <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBColorSpace" class="code">RGBColorSpace</a> *GetColorSpace() const;
      </div></div>
   &lt;&lt;<span class="fragmentname"><a href="#fragment-ImageMetadataPublicMembers-0">ImageMetadata Public Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2778" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2778"><i></i></a><div id="fragbit-2778" class="collapse"><div class="fragmentcode">      pstd::optional&lt;float&gt; renderTimeSeconds;
      pstd::optional&lt;<a href="../Utilities/Mathematical_Infrastructure.html#SquareMatrix" class="code">SquareMatrix</a>&lt;4&gt;&gt; cameraFromWorld, NDCFromWorld;
      pstd::optional&lt;<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>&gt; pixelBounds;
      pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>&gt; fullResolution;
      pstd::optional&lt;int&gt; samplesPerPixel;
      pstd::optional&lt;const <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBColorSpace" class="code">RGBColorSpace</a> *&gt; colorSpace;
      </div></div>
};</div><p>


</p>
<p>If the image has the corresponding metadata, <tt>pbrt</tt>&rsquo;s image reading routines
initialize the following fields.

</p>
<p></p>
<span class="anchor" id="fragment-ImageMetadataPublicMembers-0"></span><div class="fragmentname">&lt;&lt;ImageMetadata Public Members&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::optional&lt;float&gt; <span class="anchor" id="ImageMetadata::renderTimeSeconds"></span>renderTimeSeconds;
pstd::optional&lt;<a href="../Utilities/Mathematical_Infrastructure.html#SquareMatrix" class="code">SquareMatrix</a>&lt;4&gt;&gt; <span class="anchor" id="ImageMetadata::cameraFromWorld"></span>cameraFromWorld, <span class="anchor" id="ImageMetadata::NDCFromWorld"></span>NDCFromWorld;
pstd::optional&lt;<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>&gt; <span class="anchor" id="ImageMetadata::pixelBounds"></span>pixelBounds;
pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>&gt; <span class="anchor" id="ImageMetadata::fullResolution"></span>fullResolution;
pstd::optional&lt;int&gt; <span class="anchor" id="ImageMetadata::samplesPerPixel"></span>samplesPerPixel;
pstd::optional&lt;const <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBColorSpace" class="code">RGBColorSpace</a> *&gt; <span class="anchor" id="ImageMetadata::colorSpace"></span>colorSpace;
</div><p>


</p>
<p>

</p>
<p>The <tt>Write()</tt> method writes an image in one of the supported formats,
based on the extension of the filename passed to it.  It stores as much
of the provided metadata as possible given the image format used.

</p>
<p></p>
<span class="anchor" id="fragment-ImagePublicMethods-17"></span><div class="fragmentname">&lt;&lt;Image Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImagePublicMethods-16"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="Image::Write"></span>Write(std::string name, const ImageMetadata &amp;metadata = {}) const;</div><p>


</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#ResizingImages"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="ResizingImages"></span><h3>B.5.4  Resizing Images</h3><p>


</p>
<p>Image resizing involves application of the sampling and reconstruction
theory from Chapter&nbsp;<a href="../Sampling_and_Reconstruction.html#chap:sampling-reconstruction">8</a>: we have an image
function that has been sampled at one sampling rate, and we would like to
reconstruct a continuous image function from the original samples to
resample at a new set of sample positions.  In this section, we will discuss
the <tt>Image</tt>&rsquo;s <tt>FloatResizeUp()</tt> method, which resamples an image to
a higher resolution.  Because this represents an increase in the sampling
rate from the original rate, we do not have to worry about introducing
aliasing due to undersampling high-frequency components in this step; we
only need to reconstruct and directly resample the new function.
Figure&nbsp;<a href="#fig:texture-magnify-resample">B.6</a> illustrates this task in&nbsp;1D.

</p>
<p></p>
<span class="anchor" id="fig:texture-magnify-resample"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="phabbf06.svg" title=""><img src="phabbf06.svg" width=455 height=152 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure B.6: <span class="legend"> To increase an image&rsquo;s
resolution, the <a href="#Image"><tt>Image</tt></a> class performs two 1D resampling
steps with a separable reconstruction filter.  (a)&nbsp;A 1D function
reconstructed from four samples, denoted by dots.  (b)&nbsp;To represent the same
image function with more samples, we only need to reconstruct the
continuous function and evaluate it at the new positions.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>
A separable reconstruction filter is used for this task; recall from
Section&nbsp;<a href="../Sampling_and_Reconstruction/Image_Reconstruction.html#sec:image-reconstruction">8.8</a> that separable filters can be
written as the product of 1D filters: <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="18.348ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 7899.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f left-parenthesis x comma y right-parenthesis equals f left-parenthesis x right-parenthesis f left-parenthesis y right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="552" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="942" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1514" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1959" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2450" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3117" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="4173" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="4726" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="5115" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5688" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="6077" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6630" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="7019" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="7510" y="0"></use>
</g>
</svg>.  One advantage
of a separable filter is that if we are using one to resample an
image from one resolution <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.312ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2287.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1897" y="0"></use>
</g>
</svg> to another <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.115ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3063.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x prime comma y prime right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
<g transform="translate(389,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="809" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1350" y="0"></use>
<g transform="translate(1795,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="693" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2673" y="0"></use>
</g>
</svg>, then we can
implement the resampling as two 1D resampling steps, first resampling in
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> to create an image of resolution <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.214ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2675.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x prime comma y right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
<g transform="translate(389,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="809" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1350" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1795" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2285" y="0"></use>
</g>
</svg> and then resampling that
image to create the final image of resolution <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.115ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3063.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x prime comma y prime right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
<g transform="translate(389,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="809" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1350" y="0"></use>
<g transform="translate(1795,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="693" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2673" y="0"></use>
</g>
</svg>.  Resampling the
image via two 1D steps in this manner simplifies implementation and makes
the number of pixels accessed for each pixel in the final image a linear
function of the filter width, rather than a quadratic one.

</p>
<p>Reconstructing the original image function and sampling it at a new pixel&rsquo;s
position are mathematically equivalent to centering the reconstruction
filter kernel at the new pixel&rsquo;s position and weighting the nearby pixels
in the original image appropriately.  Thus, each new pixel is a weighted
average of a small number of pixels in the original image.

</p>
<p>The <a href="#Image::ResampleWeights"><tt>Image::ResampleWeights()</tt></a> method utility determines which original
pixels contribute to each new pixel and what the values are of the
contribution weights for each new pixel.  It returns the values in an array
of <a href="#ResampleWeight"><tt>ResampleWeight</tt></a> structures for all the pixels in a 1D row or
column of the image.  Because this information is the same for all rows of
the image when resampling in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> and all columns when resampling in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg>,
it is more efficient to compute it once for each of the two passes and then
reuse it many times for each one.

</p>
<p>For the reconstruction filter used here, no more than four of the original
pixels will contribute to each new pixel after resizing, so
<a href="#ResampleWeight"><tt>ResampleWeight</tt></a> only needs to hold four weights.  Because the four
pixels are contiguous, we only store the offset to the first one.

</p>
<p></p>
<span class="anchor" id="fragment-ResampleWeightDefinition-0"></span><div class="fragmentname">&lt;&lt;ResampleWeight Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct <span class="anchor" id="ResampleWeight"></span>ResampleWeight {
    int <span class="anchor" id="ResampleWeight::firstPixel"></span>firstPixel;
    Float <span class="anchor" id="ResampleWeight::weight"></span>weight[4]; 
};</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-ImageMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;Image Method Definitions&gt;&gt;=&nbsp;<a href="#fragment-ImageMethodDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">std::vector&lt;ResampleWeight&gt; <span class="anchor" id="Image::ResampleWeights"></span><a href="#Image" class="code">Image</a>::ResampleWeights(int oldRes, int newRes) {
    std::vector&lt;ResampleWeight&gt; wt(newRes);
    Float filterRadius = 2, tau = 2;
    for (int i = 0; i &lt; newRes; ++i) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Computeimageresamplingweightsformonoithpixel-0">Compute image resampling weights for <tt>i</tt>th pixel</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2779" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2779"><i></i></a><div id="fragbit-2779" class="collapse"><div class="fragmentcode">           Float center = (i + .5f) * oldRes / newRes;
           wt[i].firstPixel = pstd::floor((center - filterRadius) + 0.5f);
           for (int j = 0; j &lt; 4; ++j) {
               Float pos = wt[i].firstPixel + j + .5f;
               wt[i].weight[j] = <a href="../Sampling_and_Reconstruction/Image_Reconstruction.html#WindowedSinc" class="code">WindowedSinc</a>(pos - center, filterRadius, tau);
           }</div></div>
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Normalizefilterweightsforpixelresampling-0">Normalize filter weights for pixel resampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2780" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2780"><i></i></a><div id="fragbit-2780" class="collapse"><div class="fragmentcode">           Float invSumWts = 1 / (wt[i].weight[0] + wt[i].weight[1] +
                                  wt[i].weight[2] + wt[i].weight[3]);
           for (int j = 0; j &lt; 4; ++j)
               wt[i].weight[j] *= invSumWts;</div></div>
    }
    return wt;
}</div><p>


</p>
<p>Here is another instance where it is important to distinguish between
discrete and continuous pixel coordinates.  For each pixel in the resampled
image, this function starts by computing its continuous coordinates in
terms of the source image&rsquo;s pixel coordinates.  This value is stored in <tt>center</tt>,
because it is the center of the reconstruction filter for the new pixel.
Next, it is necessary to find the offset to the first pixel that
contributes to the new pixel.  This is a slightly tricky
calculation&mdash;after subtracting the filter width to find the start of the
filter&rsquo;s nonzero range, it is necessary to add an extra <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.5</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="779" y="0"></use>
</g>
</svg> offset to the
continuous coordinate before taking the floor to find the discrete
coordinate.  Figure&nbsp;<a href="#fig:resamp-half-offset">B.7</a> illustrates why this
offset is needed.

</p>
<p></p>
<span class="anchor" id="fig:resamp-half-offset"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="phabbf07.svg" title=""><img src="phabbf07.svg" width=504 height=113 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure B.7: <span class="legend"> The computation to find the first
pixel inside a reconstruction filter&rsquo;s support is slightly tricky.
Consider a filter centered around continuous coordinate 2.75 with radius 2,
as shown here.  The filter&rsquo;s support covers the range <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.596ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4562.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0.75 comma 4.75 right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-37" d="M485 644c0 -21 0 -23 -9 -35l-135 -190c-44 -62 -58 -148 -62 -171c-8 -54 -11 -109 -11 -164v-51c0 -10 0 -55 -46 -55s-46 45 -46 55c0 102 33 241 123 376l112 158h-207c-13 0 -91 0 -98 -6c-13 -12 -22 -75 -25 -91h-25l33 206h25c4 -19 6 -32 128 -32h243Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2058" y="0"></use>
<g transform="translate(2503,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-34"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="4283" y="0"></use>
</g>
</svg>,
although pixel zero is outside the filter&rsquo;s support: adding <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.5</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="779" y="0"></use>
</g>
</svg> to the
lower end before taking the floor to find the discrete pixel gives the
correct starting pixel, number one.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Starting from that first contributing pixel, this function loops over four
pixels, computing each one&rsquo;s offset to the center of the filter kernel and the
corresponding filter weight.

</p>
<p></p>
<span class="anchor" id="fragment-Computeimageresamplingweightsformonoithpixel-0"></span><div class="fragmentname">&lt;&lt;Compute image resampling weights for <tt>i</tt>th pixel&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float center = (i + .5f) * oldRes / newRes;
wt[i].firstPixel = pstd::floor((center - filterRadius) + 0.5f);
for (int j = 0; j &lt; 4; ++j) {
    Float pos = wt[i].firstPixel + j + .5f;
    wt[i].weight[j] = <a href="../Sampling_and_Reconstruction/Image_Reconstruction.html#WindowedSinc" class="code">WindowedSinc</a>(pos - center, filterRadius, tau);
}</div><p>


</p>
<p>The four filter weights generally do not sum to one.  Therefore, to ensure
that the resampled image will not be any brighter or darker than the original
image, the weights are normalized here.

</p>
<p></p>
<span class="anchor" id="fragment-Normalizefilterweightsforpixelresampling-0"></span><div class="fragmentname">&lt;&lt;Normalize filter weights for pixel resampling&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float invSumWts = 1 / (wt[i].weight[0] + wt[i].weight[1] +
                       wt[i].weight[2] + wt[i].weight[3]);
for (int j = 0; j &lt; 4; ++j)
    wt[i].weight[j] *= invSumWts;</div><p>


</p>
<p>Given <tt>ResampleWeights()</tt>, we can continue to <tt>FloatResizeUp()</tt>,
which resizes an image to a higher resolution and returns the result, with
pixels stored as <tt>Float</tt>s in memory, regardless of the input image
format.

</p>
<p></p>
<span class="anchor" id="fragment-ImageMethodDefinitions-1"></span><div class="fragmentname">&lt;&lt;Image Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-ImageMethodDefinitions-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImageMethodDefinitions-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="#Image" class="code">Image</a> <span class="anchor" id="Image::FloatResizeUp"></span><a href="#Image" class="code">Image</a>::FloatResizeUp(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> newRes, WrapMode2D wrapMode) const {
    <a href="#Image" class="code">Image</a> resampledImage(PixelFormat::Float, newRes, <a href="#Image::channelNames" class="code">channelNames</a>);
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Computexandyresamplingweightsforimageresizing-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> resampling weights for image resizing</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2781" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2781"><i></i></a><div id="fragbit-2781" class="collapse"><div class="fragmentcode">       std::vector&lt;ResampleWeight&gt; xWeights, yWeights;
       xWeights = <a href="#Image::ResampleWeights" class="code">ResampleWeights</a>(<a href="#Image::resolution" class="code">resolution</a>[0], newRes[0]);
       yWeights = <a href="#Image::ResampleWeights" class="code">ResampleWeights</a>(<a href="#Image::resolution" class="code">resolution</a>[1], newRes[1]);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Resizeimageinparallelworkingbytiles-0">Resize image in parallel, working by tiles</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2782" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2782"><i></i></a><div id="fragbit-2782" class="collapse"><div class="fragmentcode">       <a href="../Utilities/Parallelism.html#ParallelFor2D" class="code">ParallelFor2D</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>({0, 0}, newRes), [&amp;](<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> outExtent) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-DetermineextentinsourceimageandcopypixelvaluestomonoinBuf-0">Determine extent in source image and copy pixel values to <tt>inBuf</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2783" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2783"><i></i></a><div id="fragbit-2783" class="collapse"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> inExtent(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(xWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x].firstPixel,
                                        yWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y].firstPixel),
                                <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(xWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - 1].firstPixel + 4,
                                        yWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - 1].firstPixel + 4));
              std::vector&lt;float&gt; inBuf(<a href="#Image::NChannels" class="code">NChannels</a>() * inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::Area" class="code">Area</a>());
              <a href="#Image::CopyRectOut" class="code">CopyRectOut</a>(inExtent, pstd::span&lt;float&gt;(inBuf), wrapMode);</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Resizeimageinthexdimension-0">Resize image in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> dimension</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2784" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2784"><i></i></a><div id="fragbit-2784" class="collapse"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeimageextentsandallocatemonoxBuf-0">Compute image extents and allocate <tt>xBuf</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2785" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2785"><i></i></a><div id="fragbit-2785" class="collapse"><div class="fragmentcode">                 int nxOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
                 int nyOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
                 int nxIn = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
                 int nyIn = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
                 std::vector&lt;float&gt; xBuf(<a href="#Image::NChannels" class="code">NChannels</a>() * nyIn * nxOut);</div></div>
              int xBufOffset = 0;
              for (int yOut = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y; yOut &lt; inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y; ++yOut) {
                  for (int xOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x; xOut &lt; outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x; ++xOut) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-ResampleimagepixelmonoxOutyOut-0">Resample image pixel <tt>(xOut, yOut)</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2786" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2786"><i></i></a><div id="fragbit-2786" class="collapse"><div class="fragmentcode">                         const ResampleWeight &amp;rsw = xWeights[xOut];
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputemonoinOffsetintomonoinBufformonoxOutyOut-0">Compute <tt>inOffset</tt> into <tt>inBuf</tt> for <tt>(xOut, yOut)</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2787" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2787"><i></i></a><div id="fragbit-2787" class="collapse"><div class="fragmentcode">                            int xIn = rsw.firstPixel - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
                            int yIn = yOut - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
                            int inOffset = <a href="#Image::NChannels" class="code">NChannels</a>() * (xIn + yIn * nxIn);
                            </div></div>
                         for (int c = 0; c &lt; <a href="#Image::NChannels" class="code">NChannels</a>(); ++c, ++xBufOffset, ++inOffset)
                             xBuf[xBufOffset] = rsw.weight[0] * inBuf[inOffset] +
                                                rsw.weight[1] * inBuf[inOffset + <a href="#Image::NChannels" class="code">NChannels</a>()] +
                                                rsw.weight[2] * inBuf[inOffset + 2 * <a href="#Image::NChannels" class="code">NChannels</a>()] +
                                                rsw.weight[3] * inBuf[inOffset + 3 * <a href="#Image::NChannels" class="code">NChannels</a>()];</div></div>
                  }
              }</div></div>
           &lt;&lt;<span class="fragmentname">Resize image in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> dimension</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2788" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2788"><i></i></a><div id="fragbit-2788" class="collapse"><div class="fragmentcode">              std::vector&lt;float&gt; outBuf(NChannels() * nxOut * nyOut);
              for (int x = 0; x &lt; nxOut; ++x) {
                  for (int y = 0; y &lt; nyOut; ++y) {
                      int yOut = y + outExtent[0][1];
                      DCHECK(yOut &gt;= 0 &amp;&amp; yOut &lt; yWeights.size());
                      const ResampleWeight &amp;rsw = yWeights[yOut];
              
                      DCHECK_GE(rsw.firstPixel - inExtent[0][1], 0);
                      int xBufOffset =
                          NChannels() * (x + nxOut * (rsw.firstPixel - inExtent[0][1]));
                      DCHECK_GE(xBufOffset, 0);
                      int step = NChannels() * nxOut;
                      DCHECK_LT(xBufOffset + 3 * step, xBuf.size());
              
                      int outOffset = NChannels() * (x + y * nxOut);
                      for (int c = 0; c &lt; NChannels(); ++c, ++outOffset, ++xBufOffset)
                          outBuf[outOffset] =
                              std::max&lt;Float&gt;(0, (rsw.weight[0] * xBuf[xBufOffset] +
                                                  rsw.weight[1] * xBuf[xBufOffset + step] +
                                                  rsw.weight[2] * xBuf[xBufOffset + 2 * step] +
                                                  rsw.weight[3] * xBuf[xBufOffset + 3 * step]));
                  }
              }</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-CopyresampledimagepixelsoutintomonoresampledImage-0">Copy resampled image pixels out into <tt>resampledImage</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2789" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2789"><i></i></a><div id="fragbit-2789" class="collapse"><div class="fragmentcode">              resampledImage.<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(outExtent, outBuf);</div></div>
       });</div></div>
    return resampledImage;
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Computexandyresamplingweightsforimageresizing-0"></span><div class="fragmentname">&lt;&lt;Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> resampling weights for image resizing&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">std::vector&lt;ResampleWeight&gt; xWeights, yWeights;
xWeights = <a href="#Image::ResampleWeights" class="code">ResampleWeights</a>(<a href="#Image::resolution" class="code">resolution</a>[0], newRes[0]);
yWeights = <a href="#Image::ResampleWeights" class="code">ResampleWeights</a>(<a href="#Image::resolution" class="code">resolution</a>[1], newRes[1]);</div><p>


</p>
<p>Given filter weights, the image is resized in parallel, where threads work
on tiles of the output image.  Although this parallelism scheme leads
to some redundant work among threads  from the need to compute extra pixel
values at the boundaries of tiles, it has the advantage that the second
filtering operation in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> has a more compact memory access pattern, which
gives a performance benefit from better cache coherence.

</p>
<p></p>
<span class="anchor" id="fragment-Resizeimageinparallelworkingbytiles-0"></span><div class="fragmentname">&lt;&lt;Resize image in parallel, working by tiles&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Utilities/Parallelism.html#ParallelFor2D" class="code">ParallelFor2D</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>({0, 0}, newRes), [&amp;](<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> outExtent) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-DetermineextentinsourceimageandcopypixelvaluestomonoinBuf-0">Determine extent in source image and copy pixel values to <tt>inBuf</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2790" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2790"><i></i></a><div id="fragbit-2790" class="collapse"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> inExtent(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(xWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x].firstPixel,
                                 yWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y].firstPixel),
                         <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(xWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - 1].firstPixel + 4,
                                 yWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - 1].firstPixel + 4));
       std::vector&lt;float&gt; inBuf(<a href="#Image::NChannels" class="code">NChannels</a>() * inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::Area" class="code">Area</a>());
       <a href="#Image::CopyRectOut" class="code">CopyRectOut</a>(inExtent, pstd::span&lt;float&gt;(inBuf), wrapMode);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Resizeimageinthexdimension-0">Resize image in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> dimension</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2791" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2791"><i></i></a><div id="fragbit-2791" class="collapse"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeimageextentsandallocatemonoxBuf-0">Compute image extents and allocate <tt>xBuf</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2792" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2792"><i></i></a><div id="fragbit-2792" class="collapse"><div class="fragmentcode">          int nxOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
          int nyOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
          int nxIn = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
          int nyIn = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
          std::vector&lt;float&gt; xBuf(<a href="#Image::NChannels" class="code">NChannels</a>() * nyIn * nxOut);</div></div>
       int xBufOffset = 0;
       for (int yOut = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y; yOut &lt; inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y; ++yOut) {
           for (int xOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x; xOut &lt; outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x; ++xOut) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-ResampleimagepixelmonoxOutyOut-0">Resample image pixel <tt>(xOut, yOut)</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2793" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2793"><i></i></a><div id="fragbit-2793" class="collapse"><div class="fragmentcode">                  const ResampleWeight &amp;rsw = xWeights[xOut];
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputemonoinOffsetintomonoinBufformonoxOutyOut-0">Compute <tt>inOffset</tt> into <tt>inBuf</tt> for <tt>(xOut, yOut)</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2794" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2794"><i></i></a><div id="fragbit-2794" class="collapse"><div class="fragmentcode">                     int xIn = rsw.firstPixel - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
                     int yIn = yOut - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
                     int inOffset = <a href="#Image::NChannels" class="code">NChannels</a>() * (xIn + yIn * nxIn);
                     </div></div>
                  for (int c = 0; c &lt; <a href="#Image::NChannels" class="code">NChannels</a>(); ++c, ++xBufOffset, ++inOffset)
                      xBuf[xBufOffset] = rsw.weight[0] * inBuf[inOffset] +
                                         rsw.weight[1] * inBuf[inOffset + <a href="#Image::NChannels" class="code">NChannels</a>()] +
                                         rsw.weight[2] * inBuf[inOffset + 2 * <a href="#Image::NChannels" class="code">NChannels</a>()] +
                                         rsw.weight[3] * inBuf[inOffset + 3 * <a href="#Image::NChannels" class="code">NChannels</a>()];</div></div>
           }
       }</div></div>
    &lt;&lt;<span class="fragmentname">Resize image in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> dimension</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2795" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2795"><i></i></a><div id="fragbit-2795" class="collapse"><div class="fragmentcode">       std::vector&lt;float&gt; outBuf(NChannels() * nxOut * nyOut);
       for (int x = 0; x &lt; nxOut; ++x) {
           for (int y = 0; y &lt; nyOut; ++y) {
               int yOut = y + outExtent[0][1];
               DCHECK(yOut &gt;= 0 &amp;&amp; yOut &lt; yWeights.size());
               const ResampleWeight &amp;rsw = yWeights[yOut];
       
               DCHECK_GE(rsw.firstPixel - inExtent[0][1], 0);
               int xBufOffset =
                   NChannels() * (x + nxOut * (rsw.firstPixel - inExtent[0][1]));
               DCHECK_GE(xBufOffset, 0);
               int step = NChannels() * nxOut;
               DCHECK_LT(xBufOffset + 3 * step, xBuf.size());
       
               int outOffset = NChannels() * (x + y * nxOut);
               for (int c = 0; c &lt; NChannels(); ++c, ++outOffset, ++xBufOffset)
                   outBuf[outOffset] =
                       std::max&lt;Float&gt;(0, (rsw.weight[0] * xBuf[xBufOffset] +
                                           rsw.weight[1] * xBuf[xBufOffset + step] +
                                           rsw.weight[2] * xBuf[xBufOffset + 2 * step] +
                                           rsw.weight[3] * xBuf[xBufOffset + 3 * step]));
           }
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-CopyresampledimagepixelsoutintomonoresampledImage-0">Copy resampled image pixels out into <tt>resampledImage</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2796" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2796"><i></i></a><div id="fragbit-2796" class="collapse"><div class="fragmentcode">       resampledImage.<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(outExtent, outBuf);</div></div>
});</div><p>


</p>
<p>The first step copies all the pixel values that will be needed from the
source image to compute the pixels in <tt>outExtent</tt> into a local buffer,
<tt>inBuf</tt>.  There are two reasons for doing this (versus accessing pixel
values as needed from the input image): first, <tt>CopyRectOut()</tt> is
generally more efficient than accessing the pixel channel values
individually since not only are boundary conditions handled just once, but
any necessary format conversion to <tt>Float</tt> is also done once for each
pixel channel and in bulk.  Second, the pixel channel values that will be
accessed for subsequent filtering computations end up being contiguous in
memory, which also improves cache coherence.

</p>
<p></p>
<span class="anchor" id="fragment-DetermineextentinsourceimageandcopypixelvaluestomonoinBuf-0"></span><div class="fragmentname">&lt;&lt;Determine extent in source image and copy pixel values to <tt>inBuf</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a> inExtent(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(xWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x].firstPixel,
                          yWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y].firstPixel),
                  <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(xWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - 1].firstPixel + 4,
                          yWeights[outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - 1].firstPixel + 4));
std::vector&lt;float&gt; inBuf(<a href="#Image::NChannels" class="code">NChannels</a>() * inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::Area" class="code">Area</a>());
<a href="#Image::CopyRectOut" class="code">CopyRectOut</a>(inExtent, pstd::span&lt;float&gt;(inBuf), wrapMode);</div><p>


</p>
<p>After allocating a temporary buffer for the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>-resampled image, the
following loops iterate over all its pixels to compute their resampled
channel values.

</p>
<p></p>
<span class="anchor" id="fragment-Resizeimageinthexdimension-0"></span><div class="fragmentname">&lt;&lt;Resize image in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> dimension&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeimageextentsandallocatemonoxBuf-0">Compute image extents and allocate <tt>xBuf</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2797" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2797"><i></i></a><div id="fragbit-2797" class="collapse"><div class="fragmentcode">   int nxOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
   int nyOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
   int nxIn = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
   int nyIn = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
   std::vector&lt;float&gt; xBuf(<a href="#Image::NChannels" class="code">NChannels</a>() * nyIn * nxOut);</div></div>
int xBufOffset = 0;
for (int yOut = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y; yOut &lt; inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y; ++yOut) {
    for (int xOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x; xOut &lt; outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x; ++xOut) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-ResampleimagepixelmonoxOutyOut-0">Resample image pixel <tt>(xOut, yOut)</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2798" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2798"><i></i></a><div id="fragbit-2798" class="collapse"><div class="fragmentcode">           const ResampleWeight &amp;rsw = xWeights[xOut];
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputemonoinOffsetintomonoinBufformonoxOutyOut-0">Compute <tt>inOffset</tt> into <tt>inBuf</tt> for <tt>(xOut, yOut)</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2799" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2799"><i></i></a><div id="fragbit-2799" class="collapse"><div class="fragmentcode">              int xIn = rsw.firstPixel - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
              int yIn = yOut - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
              int inOffset = <a href="#Image::NChannels" class="code">NChannels</a>() * (xIn + yIn * nxIn);
              </div></div>
           for (int c = 0; c &lt; <a href="#Image::NChannels" class="code">NChannels</a>(); ++c, ++xBufOffset, ++inOffset)
               xBuf[xBufOffset] = rsw.weight[0] * inBuf[inOffset] +
                                  rsw.weight[1] * inBuf[inOffset + <a href="#Image::NChannels" class="code">NChannels</a>()] +
                                  rsw.weight[2] * inBuf[inOffset + 2 * <a href="#Image::NChannels" class="code">NChannels</a>()] +
                                  rsw.weight[3] * inBuf[inOffset + 3 * <a href="#Image::NChannels" class="code">NChannels</a>()];</div></div>
    }
}</div><p>


</p>
<p>The result of the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> resampling step will be stored in <tt>xBuf</tt>.  Note
that it is necessary to perform the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> resampling across all the
scanlines in <tt>inExtent</tt>&rsquo;s <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> range, as the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>-resampled instances of
them will be needed for the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> resampling step.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeimageextentsandallocatemonoxBuf-0"></span><div class="fragmentname">&lt;&lt;Compute image extents and allocate <tt>xBuf</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int nxOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
int nyOut = outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - outExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
int nxIn = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.x - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
int nyIn = inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMax" class="code">pMax</a>.y - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
std::vector&lt;float&gt; xBuf(<a href="#Image::NChannels" class="code">NChannels</a>() * nyIn * nxOut);</div><p>


</p>
<p>Once all the values are lined up, the actual resampling operation is
straightforward&mdash;effectively just the inner product of the normalized filter weights
and pixel channel values.

</p>
<p></p>
<span class="anchor" id="fragment-ResampleimagepixelmonoxOutyOut-0"></span><div class="fragmentname">&lt;&lt;Resample image pixel <tt>(xOut, yOut)</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">const ResampleWeight &amp;rsw = xWeights[xOut];
&lt;&lt;<span class="fragmentname"><a href="#fragment-ComputemonoinOffsetintomonoinBufformonoxOutyOut-0">Compute <tt>inOffset</tt> into <tt>inBuf</tt> for <tt>(xOut, yOut)</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2800" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2800"><i></i></a><div id="fragbit-2800" class="collapse"><div class="fragmentcode">   int xIn = rsw.firstPixel - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
   int yIn = yOut - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
   int inOffset = <a href="#Image::NChannels" class="code">NChannels</a>() * (xIn + yIn * nxIn);
   </div></div>
for (int c = 0; c &lt; <a href="#Image::NChannels" class="code">NChannels</a>(); ++c, ++xBufOffset, ++inOffset)
    xBuf[xBufOffset] = rsw.weight[0] * inBuf[inOffset] +
                       rsw.weight[1] * inBuf[inOffset + <a href="#Image::NChannels" class="code">NChannels</a>()] +
                       rsw.weight[2] * inBuf[inOffset + 2 * <a href="#Image::NChannels" class="code">NChannels</a>()] +
                       rsw.weight[3] * inBuf[inOffset + 3 * <a href="#Image::NChannels" class="code">NChannels</a>()];</div><p>


</p>
<p>The <tt>(xOut, yOut)</tt> pixel coordinate is with respect to the overall
final resampled image.  However, only the necessary input pixels for the
tile have been copied to <tt>inBuf</tt>.  Therefore, some reindexing is
necessary to compute the offset into <tt>inBuf</tt> that corresponds to the
first pixel that will be accessed to compute <tt>(xOut, yOut)</tt>&rsquo;s
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>-resized value.

</p>
<p></p>
<span class="anchor" id="fragment-ComputemonoinOffsetintomonoinBufformonoxOutyOut-0"></span><div class="fragmentname">&lt;&lt;Compute <tt>inOffset</tt> into <tt>inBuf</tt> for <tt>(xOut, yOut)</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int xIn = rsw.firstPixel - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.x;
int yIn = yOut - inExtent.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::pMin" class="code">pMin</a>.y;
int inOffset = <a href="#Image::NChannels" class="code">NChannels</a>() * (xIn + yIn * nxIn);
</div><p>


</p>
<p>The fragment &lt;&lt;<span class="fragmentname">Resize image in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> dimension</span>&gt;&gt; follows a similar
approach but filters along <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg>, going from <tt>xBuf</tt> into
<tt>outBuf</tt>.  It is therefore not included here.

</p>
<p>

</p>
<p>Given resampled pixels for <tt>outExtent</tt>, they can be copied in bulk to
the output image via <tt>CopyRectIn()</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-CopyresampledimagepixelsoutintomonoresampledImage-0"></span><div class="fragmentname">&lt;&lt;Copy resampled image pixels out into <tt>resampledImage</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">resampledImage.<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(outExtent, outBuf);</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#ImagePyramids"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:image-pyramids"></span><span id="ImagePyramids"></span><h3>B.5.5  Image Pyramids</h3><p>



</p>
<p>The <tt>GeneratePyramid()</tt> method generates an image pyramid, which
stores a source image, first resized if necessary to have power-of-two
resolution in each dimension, at its base.  Higher levels of the
pyramid are successively found by downsampling the next lower level by a
factor of two in each dimension.  Image pyramids are widely used for
accelerating image filtering operations and are a cornerstone of MIP
mapping, which is implemented in <tt>pbrt</tt>&rsquo;s <a href="../Textures_and_Materials/Image_Texture.html#MIPMap"><tt>MIPMap</tt></a> class,
defined in Section&nbsp;<a href="../Textures_and_Materials/Image_Texture.html#sec:mipmap">10.4.3</a>.

</p>
<p></p>
<span class="anchor" id="fragment-ImageMethodDefinitions-2"></span><div class="fragmentname">&lt;&lt;Image Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-ImageMethodDefinitions-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::vector&lt;<a href="#Image" class="code">Image</a>&gt; <span class="anchor" id="Image::GeneratePyramid"></span><a href="#Image" class="code">Image</a>::GeneratePyramid(<a href="#Image" class="code">Image</a> image, WrapMode2D wrapMode,
                                           <a href="../Introduction/Using_and_Understanding_the_Code.html#Allocator" class="code">Allocator</a> alloc) {
    PixelFormat origFormat = image.<a href="#Image::format" class="code">format</a>;
    int nChannels = image.<a href="#Image::NChannels" class="code">NChannels</a>();
    <a href="#ColorEncoding" class="code">ColorEncoding</a> origEncoding = image.<a href="#Image::encoding" class="code">encoding</a>;
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Preparemonoimageforbuildingpyramid-0">Prepare <tt>image</tt> for building pyramid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2801" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2801"><i></i></a><div id="fragbit-2801" class="collapse"><div class="fragmentcode">       if (!<a href="../Utilities/Mathematical_Infrastructure.html#IsPowerOf2" class="code">IsPowerOf2</a>(image.<a href="#Image::resolution" class="code">resolution</a>[0]) || !<a href="../Utilities/Mathematical_Infrastructure.html#IsPowerOf2" class="code">IsPowerOf2</a>(image.<a href="#Image::resolution" class="code">resolution</a>[1]))
           image = image.<a href="#Image::FloatResizeUp" class="code">FloatResizeUp</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(<a href="../Utilities/Mathematical_Infrastructure.html#RoundUpPow2" class="code">RoundUpPow2</a>(image.<a href="#Image::resolution" class="code">resolution</a>[0]),
                                               <a href="../Utilities/Mathematical_Infrastructure.html#RoundUpPow2" class="code">RoundUpPow2</a>(image.<a href="#Image::resolution" class="code">resolution</a>[1])),
                                               wrapMode);
       else if (!<a href="#Is32Bit" class="code">Is32Bit</a>(image.<a href="#Image::format" class="code">format</a>))
           image = image.ConvertToFormat(PixelFormat::Float);
       </div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Initializelevelsofpyramidfrommonoimage-0">Initialize levels of pyramid from <tt>image</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2802" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2802"><i></i></a><div id="fragbit-2802" class="collapse"><div class="fragmentcode">       int nLevels = 1 + <a href="../Utilities/Mathematical_Infrastructure.html#Log2Int" class="code">Log2Int</a>(std::max(image.<a href="#Image::resolution" class="code">resolution</a>[0],
                                          image.<a href="#Image::resolution" class="code">resolution</a>[1]));
       pstd::vector&lt;<a href="#Image" class="code">Image</a>&gt; pyramid(alloc);
       for (int i = 0; i &lt; nLevels - 1; ++i) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Initializei1stlevelfromithlevelandcopyithintopyramid-0">Initialize <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1568" y="0"></use>
</g>
</svg>st level from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th level and copy <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th into pyramid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2803" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2803"><i></i></a><div id="fragbit-2803" class="collapse"><div class="fragmentcode">              pyramid.push_back(<a href="#Image" class="code">Image</a>(origFormat, image.<a href="#Image::resolution" class="code">resolution</a>, image.<a href="#Image::channelNames" class="code">channelNames</a>,
                                      origEncoding, alloc));
              &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemononextImagefori1stlevel-0">Initialize <tt>nextImage</tt> for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1568" y="0"></use>
</g>
</svg>st level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2804" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2804"><i></i></a><div id="fragbit-2804" class="collapse"><div class="fragmentcode">                 <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> nextResolution(std::max(1, image.<a href="#Image::resolution" class="code">resolution</a>[0] / 2),
                                        std::max(1, image.<a href="#Image::resolution" class="code">resolution</a>[1] / 2));
                 <a href="#Image" class="code">Image</a> nextImage(image.<a href="#Image::format" class="code">format</a>, nextResolution, image.<a href="#Image::channelNames" class="code">channelNames</a>,
                                 origEncoding);</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Computeoffsetsfrompixelstothe4pixelsusedfordownsampling-0">Compute offsets from pixels to the 4 pixels used for downsampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2805" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2805"><i></i></a><div id="fragbit-2805" class="collapse"><div class="fragmentcode">                 int srcDeltas[4] = {0, nChannels, nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0],
                                     nChannels * (image.<a href="#Image::resolution" class="code">resolution</a>[0] + 1)};
                 if (image.<a href="#Image::resolution" class="code">resolution</a>[0] == 1) {
                     srcDeltas[1] = 0;
                     srcDeltas[3] -= nChannels;
                 }
                 if (image.<a href="#Image::resolution" class="code">resolution</a>[1] == 1) {
                     srcDeltas[2] = 0;
                     srcDeltas[3] -= nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0];
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Downsamplemonoimagetocreatenextlevelandupdatemonopyramid-0">Downsample <tt>image</tt> to create next level and update <tt>pyramid</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2806" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2806"><i></i></a><div id="fragbit-2806" class="collapse"><div class="fragmentcode">                 <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(0, nextResolution[1], [&amp;](int64_t y) {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Loopoverpixelsinscanlineyanddownsampleforthenextpyramidlevel-0">Loop over pixels in scanline <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> and downsample for the next pyramid level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2807" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2807"><i></i></a><div id="fragbit-2807" class="collapse"><div class="fragmentcode">                        int srcOffset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, 2 * int(y)));
                        int nextOffset = nextImage.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, int(y)));
                        for (int x = 0; x &lt; nextResolution[0]; ++x, srcOffset += nChannels)
                            for (int c = 0; c &lt; nChannels; ++c, ++srcOffset, ++nextOffset)
                                nextImage.<a href="#Image::p32" class="code">p32</a>[nextOffset] =
                                    (image.<a href="#Image::p32" class="code">p32</a>[srcOffset] + image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[1]] +
                                     image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[2]] +
                                     image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[3]]) / 4;</div></div>
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Copytwoscanlinesfrommonoimageouttoitspyramidlevel-0">Copy two scanlines from <tt>image</tt> out to its pyramid level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2808" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2808"><i></i></a><div id="fragbit-2808" class="collapse"><div class="fragmentcode">                        int yStart = 2 * y;
                        int yEnd = std::min(2 * int(y) + 2, image.<a href="#Image::resolution" class="code">resolution</a>[1]);
                        int offset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>({0, yStart});
                        size_t count = (yEnd - yStart) * nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0];
                        pyramid[i].<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>({0, yStart}, {image.<a href="#Image::resolution" class="code">resolution</a>[0], yEnd}),
                                        pstd::span&lt;const float&gt;(image.<a href="#Image::p32" class="code">p32</a>.data() + offset, count));</div></div>
                 });
                 image = std::move(nextImage);</div></div></div></div>
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Initializetoplevelofpyramidandreturnit-0">Initialize top level of pyramid and return it</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2809" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2809"><i></i></a><div id="fragbit-2809" class="collapse"><div class="fragmentcode">       pyramid.push_back(<a href="#Image" class="code">Image</a>(origFormat, {1, 1}, image.<a href="#Image::channelNames" class="code">channelNames</a>,
                               origEncoding, alloc));
       pyramid[nLevels - 1].<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>({0, 0}, {1, 1}),
                       pstd::span&lt;const float&gt;(image.<a href="#Image::p32" class="code">p32</a>.data(), nChannels));
       return pyramid;</div></div>
}</div><p>


</p>
<p>Implementation of an image pyramid is easier if the resolution of
the original image is an exact power of two in each direction; this ensures
that there is a direct relationship between the level of the
pyramid and the number of texels at that level.  If the user has provided
an image where the resolution in one or both of the dimensions is not a
power of two, then the <tt>GeneratePyramid()</tt> method calls
<tt>FloatResizeUp()</tt> to resize the image up to the next power-of-two resolution
greater than the original resolution before constructing the pyramid.
(Exercise&nbsp;B.1 at the end of the chapter describes an approach for building
image pyramids with non-power-of-two resolutions.)

</p>
<p>Otherwise, if the provided image does not use 32-bit <tt>float</tt>s for its
in-memory format, it is converted to that representation.  This helps avoid
errors in the image pyramid due to insufficient precision being used for
the inputs to the filtering computations.  (In the end, however, the
returned pyramid will have images in the format of the original image so
that memory use is not unnecessarily increased.) 

</p>
<p>These two operations motivate taking the <a href="#Image"><tt>Image</tt></a> as a parameter to a
<tt>static</tt> method, as <tt>GeneratePyramid()</tt> is, rather than being a
non-<tt>static</tt> member function.  Thus, a new image can easily be
reassigned to <tt>image</tt> as necessary.

</p>
<p></p>
<span class="anchor" id="fragment-Preparemonoimageforbuildingpyramid-0"></span><div class="fragmentname">&lt;&lt;Prepare <tt>image</tt> for building pyramid&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (!<a href="../Utilities/Mathematical_Infrastructure.html#IsPowerOf2" class="code">IsPowerOf2</a>(image.<a href="#Image::resolution" class="code">resolution</a>[0]) || !<a href="../Utilities/Mathematical_Infrastructure.html#IsPowerOf2" class="code">IsPowerOf2</a>(image.<a href="#Image::resolution" class="code">resolution</a>[1]))
    image = image.<a href="#Image::FloatResizeUp" class="code">FloatResizeUp</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(<a href="../Utilities/Mathematical_Infrastructure.html#RoundUpPow2" class="code">RoundUpPow2</a>(image.<a href="#Image::resolution" class="code">resolution</a>[0]),
                                        <a href="../Utilities/Mathematical_Infrastructure.html#RoundUpPow2" class="code">RoundUpPow2</a>(image.<a href="#Image::resolution" class="code">resolution</a>[1])),
                                        wrapMode);
else if (!<a href="#Is32Bit" class="code">Is32Bit</a>(image.<a href="#Image::format" class="code">format</a>))
    image = image.ConvertToFormat(PixelFormat::Float);
</div><p>


</p>
<p>Once we have a floating-point image with resolutions that are powers of two, the levels
of the MIP map can be initialized, starting from the bottom (finest) level.
Each higher level is found by filtering the texels from the previous level.

</p>
<p></p>
<span class="anchor" id="fragment-Initializelevelsofpyramidfrommonoimage-0"></span><div class="fragmentname">&lt;&lt;Initialize levels of pyramid from <tt>image</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int nLevels = 1 + <a href="../Utilities/Mathematical_Infrastructure.html#Log2Int" class="code">Log2Int</a>(std::max(image.<a href="#Image::resolution" class="code">resolution</a>[0],
                                   image.<a href="#Image::resolution" class="code">resolution</a>[1]));
pstd::vector&lt;<a href="#Image" class="code">Image</a>&gt; pyramid(alloc);
for (int i = 0; i &lt; nLevels - 1; ++i) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Initializei1stlevelfromithlevelandcopyithintopyramid-0">Initialize <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1568" y="0"></use>
</g>
</svg>st level from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th level and copy <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th into pyramid</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2810" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2810"><i></i></a><div id="fragbit-2810" class="collapse"><div class="fragmentcode">       pyramid.push_back(<a href="#Image" class="code">Image</a>(origFormat, image.<a href="#Image::resolution" class="code">resolution</a>, image.<a href="#Image::channelNames" class="code">channelNames</a>,
                               origEncoding, alloc));
       &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemononextImagefori1stlevel-0">Initialize <tt>nextImage</tt> for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1568" y="0"></use>
</g>
</svg>st level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2811" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2811"><i></i></a><div id="fragbit-2811" class="collapse"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> nextResolution(std::max(1, image.<a href="#Image::resolution" class="code">resolution</a>[0] / 2),
                                 std::max(1, image.<a href="#Image::resolution" class="code">resolution</a>[1] / 2));
          <a href="#Image" class="code">Image</a> nextImage(image.<a href="#Image::format" class="code">format</a>, nextResolution, image.<a href="#Image::channelNames" class="code">channelNames</a>,
                          origEncoding);</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computeoffsetsfrompixelstothe4pixelsusedfordownsampling-0">Compute offsets from pixels to the 4 pixels used for downsampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2812" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2812"><i></i></a><div id="fragbit-2812" class="collapse"><div class="fragmentcode">          int srcDeltas[4] = {0, nChannels, nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0],
                              nChannels * (image.<a href="#Image::resolution" class="code">resolution</a>[0] + 1)};
          if (image.<a href="#Image::resolution" class="code">resolution</a>[0] == 1) {
              srcDeltas[1] = 0;
              srcDeltas[3] -= nChannels;
          }
          if (image.<a href="#Image::resolution" class="code">resolution</a>[1] == 1) {
              srcDeltas[2] = 0;
              srcDeltas[3] -= nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0];
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Downsamplemonoimagetocreatenextlevelandupdatemonopyramid-0">Downsample <tt>image</tt> to create next level and update <tt>pyramid</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2813" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2813"><i></i></a><div id="fragbit-2813" class="collapse"><div class="fragmentcode">          <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(0, nextResolution[1], [&amp;](int64_t y) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Loopoverpixelsinscanlineyanddownsampleforthenextpyramidlevel-0">Loop over pixels in scanline <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> and downsample for the next pyramid level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2814" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2814"><i></i></a><div id="fragbit-2814" class="collapse"><div class="fragmentcode">                 int srcOffset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, 2 * int(y)));
                 int nextOffset = nextImage.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, int(y)));
                 for (int x = 0; x &lt; nextResolution[0]; ++x, srcOffset += nChannels)
                     for (int c = 0; c &lt; nChannels; ++c, ++srcOffset, ++nextOffset)
                         nextImage.<a href="#Image::p32" class="code">p32</a>[nextOffset] =
                             (image.<a href="#Image::p32" class="code">p32</a>[srcOffset] + image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[1]] +
                              image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[2]] +
                              image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[3]]) / 4;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Copytwoscanlinesfrommonoimageouttoitspyramidlevel-0">Copy two scanlines from <tt>image</tt> out to its pyramid level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2815" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2815"><i></i></a><div id="fragbit-2815" class="collapse"><div class="fragmentcode">                 int yStart = 2 * y;
                 int yEnd = std::min(2 * int(y) + 2, image.<a href="#Image::resolution" class="code">resolution</a>[1]);
                 int offset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>({0, yStart});
                 size_t count = (yEnd - yStart) * nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0];
                 pyramid[i].<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>({0, yStart}, {image.<a href="#Image::resolution" class="code">resolution</a>[0], yEnd}),
                                 pstd::span&lt;const float&gt;(image.<a href="#Image::p32" class="code">p32</a>.data() + offset, count));</div></div>
          });
          image = std::move(nextImage);</div></div></div></div>
}</div><p>


</p>
<p>Each time through this loop, <tt>image</tt> starts out as the
already-filtered image for the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th level that will be downsampled to
generate the image for the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1568" y="0"></use>
</g>
</svg>st level.  A new entry is added to the
image pyramid for <tt>image</tt>, though using the original pixel format.

</p>
<p></p>
<span class="anchor" id="fragment-Initializei1stlevelfromithlevelandcopyithintopyramid-0"></span><div class="fragmentname">&lt;&lt;Initialize <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1568" y="0"></use>
</g>
</svg>st level from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th level and copy <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th into pyramid&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pyramid.push_back(<a href="#Image" class="code">Image</a>(origFormat, image.<a href="#Image::resolution" class="code">resolution</a>, image.<a href="#Image::channelNames" class="code">channelNames</a>,
                        origEncoding, alloc));
&lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemononextImagefori1stlevel-0">Initialize <tt>nextImage</tt> for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1568" y="0"></use>
</g>
</svg>st level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2816" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2816"><i></i></a><div id="fragbit-2816" class="collapse"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> nextResolution(std::max(1, image.<a href="#Image::resolution" class="code">resolution</a>[0] / 2),
                          std::max(1, image.<a href="#Image::resolution" class="code">resolution</a>[1] / 2));
   <a href="#Image" class="code">Image</a> nextImage(image.<a href="#Image::format" class="code">format</a>, nextResolution, image.<a href="#Image::channelNames" class="code">channelNames</a>,
                   origEncoding);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Computeoffsetsfrompixelstothe4pixelsusedfordownsampling-0">Compute offsets from pixels to the 4 pixels used for downsampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2817" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2817"><i></i></a><div id="fragbit-2817" class="collapse"><div class="fragmentcode">   int srcDeltas[4] = {0, nChannels, nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0],
                       nChannels * (image.<a href="#Image::resolution" class="code">resolution</a>[0] + 1)};
   if (image.<a href="#Image::resolution" class="code">resolution</a>[0] == 1) {
       srcDeltas[1] = 0;
       srcDeltas[3] -= nChannels;
   }
   if (image.<a href="#Image::resolution" class="code">resolution</a>[1] == 1) {
       srcDeltas[2] = 0;
       srcDeltas[3] -= nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0];
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Downsamplemonoimagetocreatenextlevelandupdatemonopyramid-0">Downsample <tt>image</tt> to create next level and update <tt>pyramid</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2818" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2818"><i></i></a><div id="fragbit-2818" class="collapse"><div class="fragmentcode">   <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(0, nextResolution[1], [&amp;](int64_t y) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Loopoverpixelsinscanlineyanddownsampleforthenextpyramidlevel-0">Loop over pixels in scanline <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> and downsample for the next pyramid level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2819" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2819"><i></i></a><div id="fragbit-2819" class="collapse"><div class="fragmentcode">          int srcOffset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, 2 * int(y)));
          int nextOffset = nextImage.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, int(y)));
          for (int x = 0; x &lt; nextResolution[0]; ++x, srcOffset += nChannels)
              for (int c = 0; c &lt; nChannels; ++c, ++srcOffset, ++nextOffset)
                  nextImage.<a href="#Image::p32" class="code">p32</a>[nextOffset] =
                      (image.<a href="#Image::p32" class="code">p32</a>[srcOffset] + image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[1]] +
                       image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[2]] +
                       image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[3]]) / 4;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Copytwoscanlinesfrommonoimageouttoitspyramidlevel-0">Copy two scanlines from <tt>image</tt> out to its pyramid level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2820" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2820"><i></i></a><div id="fragbit-2820" class="collapse"><div class="fragmentcode">          int yStart = 2 * y;
          int yEnd = std::min(2 * int(y) + 2, image.<a href="#Image::resolution" class="code">resolution</a>[1]);
          int offset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>({0, yStart});
          size_t count = (yEnd - yStart) * nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0];
          pyramid[i].<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>({0, yStart}, {image.<a href="#Image::resolution" class="code">resolution</a>[0], yEnd}),
                          pstd::span&lt;const float&gt;(image.<a href="#Image::p32" class="code">p32</a>.data() + offset, count));</div></div>
   });
   image = std::move(nextImage);</div></div></div><p>


</p>
<p>For non-square images, the resolution in one direction must be clamped to&nbsp;1
for the upper levels of the image pyramid, where there is still
downsampling to do in the larger of the two resolutions.  This is handled
by the following <tt>std::max()</tt> calls:

</p>
<p></p>
<span class="anchor" id="fragment-InitializemononextImagefori1stlevel-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>nextImage</tt> for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i plus 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1568" y="0"></use>
</g>
</svg>st level&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a> nextResolution(std::max(1, image.<a href="#Image::resolution" class="code">resolution</a>[0] / 2),
                       std::max(1, image.<a href="#Image::resolution" class="code">resolution</a>[1] / 2));
<a href="#Image" class="code">Image</a> nextImage(image.<a href="#Image::format" class="code">format</a>, nextResolution, image.<a href="#Image::channelNames" class="code">channelNames</a>,
                origEncoding);</div><p>


</p>
<p><tt>GeneratePyramid()</tt> uses a simple box filter to average four texels
from the previous level to find the value at the current texel.  Using the
Lanczos filter here would give a slightly better result for this
computation, although this modification is left for Exercise&nbsp;B.2 at the
end of the chapter.

</p>
<p>With the box filter, each pixel <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.312ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2287.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1897" y="0"></use>
</g>
</svg> in <tt>nextImage</tt> is given by the
average of the pixels <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.637ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3288.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis 2 x comma 2 y right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="890" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1462" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="1907" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="2408" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2898" y="0"></use>
</g>
</svg>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.64ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 5011.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis 2 x plus 1 comma 2 y right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="890" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="1684" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2685" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3185" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="3631" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="4131" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4622" y="0"></use>
</g>
</svg>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.64ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 5011.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis 2 x comma 2 y plus 1 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="890" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1462" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="1907" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="2408" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="3120" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="4121" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4622" y="0"></use>
</g>
</svg>, and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.643ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 6735.1 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis 2 x plus 1 comma 2 y plus 1 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="890" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="1684" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2685" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3185" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="3631" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="4131" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="4844" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="5845" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6345" y="0"></use>
</g>
</svg>.
Here we compute the corresponding offsets from a pixel in the source
image to those four pixels; doing this here saves some math in
pixel indexing when downsampling.  These offsets are based on the scanline-based
layout of <a href="#Image"><tt>Image</tt></a> data in memory; referring to the implementation of
<a href="#Image::PixelOffset"><tt>Image::PixelOffset()</tt></a> may make their operation more clear.

</p>
<p>Here is also a good chance to handle images with single pixel resolution in
one dimension; in that case the offsets are set so that valid pixels are
used twice, and the downsampling loop can be written to always assume
four values.

</p>
<p></p>
<span class="anchor" id="fragment-Computeoffsetsfrompixelstothe4pixelsusedfordownsampling-0"></span><div class="fragmentname">&lt;&lt;Compute offsets from pixels to the 4 pixels used for downsampling&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int srcDeltas[4] = {0, nChannels, nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0],
                    nChannels * (image.<a href="#Image::resolution" class="code">resolution</a>[0] + 1)};
if (image.<a href="#Image::resolution" class="code">resolution</a>[0] == 1) {
    srcDeltas[1] = 0;
    srcDeltas[3] -= nChannels;
}
if (image.<a href="#Image::resolution" class="code">resolution</a>[1] == 1) {
    srcDeltas[2] = 0;
    srcDeltas[3] -= nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0];
}</div><p>


</p>
<p>The work for the current level is performed in parallel since each output
pixel&rsquo;s value is independent of the others.  For scenes with many textures,
MIP map generation may be a meaningful amount of <tt>pbrt</tt>&rsquo;s startup time, so
it is worthwhile to try to optimize this work done by this method so that rendering can begin more
quickly.  When the work for each level is finished, the image for the next
level is assigned to <tt>image</tt> so that the loop can proceed once again.

</p>
<p></p>
<span class="anchor" id="fragment-Downsamplemonoimagetocreatenextlevelandupdatemonopyramid-0"></span><div class="fragmentname">&lt;&lt;Downsample <tt>image</tt> to create next level and update <tt>pyramid</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(0, nextResolution[1], [&amp;](int64_t y) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Loopoverpixelsinscanlineyanddownsampleforthenextpyramidlevel-0">Loop over pixels in scanline <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> and downsample for the next pyramid level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2821" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2821"><i></i></a><div id="fragbit-2821" class="collapse"><div class="fragmentcode">       int srcOffset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, 2 * int(y)));
       int nextOffset = nextImage.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, int(y)));
       for (int x = 0; x &lt; nextResolution[0]; ++x, srcOffset += nChannels)
           for (int c = 0; c &lt; nChannels; ++c, ++srcOffset, ++nextOffset)
               nextImage.<a href="#Image::p32" class="code">p32</a>[nextOffset] =
                   (image.<a href="#Image::p32" class="code">p32</a>[srcOffset] + image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[1]] +
                    image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[2]] +
                    image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[3]]) / 4;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Copytwoscanlinesfrommonoimageouttoitspyramidlevel-0">Copy two scanlines from <tt>image</tt> out to its pyramid level</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2822" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2822"><i></i></a><div id="fragbit-2822" class="collapse"><div class="fragmentcode">       int yStart = 2 * y;
       int yEnd = std::min(2 * int(y) + 2, image.<a href="#Image::resolution" class="code">resolution</a>[1]);
       int offset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>({0, yStart});
       size_t count = (yEnd - yStart) * nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0];
       pyramid[i].<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>({0, yStart}, {image.<a href="#Image::resolution" class="code">resolution</a>[0], yEnd}),
                       pstd::span&lt;const float&gt;(image.<a href="#Image::p32" class="code">p32</a>.data() + offset, count));</div></div>
});
image = std::move(nextImage);</div><p>


</p>
<p>The following fragment computes a scanline&rsquo;s worth of downsampled pixel
values in <tt>nextImage</tt>.  It makes extensive use of the fact that the
channels for each pixel are laid out consecutively in memory and that
pixels are stored in scanline order in memory.  Thus, it can compute
offsets into the pixel arrays for the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> scanline starting at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.591ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2407.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="850" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1906" y="0"></use>
</g>
</svg> and
efficiently incrementally update them for each image channel and each
pixel.  Note also that the offsets to the neighboring pixels from <tt>srcDeltas</tt> are used to
efficiently find the necessary pixel values from <tt>image</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Loopoverpixelsinscanlineyanddownsampleforthenextpyramidlevel-0"></span><div class="fragmentname">&lt;&lt;Loop over pixels in scanline <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> and downsample for the next pyramid level&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int srcOffset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, 2 * int(y)));
int nextOffset = nextImage.<a href="#Image::PixelOffset" class="code">PixelOffset</a>(<a href="../Geometry_and_Transformations/Points.html#Point2i" class="code">Point2i</a>(0, int(y)));
for (int x = 0; x &lt; nextResolution[0]; ++x, srcOffset += nChannels)
    for (int c = 0; c &lt; nChannels; ++c, ++srcOffset, ++nextOffset)
        nextImage.<a href="#Image::p32" class="code">p32</a>[nextOffset] =
            (image.<a href="#Image::p32" class="code">p32</a>[srcOffset] + image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[1]] +
             image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[2]] +
             image.<a href="#Image::p32" class="code">p32</a>[srcOffset + srcDeltas[3]]) / 4;</div><p>


</p>
<p>We will take advantage of the fact that processing is happening in parallel
here to also copy pixel values from <tt>image</tt> into their place in the
pyramid.  Doing so here has the added benefit that the pixel values should
already be in the cache from their use as inputs to the downsampling
computation.

</p>
<p>Because the <tt>ParallelFor()</tt> loop is over scanlines in the
lower-resolution image, two scanlines from <tt>image</tt> are copied here
except in the edge case of a single-scanline-high image from a
non-square-input image.  The <a href="#Image"><tt>Image</tt></a> <tt>CopyRectIn()</tt> method copies the pixels
inside the provided bounds, taking care of converting them to the format of
the destination image pixels if necessary. 

</p>
<p></p>
<span class="anchor" id="fragment-Copytwoscanlinesfrommonoimageouttoitspyramidlevel-0"></span><div class="fragmentname">&lt;&lt;Copy two scanlines from <tt>image</tt> out to its pyramid level&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int yStart = 2 * y;
int yEnd = std::min(2 * int(y) + 2, image.<a href="#Image::resolution" class="code">resolution</a>[1]);
int offset = image.<a href="#Image::PixelOffset" class="code">PixelOffset</a>({0, yStart});
size_t count = (yEnd - yStart) * nChannels * image.<a href="#Image::resolution" class="code">resolution</a>[0];
pyramid[i].<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>({0, yStart}, {image.<a href="#Image::resolution" class="code">resolution</a>[0], yEnd}),
                pstd::span&lt;const float&gt;(image.<a href="#Image::p32" class="code">p32</a>.data() + offset, count));</div><p>


</p>
<p>After the loop terminates, we are left with a <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.165ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2223.9 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 times 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-D7" d="M624 15c-7 -8 -20 -8 -28 0l-207 207l-207 -207c-8 -8 -21 -8 -28 0c-8 7 -8 20 0 28l207 207l-207 207c-8 8 -8 21 0 28c7 8 20 8 28 0l207 -207l207 207c8 8 21 8 28 0c8 -7 8 -20 0 -28l-207 -207l207 -207c8 -8 8 -21 0 -28Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-D7" x="722" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1723" y="0"></use>
</g>
</svg> image to copy
into the top level of the image pyramid before it can be returned.

</p>
<p></p>
<span class="anchor" id="fragment-Initializetoplevelofpyramidandreturnit-0"></span><div class="fragmentname">&lt;&lt;Initialize top level of pyramid and return it&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pyramid.push_back(<a href="#Image" class="code">Image</a>(origFormat, {1, 1}, image.<a href="#Image::channelNames" class="code">channelNames</a>,
                        origEncoding, alloc));
pyramid[nLevels - 1].<a href="#Image::CopyRectIn" class="code">CopyRectIn</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2i" class="code">Bounds2i</a>({0, 0}, {1, 1}),
                pstd::span&lt;const float&gt;(image.<a href="#Image::p32" class="code">p32</a>.data(), nChannels));
return pyramid;</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#ColorEncodings"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:color-encodings"></span><span id="ColorEncodings"></span><h3>B.5.6  Color Encodings</h3><p>



</p>
<p>Color spaces often define a <em>transfer function</em> that is used to encode
color component values that are stored in the color space.  Transfer
functions date to cathode ray tube (CRT) displays, which had a nonlinear
relationship between display intensity and the voltage <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.787ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 769.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper V</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D449" d="M769 671c0 0 -1 -18 -13 -19c-37 -2 -79 -5 -128 -83l-360 -573c-8 -13 -12 -18 -28 -18c-13 0 -17 3 -20 23l-79 617c-3 25 -4 34 -60 34c-16 0 -25 0 -25 12c0 19 12 19 19 19c17 0 36 -2 54 -2s37 -1 55 -1c41 0 84 3 124 3c6 0 14 -2 14 -11c0 -20 -11 -20 -25 -20 c-46 0 -69 -13 -69 -30l68 -529l307 488s15 23 15 38c0 21 -19 31 -46 33c-7 0 -16 1 -16 12c0 19 13 19 19 19c32 0 66 -3 99 -3c27 0 56 3 82 3c8 0 13 -4 13 -12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D449" x="0" y="0"></use>
</g>
</svg> of the electron
gun, which was modeled with a gamma curve <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.042ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1309.7 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper V Superscript gamma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D449" d="M769 671c0 0 -1 -18 -13 -19c-37 -2 -79 -5 -128 -83l-360 -573c-8 -13 -12 -18 -28 -18c-13 0 -17 3 -20 23l-79 617c-3 25 -4 34 -60 34c-16 0 -25 0 -25 12c0 19 12 19 19 19c17 0 36 -2 54 -2s37 -1 55 -1c41 0 84 3 124 3c6 0 14 -2 14 -11c0 -20 -11 -20 -25 -20 c-46 0 -69 -13 -69 -30l68 -529l307 488s15 23 15 38c0 21 -19 31 -46 33c-7 0 -16 1 -16 12c0 19 13 19 19 19c32 0 66 -3 99 -3c27 0 56 3 82 3c8 0 13 -4 13 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FE" d="M543 421c0 -4 -12 -26 -19 -38c-40 -79 -104 -228 -136 -327c-4 -13 -6 -26 -8 -39c-4 -31 -14 -88 -37 -172c-11 -38 -19 -60 -32 -60c-8 0 -13 7 -13 18c0 26 30 142 52 215c7 20 12 37 12 98c0 79 -11 254 -162 254c-11 0 -120 -1 -159 -116l-4 -5c-10 0 -19 0 -19 10 c0 31 70 183 195 183c69 0 109 -49 133 -110c39 -97 40 -173 41 -204c40 101 80 201 132 296c3 7 9 7 12 7c0 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D449" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D6FE" x="1167" y="513"></use>
</g>
</svg>.  With CRTs,
doubling the RGB color components stored at a pixel did not lead to a
doubling of displayed intensity, an undesirable nonlinearity at the end of
a rendering process that is built on an assumption of linearity.
It was therefore necessary to apply <em>gamma correction</em> to image
pixels using the inverse of the gamma curve so that the image on the screen had a
linear relationship between intensity and pixel values.

</p>
<p>While modern displays no longer use electron guns, it is still worthwhile
to use a nonlinear mapping with colors that are stored in quantized representations (e.g., 8-bit
pixel components).  One reason to do so is suggested by <em>Weber&rsquo;s law</em>,
which is based on the observation that an increase of 1% of a stimulus value
(e.g., displayed color) is generally required before a human observer
notices a change&mdash;this is the <em>just noticeable difference</em>.  In
turn, a pixel encoding that allocates multiple values to invisible
differences is inefficient, at least for display.  Weber&rsquo;s law also
suggests a power law&ndash;based encoding, along the lines of gamma correction.  

</p>
<p><tt>pbrt</tt> does most of its computation using floating-point color values, for
which there is no need to apply a color encoding.  (And indeed, such an
encoding would need to be inverted any time a computation was performed
with such a color value.)  However, it is necessary to support color
encodings to decode color values from non-floating-point image formats
like PNG as well as to encode them before writing images in such formats.

</p>
<p>The <tt>ColorEncoding</tt> class defines the
<tt>ColorEncoding</tt> interface, which handles
both encoding and decoding color in various ways.

</p>
<p></p>
<span class="anchor" id="fragment-ColorEncodingDefinitions-0"></span><div class="fragmentname">&lt;&lt;ColorEncoding Definitions&gt;&gt;=&nbsp;<a href="#fragment-ColorEncodingDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">class <span class="anchor" id="ColorEncoding"></span>ColorEncoding
    : public <a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer" class="code">TaggedPointer</a>&lt;LinearColorEncoding, sRGBColorEncoding,
                           GammaColorEncoding&gt; {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ColorEncodingInterface-0">ColorEncoding Interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2823" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2823"><i></i></a><div id="fragbit-2823" class="collapse"><div class="fragmentcode">       void ToLinear(pstd::span&lt;const uint8_t&gt; vin,
                     pstd::span&lt;Float&gt; vout) const;
       void FromLinear(pstd::span&lt;const Float&gt; vin,
                       pstd::span&lt;uint8_t&gt; vout) const;
       Float ToFloatLinear(Float v) const;
       std::string ToString() const;
       static const <a href="#ColorEncoding" class="code">ColorEncoding</a> Get(const std::string &amp;name, Allocator alloc);
       static <a href="#ColorEncoding" class="code">ColorEncoding</a> Linear;
       static <a href="#ColorEncoding" class="code">ColorEncoding</a> sRGB;
       static void Init(Allocator alloc);</div></div>
};</div><p>


</p>
<p>The two main methods that <tt>ColorEncoding</tt>s must provide are
<tt>ToLinear()</tt>, which takes a set of encoded 8-bit color values and
converts them to linear <tt>Float</tt>s, and <tt>FromLinear()</tt>, which does
the reverse.  Both of these take buffers of potentially many values to
convert at once, which saves dynamic dispatch overhead compared to invoking
them for each value independently.

</p>
<p></p>
<span class="anchor" id="fragment-ColorEncodingInterface-0"></span><div class="fragmentname">&lt;&lt;ColorEncoding Interface&gt;&gt;=&nbsp;<a href="#fragment-ColorEncodingInterface-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="ColorEncoding::ToLinear"></span>ToLinear(pstd::span&lt;const uint8_t&gt; vin,
              pstd::span&lt;Float&gt; vout) const;
void <span class="anchor" id="ColorEncoding::FromLinear"></span>FromLinear(pstd::span&lt;const Float&gt; vin,
                pstd::span&lt;uint8_t&gt; vout) const;</div><p>


</p>
<p>It is sometimes useful to decode values with greater than 8-bit
precision (e.g., some image formats like PNG are able to store 16-bit
color channels).  Such cases are handled by <tt>ToFloatLinear()</tt>, which
takes a single encoded value stored as a <tt>Float</tt> and decodes it.

</p>
<p></p>
<span class="anchor" id="fragment-ColorEncodingInterface-1"></span><div class="fragmentname">&lt;&lt;ColorEncoding Interface&gt;&gt;+=&nbsp;<a href="#fragment-ColorEncodingInterface-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ColorEncodingInterface-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="ToFloatLinear"></span>ToFloatLinear(Float v) const;</div><p>


</p>
<p>

</p>
<p>

</p>
<p>The <tt>LinearColorEncoding</tt><span class="anchor" id="LinearColorEncoding"></span> class is
trivial: it divides 8-bit values by 255 to convert them to <tt>Float</tt>s
and does the reverse to convert back.  <tt>pbrt</tt> also provides
<tt>GammaColorEncoding</tt><span class="anchor" id="GammaColorEncoding"></span>, which applies a
plain gamma curve of specified exponent.  Neither of these are included in
the text here.

</p>
<p><tt>sRGBColorEncoding</tt> implements the encoding specified by the sRGB
color space.  It combines a linear segment for small values with a power
curve for larger ones.

</p>
<p></p>
<span class="anchor" id="fragment-ColorEncodingDefinitions-1"></span><div class="fragmentname">&lt;&lt;ColorEncoding Definitions&gt;&gt;+=&nbsp;<a href="#fragment-ColorEncodingDefinitions-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">class <span class="anchor" id="sRGBColorEncoding"></span>sRGBColorEncoding {
  public:
    &lt;&lt;<span class="fragmentname">sRGBColorEncoding Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2824" role="button" class="fa codecarat collapsed" aria-expanded="false" aria-controls="fragbit-2824"><i></i></a><div id="fragbit-2824" class="collapse"><div class="fragmentcode">       PBRT_CPU_GPU
       void ToLinear(pstd::span&lt;const uint8_t&gt; vin, pstd::span&lt;Float&gt; vout) const;
       PBRT_CPU_GPU
       Float ToFloatLinear(Float v) const;
       PBRT_CPU_GPU
       void FromLinear(pstd::span&lt;const Float&gt; vin, pstd::span&lt;uint8_t&gt; vout) const;
       
       std::string ToString() const { return "[ sRGBColorEncoding ]"; }</div></div>
};</div><p>


</p>
<p>A linear value <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> is converted to an sRGB-encoded value <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.292ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 986.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="809" y="-213"></use>
</g>
</svg> by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="44.766ex" height="5.509ex" style="vertical-align: -2.171ex;" viewBox="0 -1437.2 19274 2372" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x Subscript normal e Baseline equals StartLayout Enlarged left-brace 1st Row 1st Column 12.92 x 2nd Column x less-than-or-equal-to 0.0031308 2nd Row 1st Column 1.055 x Superscript 1 slash 2.4 Baseline minus 0.055 2nd Column otherwise period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7B" d="M425 -238c0 -7 -5 -12 -12 -12c-105 0 -196 52 -196 125v250c0 58 -55 113 -130 113c-7 0 -12 5 -12 12s5 12 12 12c75 0 130 55 130 113v250c0 73 91 125 196 125c7 0 12 -5 12 -12s-5 -12 -12 -12c-75 0 -130 -49 -130 -101v-250c0 -58 -48 -104 -115 -125 c67 -21 115 -67 115 -125v-250c0 -52 55 -101 130 -101c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-39" d="M457 329c0 -215 -122 -351 -251 -351c-85 0 -139 41 -139 108c0 39 30 48 46 48c22 0 46 -15 46 -46c0 -17 -8 -46 -52 -46c27 -34 81 -36 98 -36c58 0 162 46 162 280v32c-23 -58 -64 -100 -125 -100c-112 0 -200 98 -200 223c0 75 23 117 64 162c43 45 92 63 147 63 c89 0 204 -68 204 -337zM365 421c0 46 -4 109 -16 141c-17 45 -50 79 -96 79c-35 0 -73 -13 -100 -63c-21 -37 -21 -84 -21 -138c0 -49 0 -99 18 -136c31 -63 77 -63 93 -63c88 0 122 97 122 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2264" d="M691 75c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259zM702 -99c0 -11 -9 -20 -20 -20h-586c-11 0 -20 9 -20 20s9 20 20 20h586c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-38" d="M457 168c0 -107 -95 -190 -208 -190c-105 0 -207 67 -207 173c0 99 86 155 144 184c-25 17 -62 42 -73 54c-42 47 -44 92 -44 110c0 93 81 167 181 167c91 0 180 -57 180 -149c0 -66 -49 -118 -121 -155c64 -40 80 -50 99 -71c38 -42 49 -87 49 -123zM386 517 c0 72 -64 124 -137 124c-71 0 -136 -42 -136 -103c0 -17 4 -51 50 -81l124 -80c60 35 99 83 99 140zM407 132c0 61 -47 91 -75 110l-123 78c-85 -47 -117 -111 -117 -169c0 -83 72 -145 158 -145c82 0 157 52 157 126Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE5-7B" d="M608 -780c0 -11 -9 -20 -20 -20c-2 0 -3 0 -5 1c-145 37 -273 148 -273 261v526c0 99 -81 213 -195 243c-9 2 -15 10 -15 19s6 17 15 19c114 30 195 144 195 243v526c0 113 128 224 273 261c2 1 3 1 5 1c11 0 20 -9 20 -20c0 -9 -6 -17 -15 -19 c-114 -29 -195 -134 -195 -223v-526c0 -108 -96 -212 -215 -262c119 -50 215 -154 215 -262v-526c0 -89 81 -194 195 -223c9 -2 15 -10 15 -19Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="809" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1264" y="0"></use>
<g transform="translate(2320,0)">
 <use xlink:href="#E1-LATINMODERNSIZE5-7B"></use>
<g transform="translate(874,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,546)">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="1001" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-39" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="1780" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="2280" y="0"></use>
</g>
<g transform="translate(0,-647)">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1780" y="0"></use>
<g transform="translate(2280,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
<g transform="translate(572,362)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
<g transform="translate(707,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-34" x="779" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="4787" y="0"></use>
<g transform="translate(5788,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1780" y="0"></use>
</g>
</g>
</g>
<g transform="translate(9058,0)">
<g transform="translate(0,546)">
<g transform="translate(332,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2264" x="850" y="0"></use>
<g transform="translate(1906,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-33" x="1780" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2280" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-33" x="2781" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="3281" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-38" x="3782" y="0"></use>
</g>
</g>
</g>
<g transform="translate(0,-647)">
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="332" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-74" x="832" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-68" x="1222" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="1778" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="2223" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-77" x="2615" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="3338" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="3616" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="4011" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="4455" y="0"></use>
</g>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>


</p>
<p>The work of conversion is handled by the
<tt>LinearToSRGB8()</tt><span class="anchor" id="LinearToSRGB8"></span> function, which is not included
here.  It uses a rational polynomial approximation to avoid the cost of a
<tt>std::pow()</tt> call in computing the encoded value.

</p>
<p></p>
<span class="anchor" id="fragment-ColorEncodingMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;ColorEncoding Method Definitions&gt;&gt;=&nbsp;<a href="#fragment-ColorEncodingMethodDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="sRGBColorEncoding::FromLinear"></span>sRGBColorEncoding::FromLinear(pstd::span&lt;const Float&gt; vin,
                                   pstd::span&lt;uint8_t&gt; vout) const {
    for (size_t i = 0; i &lt; vin.size(); ++i)
        vout[i] = <a href="#LinearToSRGB8" class="code">LinearToSRGB8</a>(vin[i]);
}</div><p>


</p>
<p>The inverse transformation is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="36.475ex" height="7.843ex" style="vertical-align: -3.338ex;" viewBox="0 -1939.5 15704.5 3376.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x equals StartLayout Enlarged left-brace 1st Row 1st Column StartFraction x Subscript normal e Baseline Over 12.92 EndFraction 2nd Column x Subscript normal e Baseline less-than-or-equal-to 0.04045 2nd Row 1st Column left-parenthesis StartFraction x Subscript normal e Baseline plus 0.055 Over 1.055 EndFraction right-parenthesis Superscript 2.4 Baseline 2nd Column otherwise period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7B" d="M425 -238c0 -7 -5 -12 -12 -12c-105 0 -196 52 -196 125v250c0 58 -55 113 -130 113c-7 0 -12 5 -12 12s5 12 12 12c75 0 130 55 130 113v250c0 73 91 125 196 125c7 0 12 -5 12 -12s-5 -12 -12 -12c-75 0 -130 -49 -130 -101v-250c0 -58 -48 -104 -115 -125 c67 -21 115 -67 115 -125v-250c0 -52 55 -101 130 -101c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-39" d="M457 329c0 -215 -122 -351 -251 -351c-85 0 -139 41 -139 108c0 39 30 48 46 48c22 0 46 -15 46 -46c0 -17 -8 -46 -52 -46c27 -34 81 -36 98 -36c58 0 162 46 162 280v32c-23 -58 -64 -100 -125 -100c-112 0 -200 98 -200 223c0 75 23 117 64 162c43 45 92 63 147 63 c89 0 204 -68 204 -337zM365 421c0 46 -4 109 -16 141c-17 45 -50 79 -96 79c-35 0 -73 -13 -100 -63c-21 -37 -21 -84 -21 -138c0 -49 0 -99 18 -136c31 -63 77 -63 93 -63c88 0 122 97 122 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2264" d="M691 75c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259zM702 -99c0 -11 -9 -20 -20 -20h-586c-11 0 -20 9 -20 20s9 20 20 20h586c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE3-28" d="M461 -459c0 -7 -6 -13 -13 -13c-3 0 -6 1 -8 3c-147 111 -284 390 -284 633v172c0 243 137 522 284 633c2 2 5 3 8 3c7 0 13 -6 13 -13c0 -4 -2 -8 -5 -10c-140 -105 -236 -383 -236 -613v-172c0 -230 96 -508 236 -613c3 -2 5 -6 5 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE3-29" d="M367 164c0 -243 -137 -522 -284 -633c-3 -2 -5 -3 -8 -3c-7 0 -13 6 -13 13c0 4 2 8 5 10c140 105 236 383 236 613v172c0 230 -96 508 -236 613c-3 2 -5 6 -5 10c0 7 6 13 13 13c3 0 5 -1 8 -3c147 -111 284 -390 284 -633v-172Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE7-7B" d="M755 -1224c0 -14 -12 -26 -26 -26c-3 0 -6 1 -9 2c-169 61 -320 222 -320 373v750c0 137 -97 300 -236 351c-10 3 -17 13 -17 24s7 21 17 24c139 51 236 214 236 351v750c0 151 151 312 320 373c3 1 6 2 9 2c14 0 26 -12 26 -26c0 -11 -7 -21 -17 -24 c-138 -51 -236 -202 -236 -325v-750c0 -147 -120 -300 -265 -375c145 -75 265 -228 265 -375v-750c0 -123 98 -274 236 -325c10 -3 17 -13 17 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="850" y="0"></use>
<g transform="translate(1906,0)">
 <use xlink:href="#E1-LATINMODERNSIZE7-7B"></use>
<g transform="translate(1069,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,935)">
<g transform="translate(120,0)">
<rect stroke="none" width="1732" height="60" x="0" y="220"></rect>
<g transform="translate(500,557)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-65" x="705" y="-185"></use>
</g>
<g transform="translate(60,-417)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2E" x="1001" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-39" x="1279" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1780" y="0"></use>
</g>
</g>
</g>
<g transform="translate(0,-833)">
 <use xlink:href="#E1-LATINMODERNSIZE3-28"></use>
<g transform="translate(523,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="3013" height="60" x="0" y="220"></rect>
<g transform="translate(60,557)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-65" x="705" y="-185"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="1033" y="0"></use>
<g transform="translate(1281,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="779" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-35" x="1779" y="0"></use>
</g>
</g>
<g transform="translate(700,-417)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="779" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-35" x="1779" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE3-29" x="3777" y="0"></use>
<g transform="translate(4300,756)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-34" x="779" y="0"></use>
</g>
</g>
</g>
<g transform="translate(6295,0)">
<g transform="translate(0,935)">
<g transform="translate(332,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="809" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2264" x="1264" y="0"></use>
<g transform="translate(2320,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1780" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="2280" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="2781" y="0"></use>
</g>
</g>
</g>
<g transform="translate(0,-833)">
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="332" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-74" x="832" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-68" x="1222" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="1778" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="2223" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-77" x="2615" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="3338" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="3616" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="4011" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="4455" y="0"></use>
</g>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>

For 8-bit encoded values, the
<tt>SRGB8ToLinear()</tt><span class="anchor" id="SRGB8ToLinear"></span> function uses a
precomputed 256-entry lookup table.  A separate
<tt>SRGBToLinear()</tt><span class="anchor" id="SRGBToLinear"></span> uses a rational polynomial
approximation for arbitrary floating-point values between&nbsp;0 and&nbsp;1.

</p>
<p></p>
<span class="anchor" id="fragment-ColorEncodingMethodDefinitions-1"></span><div class="fragmentname">&lt;&lt;ColorEncoding Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-ColorEncodingMethodDefinitions-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="sRGBColorEncoding::ToLinear"></span>sRGBColorEncoding::ToLinear(pstd::span&lt;const uint8_t&gt; vin,
                                 pstd::span&lt;Float&gt; vout) const {
    for (size_t i = 0; i &lt; vin.size(); ++i)
        vout[i] = SRGB8ToLinear(vin[i]);
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>The linear and sRGB encodings are widely used in the system, so they are made
available via <tt>static</tt> member variables in the
<tt>ColorEncoding</tt> class.

</p>
<p></p>
<span class="anchor" id="fragment-ColorEncodingInterface-2"></span><div class="fragmentname">&lt;&lt;ColorEncoding Interface&gt;&gt;+=&nbsp;<a href="#fragment-ColorEncodingInterface-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">static <a href="#ColorEncoding" class="code">ColorEncoding</a> <span class="anchor" id="ColorEncoding::Linear"></span>Linear;
static <a href="#ColorEncoding" class="code">ColorEncoding</a> <span class="anchor" id="ColorEncoding::sRGB"></span>sRGB;</div><p>


</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
<div class="container-fluid">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>,<br>
<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">&copy; 2004-2023</a> Matt Pharr, Wenzel Jakob, and Greg Humphreys.
<a href="https://github.com/mmp/pbr-book-website/"><span class="fab fa-github"></span></a><br>
Purchase a printed copy: <a href="https://www.amazon.com/Physically-Based-Rendering-fourth-Implementation/dp/0262048027?keywords=physically+based+rendering+4th+edition&qid=1671730412&sprefix=physically+based%!C(MISSING)aps%!C(MISSING)145&sr=8-1&linkCode=ll1&tag=pharr-20&linkId=81a816d90f0c7e872617f1f930a51fd6&language=en_US&ref_=as_li_ss_tl"><span class="fab fa-amazon"></span></a>
<a href="https://mitpress.mit.edu/9780262048026/physically-based-rendering/"><img src="/mitpress.png" width=10 height=16></a>
</span>
</div>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Utilities/Parallelism.html">Utilities / Parallelism</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
